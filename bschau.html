<!-- 

///////////////////////////////////////////////
/////Code được viết bởi Chauhuynh0104/////////
////http://fb.com/chauhuynh0104//////////////
/////////////079.567.9350///////////////////
///Vui lòng tôn trọng bản quyền tác giả////
/////////Không xoá dòng này //////////////
/////////////////////////////////////////

!-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Bệnh Án</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff9800;
            --primary-light: #ffe0b2;
            --primary-dark: #f57c00;
            --bg-color: #ffffff;
            --border-color: #ffcc80;
            --text-color: #333;
            --light-text: #666;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f9f9f9; color: var(--text-color); line-height: 1.6; padding: 10px; }

        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 20px; }
        .header { background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header h1 { font-size: 28px; font-weight: 600; }
        .header i { margin-right: 10px; }

        .left-panel, .right-panel { flex: 1; background-color: var(--bg-color); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .right-panel { flex: 2; }

        .panel-header { background-color: var(--primary-light); padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { color: var(--primary-dark); font-size: 20px; }

        .panel-content { padding: 20px; flex: 1; overflow-y: auto; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: #f0f0f0; color: var(--text-color); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .notification-bar { background-color: #fff3e0; border-left: 5px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .notification-bar i { color: var(--warning-color); margin-right: 10px; }

        .search-filter { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-filter input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 200px; }
        .search-filter select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }

        .patient-room-group { margin-bottom: 20px; }
        .patient-room-group h3 { color: var(--primary-dark); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--border-color); }
        .patient-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .patient-item:hover { background-color: #fff9f0; border-color: var(--border-color); }
        .patient-item.active { background-color: var(--primary-light); border-color: var(--primary-color); }

        .patient-type.inpatient { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .patient-type.outpatient { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2); }

        .status-ok { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-error { display: inline-block; padding: 8px 16px; background: #fb7185; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-warning { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .stats-table th, .stats-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .stats-table th { background-color: #f9f9f9; color: var(--primary-dark); font-weight: 600; }

        .patient-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: var(--light-text); }
        .form-group input, .form-group select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background-color: white; border-radius: var(--radius); width: 90%; max-width: 700px; max-height: 90vh; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; }
        .modal-content { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-text); }

        .hidden { display: none; }

        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.4s ease; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        footer { text-align: center; padding: 20px; color: var(--light-text); font-size: 14px; margin-top: 30px; }

/* ================== RESPONSIVE MOBILE ================== */
@media (max-width: 768px) {

    body {
        padding: 6px;
        font-size: 14px;
    }

    /* Header */
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 15px;
    }

    .header h1 {
        font-size: 20px;
    }

    .header p {
        font-size: 13px;
    }

    #newPatientBtn {
        width: 100%;
        justify-content: center;
    }

    /* Container: 2 cột -> 1 cột */
    .container {
        flex-direction: column;
        gap: 12px;
    }

    .left-panel,
    .right-panel {
        flex: unset;
        width: 100%;
    }

    /* Panel */
    .panel-header h2 {
        font-size: 16px;
    }

    .panel-content {
        padding: 12px;
    }

    /* Search */
    .search-filter {
        flex-direction: column;
    }

    .search-filter input,
    .search-filter select {
        width: 100%;
        font-size: 14px;
    }

    /* Patient item */
    .patient-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 12px;
    }

    .patient-type {
        font-size: 12px;
        padding: 6px 12px;
    }

    /* Table -> scroll ngang */
    .stats-table {
        font-size: 13px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    /* Form */
    .patient-form {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .form-group input,
    .form-group select {
        font-size: 14px;
        padding: 10px;
    }

    /* Modal */
    .modal {
        width: 95%;
        max-height: 90vh;
    }

    .modal-header {
        font-size: 16px;
        padding: 12px;
    }

    /* Button */
    .btn {
        padding: 10px 14px;
        font-size: 14px;
    }

    /* Toast */
    .toast {
        min-width: unset;
        width: calc(100vw - 40px);
        font-size: 13px;
    }

    footer {
        font-size: 12px;
    }
}

/* Mobile rất nhỏ (≤480px) */
@media (max-width: 480px) {

    .header h1 {
        font-size: 18px;
    }

    .panel-header h2 {
        font-size: 15px;
    }

    .btn {
        font-size: 13px;
    }

    .patient-item {
        padding: 10px;
    }
}

    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1><i class="fas fa-heartbeat"></i> HỆ THỐNG QUẢN LÝ BỆNH ÁN</h1>
            <p>Quản lý thông tin bệnh nhân và theo dõi quá trình điều trị</p>
        </div>
        <button id="newPatientBtn" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Thêm bệnh nhân mới
        </button>
    </div>

    <div class="notification-bar" id="notificationContainer">
        <div><i class="fas fa-bell"></i><span id="notificationText">Không có thông báo nào</span></div>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header"><h2><i class="fas fa-users"></i> DANH SÁCH BỆNH NHÂN</h2></div>
            <div class="panel-content">
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm bệnh nhân...">
                    <select id="filterStatus">   <option value="all">Tất cả</option><option value="discharged">Đã ra viện</option>
                        <option value="active"selected>Chưa ra viện</option>
                        
                     
                    </select>
                </div>
                <div id="patientListContainer"><div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Đang tải dữ liệu...</p></div></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                <h2 id="rightPanelTitle"><i class="fas fa-chart-bar"></i> THỐNG KÊ GIỜ KHÁM</h2>
                <button id="viewStatsBtn" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> Xem thống kê</button>
            </div>
            <div class="panel-content" id="rightPanelContent">
                <div id="statsContent">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>STT</th><th>Tên</th><th>Phòng</th><th>Giờ khám</th><th>Số ngày</th><th>Loại</th><th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody"></tbody>
                    </table>
                </div>
                <div id="patientDetailContent" class="hidden"></div>
            </div>
        </div>
    </div>

    <footer>Design By Doctor Châu</footer>
    <div id="toastContainer"></div>

    <!-- Password Modal - Ẩn lúc đầu -->
    <div id="passwordModal" class="overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>Nhập mật khẩu để tiếp tục</h3></div>
            <div class="modal-content">
                <input type="password" id="passwordInput" placeholder="Mật khẩu" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="passwordOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal thêm/sửa bệnh nhân -->
    <div id="patientModal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header" id="modalTitle">Thêm bệnh nhân mới<button class="close-btn" id="closeModalBtn">×</button></div>
            <div class="modal-content">
                <form id="patientForm">
                    <div class="patient-form">
                        <div class="form-group"><label for="fullName">Họ tên *</label><input type="text" id="fullName" required></div>
                        <div class="form-group"><label for="age">Tuổi *</label><input type="number" id="age" min="1" max="120" required></div>
                        <div class="form-group"><label for="gender">Giới tính *</label><select id="gender" required><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div>
                        <div class="form-group"><label for="diagnosis">Chẩn đoán *</label><input type="text" id="diagnosis" required></div>
                        <div class="form-group"><label for="admissionDate">Ngày vào viện *</label><input type="date" id="admissionDate" required></div>
                        <div class="form-group"><label for="admissionTime">Giờ vào viện *</label><input type="time" id="admissionTime" required></div>
                        <div class="form-group"><label for="examinationTime">Giờ khám bệnh *</label><input type="time" id="examinationTime" required></div>
                        <div class="form-group"><label for="room">Phòng *</label><select id="room" required><option value="9">Phòng 9</option><option value="11">Phòng 11</option></select></div>
                        <div class="form-group"><label for="patientType">Loại bệnh nhân *</label><select id="patientType" required><option value="Nội trú">Nội trú</option><option value="Ban ngày">Ban ngày</option></select></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Đóng</button>
                <button type="button" class="btn btn-success" id="savePatientBtn">Lưu thông tin</button>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div id="confirmModal" class="overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">Xác nhận xóa<button class="close-btn" id="closeConfirmModalBtn">×</button></div>
            <div class="modal-content"><p>Bạn có chắc chắn muốn xóa bệnh nhân này không? Hành động này không thể hoàn tác.</p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>

    <script>
     const PASSWORD = "1!"; // ← Đổi mật khẩu ở đây
    const REFRESH_KEY = "yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr";
    const APP_KEY = "qzy5kclrf827aey";
    const APP_SECRET = "6jlsunzjqr3s3nh";

    let patients = [];
    let accessToken = "";
    let isAuthenticated = false;        // Sẽ được kiểm tra từ localStorage
    let pendingAction = null;
    let currentPatientId = null;
    let currentView = 'stats';

    // =================== THÊM MỚI: Quản lý đăng nhập bằng localStorage ===================
    const AUTH_STORAGE_KEY = "hospital_app_authenticated";

    // Kiểm tra xem đã đăng nhập chưa (khi load trang)
    function checkStoredAuth() {
        const stored = localStorage.getItem(AUTH_STORAGE_KEY);
        if (stored === "true") {
            isAuthenticated = true;
        }
    }

    // Lưu trạng thái đăng nhập
    function setAuthenticated(value) {
        isAuthenticated = value;
        localStorage.setItem(AUTH_STORAGE_KEY, value.toString());
    }

    // Đăng xuất: xóa trạng thái xác thực
    function logout() {
        setAuthenticated(false);
        showToast('Đã đăng xuất thành công!', 'info');
        // Có thể reload lại trang để làm sạch giao diện nếu muốn
        location.reload();
    }
    // ================================================================================

    function showToast(msg, type = 'info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    // Chỉ hiện mật khẩu khi chưa xác thực
    function requirePassword(action) {
        if (isAuthenticated) {
            action();
            return;
        }
        pendingAction = action;
        document.getElementById('passwordModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    }

    document.getElementById('passwordOk').onclick = () => {
        if (document.getElementById('passwordInput').value === PASSWORD) {
            setAuthenticated(true);  // ← Lưu vào localStorage
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            if (pendingAction) { pendingAction(); pendingAction = null; }
            showToast('Đăng nhập thành công!', 'success');
        } else {
            showToast('Mật khẩu sai!', 'error');
        }
    };


        document.getElementById('passwordInput').onkeyup = e => { if (e.key === 'Enter') document.getElementById('passwordOk').click(); };

        // Dropbox
        async function getAccessToken() {
            const res = await fetch('https://api.dropbox.com/oauth2/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=refresh_token&refresh_token=${REFRESH_KEY}&client_id=${APP_KEY}&client_secret=${APP_SECRET}` });
            if (!res.ok) throw new Error('Token error');
            const data = await res.json();
            accessToken = data.access_token;
        }

        async function loadFromDropbox() {
            try {
                await getAccessToken();
                const res = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json' }) }
                });
                if (res.status === 409) return [];
                if (!res.ok) throw new Error('Download failed');
                return await res.json();
            } catch { return []; }
        }

        async function saveToDropbox(data) {
            await getAccessToken();
            await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json', mode: 'overwrite' }), 'Content-Type': 'application/octet-stream' },
                body: JSON.stringify(data)
            });
        }

        function isDischarged(p) {
            if (!p.dischargeDate || !p.dischargeTime) return false;
            return new Date(`${p.dischargeDate}T${p.dischargeTime}`) < new Date();
        }

        function filterPatients(list) {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const f = document.getElementById('filterStatus').value;
            return list.filter(p => {
                const match = p.fullName.toLowerCase().includes(q);
                const discharged = isDischarged(p);
                if (f === 'active') return match && !discharged;
                if (f === 'discharged') return match && discharged;
                return match;
            });
        }

        function formatDate(d) { const date = new Date(d); return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear()}`; }

        function renderPatientList() {
            const filtered = filterPatients(patients);
            const rooms = {};
            filtered.forEach(p => { if (!rooms[p.room]) rooms[p.room] = []; rooms[p.room].push(p); });

            let html = '';
            Object.keys(rooms).sort().forEach(room => {
                html += `<div class="patient-room-group"><h3>Phòng ${room}</h3>`;
                rooms[room].forEach(p => {
                    const discharged = isDischarged(p);
                    html += `<div class="patient-item ${currentPatientId === p.id ? 'active' : ''}" onclick="requirePassword(() => showPatientDetail('${p.id}'))">
                        <span class="patient-name">${p.fullName}</span> ${p.age} tuổi
                        <span class="patient-details">
                            <span class="patient-type ${p.patientType === 'Nội trú' ? 'inpatient' : 'outpatient'}">${p.patientType}</span>
                            ${discharged ? '<small style="color:#888;margin-left:8px">(Đã ra viện)</small>' : ''}
                        </span>
                    </div>`;
                });
                html += '</div>';
            });

            document.getElementById('patientListContainer').innerHTML = html || '<div class="empty-state"><i class="fas fa-users-slash"></i><p>Không có bệnh nhân nào</p></div>';
        }

        function renderStatsTable() {
            const now = new Date();
            const filtered = filterPatients(patients).filter(p => !isDischarged(p)).sort((a,b) => a.examinationTime.localeCompare(b.examinationTime));
            let html = '', stt = 1;
            filtered.forEach(p => {
                const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
                let statusText = 'Đang điều trị', statusClass = 'status-ok';
                if (p.dischargeDate) {
                    const d = new Date(`${p.dischargeDate}T${p.dischargeTime || '00:00'}`);
                    if (d < now) return;
                    const today = now.toISOString().split('T')[0];
                    statusText = p.dischargeDate === today ? `Ra viện hôm nay - ${p.dischargeTime}` : `Ra viện ${formatDate(p.dischargeDate)} - ${p.dischargeTime}`;
                    statusClass = p.dischargeDate === today ? 'status-warning' : 'status-error';
                }
                html += `<tr><td>${stt++}</td><td>${p.fullName}</td><td>${p.room}</td><td>${p.examinationTime}</td><td>${days} ngày</td><td>${p.patientType}</td><td><span class="${statusClass}">${statusText}</span></td></tr>`;
            });
            document.getElementById('statsTableBody').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;">Không có dữ liệu</td></tr>';
        }

        function updateNotifications() {
            const now = new Date();
            const overdue = patients.filter(p => {
                if (isDischarged(p)) return false;
                const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
                return (p.patientType === 'Nội trú' && days > 21) || (p.patientType === 'Ban ngày' && days > 14);
            });

            if (overdue.length === 0) {
                document.getElementById('notificationContainer').style.display = 'none';
            } else {
                document.getElementById('notificationContainer').style.display = 'flex';
                let txt = '';
                overdue.forEach(p => {
                    const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
                    txt += `<strong>${p.fullName}</strong> (Phòng ${p.room}) - ${p.patientType} nằm ${days} ngày<br>`;
                });
                document.getElementById('notificationText').innerHTML = txt;
            }
        }

        function showPatientDetail(id) {
            currentPatientId = id; currentView = 'patient';
            const p = patients.find(x => x.id === id);
            document.getElementById('rightPanelTitle').innerHTML = `<i class="fas fa-user"></i> Thông tin bệnh nhân: ${p.fullName}`;
            document.getElementById('patientDetailContent').innerHTML = `
                <form id="detailForm">
                    <div class="patient-form">
                        <div class="form-group"><label>Họ tên *</label><input id="detailFullName" value="${p.fullName}" required></div>
                        <div class="form-group"><label>Tuổi *</label><input type="number" id="detailAge" value="${p.age}" required></div>
                        <div class="form-group"><label>Giới tính *</label><select id="detailGender" required><option value="Nam" ${p.gender==='Nam'?'selected':''}>Nam</option><option value="Nữ" ${p.gender==='Nữ'?'selected':''}>Nữ</option></select></div>
                        <div class="form-group"><label>Chẩn đoán *</label><input id="detailDiagnosis" value="${p.diagnosis}" required></div>
                        <div class="form-group"><label>Ngày vào viện *</label><input type="date" id="detailAdmissionDate" value="${p.admissionDate}" required></div>
                        <div class="form-group"><label>Giờ vào viện *</label><input type="time" id="detailAdmissionTime" value="${p.admissionTime}" required></div>
                        <div class="form-group"><label>Giờ khám bệnh *</label><input type="time" id="detailExaminationTime" value="${p.examinationTime}" required></div>
                        <div class="form-group"><label>Phòng *</label><select id="detailRoom" required><option value="9" ${p.room==='9'?'selected':''}>Phòng 9</option><option value="11" ${p.room==='11'?'selected':''}>Phòng 11</option></select></div>
                        <div class="form-group"><label>Loại bệnh nhân *</label><select id="detailPatientType" required><option value="Nội trú" ${p.patientType==='Nội trú'?'selected':''}>Nội trú</option><option value="Ban ngày" ${p.patientType==='Ban ngày'?'selected':''}>Ban ngày</option></select></div>
                        <div class="form-group"><label>Ngày ra viện</label><input type="date" id="detailDischargeDate" value="${p.dischargeDate||''}"></div>
                        <div class="form-group"><label>Giờ ra viện</label><input type="time" id="detailDischargeTime" value="${p.dischargeTime||''}"></div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" onclick="requirePassword(() => updatePatient('${id}'))">Cập nhật</button>
                        <button type="button" class="btn btn-danger" onclick="requirePassword(() => showConfirmDeleteModal('${id}'))">Xóa bệnh nhân</button>
                    </div>
                </form>`;
            document.getElementById('statsContent').classList.add('hidden');
            document.getElementById('patientDetailContent').classList.remove('hidden');
            renderPatientList();
        }

        function showStatsView() {
            currentView = 'stats'; currentPatientId = null;
            document.getElementById('rightPanelTitle').innerHTML = '<i class="fas fa-chart-bar"></i> THỐNG KÊ GIỜ KHÁM';
            document.getElementById('statsContent').classList.remove('hidden');
            document.getElementById('patientDetailContent').classList.add('hidden');
            renderPatientList(); renderStatsTable();
        }

        function showAddPatientModal() {
            document.getElementById('modalTitle').textContent = 'Thêm bệnh nhân mới';
            document.getElementById('patientForm').reset();
            const now = new Date();
            document.getElementById('admissionDate').value = now.toISOString().split('T')[0];
            document.getElementById('admissionTime').value = now.toTimeString().slice(0,5);
            document.getElementById('examinationTime').value = "07:00";
            document.getElementById('patientModal').classList.remove('hidden');
        }

        async function savePatient() {
            if (!document.getElementById('patientForm').checkValidity()) { showToast('Vui lòng điền đầy đủ thông tin', 'error'); return; }
            const id = 'patient_' + Date.now();
            const newP = { id, fullName: document.getElementById('fullName').value, age: +document.getElementById('age').value, gender: document.getElementById('gender').value,
                diagnosis: document.getElementById('diagnosis').value, admissionDate: document.getElementById('admissionDate').value,
                admissionTime: document.getElementById('admissionTime').value, examinationTime: document.getElementById('examinationTime').value,
                room: document.getElementById('room').value, patientType: document.getElementById('patientType').value,
                dischargeDate: '', dischargeTime: '' };
            patients.push(newP);
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                document.getElementById('patientModal').classList.add('hidden');
                showToast('Thêm thành công!', 'success');
                showPatientDetail(id);
            } catch { showToast('Lỗi lưu dữ liệu', 'error'); }
        }

        async function updatePatient(id) {
            const i = patients.findIndex(p => p.id === id);
            patients[i] = { ...patients[i],
                fullName: document.getElementById('detailFullName').value, age: +document.getElementById('detailAge').value,
                gender: document.getElementById('detailGender').value, diagnosis: document.getElementById('detailDiagnosis').value,
                admissionDate: document.getElementById('detailAdmissionDate').value, admissionTime: document.getElementById('detailAdmissionTime').value,
                examinationTime: document.getElementById('detailExaminationTime').value, room: document.getElementById('detailRoom').value,
                patientType: document.getElementById('detailPatientType').value,
                dischargeDate: document.getElementById('detailDischargeDate').value || '',
                dischargeTime: document.getElementById('detailDischargeTime').value || '' };
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                showToast('Cập nhật thành công!', 'success');
            } catch { showToast('Lỗi cập nhật', 'error'); }
        }

        async function deletePatient(id) {
            patients = patients.filter(p => p.id !== id);
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                showStatsView();
                document.getElementById('confirmModal').classList.add('hidden');
                showToast('Xóa thành công!', 'success');
            } catch { showToast('Lỗi xóa', 'error'); }
        }

        function showConfirmDeleteModal(id) {
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').onclick = () => deletePatient(id);
        }

        // Sự kiện (đều qua requirePassword)
        document.getElementById('newPatientBtn').onclick = () => requirePassword(showAddPatientModal);
        document.getElementById('viewStatsBtn').onclick = () => requirePassword(showStatsView);
        document.getElementById('savePatientBtn').onclick = () => requirePassword(savePatient);
        document.getElementById('searchInput').oninput = () => requirePassword(() => { renderPatientList(); renderStatsTable(); });
        document.getElementById('filterStatus').onchange = () => requirePassword(() => { renderPatientList(); renderStatsTable(); });

        document.getElementById('closeModalBtn').onclick = document.getElementById('cancelBtn').onclick = () => document.getElementById('patientModal').classList.add('hidden');
        document.getElementById('closeConfirmModalBtn').onclick = document.getElementById('cancelDeleteBtn').onclick = () => document.getElementById('confirmModal').classList.add('hidden');

        document.getElementById('fullName').oninput = function() {
            if (this.value.toLowerCase().includes('thị')) document.getElementById('gender').value = 'Nữ';
        };

        // Phím tắt
       document.onkeydown = e => {
        if (e.ctrlKey && e.key === 'n') { 
            e.preventDefault(); 
            requirePassword(showAddPatientModal); 
        }
        if (e.key === 'Escape') requirePassword(showStatsView);
        if (e.key === 'F5') location.reload();
    if (e.ctrlKey && e.key === 's') {
            e.preventDefault(); // Ngăn hành vi lưu trang mặc định của trình duyệt

            requirePassword(() => {
                if (currentView === 'stats' && !currentPatientId) {
                    // Đang ở modal Thêm bệnh nhân mới (modal đang mở)
                    if (!document.getElementById('patientModal').classList.contains('hidden')) {
                        savePatient(); // Gọi hàm lưu bệnh nhân mới
                    } else {
                        showToast('Không có hành động lưu nào đang mở', 'info');
                    }
                } else if (currentPatientId) {
                    // Đang xem chi tiết bệnh nhân → Cập nhật
                    updatePatient(currentPatientId);
                } else {
                    showToast('Không có hành động lưu nào', 'info');
                }
            });
        }
        if (e.key === 'F1') { 
            e.preventDefault(); 
            if (currentPatientId) requirePassword(() => showConfirmDeleteModal(currentPatientId)); 
        }
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            const sel = document.getElementById('filterStatus');
            sel.value = sel.value === 'all' ? 'active' : 'all';
            requirePassword(() => sel.dispatchEvent(new Event('change')));
        }

        // ← THÊM MỚI: Phím F2 để đăng xuất
        if (e.key === 'F2') {
            e.preventDefault();
            if (isAuthenticated) {
             
                    logout();
               
            } else {
                showToast('Bạn chưa đăng nhập', 'info');
            }
        }
    };

        // Khởi động ngay - hiển thị giao diện luôn
        async function initApp() {
        checkStoredAuth();               
        patients = await loadFromDropbox();
        renderPatientList();
        renderStatsTable();
        updateNotifications();
        showStatsView();
    }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
