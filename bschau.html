

<!-- 

///////////////////////////////////////////////
/////Code ƒë∆∞·ª£c vi·∫øt b·ªüi Chauhuynh0104/////////
////http://fb.com/chauhuynh0104//////////////
/////////////079.567.9350///////////////////
///Vui l√≤ng t√¥n tr·ªçng b·∫£n quy·ªÅn t√°c gi·∫£////
/////////Kh√¥ng xo√° d√≤ng n√†y //////////////
/////////////////////////////////////////

!-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B·ªánh √Ån</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff9800;
            --primary-light: #ffe0b2;
            --primary-dark: #f57c00;
            --bg-color: #ffffff;
            --border-color: #ffcc80;
            --text-color: #333;
            --light-text: #666;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f9f9f9; color: var(--text-color); line-height: 1.6; padding: 10px; }

        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 20px; }
        .header { background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header h1 { font-size: 28px; font-weight: 600; }
        .header i { margin-right: 10px; }

        .left-panel, .right-panel { flex: 1; background-color: var(--bg-color); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .right-panel { flex: 2; }

        .panel-header { background-color: var(--primary-light); padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { color: var(--primary-dark); font-size: 20px; }

        .panel-content { padding: 20px; flex: 1; overflow-y: auto; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: #f0f0f0; color: var(--text-color); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .notification-bar { background-color: #fff3e0; border-left: 5px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .notification-bar i { color: var(--warning-color); margin-right: 10px; }

        .search-filter { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-filter input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 200px; }
        .search-filter select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }

        .patient-room-group { margin-bottom: 20px; }
        .patient-room-group h3 { color: var(--primary-dark); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--border-color); }
        .patient-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .patient-item:hover { background-color: #fff9f0; border-color: var(--border-color); }
        .patient-item.active { background-color: var(--primary-light); border-color: var(--primary-color); }

        .patient-type.inpatient { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .patient-type.outpatient { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2); }

        .status-ok { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-error { display: inline-block; padding: 8px 16px; background: #fb7185; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-warning { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .stats-table th, .stats-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .stats-table th { background-color: #f9f9f9; color: var(--primary-dark); font-weight: 600; }

        .patient-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: var(--light-text); }
        .form-group input, .form-group select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background-color: white; border-radius: var(--radius); width: 90%; max-width: 900px; max-height: 90vh; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; }
        .modal-content { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-text); }

        .hidden { display: none; }

        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.4s ease; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        footer { text-align: center; padding: 20px; color: var(--light-text); font-size: 14px; margin-top: 30px; }

/* ================== RESPONSIVE MOBILE ================== */
@media (max-width: 768px) {

    body {
        padding: 6px;
        font-size: 14px;
    }

    /* Header */
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 15px;
    }

    .header h1 {
        font-size: 20px;
    }

    .header p {
        font-size: 13px;
    }

    #newPatientBtn {
        width: 100%;
        justify-content: center;
    }

    /* Container: 2 c·ªôt -> 1 c·ªôt */
    .container {
        flex-direction: column;
        gap: 12px;
    }

    .left-panel,
    .right-panel {
        flex: unset;
        width: 100%;
    }

    /* Panel */
    .panel-header h2 {
        font-size: 16px;
    }

    .panel-content {
        padding: 12px;
    }

    /* Search */
    .search-filter {
        flex-direction: column;
    }

    .search-filter input,
    .search-filter select {
        width: 100%;
        font-size: 14px;
    }

    /* Patient item */
    .patient-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 12px;
    }

    .patient-type {
        font-size: 12px;
        padding: 6px 12px;
    }

    /* Table -> scroll ngang */
    .stats-table {
        font-size: 13px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    /* Form */
    .patient-form {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .form-group input,
    .form-group select {
        font-size: 14px;
        padding: 10px;
    }

    /* Modal */
    .modal {
        width: 95%;
        max-height: 90vh;
    }

    .modal-header {
        font-size: 16px;
        padding: 12px;
    }

    /* Button */
    .btn {
        padding: 10px 14px;
        font-size: 14px;
    }

    /* Toast */
    .toast {
        min-width: unset;
        width: calc(100vw - 40px);
        font-size: 13px;
    }

    footer {
        font-size: 12px;
    }
}

/* Mobile r·∫•t nh·ªè (‚â§480px) */
@media (max-width: 480px) {

    .header h1 {
        font-size: 18px;
    }

    .panel-header h2 {
        font-size: 15px;
    }

    .btn {
        font-size: 13px;
    }

    .patient-item {
        padding: 10px;
    }
}
.date-wrapper{
    position: relative;
    display: flex;
    align-items: center;
}

/* ch·ª´a ch·ªó cho ch·ªØ + icon */
.date-wrapper input{
    width: 100%;
    padding-right: 110px;
}

/* ch·ªØ Th·ª© n·∫±m TR∆Ø·ªöC icon */
.date-wrapper span{
    position: absolute;
    right: 55px;
    font-weight: 600;
    color: #ff5722;
}

/* icon l·ªãch n·∫±m m√©p ph·∫£i */
.date-wrapper input::-webkit-calendar-picker-indicator{
    position: absolute;
    right: 10px;
    cursor: pointer;
}

    .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end; /* ƒê·∫©y to√†n b·ªô n√∫t sang b√™n ph·∫£i */
}
/* Dropdown th·ªëng k√™ t·ªïng ‚Äì gi·ªëng filterStatus */
#totalYearSelect {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    min-width: 160px;
    background-color: #fff;
    cursor: pointer;
}

/* Khi focus ‚Äì gi·ªëng c√°c select kh√°c */
#totalYearSelect:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
}
#dateRangeBox {
    display: none;          /* ‚Üê M·∫∂C ƒê·ªäNH ·∫®N */
    gap: 10px;
    width: 100%;
}
/* Kho·∫£ng ng√†y gi·ªëng filterStatus */
#dateRangeBox input[type="date"] {
    flex: unset;          /* b·ªè flex:1 */
    width: 200px;         /* gi·ªëng select */
    min-width: 160px;
}

.patient-item-left {
    justify-content: flex-start !important;
    gap: 10px; /* kho·∫£ng c√°ch gi·ªØa checkbox v√† ch·ªØ */
}
input[type="number"],
.bschau {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    min-width: 160px;
    background-color: #fff;
    cursor: pointer;
}

/* Khi focus ‚Äì gi·ªëng c√°c select kh√°c */
input[type="number"]:focus,
.bschau:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2);
}
@media (max-width: 480px) {
    .patient-item {
        display: flex !important;
        flex-direction: row !important;   /* üî• √©p n·∫±m ngang */
        align-items: center !important;
        text-align: left !important;      /* üî• b·ªè cƒÉn gi·ªØa */
        gap: 8px;
    }

    .patient-name {
        flex: 1;
        min-width: 0;                     /* üî• b·∫Øt bu·ªôc */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left !important;
        font-size: 14px;
    }

    .patient-age {
        flex-shrink: 0;
        white-space: nowrap;
        font-size: 13px;
    }

    .patient-details {
        flex-shrink: 0;
        display: flex;
        align-items: center;
    }

    .patient-type {
        white-space: nowrap;
        font-size: 12px;
        padding: 4px 10px;
    }
}

@media (max-width: 410px) {

    .stats-table {
        table-layout: fixed;      /* üî• r·∫•t quan tr·ªçng */
        width: 100%;
    }

    .stats-table th,
    .stats-table td {
        padding: 6px 4px;         /* üî• thu padding */
        font-size: 13px;
        text-align: center;
        white-space: nowrap;
    }

    /* C·ªôt T√™n cho ph√©p chi·∫øm nhi·ªÅu h∆°n */
    .stats-table th:nth-child(2),
    .stats-table td:nth-child(2) {
        text-align: left;
        padding-left: 6px;
        width: 28%;
    }

    /* C√°c c·ªôt s·ªë √©p nh·ªè */
    .stats-table th:nth-child(1),
    .stats-table td:nth-child(1),
    .stats-table th:nth-child(3),
    .stats-table td:nth-child(3),
    .stats-table th:nth-child(4),
    .stats-table td:nth-child(4),
    .stats-table th:nth-child(5),
    .stats-table td:nth-child(5),
    .stats-table th:nth-child(6),
    .stats-table td:nth-child(6) {
        width: 10%;
    }

    /* Tr·∫°ng th√°i */
    .stats-table th:nth-child(7),
    .stats-table td:nth-child(7) {
        width: 12%;
    }
}

    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1><i class="fas fa-heartbeat"></i>Electronic Medical Record</h1>
            <p>Dr.Chau</p>
        </div>
        <button id="newPatientBtn" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Th√™m b·ªánh nh√¢n m·ªõi
        </button>
    </div>

 <div class="notification-bar hidden" id="notificationContainer">
    <div id="notificationContent">
        <i class="fas fa-bell"></i><span id="notificationText">Kh√¥ng c√≥ th√¥ng b√°o n√†o</span>
    </div>
    <div id="notificationLoading" class="hidden" style="align-items:center; gap:10px; color:#ff9800;">
        <i class="fas fa-spinner fa-spin"></i><p>ƒêang t·∫£i th√¥ng b√°o...</p>
    </div>
</div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header"><h2><i class="fas fa-users"></i> DANH S√ÅCH B·ªÜNH NH√ÇN</h2></div>
            <div class="panel-content">
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm b·ªánh nh√¢n...">
                    <select id="filterStatus">
    <option value="all">T·∫•t c·∫£</option>
    <option value="active" selected>Ch∆∞a ra vi·ªán</option>
    <option value="discharged">ƒê√£ ra vi·ªán</option>
    <option value="range">Kho·∫£ng th·ªùi gian</option>
</select>
<div id="dateRangeBox">
    <input type="date" id="searchFrom">
    <input type="date" id="searchTo">
</div>


                </div>
                <div id="patientListContainer"><div class="loading"><center><i class="fas fa-spinner fa-spin"></i><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></center></div></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                <h2 id="rightPanelTitle"><i class="fas fa-chart-bar"></i> TH·ªêNG K√ä GI·ªú KH√ÅM</h2>
                <button id="viewStatsBtn" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> Xem th·ªëng k√™</button>
				<button id="totalStatsBtn" class="btn btn-primary"><i class="fas fa-chart-pie"></i> Th·ªëng k√™ t·ªïng</button>
            </div>
          <div class="panel-content" id="rightPanelContent">

    <!-- ====== TH·ªêNG K√ä GI·ªú KH√ÅM (C≈®) ====== -->
    <div id="statsContent">
        <div id="statsTableContainer">
            <table class="stats-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n</th>
                        <th>Ph√≤ng</th>
                        <th>Gi·ªù kh√°m</th>
                        <th>S·ªë ng√†y</th>
                        <th>Lo·∫°i</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="statsTableBody"></tbody>
            </table>
        </div>

        <div id="statsLoading" style="text-align:center; padding:40px; color:#666;">
            <i class="fas fa-spinner fa-spin"></i>
            <p>ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
        </div>
    </div>

    <!-- ====== üëâ TH·ªêNG K√ä T·ªîNG (TH√äM M·ªöI ‚Äì D√ÅN V√ÄO ƒê√ÇY) ====== -->
    <div id="totalStatsContent" class="hidden">

        <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap">
            <select id="totalYearSelect"></select>
        
        </div>

        <table class="stats-table">
            <tbody id="totalStatsBody"></tbody>
        </table>

    </div>

    <!-- ====== CHI TI·∫æT B·ªÜNH NH√ÇN ====== -->
    <div id="patientDetailContent" class="hidden"></div>

</div>
        </div>
    </div>

    <footer>¬© 2014-2026 By Dr.Ch√¢u</footer>
    <div id="toastContainer"></div>

    <!-- Password Modal - ·∫®n l√∫c ƒë·∫ßu -->
    <div id="passwordModal" class="overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ ti·∫øp t·ª•c</h3></div>
            <div class="modal-content">
                <input type="password" id="passwordInput" placeholder="M·∫≠t kh·∫©u" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="passwordOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a b·ªánh nh√¢n -->
    <div id="patientModal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header" id="modalTitle">Th√™m b·ªánh nh√¢n m·ªõi<button class="close-btn" id="closeModalBtn">√ó</button></div>
            <div class="modal-content">
                <form id="patientForm">
                    <div class="patient-form">
                        <div class="form-group"><label for="fullName">H·ªç t√™n *</label><input type="text" id="fullName" required></div>
                        <div class="form-group"><label for="age">Tu·ªïi *</label><input type="number" id="age" min="1" max="120" required></div>
                        <div class="form-group"><label for="gender">Gi·ªõi t√≠nh *</label><select id="gender" required><option value="Nam">Nam</option><option value="N·ªØ">N·ªØ</option></select></div>
                        <div class="form-group"><label for="diagnosis">Ch·∫©n ƒëo√°n *</label><input type="text" id="diagnosis" required></div>
                       <div class="form-group">
					  <label for="admissionDate">Ng√†y v√†o vi·ªán *
					  <span id="admissionLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>

					  
					  </label>
                        

    <div class="date-wrapper">
        <input type="date" id="admissionDate" required>
        <span id="admissionWeekday"></span>
    </div>
</div>

                        <div class="form-group"><label for="admissionTime">Gi·ªù v√†o vi·ªán *</label><input type="time" id="admissionTime" required></div>
                        <div class="form-group"><label for="examinationTime">Gi·ªù kh√°m b·ªánh *</label><input type="time" id="examinationTime" required></div>
                        <div class="form-group"><label for="room">Ph√≤ng *</label><select id="room" required><option value="9">Ph√≤ng 9</option><option value="11">Ph√≤ng 11</option><option value="1">Ph√≤ng 1</option><option value="2">Ph√≤ng 2</option><option value="10">Ph√≤ng 10</option></select></div>
                        <div class="form-group"><label for="patientType">Lo·∫°i b·ªánh nh√¢n *</label><select id="patientType" required><option value="N·ªôi tr√∫">N·ªôi tr√∫</option><option value="Ban ng√†y">Ban ng√†y</option></select></div>
						<div class="form-group"><label>X√©t nghi·ªám</label><input type="text" id="labInput" readonly placeholder="Ch·ªçn x√©t nghi·ªám" onclick="openLabModal()"></div>
						<div class="form-group"><label>H√¨nh ·∫£nh</label><input type="text" id="imagingInput" readonly placeholder="Ch·ªçn h√¨nh ·∫£nh" onclick="openImagingModal()"></div>
						<div class="form-group"><label>Th·ªß thu·∫≠t</label><input type="text" id="procedureInput" readonly placeholder="Ch·ªçn th·ªß thu·∫≠t" onclick="openProcedureModal()"></div>



				  </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">ƒê√≥ng</button>
                <button type="button" class="btn btn-success" id="savePatientBtn">L∆∞u th√¥ng tin</button>
            </div>
        </div>
    </div>

    <!-- Modal x√°c nh·∫≠n x√≥a -->
    <div id="confirmModal" class="overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">X√°c nh·∫≠n x√≥a<button class="close-btn" id="closeConfirmModalBtn">√ó</button></div>
            <div class="modal-content"><p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·ªánh nh√¢n n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√≥a</button>
            </div>
        </div>
    </div>

    <script>
     const PASSWORD = "1!"; // ‚Üê ƒê·ªïi m·∫≠t kh·∫©u ·ªü ƒë√¢y
    const REFRESH_KEY = "yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr";
    const APP_KEY = "qzy5kclrf827aey";
    const APP_SECRET = "6jlsunzjqr3s3nh";

    let patients = [];
    let accessToken = "";
    let isAuthenticated = false;        // S·∫Ω ƒë∆∞·ª£c ki·ªÉm tra t·ª´ localStorage
    let pendingAction = null;
    let currentPatientId = null;
    let currentView = 'stats';
	let tempLab = "";
	let tempImaging = "";
	let tempProcedure = "";

    // =================== TH√äM M·ªöI: Qu·∫£n l√Ω ƒëƒÉng nh·∫≠p b·∫±ng localStorage ===================
    const AUTH_STORAGE_KEY = "hospital_app_authenticated";

    // Ki·ªÉm tra xem ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a (khi load trang)
    function checkStoredAuth() {
        const stored = localStorage.getItem(AUTH_STORAGE_KEY);
        if (stored === "true") {
            isAuthenticated = true;
        }
    }

    // L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
    function setAuthenticated(value) {
        isAuthenticated = value;
        localStorage.setItem(AUTH_STORAGE_KEY, value.toString());
    }

    // ƒêƒÉng xu·∫•t: x√≥a tr·∫°ng th√°i x√°c th·ª±c
    function logout() {
        setAuthenticated(false);
        showToast('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!', 'info');
        // C√≥ th·ªÉ reload l·∫°i trang ƒë·ªÉ l√†m s·∫°ch giao di·ªán n·∫øu mu·ªën
        location.reload();
    }
    // ================================================================================

    function showToast(msg, type = 'info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    // Ch·ªâ hi·ªán m·∫≠t kh·∫©u khi ch∆∞a x√°c th·ª±c
    function requirePassword(action) {
        if (isAuthenticated) {
            action();
            return;
        }
        pendingAction = action;
        document.getElementById('passwordModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    }

    document.getElementById('passwordOk').onclick = () => {
        if (document.getElementById('passwordInput').value === PASSWORD) {
            setAuthenticated(true);  // ‚Üê L∆∞u v√†o localStorage
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            if (pendingAction) { pendingAction(); pendingAction = null; }
            showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        } else {
            showToast('M·∫≠t kh·∫©u sai!', 'error');
        }
    };


        document.getElementById('passwordInput').onkeyup = e => { if (e.key === 'Enter') document.getElementById('passwordOk').click(); };

        // Dropbox
        async function getAccessToken() {
            const res = await fetch('https://api.dropbox.com/oauth2/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=refresh_token&refresh_token=${REFRESH_KEY}&client_id=${APP_KEY}&client_secret=${APP_SECRET}` });
            if (!res.ok) throw new Error('Token error');
            const data = await res.json();
            accessToken = data.access_token;
        }

        async function loadFromDropbox() {
            try {
                await getAccessToken();
                const res = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json' }) }
                });
                if (res.status === 409) return [];
                if (!res.ok) throw new Error('Download failed');
                return await res.json();
            } catch { return []; }
        }

        async function saveToDropbox(data) {
            await getAccessToken();
            await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json', mode: 'overwrite' }), 'Content-Type': 'application/octet-stream' },
                body: JSON.stringify(data)
            });
        }

        function isDischarged(p) {
            if (!p.dischargeDate || !p.dischargeTime) return false;
            return new Date(`${p.dischargeDate}T${p.dischargeTime}`) < new Date();
        }

function filterPatients(list) {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const f = document.getElementById('filterStatus').value;
    const from = document.getElementById('searchFrom').value;
    const to = document.getElementById('searchTo').value;

    return list.filter(p => {
        const match = p.fullName.toLowerCase().includes(q);
        const discharged = isDischarged(p);

        let dateOk = true;
        if (f === 'range') {
            if (from) dateOk = new Date(p.admissionDate) >= new Date(from);
            if (to) dateOk = dateOk && new Date(p.admissionDate) <= new Date(to);
        }

        if (f === 'active') return match && !discharged;
        if (f === 'discharged') return match && discharged;
        if (f === 'range') return match && dateOk;

        return match;
    });
}


        function formatDate(d) { const date = new Date(d); return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear()}`; }

function renderPatientList() {
    const filtered = filterPatients(patients);
    const rooms = {};
    const isNarrow = window.innerWidth < 410;

    filtered.forEach(p => {
        if (!rooms[p.room]) rooms[p.room] = [];
        rooms[p.room].push(p);
    });

    let html = '';

    Object.keys(rooms)
        .sort((a, b) => Number(a) - Number(b))
        .forEach(room => {

            html += `<div class="patient-room-group"><h3>Ph√≤ng ${room}</h3>`;

            rooms[room].forEach(p => {
                const discharged = isDischarged(p);

                // ===== LO·∫†I B·ªÜNH NH√ÇN =====
                let patientTypeText = p.patientType;
                let patientTypeTooltip = '';

                if (isNarrow) {
                    if (p.patientType === 'N·ªôi tr√∫') patientTypeText = 'NT';
                    if (p.patientType === 'Ban ng√†y') patientTypeText = 'BN';
                    patientTypeTooltip = `title="${p.patientType}"`;
                }

                // ===== TU·ªîI =====
                const ageText = isNarrow ? `${p.age}T` : `${p.age} tu·ªïi`;

                html += `
<div class="patient-item ${currentPatientId === p.id ? 'active' : ''}"
     onclick="requirePassword(() => showPatientDetail('${p.id}'))">

    <span class="patient-name">${p.fullName}</span>
    <span class="patient-age">${ageText}</span>

    <span class="patient-details">
        <span class="patient-type ${p.patientType === 'N·ªôi tr√∫' ? 'inpatient' : 'outpatient'}"
              ${patientTypeTooltip}>
            ${patientTypeText}
        </span>
        ${discharged ? '<small style="color:#888;margin-left:8px">(ƒê√£ ra vi·ªán)</small>' : ''}
    </span>
</div>`;
            });

            html += '</div>';
        });

    document.getElementById('patientListContainer').innerHTML =
        html || '<div class="empty-state"><center><p><i class="fas fa-users-slash"></i>Kh√¥ng c√≥ b·ªánh nh√¢n n√†o</p></center></div>';
}



     function renderStatsTable() {
    showStatsLoading(true);

    const now = new Date();
    const isNarrow = window.innerWidth < 410;

    const filtered = filterPatients(patients)
        .filter(p => !isDischarged(p))
        .sort((a,b) => a.examinationTime.localeCompare(b.examinationTime));

    let html = '', stt = 1;

    filtered.forEach(p => {
       const start = new Date(p.admissionDate);
const today = new Date();

start.setHours(0,0,0,0);
today.setHours(0,0,0,0);

const days = Math.floor((today - start) / 86400000);


        // ===== T√äN =====
        let displayName = p.fullName;
        let nameTooltip = '';

        if (isNarrow && p.fullName) {
            const parts = p.fullName.trim().split(/\s+/);
            displayName = parts[parts.length - 1];
            nameTooltip = `title="${p.fullName}"`;
        }

        // ===== LO·∫†I B·ªÜNH NH√ÇN =====
        let patientTypeText = p.patientType;
        let patientTypeTooltip = '';

        if (isNarrow) {
            if (p.patientType === 'Ban ng√†y') patientTypeText = 'BN';
            if (p.patientType === 'N·ªôi tr√∫') patientTypeText = 'NT';
            patientTypeTooltip = `title="${p.patientType}"`;
        }

        // ===== TR·∫†NG TH√ÅI =====
        let statusText = 'ƒêang ƒëi·ªÅu tr·ªã';
        let statusClass = 'status-ok';
        let statusTooltip = '';

        if (p.dischargeDate) {
            const d = new Date(`${p.dischargeDate}T${p.dischargeTime || '00:00'}`);
            if (d < now) return;

            const today = now.toISOString().split('T')[0];
            const fullText = p.dischargeDate === today
                ? `Ra vi·ªán h√¥m nay - ${p.dischargeTime}`
                : `Ra vi·ªán ${formatDate(p.dischargeDate)} - ${p.dischargeTime}`;

            if (isNarrow) {
                statusText = p.dischargeDate === today ? 'RVHN' : 'RV';
                statusTooltip = `title="${fullText}"`;
            } else {
                statusText = fullText;
            }

            statusClass = p.dischargeDate === today ? 'status-warning' : 'status-error';
        } else if (isNarrow) {
            statusText = 'ƒêT';
            statusTooltip = 'title="ƒêang ƒëi·ªÅu tr·ªã"';
        }

        html += `
<tr style="cursor:pointer" onclick="requirePassword(() => showPatientDetail('${p.id}'))">
    <td>${stt++}</td>
    <td ${nameTooltip}>${displayName}</td>
    <td>${p.room}</td>
    <td>${formatHourHM(p.examinationTime)}</td>
    <td>${isNarrow ? days : days + ' ng√†y'}</td>
    <td ${patientTypeTooltip}>${patientTypeText}</td>
    <td><span class="${statusClass}" ${statusTooltip}>${statusText}</span></td>
</tr>`;
    });

    document.getElementById('statsTableBody').innerHTML =
        html || '<tr><td colspan="7" style="text-align:center;padding:40px;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';

    showStatsLoading(false);
}



function updateNotifications() {
    showNotificationLoading(true);

    const today = new Date();
    today.setHours(0,0,0,0);

    const overdue = patients.filter(p => {
        if (isDischarged(p)) return false;

        const start = new Date(p.admissionDate);
        start.setHours(0,0,0,0);

        const days = Math.floor((today - start) / 86400000);

        return (p.patientType === 'N·ªôi tr√∫' && days > 21)
            || (p.patientType === 'Ban ng√†y' && days > 14);
    });

    if (overdue.length === 0) {
        document.getElementById('notificationContainer').classList.add('hidden');
    } else {
        let txt = '<strong>C·∫£nh b√°o qu√° ng√†y n·∫±m vi·ªán:</strong><br>';

        overdue.forEach(p => {
            const start = new Date(p.admissionDate);
            start.setHours(0,0,0,0);

            const days = Math.floor((today - start) / 86400000);

            txt += `‚Ä¢ <strong>${p.fullName}</strong> (Ph√≤ng ${p.room}) - ${p.patientType} n·∫±m ${days} ng√†y<br>`;
        });

        document.getElementById('notificationText').innerHTML = txt;
        document.getElementById('notificationContainer').classList.remove('hidden');
    }

    showNotificationLoading(false);
}


        function showPatientDetail(id) {
            currentPatientId = id; currentView = 'patient';
            const p = patients.find(x => x.id === id);
            document.getElementById('rightPanelTitle').innerHTML = `<i class="fas fa-user"></i> Th√¥ng tin b·ªánh nh√¢n: ${p.fullName}`;
            document.getElementById('patientDetailContent').innerHTML = `
                <form id="detailForm">
                    <div class="patient-form">
                        <div class="form-group"><label>H·ªç t√™n *</label><input id="detailFullName" value="${p.fullName}" required></div>
                        <div class="form-group"><label>Tu·ªïi *</label><input type="number" id="detailAge" value="${p.age}" required></div>
                        <div class="form-group"><label>Gi·ªõi t√≠nh *</label><select id="detailGender" required><option value="Nam" ${p.gender==='Nam'?'selected':''}>Nam</option><option value="N·ªØ" ${p.gender==='N·ªØ'?'selected':''}>N·ªØ</option></select></div>
                        <div class="form-group"><label>Ch·∫©n ƒëo√°n *</label><input id="detailDiagnosis" value="${p.diagnosis}" required></div>
                        <div class="form-group">
    <label>Ng√†y v√†o vi·ªán *
     <span id="detailAdmissionLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>
    
    </label>
    <div class="date-wrapper">
        <input type="date" id="detailAdmissionDate" value="${p.admissionDate}" required>
        <span id="detailAdmissionWeekday"></span>
    </div>
</div>


                        <div class="form-group"><label>Gi·ªù v√†o vi·ªán *</label><input type="time" id="detailAdmissionTime" value="${p.admissionTime}" required></div>
                        <div class="form-group"><label>Gi·ªù kh√°m b·ªánh *</label><input type="time" id="detailExaminationTime" value="${p.examinationTime}" required></div>
                        <div class="form-group"><label>Ph√≤ng *</label><select id="detailRoom" required><option value="9" ${p.room==='9'?'selected':''}>Ph√≤ng 9</option><option value="11" ${p.room==='11'?'selected':''}>Ph√≤ng 11</option><option value="1" ${p.room==='1'?'selected':''}>Ph√≤ng 1</option><option value="2" ${p.room==='2'?'selected':''}>Ph√≤ng 2</option><option value="10" ${p.room==='10'?'selected':''}>Ph√≤ng 10</option></select></div>
                        <div class="form-group"><label>Lo·∫°i b·ªánh nh√¢n *</label><select id="detailPatientType" required><option value="N·ªôi tr√∫" ${p.patientType==='N·ªôi tr√∫'?'selected':''}>N·ªôi tr√∫</option><option value="Ban ng√†y" ${p.patientType==='Ban ng√†y'?'selected':''}>Ban ng√†y</option></select></div>
                      
<div class="form-group">
    <label>X√©t nghi·ªám</label>
    <input type="text" id="detailLabInput" readonly
       value="${p.lab || ''}"
       onclick="openLabModal(true)">

</div>

<div class="form-group">
    <label>H√¨nh ·∫£nh</label>
    <input type="text" id="detailImagingInput" readonly
       value="${p.imaging || ''}"
       onclick="openImagingModal(true)">
</div>

<div class="form-group">
    <label>Th·ªß thu·∫≠t</label>
   <input type="text" id="detailProcedureInput" readonly
       value="${formatProcedureText(p.procedure || '')}"
       onclick="openProcedureModal(true)">
</div>



					  <div class="form-group">
    <label>Ng√†y ra vi·ªán
    <span id="detailDischargeLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>
    
    </label>
    <div class="date-wrapper">
        <input type="date" id="detailDischargeDate" value="${p.dischargeDate||''}">
        <span id="detailDischargeWeekday"></span>
    </div>
</div>

    <div class="form-group"><label>Gi·ªù ra vi·ªán</label><input type="time" id="detailDischargeTime" value="${p.dischargeTime||''}"></div>
	
	<div class="form-group">
  <label>T·ªïng ng√†y:</label>
  <input type="text" id="totalDays" readonly>
</div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" onclick="requirePassword(() => updatePatient('${id}'))">C·∫≠p nh·∫≠t</button>
                        <button type="button" class="btn btn-danger" onclick="requirePassword(() => showConfirmDeleteModal('${id}'))">X√≥a b·ªánh nh√¢n</button>
                    </div>
                </form>`;
				// ƒê·∫∑t gi√° tr·ªã ban ƒë·∫ßu cho √¥ T·ªïng ng√†y
				document.getElementById("totalDays").value = calcHospitalDays(p.admissionDate, p.dischargeDate);
// G·∫Øn s·ª± ki·ªán t·ª± ƒë·ªông c·∫≠p nh·∫≠t th·ª© trong			
setTimeout(() => {

    bindWeekdayAutoUpdate(
        "detailAdmissionDate",
        "detailAdmissionWeekday",
        "detailAdmissionLunar"
    );

    bindWeekdayAutoUpdate(
        "detailDischargeDate",
        "detailDischargeWeekday",
        "detailDischargeLunar"
    );

}, 100);
// === TH√äM M·ªöI: T·ª± ƒë·ªông t√≠nh t·ªïng ng√†y khi thay ƒë·ªïi ng√†y v√†o ho·∫∑c ng√†y ra ===
    const admissionDateInput = document.getElementById('detailAdmissionDate');
    const dischargeDateInput = document.getElementById('detailDischargeDate');
    const totalDaysInput = document.getElementById('totalDays');

    function updateTotalDays() {
        const admit = admissionDateInput.value;
        const discharge = dischargeDateInput.value;
        totalDaysInput.value = calcHospitalDays(admit, discharge);
    }

    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr√™n c·∫£ hai √¥ ng√†y
    admissionDateInput.addEventListener('input', updateTotalDays);
    dischargeDateInput.addEventListener('input', updateTotalDays);

    // N·∫øu ng∆∞·ªùi d√πng x√≥a ng√†y ra vi·ªán ‚Üí √¥ t·ªïng ng√†y s·∫Ω tr·ªëng
    // (h√†m calcHospitalDays ƒë√£ x·ª≠ l√Ω tr∆∞·ªùng h·ª£p thi·∫øu discharge)
            document.getElementById('statsContent').classList.add('hidden');
            document.getElementById('patientDetailContent').classList.remove('hidden');
            renderPatientList();
        }

    function showStatsView() {
    currentView = 'stats'; currentPatientId = null;
	document.getElementById('totalStatsContent').classList.add('hidden');
    document.getElementById('rightPanelTitle').innerHTML = '<i class="fas fa-chart-bar"></i> TH·ªêNG K√ä GI·ªú KH√ÅM';
    document.getElementById('statsContent').classList.remove('hidden');
    document.getElementById('patientDetailContent').classList.add('hidden');
    
    showStatsLoading(true);  // <<< TH√äM
    renderStatsTable();      // renderStatsTable ƒë√£ t·ª± ·∫©n loading khi xong
    renderPatientList();
}

        function showAddPatientModal() {
    document.getElementById('modalTitle').textContent = 'Th√™m b·ªánh nh√¢n m·ªõi';
    document.getElementById('patientForm').reset();

    const now = new Date();
    document.getElementById('admissionDate').value = now.toISOString().split('T')[0];
    document.getElementById('admissionTime').value = now.toTimeString().slice(0,5);
    document.getElementById('examinationTime').value = "07:00";

    document.getElementById('patientModal').classList.remove('hidden');

    // ‚úÖ G·ªåI H√ÄM T·∫†I ƒê√ÇY
    bindWeekdayAutoUpdate(
        "admissionDate",
        "admissionWeekday",
        "admissionLunar"
    );
}

async function savePatient() {
    if (!document.getElementById('patientForm').checkValidity()) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error');
        return;
    }

    const id = 'patient_' + Date.now();

    const newP = {
        id,
        fullName: document.getElementById('fullName').value,
        age: +document.getElementById('age').value,
        gender: document.getElementById('gender').value,
        diagnosis: document.getElementById('diagnosis').value,
        admissionDate: document.getElementById('admissionDate').value,
        admissionTime: document.getElementById('admissionTime').value,
        examinationTime: document.getElementById('examinationTime').value,
        room: document.getElementById('room').value,
        patientType: document.getElementById('patientType').value,

        // ‚úÖ CLS ‚Äì ch·ªâ l∆∞u khi b·∫•m L∆ØU
        lab: tempLab || "",
        imaging: tempImaging || "",
        procedure: tempProcedure || "",

        dischargeDate: '',
        dischargeTime: ''
    };

    patients.push(newP);

    try {
        await saveToDropbox(patients);

        // reset d·ªØ li·ªáu t·∫°m sau khi ƒë√£ l∆∞u
        tempLab = "";
        tempImaging = "";
        tempProcedure = "";

        renderPatientList();
        renderStatsTable();
        updateNotifications();

        document.getElementById('patientModal').classList.add('hidden');
        showToast('Th√™m th√†nh c√¥ng!', 'success');
        showPatientDetail(id);

    } catch {
        showToast('L·ªói l∆∞u d·ªØ li·ªáu', 'error');
    }
}


       async function updatePatient(id) {
    const i = patients.findIndex(p => p.id === id);
    if (i === -1) {
        showToast('Kh√¥ng t√¨m th·∫•y b·ªánh nh√¢n', 'error');
        return;
    }

    patients[i] = {
        ...patients[i],

        fullName: document.getElementById('detailFullName').value,
        age: +document.getElementById('detailAge').value,
        gender: document.getElementById('detailGender').value,
        diagnosis: document.getElementById('detailDiagnosis').value,

        admissionDate: document.getElementById('detailAdmissionDate').value,
        admissionTime: document.getElementById('detailAdmissionTime').value,
        examinationTime: document.getElementById('detailExaminationTime').value,

        room: document.getElementById('detailRoom').value,
        patientType: document.getElementById('detailPatientType').value,

        // ‚úÖ CLS ‚Äì ch·ªâ ghi khi b·∫•m C·∫¨P NH·∫¨T
        lab: tempLab || patients[i].lab,
        imaging: tempImaging || patients[i].imaging,
        procedure: tempProcedure || patients[i].procedure,

        dischargeDate: document.getElementById('detailDischargeDate').value || '',
        dischargeTime: document.getElementById('detailDischargeTime').value || ''
    };

    try {
        await saveToDropbox(patients);

        // ‚úÖ reset d·ªØ li·ªáu t·∫°m
        tempLab = "";
        tempImaging = "";
        tempProcedure = "";

        renderPatientList();
        renderStatsTable();
        updateNotifications();

        showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');

    } catch {
        showToast('L·ªói c·∫≠p nh·∫≠t', 'error');
    }
}


        async function deletePatient(id) {
            patients = patients.filter(p => p.id !== id);
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                showStatsView();
                document.getElementById('confirmModal').classList.add('hidden');
                showToast('X√≥a th√†nh c√¥ng!', 'success');
            } catch { showToast('L·ªói x√≥a', 'error'); }
        }

        function showConfirmDeleteModal(id) {
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').onclick = () => deletePatient(id);
        }

        // S·ª± ki·ªán (ƒë·ªÅu qua requirePassword)
        document.getElementById('newPatientBtn').onclick = () => requirePassword(showAddPatientModal);
        document.getElementById('viewStatsBtn').onclick = () => requirePassword(showStatsView);
        document.getElementById('savePatientBtn').onclick = () => requirePassword(savePatient);
		
		
		document.getElementById('totalStatsBtn').onclick = () => requirePassword(() => {

    currentView = 'totalStats';

    // ·∫®n c√°c view kh√°c
    document.getElementById('statsContent').classList.add('hidden');
    document.getElementById('patientDetailContent').classList.add('hidden');

    // Hi·ªán th·ªëng k√™ t·ªïng
    document.getElementById('totalStatsContent').classList.remove('hidden');

    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ b√™n ph·∫£i
    document.getElementById('rightPanelTitle').innerHTML =
        '<i class="fas fa-chart-pie"></i> TH·ªêNG K√ä T·ªîNG';

    // ƒê·ªï danh s√°ch nƒÉm
    const yearSelect = document.getElementById('totalYearSelect');
    const years = getAvailableYears();

    yearSelect.innerHTML =
        `<option value="all">T·∫•t c·∫£ nƒÉm</option>` +
        years.map(y => `<option value="${y}">${y}</option>`).join('');

    renderTotalStats();
});

		
		
		
        document.getElementById('searchInput').oninput = () => requirePassword(() => { renderPatientList(); renderStatsTable(); });
// ===== B∆Ø·ªöC 3: ·∫®n/hi·ªán kho·∫£ng ng√†y theo filterStatus =====
const filterStatus = document.getElementById('filterStatus');
const dateRangeBox = document.getElementById('dateRangeBox');

filterStatus.onchange = () => requirePassword(() => {

    if (filterStatus.value === 'range') {
        dateRangeBox.style.display = 'flex';   // HI·ªÜN
    } else {
        dateRangeBox.style.display = 'none';   // ·∫®N
        document.getElementById('searchFrom').value = '';
        document.getElementById('searchTo').value = '';
    }

    renderPatientList();
    renderStatsTable();
});
// ===== B·ªî SUNG: ƒë·ªïi ng√†y l√† l·ªçc ngay =====
document.getElementById('searchFrom').onchange =
document.getElementById('searchTo').onchange = () =>
    requirePassword(() => {
        renderPatientList();
        renderStatsTable();
    });


        document.getElementById('closeModalBtn').onclick = document.getElementById('cancelBtn').onclick = () => document.getElementById('patientModal').classList.add('hidden');
        document.getElementById('closeConfirmModalBtn').onclick = document.getElementById('cancelDeleteBtn').onclick = () => document.getElementById('confirmModal').classList.add('hidden');

        document.getElementById('fullName').oninput = function() {
            if (this.value.toLowerCase().includes('th·ªã')) document.getElementById('gender').value = 'N·ªØ';
        };

        // Ph√≠m t·∫Øt
       document.onkeydown = e => {
        if (e.ctrlKey && e.key === 'n') { 
            e.preventDefault(); 
            requirePassword(showAddPatientModal); 
        }
        if (e.key === 'Escape') requirePassword(showStatsView);
        if (e.key === 'F5') location.reload();
    if (e.ctrlKey && e.key === 's') {
            e.preventDefault(); // NgƒÉn h√†nh vi l∆∞u trang m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát

            requirePassword(() => {
                if (currentView === 'stats' && !currentPatientId) {
                    // ƒêang ·ªü modal Th√™m b·ªánh nh√¢n m·ªõi (modal ƒëang m·ªü)
                    if (!document.getElementById('patientModal').classList.contains('hidden')) {
                        savePatient(); // G·ªçi h√†m l∆∞u b·ªánh nh√¢n m·ªõi
                    } else {
                        showToast('Kh√¥ng c√≥ h√†nh ƒë·ªông l∆∞u n√†o ƒëang m·ªü', 'info');
                    }
                } else if (currentPatientId) {
                    // ƒêang xem chi ti·∫øt b·ªánh nh√¢n ‚Üí C·∫≠p nh·∫≠t
                    updatePatient(currentPatientId);
                } else {
                    showToast('Kh√¥ng c√≥ h√†nh ƒë·ªông l∆∞u n√†o', 'info');
                }
            });
        }
        if (e.key === 'F1') { 
            e.preventDefault(); 
            if (currentPatientId) requirePassword(() => showConfirmDeleteModal(currentPatientId)); 
        }
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            const sel = document.getElementById('filterStatus');
            sel.value = sel.value === 'all' ? 'active' : 'all';
            requirePassword(() => sel.dispatchEvent(new Event('change')));
        }

        // ‚Üê TH√äM M·ªöI: Ph√≠m F2 ƒë·ªÉ ƒëƒÉng xu·∫•t
        if (e.key === 'F2') {
            e.preventDefault();
            if (isAuthenticated) {
             
                    logout();
               
            } else {
                showToast('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p', 'info');
            }
        }
    };

        // Kh·ªüi ƒë·ªông ngay - hi·ªÉn th·ªã giao di·ªán lu√¥n
async function initApp() {
    checkStoredAuth();               
    showStatsLoading(true);
    showNotificationLoading(true);
    
    patients = await loadFromDropbox();
    renderPatientList();
    renderStatsTable();       // s·∫Ω t·ª± ·∫©n loading
    updateNotifications();    // s·∫Ω t·ª± ·∫©n loading
    showStatsView();
}

        document.addEventListener('DOMContentLoaded', initApp);
		
	


function getVNWeekday(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const days = ["Ch·ªß Nh·∫≠t","Th·ª© 2","Th·ª© 3","Th·ª© 4","Th·ª© 5","Th·ª© 6","Th·ª© 7"];
    return days[d.getDay()];
}

function bindWeekdayAutoUpdate(inputId, spanId, lunarId){
    const input = document.getElementById(inputId);
    const span = document.getElementById(spanId);
    const lunar = document.getElementById(lunarId);
    if(!input) return;

    function update(){
        if(span) span.textContent = getVNWeekday(input.value);
        if(lunar) lunar.textContent = getLunarText(input.value);
    }

    input.addEventListener("input", update);
    update();
}
function formatHourHM(timeStr){
    if(!timeStr) return "";
    const [h, m] = timeStr.split(":");
    return `${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
}
function calcHospitalDays(admit, discharge){
    if (!admit) return "";

    const a = new Date(admit);
    a.setHours(0,0,0,0);

    // n·∫øu ch∆∞a c√≥ ng√†y ra vi·ªán ‚Üí l·∫•y h√¥m nay
    const r = discharge ? new Date(discharge) : new Date();
    r.setHours(0,0,0,0);

    const diff = Math.floor((r - a) / 86400000);

    return diff >= 0 ? diff + " ng√†y" : "";
}

/* ====== AM LICH VIET NAM - HO NGOC DUC (CHUAN) ====== */
const CAN = ["Gi√°p","·∫§t","B√≠nh","ƒêinh","M·∫≠u","K·ª∑","Canh","T√¢n","Nh√¢m","Qu√Ω"];
const CHI = ["T√Ω","S·ª≠u","D·∫ßn","M√£o","Th√¨n","T·ªµ","Ng·ªç","M√πi","Th√¢n","D·∫≠u","Tu·∫•t","H·ª£i"];

function INT(d) {
    return Math.floor(d);
}

function jdFromDate(dd, mm, yy) {
    var a = INT((14 - mm) / 12);
    var y = yy + 4800 - a;
    var m = mm + 12 * a - 3;
    var jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - INT(y / 100) + INT(y / 400) - 32045;
    if (jd < 2299161) {
        jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - 32083;
    }
    return jd;
}

function NewMoon(k) {
    var T = k / 1236.85;
    var T2 = T * T;
    var T3 = T2 * T;
    var dr = Math.PI / 180;
    var Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
    Jd1 += 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
    var M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
    var Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
    var F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
    var C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
    C1 -= 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
    C1 -= 0.0004 * Math.sin(dr * 3 * Mpr);
    C1 += 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
    C1 -= 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
    C1 -= 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
    C1 += 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
    var deltat;
    if (T < -11) {
        deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
    } else {
        deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
    }
    var JdNew = Jd1 + C1 - deltat;
    return JdNew;
}

function SunLongitude(jdn) {
    var T = (jdn - 2451545.0) / 36525;
    var T2 = T * T;
    var dr = Math.PI / 180;
    var M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
    var L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
    var DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
    DL += (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
    var L = L0 + DL;
    L = L * dr;
    L = L - Math.PI * 2 * (INT(L / (Math.PI * 2)));
    return L;
}

function getSunLongitude(dayNumber, timeZone) {
    return INT(SunLongitude(dayNumber - 0.5 - timeZone / 24) / Math.PI * 6);
}

function getNewMoonDay(k, timeZone) {
    return INT(NewMoon(k) + 0.5 + timeZone / 24);
}

function getLunarMonth11(yy, timeZone) {
    var off = jdFromDate(31, 12, yy) - 2415021;
    var k = INT(off / 29.530588853);
    var nm = getNewMoonDay(k, timeZone);
    var sunLong = getSunLongitude(nm, timeZone);
    if (sunLong >= 9) {
        nm = getNewMoonDay(k - 1, timeZone);
    }
    return nm;
}

function getLeapMonthOffset(a11, timeZone) {
    var k = INT((a11 - 2415021.076998695) / 29.530588853 + 0.5);
    var last = 0;
    var i = 1;
    var arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    } while (arc != last && i < 14);
    return i - 1;
}

function getLunarDate(dd, mm, yy) {
    const tz = 7; // Timezone cho Vi·ªát Nam (UTC+7)
    var dayNumber = jdFromDate(dd, mm, yy);
    var k = INT((dayNumber - 2415021.076998695) / 29.530588853);
    var monthStart = getNewMoonDay(k + 1, tz);
    if (monthStart > dayNumber) {
        monthStart = getNewMoonDay(k, tz);
    }
    var a11 = getLunarMonth11(yy, tz);
    var b11 = a11;
    var lunarYear;
    if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, tz);
    } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, tz);
    }
    var lunarDay = dayNumber - monthStart + 1;
    var diff = INT((monthStart - a11) / 29);
    var lunarLeap = 0;
    var lunarMonth = diff + 11;
    if (b11 - a11 > 365) {
        var leapMonthDiff = getLeapMonthOffset(a11, tz);
        if (diff >= leapMonthDiff) {
            lunarMonth = diff + 10;
            if (diff == leapMonthDiff) {
                lunarLeap = 1;
            }
        }
    }
    if (lunarMonth > 12) {
        lunarMonth -= 12;
    }
    if (lunarMonth >= 11 && diff < 4) {
        lunarYear -= 1;
    }
    return {
        day: lunarDay,
        month: lunarMonth,
        year: lunarYear,
        canChi: `${CAN[(lunarYear + 6) % 10]} ${CHI[(lunarYear + 8) % 12]}`
    };
}

function getLunarText(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    const l = getLunarDate(d.getDate(), d.getMonth() + 1, d.getFullYear());

    // Th√™m s·ªë 0 v√†o ng√†y v√† th√°ng n·∫øu < 10
    const dayStr = l.day.toString().padStart(2, '0');
    const monthStr = l.month.toString().padStart(2, '0');

    return `${dayStr}/${monthStr}/${l.year} (${l.canChi})`;
}


function showStatsLoading(show = true) {
    if (show) {
        document.getElementById('statsTableContainer').classList.add('hidden');
        document.getElementById('statsLoading').classList.remove('hidden');
    } else {
        document.getElementById('statsTableContainer').classList.remove('hidden');
        document.getElementById('statsLoading').classList.add('hidden');
    }
}

function showNotificationLoading(show = true) {
    const container = document.getElementById('notificationContainer');
    const content = document.getElementById('notificationContent');
    const loading = document.getElementById('notificationLoading');

    if (show) {
        container.classList.remove('hidden');
        content.style.display = 'none';  // ·∫®n content
        loading.style.display = 'flex';  // Hi·ªán loading v·ªõi flex
    } else {
        loading.style.display = 'none';  // ·∫®n loading
        content.style.display = '';      // Hi·ªán content (tr·ªü v·ªÅ m·∫∑c ƒë·ªãnh, th∆∞·ªùng l√† block ho·∫∑c flex t√πy CSS)
    }
}


const LAB_KEYS = ["T·ªïng ph√¢n t√≠ch","Sinh ho√°","N∆∞·ªõc ti·ªÉu","Vi sinh"];

const IMAGING_KEYS = [
  "Xquang c·ªï",
  "Xquang l∆∞ng",
  "Xquang g·ªëi",
  "Xquang vai",
  "Xquang kh·ªõp h√°ng",
  "Si√™u √¢m ·ªï b·ª•ng",
  "Si√™u √¢m kh·ªõp g·ªëi",
  "Si√™u √¢m kh·ªõp vai"
];

const PROCEDURE_MAP = {
  dienCham: "ƒêi·ªán ch√¢m",
  chieuDen: "Chi·∫øu ƒë√®n h·ªìng ngo·∫°i",
  xoaBop: "Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay",
  kyThuatXoaBop: "K·ªπ thu·∫≠t xoa b√≥p v√πng",
  thuyCham: "Thu·ª∑ ch√¢m",
  giacHoi: "Gi√°c h∆°i"
};

function calcMedicalStats(patients){
  const stat = { lab:{}, imaging:{}, procedure:{} };

  LAB_KEYS.forEach(k=>stat.lab[k]=0);
  IMAGING_KEYS.forEach(k=>stat.imaging[k]=0);
  Object.values(PROCEDURE_MAP).forEach(k=>stat.procedure[k]=0);

  patients.forEach(p=>{
    // X√âT NGHI·ªÜM
    if(p.lab){
      LAB_KEYS.forEach(k=>{
        if(p.lab.includes(k)) stat.lab[k]++;
      });
    }

    // H√åNH ·∫¢NH
    if(p.imaging){
      IMAGING_KEYS.forEach(k=>{
        if(p.imaging.includes(k)) stat.imaging[k]++;
      });
    }

    // TH·ª¶ THU·∫¨T
    if(p.procedure){
      for(const key in p.procedure){
        const name = PROCEDURE_MAP[key];
        if(name) stat.procedure[name]+=Number(p.procedure[key]||0);
      }
    }
  });

  return stat;
}




function getAvailableYears() {
    const years = new Set();
    patients.forEach(p => {
        if (p.admissionDate) {
            years.add(new Date(p.admissionDate).getFullYear());
        }
    });
    return Array.from(years).sort((a,b)=>b-a);
}
function renderTotalStats() {
    const year = document.getElementById("totalYearSelect").value;

    const today = new Date();
    today.setHours(0,0,0,0);

    const list = patients.filter(p => {
        if (year === "all") return true;
        return new Date(p.admissionDate).getFullYear() == year;
    });

    let total = list.length;
    let noiTru = 0;
    let banNgay = 0;
    let noiTru20 = 0;
    let banNgay14 = 0;

    list.forEach(p => {
        const start = new Date(p.admissionDate);
        start.setHours(0,0,0,0);

        const days = Math.floor((today - start) / 86400000);

        if (p.patientType === "N·ªôi tr√∫") {
            noiTru++;
            if (days > 20) noiTru20++;
        }

        if (p.patientType === "Ban ng√†y") {
            banNgay++;
            if (days > 14) banNgay14++;
        }
    });

    document.getElementById("totalStatsBody").innerHTML = `
       <div class="patient-item">T·ªïng s·ªë b·ªánh nh√¢n ƒëi·ªÅu tr·ªã<b>${total}</b></div>
       <div class="patient-item">B·ªánh nh√¢n n·ªôi tr√∫<b>${noiTru}</b></div>
       <div class="patient-item">B·ªánh nh√¢n ban ng√†y<b>${banNgay}</b></div>
       <div class="patient-item">N·ªôi tr√∫ n·∫±m > 20 ng√†y<b>${noiTru20}</b></div>
       <div class="patient-item">Ban ng√†y > 14 ng√†y<b>${banNgay14}</b></div>
    `;

    /* ===== TH·ªêNG K√ä C·∫¨N L√ÇM S√ÄNG ‚Äì TH·ª¶ THU·∫¨T ===== */
    const m = calcMedicalStats(patients);
    let extraHTML = "";

    // X√âT NGHI·ªÜM
    const labTotal = Object.values(m.lab).reduce((a,b)=>a+b,0);
    extraHTML += `<div class="patient-item">`;
    extraHTML += `X√©t nghi·ªám: ${labTotal}<br>`;
    for(const k in m.lab){
        extraHTML += `+ ${k}: ${m.lab[k]}<br>`;
    }
    extraHTML += `</div>`;

    // H√åNH ·∫¢NH
    const imgTotal = Object.values(m.imaging).reduce((a,b)=>a+b,0);
    extraHTML += `<div class="patient-item">`;
    extraHTML += `H√¨nh ·∫£nh: ${imgTotal}<br>`;
    for(const k in m.imaging){
        extraHTML += `+ ${k}: ${m.imaging[k]}<br>`;
    }
    extraHTML += `</div>`;

    // TH·ª¶ THU·∫¨T
    const proTotal = Object.values(m.procedure).reduce((a,b)=>a+b,0);
    extraHTML += `<div class="patient-item">`;
    extraHTML += `Th·ªß thu·∫≠t: ${proTotal}<br>`;
    for(const k in m.procedure){
        extraHTML += `+ ${k}: ${m.procedure[k]}<br>`;
    }
    extraHTML += `</div>`;

    document.getElementById("totalStatsContent").innerHTML += extraHTML;
}

let currentTarget = null;

function openLabModal(detail=false){
  currentTarget = detail ? "detailLabInput" : "labInput";

  const value = detail && currentPatientId
      ? patients.find(p=>p.id===currentPatientId).lab
      : tempLab;

  document.querySelectorAll("#labModal input[type=checkbox]").forEach(cb=>{
      cb.checked = value?.includes(cb.value);
  });

  document.getElementById("labModal").classList.remove("hidden");
}

function closeLabModal(){
  document.getElementById("labModal").classList.add("hidden");
}
function saveLab(){
  tempLab = [...document.querySelectorAll("#labModal input:checked")]
      .map(i => i.value)
      .join(", ");

  document.getElementById(currentTarget).value = tempLab;
  closeLabModal();
}



function openImagingModal(detail = false) {
 initImagingModal();
    currentTarget = detail ? "detailImagingInput" : "imagingInput";

    const value = detail && currentPatientId
        ? patients.find(p => p.id === currentPatientId)?.imaging
        : tempImaging;

    // reset tr∆∞·ªõc
    document.querySelectorAll("#imagingModal input[type=checkbox]").forEach(cb => cb.checked = false);
    document.querySelectorAll("#imagingModal select").forEach(s => s.value = "");

    if (!value) {
        document.getElementById("imagingModal").classList.remove("hidden");
        return;
    }

    // ==== XQUANG ====
    chkXrayNeck.checked = value.includes("Xquang c·ªï");
    chkXrayBack.checked = value.includes("Xquang l∆∞ng");

    if (value.includes("Xquang g·ªëi")) {
        chkXrayKnee.checked = true;
        xrayKnee.value = value.includes("(Tr√°i)") ? "Tr√°i"
                         : value.includes("(Ph·∫£i)") ? "Ph·∫£i" : "";
    }

    if (value.includes("Xquang vai")) {
        chkXrayShoulder.checked = true;
        xrayShoulder.value = value.includes("(Tr√°i)") ? "Tr√°i"
                             : value.includes("(Ph·∫£i)") ? "Ph·∫£i" : "";
    }
 chkXrayHip.checked = value.includes("Xquang kh·ªõp h√°ng");
    // ==== SI√äU √ÇM ====
    chkUSAbdomen.checked = value.includes("Si√™u √¢m ·ªï b·ª•ng");

    if (value.includes("Si√™u √¢m kh·ªõp g·ªëi")) {
        chkUSKnee.checked = true;
        usKnee.value = value.includes("(Tr√°i)") ? "Tr√°i"
                     : value.includes("(Ph·∫£i)") ? "Ph·∫£i" : "";
    }

    if (value.includes("Si√™u √¢m kh·ªõp vai")) {
        chkUSShoulder.checked = true;
        usShoulder.value = value.includes("(Tr√°i)") ? "Tr√°i"
                           : value.includes("(Ph·∫£i)") ? "Ph·∫£i" : "";
    }

    document.getElementById("imagingModal").classList.remove("hidden");
}


function closeImagingModal(){
  document.getElementById("imagingModal").classList.add("hidden");
}
function saveImaging(){
    let arr = [];

    if (chkXrayNeck.checked) arr.push("Xquang c·ªï");
    if (chkXrayBack.checked) arr.push("Xquang l∆∞ng");

    if (chkXrayKnee.checked && xrayKnee.value)
        arr.push(`Xquang g·ªëi (${xrayKnee.value})`);

    if (chkXrayShoulder.checked && xrayShoulder.value)
        arr.push(`Xquang vai (${xrayShoulder.value})`);
 
 if (chkXrayHip.checked) arr.push("Xquang kh·ªõp h√°ng");

    if (chkUSAbdomen.checked) arr.push("Si√™u √¢m ·ªï b·ª•ng");

    if (chkUSKnee.checked && usKnee.value)
        arr.push(`Si√™u √¢m kh·ªõp g·ªëi (${usKnee.value})`);

    if (chkUSShoulder.checked && usShoulder.value)
        arr.push(`Si√™u √¢m kh·ªõp vai (${usShoulder.value})`);

    tempImaging = arr.join(", ");
    document.getElementById(currentTarget).value = tempImaging;
    closeImagingModal();
}




function openProcedureModal(detail = false){
  currentTarget = detail ? "detailProcedureInput" : "procedureInput";

  const oldData = detail && currentPatientId
    ? patients.find(p => p.id === currentPatientId)?.procedure || {}
    : tempProcedure || {};

  document.querySelectorAll('#procedureModal input[type=checkbox]').forEach(cb => {
    const key = cb.dataset.key;
    const qtyInput = document.querySelector(
      `#procedureModal input[data-qty="${key}"]`
    );

    // === set tr·∫°ng th√°i ban ƒë·∫ßu ===
    if (oldData[key]) {
      cb.checked = true;
      qtyInput.value = oldData[key];   // gi·ªØ s·ªë c≈©
    } else {
      cb.checked = false;
      qtyInput.value = 0;
    }

    // === üî• QUAN TR·ªåNG: t√≠ch ‚Üí t·ª± set = 1 ===
    cb.onchange = () => {
      if (cb.checked) {
        if (!qtyInput.value || qtyInput.value == 0) {
          qtyInput.value = 1;          // ‚úÖ auto 1
        }
      } else {
        qtyInput.value = 0;            // ‚ùå b·ªè t√≠ch ‚Üí 0
      }
    };
  });

  document.getElementById("procedureModal").classList.remove("hidden");
}


function closeProcedureModal(){
  document.getElementById("procedureModal").classList.add("hidden");
}
function saveProcedure(){
  const data = {};
  const lines = [];

  document.querySelectorAll('#procedureModal input[type=checkbox]').forEach(cb=>{
    const key = cb.dataset.key;
    const qtyInput = document.querySelector(`#procedureModal input[data-qty="${key}"]`);
    const qty = parseInt(qtyInput.value) || 0;

    if(cb.checked && qty > 0){
      data[key] = qty;
      lines.push(`${cb.parentElement.innerText.trim()} (${qty})`);
    }
  });

  tempProcedure = data;
  document.getElementById(currentTarget).value = lines.join(', ');
  closeProcedureModal();
}



function bindImagingCheckbox(chkId, selectId) {
    const chk = document.getElementById(chkId);
    const sel = document.getElementById(selectId);
    if (!chk || !sel) return;

    chk.onchange = () => {
        sel.disabled = !chk.checked;
        if (!chk.checked) sel.value = "";
    };
}

// g·ªçi khi m·ªü modal
function initImagingModal() {
    bindImagingCheckbox("chkXrayKnee", "xrayKnee");
    bindImagingCheckbox("chkXrayShoulder", "xrayShoulder");
    bindImagingCheckbox("chkUSKnee", "usKnee");
    bindImagingCheckbox("chkUSShoulder", "usShoulder");
}
function formatProcedureText(p){
  if(!p) return '';
  const map = {
    dienCham: 'ƒêi·ªán ch√¢m',
    chieuDen: 'Chi·∫øu ƒë√®n',
    xoaBop: 'Xoa b√≥p',
    kyThuatXoaBop: 'KT xoa b√≥p',
    thuyCham: 'Thu·ª∑ ch√¢m',
    giacHoi: 'Gi√°c h∆°i'
  };

  return Object.keys(p)
    .filter(k => p[k] > 0)
    .map(k => `${map[k]} (${p[k]})`)
    .join(', ');
}
document.addEventListener("change", function (e) {
    if (e.target && e.target.id === "totalYearSelect") {
        renderTotalStats();
    }
});
function updateStatsTableHeader() {
    const isNarrow = window.innerWidth < 410;
    const ths = document.querySelectorAll('.stats-table thead th');

    if (!ths.length) return;
	ths[0].innerText = isNarrow ? 'T' : 'STT';
	ths[2].innerText = isNarrow ? 'P' : 'Ph√≤ng';
    ths[3].innerText = isNarrow ? 'Gi·ªù' : 'Gi·ªù kh√°m';
    ths[4].innerText = isNarrow ? 'N' : 'S·ªë ng√†y';
	ths[5].innerText = isNarrow ? 'L' : 'Lo·∫°i';
    ths[6].innerText = isNarrow ? 'TT' : 'Tr·∫°ng th√°i';
}

window.addEventListener('resize', updateStatsTableHeader);
updateStatsTableHeader();


</script>
<div id="labModal" class="overlay hidden">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      X√©t nghi·ªám
      <button class="close-btn" onclick="closeLabModal()">√ó</button>
    </div>
    <div class="modal-content">
      <label class="patient-item patient-item-left"><input type="checkbox" value="T·ªïng ph√¢n t√≠ch"> T·ªïng ph√¢n t√≠ch</label><br>
      <label class="patient-item patient-item-left"><input type="checkbox" value="Sinh ho√°"> Sinh ho√°</label><br>
      <label class="patient-item patient-item-left"><input type="checkbox" value="N∆∞·ªõc ti·ªÉu"> N∆∞·ªõc ti·ªÉu</label><br>
      <label class="patient-item patient-item-left"><input type="checkbox" value="Vi sinh"> Vi sinh</label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="saveLab()">OK</button>
    </div>
  </div>
</div>
<div id="imagingModal" class="overlay hidden">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      H√¨nh ·∫£nh
      <button class="close-btn" onclick="closeImagingModal()">√ó</button>
    </div>
    <div class="modal-content">

<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkXrayNeck" value="Xquang c·ªï">
  Xquang c·ªï
</label><br>

<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkXrayBack" value="Xquang l∆∞ng">
  Xquang l∆∞ng
</label class="patient-item"><br>

<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkXrayKnee">
  Xquang g·ªëi

<select id="xrayKnee" class="bschau" disabled>
  <option>Tr√°i</option>
  <option>Ph·∫£i</option>
  <option>2 b√™n</option>
</select></label>
<br>
<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkXrayShoulder">
  Xquang vai

<select id="xrayShoulder" class="bschau" disabled>
  <option>Th·∫≥ng</option>
  <option>Nghi√™ng</option>
  <option>C·∫£ 2</option>
</select></label><br>
<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkXrayHip" value="Xquang kh·ªõp h√°ng">
  Xquang kh·ªõp h√°ng
</label class="patient-item"><br>

     <label class="patient-item patient-item-left">
  <input type="checkbox" id="chkUSAbdomen" value="Si√™u √¢m ·ªï b·ª•ng">
  Si√™u √¢m ·ªï b·ª•ng
</label><br>

<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkUSKnee">
  Si√™u √¢m kh·ªõp g·ªëi

<select id="usKnee" class="bschau" disabled>
  <option>Tr√°i</option>
  <option>Ph·∫£i</option>
  <option>2 b√™n</option>
</select></label><br>

<label class="patient-item patient-item-left">
  <input type="checkbox" id="chkUSShoulder">
  Si√™u √¢m kh·ªõp vai

<select id="usShoulder" class="bschau" disabled>
  <option>Tr√°i</option>
  <option>Ph·∫£i</option>
  <option>2 b√™n</option>
</select></label>


    </div>
    <div class="modal-footer">
      <button class="btn btn-success" onclick="saveImaging()">OK</button>
    </div>
  </div>
</div>
<div id="procedureModal" class="overlay hidden">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      Th·ªß thu·∫≠t
      <button class="close-btn" onclick="closeProcedureModal()">√ó</button>
    </div>
   <div class="modal-content">

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="dienCham"> ƒêi·ªán ch√¢m
    </label>
    <input type="number" min="1" value="0" data-qty="dienCham" style="width:70px">
  </div>

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="chieuDen"> Chi·∫øu ƒë√®n h·ªìng ngo·∫°i
    </label>
    <input type="number" min="1" value="0" data-qty="chieuDen" style="width:70px">
  </div>

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="xoaBop"> Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay
    </label>
    <input type="number" min="1" value="0" data-qty="xoaBop" style="width:70px">
  </div>

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="kyThuatXoaBop"> K·ªπ thu·∫≠t xoa b√≥p v√πng
    </label>
    <input type="number" min="1" value="0" data-qty="kyThuatXoaBop" style="width:70px">
  </div>

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="thuyCham"> Thu·ª∑ ch√¢m
    </label>
    <input type="number" min="1" value="0" data-qty="thuyCham" style="width:70px">
  </div>

  <div class="patient-item patient-item-left">
    <label style="flex:1">
      <input type="checkbox" data-key="giacHoi"> Gi√°c h∆°i
    </label>
    <input type="number" min="1" value="0" data-qty="giacHoi" style="width:70px">
  </div>

</div>

    <div class="modal-footer">
      <button class="btn btn-success" onclick="saveProcedure()">OK</button>
    </div>
  </div>
</div>

</body></html>
