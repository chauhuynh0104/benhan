<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doctor Ch√¢u</title><script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script>
const REFRESH_KEY = "yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr";
const APP_KEY = "qzy5kclrf827aey";
const APP_SECRET = "6jlsunzjqr3s3nh";

let dropboxToken = null;

// ‚öôÔ∏è L·∫•y access_token t·ª´ refresh_token
async function getAccessToken() {
  const resp = await fetch("https://api.dropboxapi.com/oauth2/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "refresh_token",
      refresh_token: REFRESH_KEY,
      client_id: APP_KEY,
      client_secret: APP_SECRET
    })
  });
  const data = await resp.json();
  dropboxToken = data.access_token;

}
</script>
<script>
// üì• T·∫£i /patients_v1.json t·ª´ Dropbox
async function loadPatientsFromDropbox() {
  if (!dropboxToken) await getAccessToken();
  const resp = await fetch("https://content.dropboxapi.com/2/files/download", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + dropboxToken,
      "Dropbox-API-Arg": JSON.stringify({ path: "/patients_v1.json" })
    }
  });

  if (!resp.ok) {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file tr√™n Dropbox, t·∫°o danh s√°ch tr·ªëng.");
    return [];
  }

  const text = await resp.text();
  try {
    const data = JSON.parse(text);
   
    return data;
  } catch (e) {
    console.error("‚ùå JSON b·ªã l·ªói:", e);
    return [];
  }
}
</script>
<script>
// üíæ Ghi ƒë√® /patients_v1.json l√™n Dropbox
async function savePatientsToDropbox(patients) {
  if (!dropboxToken) await getAccessToken();
  const resp = await fetch("https://content.dropboxapi.com/2/files/upload", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + dropboxToken,
      "Dropbox-API-Arg": JSON.stringify({
        path: "/patients_v1.json",
        mode: "overwrite",
        autorename: false
      }),
      "Content-Type": "application/octet-stream"
    },
    body: JSON.stringify(patients, null, 2)
  });
  if (resp.ok) {

  } else {
    console.error("‚ùå L∆∞u th·∫•t b·∫°i:", await resp.text());
  }
}
</script>
  <style>
    :root{
      --bg:#fff7f0; --accent:#ff7a18; --muted:#6b6b6b; --card:#ffffff; --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#fffaf5 0%, #fff1e6 100%);color:#222}
    .app{display:flex;gap:20px;height:100vh;padding:18px}
   .sidebar{
  width:220px;
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:var(--shadow);
  overflow:auto;
  resize: horizontal;        /* ‚úÖ Cho ph√©p k√©o ngang */
  min-width:150px;           /* Gi·ªõi h·∫°n nh·ªè nh·∫•t */
  max-width:400px;           /* Gi·ªõi h·∫°n l·ªõn nh·∫•t */
}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h2{margin:0;color:var(--accent)}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,122,24,0.15)}
    .patient-list{display:flex;flex-direction:column;gap:8px}
    .patient-item{padding:10px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .patient-item:hover{background:linear-gradient(90deg,rgba(255,122,24,0.06),transparent)}
    .patient-meta{font-size:13px;color:var(--muted)}
.app{
  display:flex;
  gap:20px;
  height:100vh;
  padding:18px;
  align-items: stretch;  /* ‚úÖ ƒë·ªÉ hai kh·ªëi c√πng cao */
}

  .main{
  flex:1;
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:var(--shadow);
  overflow:auto;
  resize: both;              /* ‚úÖ Cho ph√©p k√©o c·∫£ ngang + d·ªçc */
  min-width:400px;
  min-height:300px;
  max-height:100vh;
}    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input,select,textarea{width:90%;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff}
    .section{background:var(--glass);padding:12px;border-radius:10px}
    .med-list,.thang-list,.procedure-list{display:flex;flex-direction:column;gap:8px}
.med-row{
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #f0e6de;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  align-items: center;
}

/* Thu·ªëc s·∫Øc: 5 c·ªôt gi√£n ƒë·ªÅu h∆°n */
.thang-row,.proc-row {
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #f0e6de;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 40px;
  align-items: center;
}


   .med-row .full{grid-column:1/-1}
    .med-row input, .thang-row input, .proc-row input{padding:6px}
    .small{font-size:12px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* modal form */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal.open{display:flex}
    .card{background:#fff;padding:18px;border-radius:12px;width:720px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}

    .right-top{display:flex;gap:12px;align-items:center}
    .meta-block{background:#fff;padding:10px;border-radius:8px;border:1px solid #f2e7df}

    footer{margin-top:16px;font-size:12px;color:var(--muted)}

    @media (max-width:900px){.app{flex-direction:column}.sidebar{width:100%;height:260px}.main{height:auto}}
	.med-row,thang-row{
  gap: 20px; /* tƒÉng kho·∫£ng c√°ch chung gi·ªØa c√°c √¥ */
}#divider {
  width: 6px;
  cursor: col-resize;               /* ‚úÖ hi·ªán con tr·ªè k√©o ngang */
  background: linear-gradient(to right, #f8d5b2, #ffd7a0);
  border-radius: 3px;
  transition: background 0.2s;
}
#divider:hover {
  background: linear-gradient(to right, #ffb56b, #ff9a3c);
}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
  
    <div class="header">
    
      <button class="btn" id="addPatientBtn">Th√™m b·ªánh nh√¢n</button>
    </div>
    <input id="search" placeholder="T√¨m ki·∫øm t√™n / tu·ªïi / gi·ªõi" style="width:90%;padding:8px;border-radius:10px;border:1px solid #fde9d8;margin-bottom:10px" />
    <div class="patient-list" id="patientList"></div>
  </aside>
<div id="divider"></div>
  <main class="main">
    <div class="right-top"style="display:none">
      <div class="meta-block" id="patientHeader">Ch·ªçn m·ªôt b·ªánh nh√¢n ƒë·ªÉ xem chi ti·∫øt</div>
      <div style="flex:1"></div>
     
    </div>

    <div id="patientDetailArea" style="margin-top:12px;display:none">
<div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:320px;display:none" class="section">
          <h3>Th√¥ng tin c∆° b·∫£n</h3>
          <div class="grid">
            <div>
              <label>T√™n b·ªánh nh√¢n</label>
              <input id="p_name" />
            </div>
            <div>
              <label>Tu·ªïi</label>
              <input id="p_age" type="number"/>
            </div>
            <div>
              <label>Gi·ªõi</label>
              <select id="p_gender"style="width:60px;"><option>Nam</option><option>N·ªØ</option><option>Kh√°c</option></select>
            </div>
            <div>
              <label>ƒê·ªãa ch·ªâ</label>
              <input id="p_address" />
            </div>
            <div style="grid-column:1/-1">
              <label>Ch·∫©n ƒëo√°n</label>
              <textarea id="p_dx" rows="2"></textarea>
            </div>
          </div>
        </div>

      <div style="flex:1;min-width:320px" class="section">
          <h3>Thu·ªëc t√¢n d∆∞·ª£c v√† ch·∫ø ph·∫©m <button class="btn secondary" id="addMedicineBtn" style="float:right">Th√™m Thu·ªëc</button></h3>
          <div class="med-list" id="medList"></div>
        </div>

</div>
        <div style="flex:1;min-width:320px" class="section">
          <h3>Thu·ªëc s·∫Øc <button class="btn secondary" id="addThangBtn" style="float:right">Th√™m Thu·ªëc</button></h3>
          <div class="thang-list" id="thangList"></div>
        </div>
<div style="flex:1;min-width:320px" class="section">
  <h3>Th·ªß thu·∫≠t <button class="btn secondary" id="addProcBtn" style="float:right">Th√™m Th·ªß thu·∫≠t</button></h3>
  <div class="procedure-list" id="procList"></div>
</div>

        <div style="flex:1;min-width:320px" class="section">
          <h3>Ng√†y v√†o / ra vi·ªán</h3>
          <div class="grid">
            <div>
              <label>Ng√†y v√†o vi·ªán</label>
              <input id="admit_date" type="date" />
            </div>
            <div>
              <label>Ng√†y ra vi·ªán</label>
              <input id="discharge_date" type="date" />
            </div>
            <div style="grid-column:1/-1">
              <label>T·ªïng s·ªë ng√†y n·∫±m vi·ªán</label>
              <input id="total_days" readonly />
            </div>
          </div>
        </div>
   <div class="actions">
        <button class="btn" id="saveWordBtn">L∆∞u Word</button>
		<button class="btn secondary" id="deletePatientBtn" style="background:#ffeded;color:#c0392b;border:1px solid #ffcfcf;">üóë X√≥a</button>
        <button class="btn secondary" id="cancelBtn">H·ªßy</button>
        <button class="btn" id="savePatientBtn">L∆∞u b·ªánh nh√¢n</button>
      

      </div>
      </div>

   
  
    </div>
  </main>
</div>

<!-- modal th√™m b·ªánh nh√¢n -->
<div class="modal" id="modal">
  <div class="card">
    <h3>Th√™m b·ªánh nh√¢n m·ªõi</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
      <div>
        <label>T√™n</label>
        <input id="new_name" />
      </div>
      <div>
        <label>Tu·ªïi</label>
        <input id="new_age" type="number" />
      </div>
      <div>
        <label>Gi·ªõi</label>
        <select id="new_gender"><option>Nam</option><option>N·ªØ</option><option>Kh√°c</option></select>
      </div>
	  <div>
        <label>Ch·∫©n ƒëo√°n</label>
       <textarea id="p_dx"></textarea>
      </div>
	  
      <div>
        <label>ƒê·ªãa ch·ªâ</label>
        <input id="new_address" />
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="modalClose">ƒê√≥ng</button>
      <button class="btn" id="modalSave">Th√™m</button>
    </div>
  </div>
</div>

<script>
// Helper
const medsSuggest = ['Dubemin','piracetam','kamelox','mimosa','amlodipin','reumokam'];
function todayStr(){const d=new Date();return d.toISOString().slice(0,10)}
function addDays(dateStr, n){const d=new Date(dateStr);d.setDate(d.getDate()+n);return d.toISOString().slice(0,10)}
function daysBetween(a,b){if(!a||!b) return '';
  const A=new Date(a), B=new Date(b);
  const diff=Math.round((B-A)/(1000*60*60*24));
  return diff>=0? diff : '';
}

// App state
let patients = [];
window.addEventListener('load', async () => {
  patients = await loadPatientsFromDropbox();
  renderPatientList();
 capNhatThongBao();
});

let currentPatientId = null;

// DOM
const patientListEl = document.getElementById('patientList');
const addPatientBtn = document.getElementById('addPatientBtn');
const modal = document.getElementById('modal');
const modalSave = document.getElementById('modalSave');
const modalClose = document.getElementById('modalClose');
const savePatientBtn = document.getElementById('savePatientBtn');
const deletePatientBtn = document.getElementById('deletePatientBtn');
const cancelBtn = document.getElementById('cancelBtn');
cancelBtn.addEventListener('click', () => {
  // ·∫®n khu chi ti·∫øt b·ªánh nh√¢n, hi·ªán l·∫°i m√†n h√¨nh gi·ªõi thi·ªáu
  document.getElementById('patientDetailArea').style.display = 'none';
  const intro = document.getElementById('introScreen');
  if (intro) intro.style.display = 'block';
  currentPatientId = null;
});
const patientDetailArea = document.getElementById('patientDetailArea');
const patientHeader = document.getElementById('patientHeader');
const saveWordBtn = document.getElementById('saveWordBtn');

const inputs = {
  name: document.getElementById('p_name'),
  age: document.getElementById('p_age'),
  gender: document.getElementById('p_gender'),
  address: document.getElementById('p_address'),
  dx: document.getElementById('p_dx'),
  admit: document.getElementById('admit_date'),
  discharge: document.getElementById('discharge_date'),
  total: document.getElementById('total_days')
};

const medList = document.getElementById('medList');
const addMedBtn = document.getElementById('addMedicineBtn');
const thangList = document.getElementById('thangList');
const addThangBtn = document.getElementById('addThangBtn');
const procList = document.getElementById('procList');
const addProcBtn = document.getElementById('addProcBtn');
addProcBtn.addEventListener('click', () => procList.appendChild(createProcRow({})));
// init
function renderPatientList(filter=''){
  patientListEl.innerHTML='';
  const arr = patients.filter(p=> (p.name||'').toLowerCase().includes(filter.toLowerCase()) || (''+p.age).includes(filter) || (p.gender||'').toLowerCase().includes(filter.toLowerCase()));
  arr.forEach(p=>{
    const el = document.createElement('div'); el.className='patient-item';
    el.innerHTML = `<div>
      <div style="font-weight:600">${p.name||'(ch∆∞a c√≥ t√™n)'}</div>
      <div class="patient-meta">Tu·ªïi: ${p.age||''} ‚Ä¢ ${p.gender||''}</div>
    </div>
    <div style="text-align:right;min-width:80px"><button class="btn secondary" data-id="${p.id}" style="padding:6px;border-radius:8px">M·ªü</button></div>`;
   // Khi click to√†n b·ªô h√†ng b·ªánh nh√¢n -> m·ªü lu√¥n
el.addEventListener('click',()=>openPatient(p.id));

// NgƒÉn vi·ªác click n√∫t ‚ÄúM·ªü‚Äù b·ªã l·∫∑p 2 l·∫ßn
el.querySelector('button').addEventListener('click',e=>{
  e.stopPropagation(); // ch·∫∑n n·ªïi b·ªçt
  openPatient(p.id);
});

patientListEl.appendChild(el);
  })
}

function openPatient(id){
  const p = patients.find(x=>x.id===id); 
  if(!p) return;
  
  const intro = document.getElementById('introScreen');
if(intro) intro.style.display = 'none'; // ‚úÖ x√≥a n·ªôi dung gi·ªõi thi·ªáu c≈© tr∆∞·ªõc khi hi·ªÉn th·ªã b·ªánh nh√¢n
  currentPatientId=id;
  patientDetailArea.style.display='block';
  patientHeader.innerHTML = `<strong>${p.name||''}</strong><div class="patient-meta">Tu·ªïi ${p.age||''} ‚Ä¢ ${p.gender||''}<br/> ${p.address||''}</div>`;
  inputs.name.value = p.name||''; inputs.age.value=p.age||''; inputs.gender.value=p.gender||'Nam'; inputs.address.value=p.address||''; inputs.dx.value=p.dx||'';
  // meds
  medList.innerHTML=''; (p.meds||[]).forEach(m=>medList.appendChild(createMedRow(m)));
  // thangs
  thangList.innerHTML=''; (p.thangs||[]).forEach(t=>thangList.appendChild(createThangRow(t)));
  // procs
  procList.innerHTML=''; (p.procs||[]).forEach(pr=>procList.appendChild(createProcRow(pr)));
  // dates
  inputs.admit.value = p.admit||''; inputs.discharge.value = p.discharge||''; inputs.total.value = p.total||'';
}

function createMedRow(model){
  const row = document.createElement('div'); row.className='med-row';
  row.innerHTML = `
    <input list="mednames" class="med-name" placeholder="T√™n thu·ªëc..." />
    <input class="med-qty" placeholder="S·ªë l∆∞·ª£ng" />
    <input class="med-times" placeholder="S·ªë l·∫ßn/ng√†y" />
    <input class="med-timeinfo" placeholder="Th·ªùi gian d√πng" />
    <select class="med-route">
      <option>U·ªëng</option>
      <option>Ti√™m</option>
      <option>Thu·ª∑ ch√¢m</option>
    </select>
    <div style="display:flex;gap:6px">
      <input type="date" class="med-start" />
      <input type="date" class="med-end" style="display:none" />
      <button class="btn secondary small stopBtn">Ng∆∞ng thu·ªëc</button>
      <button class="btn small removeMed">X√≥a</button>
    </div>`;

  // attach datalist
  if(!document.getElementById('mednames')){
    const dl = document.createElement('datalist'); dl.id='mednames';
    medsSuggest.forEach(m=>{
      const o=document.createElement('option'); o.value=m; dl.appendChild(o);
    });
    document.body.appendChild(dl);
  }

  const nameIn = row.querySelector('.med-name');
  const qtyIn = row.querySelector('.med-qty');
  const timesIn = row.querySelector('.med-times');
  const timeinfo = row.querySelector('.med-timeinfo');
  const route = row.querySelector('.med-route');
  const start = row.querySelector('.med-start');
  const end = row.querySelector('.med-end');
  const stopBtn = row.querySelector('.stopBtn');

  start.value = model?.start || todayStr();
  end.value = model?.end || '';
  nameIn.value = model?.name || '';
  qtyIn.value = model?.qty || '';
  timesIn.value = model?.times || '';
  timeinfo.value = model?.timeinfo || '';
  route.value = model?.route || 'U·ªëng';
  if(end.value) end.style.display='block';

  // preset logic on select name
  nameIn.addEventListener('input',()=>{
    const v = nameIn.value.trim().toLowerCase();
    if(v==='dubemin'){
      qtyIn.value=1;
      timesIn.value=1;
      timeinfo.value='Bu·ªïi s√°ng';
      route.value='Thu·ª∑ ch√¢m';
      themLuaChonThuyCham(row); // ‚úÖ t·ª± hi·ªán ch·ªçn Li√™n ti·∫øp/C√°ch ng√†y
    } else if(v==='mimosa'){
      qtyIn.value=2; timesIn.value=1; timeinfo.value='20:00'; route.value='U·ªëng';
    } else if(v==='piracetam'){
      qtyIn.value=3; timesIn.value=3; timeinfo.value='08:00-14:00-20:00'; route.value='U·ªëng';
    } else if(v==='kamelox'){
      qtyIn.value=1; timesIn.value=1; timeinfo.value='18:00 sau ƒÉn'; route.value='U·ªëng';
    } else if(v==='reumokam'){
      qtyIn.value=1; timesIn.value=1; timeinfo.value='Bu·ªïi t·ªëi 18:00 sau ƒÉn'; route.value='Ti√™m';
    }
  });

  stopBtn.addEventListener('click',()=>{ end.value = todayStr(); end.style.display='block'; });
  row.querySelector('.removeMed').addEventListener('click',()=>{ row.remove(); });
// ‚úÖ N·∫øu thu·ªëc ƒë√£ c√≥ Thu·ª∑ ch√¢m, kh√¥i ph·ª•c l·ª±a ch·ªçn mode
if(model?.route === 'Thu·ª∑ ch√¢m') {
  themLuaChonThuyCham(row); // th√™m dropdown Li√™n ti·∫øp / C√°ch ng√†y
  const select = row.querySelector('.thuycham-mode');
  if(select && model.mode) select.value = model.mode; // ch·ªçn l·∫°i gi√° tr·ªã ƒë√£ l∆∞u
}
  return row;
}

function createThangRow(model){
  const row = document.createElement('div'); row.className='thang-row';
  row.innerHTML = `
    <input class="thang-name" placeholder="T√™n thang..." />
    <input type="date" class="thang-start" />
    <input type="date" class="thang-end" />
    <input class="thang-count" readonly placeholder="S·ªë thang" />
    <div style="display:flex;gap:6px">
      <button class="btn small calcThang"style="display:none">T√≠nh</button>
      <button class="btn small removeThang">X√≥a</button>
    </div>`;
  const name = row.querySelector('.thang-name'); const s = row.querySelector('.thang-start'); const e = row.querySelector('.thang-end'); const cnt = row.querySelector('.thang-count');
  s.value = model?.start||''; e.value = model?.end||''; name.value = model?.name||'';
  function calc(){ if(s.value && e.value){ const a=new Date(s.value), b=new Date(e.value); const diff = Math.round((b-a)/(1000*60*60*24))+1; cnt.value = diff>0? diff:0 } }
  row.querySelector('.calcThang').addEventListener('click',calc);
  [s,e].forEach(el=>el.addEventListener('change',calc));
  row.querySelector('.removeThang').addEventListener('click',()=>row.remove());
  return row;
}

function createProcRow(model){
  const row = document.createElement('div'); row.className='proc-row';
  row.innerHTML = `
    <select class="proc-type"><option>ƒêi·ªán ch√¢m</option><option>H·ªìng ngo·∫°i</option><option>Xoa b√≥p</option><option>Thu·ª∑ ch√¢m</option><option>Gi√°c h∆°i</option></select>
    <input type="date" class="proc-start" />
    <input type="date" class="proc-end" />
    <input class="proc-days" readonly placeholder="S·ªë ng√†y" />
    <div style="display:flex;gap:6px">
      <button class="btn small calcProc"style="display:none">T√≠nh</button>
      <button class="btn small removeProc">X√≥a</button>
    </div>`;
  const type = row.querySelector('.proc-type'); const s = row.querySelector('.proc-start'); const e = row.querySelector('.proc-end'); const days = row.querySelector('.proc-days');
  s.value = model?.start||''; e.value = model?.end||''; type.value = model?.type||'ƒêi·ªán ch√¢m';
  function calc(){ if(type.value==='Thu·ª∑ ch√¢m'){ s.value = todayStr(); e.value = todayStr(); days.value=1; return;} if(type.value==='Gi√°c h∆°i'){ s.value = todayStr(); e.value = addDays(s.value,4); days.value = 5; return;} if(s.value && e.value){ const d = daysBetween(s.value,e.value); days.value = d!==''? d+1 : '';} }
  row.querySelector('.calcProc').addEventListener('click',calc);
  type.addEventListener('change',calc);
  [s,e].forEach(el=>el.addEventListener('change',()=>{ if(s.value && e.value){ const d = daysBetween(s.value,e.value); days.value = d!==''? d+1 : '';} }));
  row.querySelector('.removeProc').addEventListener('click',()=>row.remove());
  return row;
}

// events
addPatientBtn.addEventListener('click',()=>{ modal.classList.add('open'); });
modalClose.addEventListener('click',()=>modal.classList.remove('open'));
modalSave.addEventListener('click', async ()=>{
  const name=document.getElementById('new_name').value.trim();
  const age=document.getElementById('new_age').value; const gender=document.getElementById('new_gender').value; const address=document.getElementById('new_address').value;
  const id = 'p_'+Date.now();
  const p = {id,name,age,gender,address,dx:'',meds:[],thangs:[],procs:[],admit:'',discharge:'',total:''};
  patients.push(p); await savePatientsToDropbox(patients); modal.classList.remove('open'); renderPatientList(); openPatient(id);
});

document.getElementById('search').addEventListener('input',e=>renderPatientList(e.target.value));

addMedBtn.addEventListener('click',()=> medList.appendChild(createMedRow({})));
addThangBtn.addEventListener('click',()=> thangList.appendChild(createThangRow({})));

// add default one med/thang/proc when new open
function ensureSections(){ if(medList.children.length===0) medList.appendChild(createMedRow({})); if(thangList.children.length===0) thangList.appendChild(createThangRow({})); if(procList.children.length===0) procList.appendChild(createProcRow({})); }

savePatientBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  p.name = inputs.name.value.trim(); p.age = inputs.age.value; p.gender = inputs.gender.value; p.address = inputs.address.value; p.dx = inputs.dx.value;
  // meds
  p.meds = Array.from(medList.children).map(r=>({
    name: r.querySelector('.med-name').value,
    qty: r.querySelector('.med-qty').value,
    times: r.querySelector('.med-times').value,
    timeinfo: r.querySelector('.med-timeinfo').value,
    route: r.querySelector('.med-route').value,
    start: r.querySelector('.med-start').value,
  end: r.querySelector('.med-end').value,
  mode: r.querySelector('.thuycham-mode') ? r.querySelector('.thuycham-mode').value : 'Li√™n ti·∫øp'  // ‚úÖ th√™m d√≤ng n√†y
})).filter(m=>m.name||m.qty||m.times);
  // thangs
  p.thangs = Array.from(thangList.children).map(r=>({
    name: r.querySelector('.thang-name').value,
    start: r.querySelector('.thang-start').value,
    end: r.querySelector('.thang-end').value,
    count: r.querySelector('.thang-count').value
  })).filter(t=>t.name||t.start||t.end);
  // procs
  p.procs = Array.from(procList.children).map(r=>({
    type: r.querySelector('.proc-type').value,
    start: r.querySelector('.proc-start').value,
    end: r.querySelector('.proc-end').value,
    days: r.querySelector('.proc-days').value
  })).filter(x=>x.type);
  // dates
  p.admit = inputs.admit.value; p.discharge = inputs.discharge.value;
  if(p.admit && p.discharge){ const tot = parseInt(daysBetween(p.admit,p.discharge)); p.total = isNaN(tot)?'': tot+1; } else p.total=''; inputs.total.value = p.total;
// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
})();
  savePatientBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  p.name = inputs.name.value.trim(); 
  p.age = inputs.age.value; 
  p.gender = inputs.gender.value; 
  p.address = inputs.address.value; 
  p.dx = inputs.dx.value;

  // meds
  p.meds = Array.from(medList.children).map(r=>({
    name: r.querySelector('.med-name').value,
    qty: r.querySelector('.med-qty').value,
    times: r.querySelector('.med-times').value,
    timeinfo: r.querySelector('.med-timeinfo').value,
    route: r.querySelector('.med-route').value,
    start: r.querySelector('.med-start').value,
    end: r.querySelector('.med-end').value,
    mode: r.querySelector('.thuycham-mode') ? r.querySelector('.thuycham-mode').value : 'Li√™n ti·∫øp' // ‚úÖ th√™m d√≤ng n√†y n·∫øu ch∆∞a c√≥
  })).filter(m=>m.name||m.qty||m.times);

  // thangs
  p.thangs = Array.from(thangList.children).map(r=>({
    name: r.querySelector('.thang-name').value,
    start: r.querySelector('.thang-start').value,
    end: r.querySelector('.thang-end').value,
    count: r.querySelector('.thang-count').value
  })).filter(t=>t.name||t.start||t.end);

  // procs
  p.procs = Array.from(procList.children).map(r=>({
    type: r.querySelector('.proc-type').value,
    start: r.querySelector('.proc-start').value,
    end: r.querySelector('.proc-end').value,
    days: r.querySelector('.proc-days').value
  })).filter(x=>x.type);

  // dates
  p.admit = inputs.admit.value; 
  p.discharge = inputs.discharge.value;
  if(p.admit && p.discharge){
    const tot = parseInt(daysBetween(p.admit,p.discharge));
    p.total = isNaN(tot)?'': tot+1;
  } else p.total='';
  inputs.total.value = p.total;

// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
})();
  capNhatThongBao(); // ‚úÖ th√™m d√≤ng n√†y ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng b√°o ngay
});
});

saveWordBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  // build html content for doc
  let html = `<html><head><meta charset="utf-8"><title>H·ªì s∆° ${p.name}</title></head><body>`;
  html += `<h2>H·ªì s∆° b·ªánh nh√¢n: ${p.name}</h2>`;
  html += `<p>Tu·ªïi: ${p.age} ‚Ä¢ Gi·ªõi: ${p.gender}</p>`;
  html += `<p>ƒê·ªãa ch·ªâ: ${p.address||''}</p>`;
  html += `<h3>Ch·∫©n ƒëo√°n</h3><p>${p.dx||''}</p>`;
  html += `<h3>Thu·ªëc t√¢n d∆∞·ª£c</h3><ul>`;
  (p.meds||[]).forEach(m=>{ html += `<li>${m.name} ‚Äî SL:${m.qty} ‚Ä¢ l·∫ßn/ng√†y:${m.times} ‚Ä¢ ${m.timeinfo} ‚Ä¢ ƒë∆∞·ªùng: ${m.route} ‚Ä¢ ${m.start||''} ‚Üí ${m.end||''}</li>`}); html += `</ul>`;
  html += `<h3>Thu·ªëc s·∫Øc</h3><ul>`; (p.thangs||[]).forEach(t=>{ html += `<li>${t.name} ‚Äî ${t.start||''} ‚Üí ${t.end||''} ‚Ä¢ ${t.count||''} thang</li>`}); html += `</ul>`;
  html += `<h3>Th·ªß thu·∫≠t</h3><ul>`; (p.procs||[]).forEach(pr=>{ html += `<li>${pr.type} ‚Äî ${pr.start||''} ‚Üí ${pr.end||''} ‚Ä¢ ${pr.days||''} ng√†y</li>`}); html += `</ul>`;
  html += `<p>Ng√†y v√†o: ${p.admit||''} ‚Ä¢ Ng√†y ra: ${p.discharge||''} ‚Ä¢ T·ªïng: ${p.total||''}</p>`;
  html += `</body></html>`;

  // save into localStorage per patient
  localStorage.setItem('patient_doc_'+p.id, html);
  // create downloadable .doc
  const blob = new Blob([html], {type:'application/msword'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `${p.name||'patient'}_${p.id}.doc`; a.click(); URL.revokeObjectURL(url);

});



// ====== N√öT X√ìA B·ªÜNH NH√ÇN (C√ì POPUP) ======
window.addEventListener('load', () => {
  const deleteModal = document.getElementById('deleteConfirm');
  const deleteText = document.getElementById('deleteText');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');
  const deletePatientBtn = document.getElementById('deletePatientBtn');

  if (!deleteModal || !deletePatientBtn) return; // n·∫øu popup ch∆∞a c√≥ th√¨ tho√°t

  deletePatientBtn.addEventListener('click', () => {
    if (!currentPatientId) return alert('Ch∆∞a ch·ªçn b·ªánh nh√¢n!');
    const p = patients.find(x => x.id === currentPatientId);
    if (!p) return;

    deleteText.innerHTML = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <b>${p.name}</b> kh·ªèi danh s√°ch kh√¥ng?`;
    deleteModal.style.display = 'flex';
  });

  // H·ªßy x√≥a
  cancelDelete.addEventListener('click', () => {
    deleteModal.style.display = 'none';
  });

  // X√°c nh·∫≠n x√≥a
confirmDelete.addEventListener('click', async () => {
    const p = patients.find(x => x.id === currentPatientId);
    if (!p) return;

    patients = patients.filter(x => x.id !== currentPatientId);
await savePatientsToDropbox(patients);


    deleteModal.style.display = 'none';
    document.getElementById('patientDetailArea').style.display = 'none';
    const intro = document.getElementById('introScreen');
    if (intro) intro.style.display = 'block';
    currentPatientId = null;
    renderPatientList();
  });
});



// when opening patient ensure sections exist
document.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('.patient-item')){
    const id = e.target.getAttribute('data-id'); if(id) openPatient(id);
  }
});

// update total days when admit/discharge change
inputs.admit.addEventListener('change',()=>{ if(inputs.admit.value && inputs.discharge.value){ const tot=daysBetween(inputs.admit.value, inputs.discharge.value); inputs.total.value = tot!==''? tot+1 : ''; } });
inputs.discharge.addEventListener('change',()=>{ if(inputs.admit.value && inputs.discharge.value){ const tot=daysBetween(inputs.admit.value, inputs.discharge.value); inputs.total.value = tot!==''? tot+1 : ''; } });

// initial render
renderPatientList();
// ‚úÖ Hi·ªÉn th·ªã m√†n h√¨nh gi·ªõi thi·ªáu thay v√¨ m·ªü b·ªánh nh√¢n ƒë·∫ßu ti√™n
// ‚úÖ T·∫°o div ri√™ng cho trang gi·ªõi thi·ªáu, th√™m v√†o ph√≠a tr√™n
const introDiv = document.createElement("div");
introDiv.id = "introScreen";
introDiv.innerHTML = `
  <div style="text-align:center;padding:60px 20px;color:#444;line-height:1.6">
    <h1 style="color:#ff7a18;font-size:28px;margin-bottom:16px">üè• Ph·∫ßn m·ªÅm Qu·∫£n l√Ω B·ªánh nh√¢n</h1>
    <p style="font-size:16px">
      Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <strong>Doctor Ch√¢u Clinic System</strong> ‚Äî n·ªÅn t·∫£ng qu·∫£n l√Ω h·ªì s∆° b·ªánh nh√¢n hi·ªán ƒë·∫°i, t·ª± ƒë·ªông v√† th√¢n thi·ªán.<br>
      H·ªá th·ªëng h·ªó tr·ª£:
    </p>
    <ul style="text-align:left;display:inline-block;margin:16px auto;font-size:15px;line-height:1.8">
      <li>üîπ Qu·∫£n l√Ω th√¥ng tin b·ªánh nh√¢n, thu·ªëc, th·ªß thu·∫≠t, ng√†y v√†o ‚Äì ra vi·ªán</li>
      <li>üîπ Theo d√µi v√† c·∫£nh b√°o t·ª± ƒë·ªông Th·ªßy ch√¢m, Ti√™m</li>
      <li>üîπ L∆∞u, xu·∫•t h·ªì s∆° sang Word nhanh ch√≥ng</li>
    </ul>
    <p style="margin-top:20px;font-size:14px;color:#666">
      üëâ H√£y ch·ªçn b·ªánh nh√¢n ·ªü khung b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu xem v√† ch·ªânh s·ª≠a h·ªì s∆°.
    </p>
  </div>    <footer>Design By Dr. Ch√¢u</footer>
`;
document.querySelector('.main').appendChild(introDiv);



// open first patient by default
//if(patients[0]) openPatient(patients[0].id); ensureSections();

/* ====== TH√îNG B√ÅO THU·ª∂ CH√ÇM + TI√äM ====== */
const thongBaoChung = document.createElement('div');
thongBaoChung.id = 'thongBaoChung';
thongBaoChung.style.cssText = `
  background:#fff3e0;
  border:1px solid #ffc085;
  border-radius:10px;
  padding:10px 14px;
  margin-top:15px;
  font-size:14px;
  color:#b34700;
  line-height:1.5;
`;
document.querySelector('.main').prepend(thongBaoChung);

function laCuoiTuan(d){
  const day = d.getDay();
  return day===5 || day===6 || day===0; // T6-T7-CN
}

function tinhNgayCanLen(route, startDate, mode){
  const today = new Date();
  const ngayBatDau = new Date(startDate);
  const danhSach = [];
  const diff = Math.floor((today - ngayBatDau)/(1000*60*60*24));
  if(diff < 0) return [];
  if(route === 'Thu·ª∑ ch√¢m'){
    if(mode==='Li√™n ti·∫øp'){
      for(let i=1;i<=diff+1;i++){
        const d = new Date(ngayBatDau); d.setDate(d.getDate()+i);
        if(d.getDay()!==6 && d.getDay()!==0) danhSach.push(d);
      }
    } else if(mode==='C√°ch ng√†y'){
      for(let i=2;i<=diff+2;i+=2){
        const d = new Date(ngayBatDau); d.setDate(d.getDate()+i);
        if(d.getDay()!==6 && d.getDay()!==0) danhSach.push(d);
      }
    }
  }
  if(route === 'Ti√™m'){
    for(let i=1;i<=diff+1;i++){
      const d = new Date(ngayBatDau); d.setDate(d.getDate()+i);
      danhSach.push(d);
    }
  }
  // N·∫øu h√¥m nay l√† T6-T7-CN th√¨ th√™m th·ª© 2 tu·∫ßn sau
  if(laCuoiTuan(today)){
    const monday = new Date(today);
    monday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7));
    danhSach.push(monday);
  }
  return danhSach;
}

function dinhDangNgayVN(d){return d.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'})}

function capNhatThongBao(){
  let html = '';
  const today = new Date();
  patients.forEach(p=>{
const tiems = (p.meds||[]).filter(m=>m.route==='Ti√™m');
const demThuocTiem = {};

// ƒê·∫øm s·ªë l·∫ßn ti√™m theo t√™n thu·ªëc
tiems.forEach(m=>{
  const ten = m.name?.trim().toLowerCase() || '(ch∆∞a ƒë·∫∑t t√™n)';
  demThuocTiem[ten] = (demThuocTiem[ten] || 0) + 1;
});

// N·∫øu t√™n thu·ªëc ti√™m c√≥ h∆°n 3 l·∫ßn -> c·∫£nh b√°o
Object.keys(demThuocTiem).forEach(ten=>{
  if(demThuocTiem[ten] > 3){
    html += `<div><strong>${p.name}</strong>: Thu·ªëc <b>${ten}</b> ti√™m qu√° 3 l·∫ßn (${demThuocTiem[ten]} l·∫ßn).</div>`;
  }
});

// Th·ªßy ch√¢m v·∫´n gi·ªØ logic c≈©
(p.meds||[]).forEach(m=>{
  if(m.route==='Thu·ª∑ ch√¢m' && m.start){
    const selectMode = m.mode || 'Li√™n ti·∫øp';
    const danhSach = tinhNgayCanLen(m.route, m.start, selectMode);
    if(danhSach.length>0){
      const ngayText = danhSach.map(d=>dinhDangNgayVN(d)).join(', ');
      html += `<div><strong>${p.name}</strong>: Ch∆∞a l√™n thu·ªëc <b>${m.route}</b> cho c√°c ng√†y: ${ngayText}</div>`;
    }
  }
});
  });
  thongBaoChung.innerHTML = html || '‚úÖ Kh√¥ng c√≥ th√¥ng b√°o c·∫ßn nh·∫Øc.';
}

/* ====== Th√™m 2 selection khi ch·ªçn Thu·ª∑ ch√¢m ====== */
function themLuaChonThuyCham(row){
  if(row.querySelector('.thuycham-mode')) return;
  const select = document.createElement('select');
  select.className='thuycham-mode';
  select.innerHTML = `<option>Li√™n ti·∫øp</option><option>C√°ch ng√†y</option>`;
  row.querySelector('.med-route').after(select);
  select.addEventListener('change',()=> {
    const p = patients.find(x=>x.id===currentPatientId);
    if(!p) return;
    const tenThuoc = row.querySelector('.med-name').value;
    const med = (p.meds||[]).find(m=>m.name===tenThuoc);
    if(med) { med.mode = select.value; 
	
// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
})();
	
	
	capNhatThongBao(); }
  });
}

document.addEventListener('change',e=>{
  if(e.target && e.target.classList.contains('med-route')){
    const row = e.target.closest('.med-row');
    if(e.target.value==='Thu·ª∑ ch√¢m'){ themLuaChonThuyCham(row); }
  }
});
// ‚úÖ T·ª± ƒë·ªông hi·ªán ch·ªçn Li√™n ti·∫øp / C√°ch ng√†y n·∫øu load form c√≥ s·∫µn Thu·ª∑ ch√¢m
document.querySelectorAll('.med-route').forEach(sel=>{
  if(sel.value==='Thu·ª∑ ch√¢m'){
    const row = sel.closest('.med-row');
    themLuaChonThuyCham(row);
  }
});


</script>







<script>
// ‚úÖ Cho ph√©p k√©o gi√£n sidebar b·∫±ng divider
const sidebar = document.querySelector('.sidebar');
const divider = document.getElementById('divider');
const main = document.querySelector('.main');

let isDragging = false;

divider.addEventListener('mousedown', e => {
  isDragging = true;
  document.body.style.userSelect = 'none';
});

window.addEventListener('mouseup', e => {
  if(isDragging){
    isDragging = false;
    document.body.style.userSelect = 'auto';
    // ‚úÖ l∆∞u l·∫°i ƒë·ªô r·ªông sidebar ƒë·ªÉ nh·ªõ l·∫ßn sau
    localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
  }
});

window.addEventListener('mousemove', e => {
  if(!isDragging) return;
  const newWidth = e.clientX - sidebar.getBoundingClientRect().left;
  if(newWidth > 150 && newWidth < 500){
    sidebar.style.width = newWidth + 'px';
  }
});

// ‚úÖ kh√¥i ph·ª•c ƒë·ªô r·ªông sidebar khi t·∫£i l·∫°i trang
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('sidebarWidth');
  if(saved) sidebar.style.width = saved + 'px';
});
/* ====== PH√çM T·∫ÆT: Ctrl+S, Ctrl+Shift+S ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + S ‚Üí L∆∞u b·ªánh nh√¢n
  if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 's') {
    e.preventDefault(); // ch·∫∑n tr√¨nh duy·ªát l∆∞u trang
    const saveBtn = document.getElementById('savePatientBtn');
    if (saveBtn) saveBtn.click();
  }

  // Ctrl + Shift + S ‚Üí L∆∞u Word
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 's') {
    e.preventDefault();
    const saveWordBtn = document.getElementById('saveWordBtn');
    if (saveWordBtn) saveWordBtn.click();
  }
});/* ====== PH√çM T·∫ÆT: Ctrl+L ·∫©n/hi·ªán Th√¥ng tin c∆° b·∫£n ====== */
document.addEventListener('keydown', function(e) {
  // Ki·ªÉm tra Ctrl + L
  if (e.ctrlKey && e.key.toLowerCase() === 'l') {
    e.preventDefault();
    // T√¨m ph·∫ßn Th√¥ng tin c∆° b·∫£n
    const infoSection = document.querySelector('h3')?.textContent.includes('Th√¥ng tin c∆° b·∫£n')
      ? document.querySelector('h3').closest('.section')
      : document.querySelector('.section:nth-of-type(1)'); // fallback n·∫øu c√≥ thay ƒë·ªïi
    if (!infoSection) return;

    // Toggle display
    if (infoSection.style.display === 'none') {
      infoSection.style.display = ''; // hi·ªán l·∫°i
    } else {
      infoSection.style.display = 'none'; // ·∫©n ƒëi
    }
	
  }
});
/* ====== PH√çM T·∫ÆT: Ctrl+S, Ctrl+Shift+S ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + S ‚Üí L∆∞u b·ªánh nh√¢n
    if (e.key === 'Escape') {
   e.preventDefault();
    const cancelBtn = document.getElementById('cancelBtn');
    if (cancelBtn) cancelBtn.click();
  }
});

</script>


<style>
@keyframes fadeIn {
  from {opacity:0; transform:translateY(-10px);}
  to {opacity:1; transform:translateY(0);}
}
</style>
<!-- ===== POPUP X√ÅC NH·∫¨N X√ìA ===== -->
<div id="deleteConfirm" class="modal" style="display:none;">
  <div class="card" style="width:360px;backdrop-filter:blur(10px);background:rgba(255,255,255,0.95);text-align:center;animation:fadeIn 0.3s ease;">
    <h3 style="color:#c0392b;">üóë X√≥a b·ªánh nh√¢n</h3>
    <p id="deleteText" style="margin:12px 0 18px;color:#555;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªánh nh√¢n n√†y kh√¥ng?</p>
    <div style="display:flex;justify-content:center;gap:10px;">
      <button class="btn secondary" id="cancelDelete">H·ªßy</button>
      <button class="btn" id="confirmDelete" style="background:#e74c3c;">X√≥a</button>
    </div>
  </div>
</div>


<!-- ===== POPUP ƒêƒÇNG NH·∫¨P ===== -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="card" style="width:340px;backdrop-filter:blur(10px);background:rgba(255,255,255,0.95);text-align:center;animation:fadeIn 0.3s ease;">
    <h3 style="color:#ff7a18;">üîí ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
    <p style="margin:12px 0 8px;color:#555;">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem chi ti·∫øt b·ªánh nh√¢n</p>
    <input id="loginPassword" type="password" placeholder="M·∫≠t kh·∫©u" style="padding:8px;width:80%;border-radius:8px;border:1px solid #ffd9b0;">
    <div style="display:flex;justify-content:center;gap:10px;margin-top:16px;">
      <button class="btn secondary" id="cancelLogin">H·ªßy</button>
      <button class="btn" id="confirmLogin">ƒêƒÉng nh·∫≠p</button>
    </div>
    <p id="loginError" style="color:#c0392b;font-size:13px;margin-top:10px;display:none;">Sai m·∫≠t kh·∫©u!</p>
  </div>
</div>

<script>/* ===== ƒêƒÇNG NH·∫¨P XEM H·ªí S∆† ===== */
const loginModal = document.getElementById('loginModal');
const loginPassword = document.getElementById('loginPassword');
const loginError = document.getElementById('loginError');
const cancelLogin = document.getElementById('cancelLogin');
const confirmLogin = document.getElementById('confirmLogin');

let pendingOpenId = null; // l∆∞u b·ªánh nh√¢n ƒë·ªãnh m·ªü tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p
const CORRECT_PASSWORD = "1!"; // üîë thay m·∫≠t kh·∫©u t·∫°i ƒë√¢y

// --- B·ªçc l·∫°i h√†m openPatient ƒë·ªÉ y√™u c·∫ßu ƒëƒÉng nh·∫≠p ---
const originalOpenPatient = openPatient;
openPatient = function(id) {
  if (!localStorage.getItem('isLoggedIn')) {
    pendingOpenId = id;
    loginModal.style.display = 'flex';
    loginPassword.value = '';
    loginError.style.display = 'none';
    // üëá t·ª± ƒë·ªông focus v√†o √¥ nh·∫≠p m·∫≠t kh·∫©u
    setTimeout(() => loginPassword.focus(), 100);
    return;
  }
  originalOpenPatient(id);
};

// --- X·ª≠ l√Ω ƒëƒÉng nh·∫≠p ---
function doLogin() {
  if (loginPassword.value === CORRECT_PASSWORD) {
    localStorage.setItem('isLoggedIn', 'true');
    loginModal.style.display = 'none';
    loginError.style.display = 'none';
    showLogoutButton();
    if (pendingOpenId) {
      originalOpenPatient(pendingOpenId);
      pendingOpenId = null;
    }
  } else {
    loginError.style.display = 'block';
  }
}

confirmLogin.addEventListener('click', doLogin);
cancelLogin.addEventListener('click', () => {
  loginModal.style.display = 'none';
});

// ‚úÖ B·∫•m Enter trong √¥ m·∫≠t kh·∫©u c≈©ng ƒëƒÉng nh·∫≠p
loginPassword.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    doLogin();
  }
});

// --- H√†m t·∫°o n√∫t ƒëƒÉng xu·∫•t ---
function showLogoutButton() {
  if (document.getElementById('logoutBtn')) return; // ƒë√£ c√≥ th√¨ th√¥i
  const logoutBtn = document.createElement('button');
  logoutBtn.id = 'logoutBtn';
  logoutBtn.textContent = 'ƒêƒÉng xu·∫•t';
  logoutBtn.className = 'btn secondary';
  logoutBtn.style.float = 'right';
  logoutBtn.style.marginLeft = '10px';
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('isLoggedIn');

    document.getElementById('logoutBtn').remove();
    // ·∫®n chi ti·∫øt b·ªánh nh√¢n n·∫øu ƒëang xem
    document.getElementById('patientDetailArea').style.display = 'none';
    const intro = document.getElementById('introScreen');
    if (intro) intro.style.display = 'block';
  });
  document.querySelector('.header').appendChild(logoutBtn);
}

// --- N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥, t·ª± hi·ªán n√∫t ---
window.addEventListener('load', () => {
  if (localStorage.getItem('isLoggedIn')) {
    showLogoutButton();
  }
});


</script>
</body>
</html>
