<!-- 

///////////////////////////////////////////////
/////Code được viết bởi Chauhuynh0104/////////
////http://fb.com/chauhuynh0104//////////////
/////////////079.567.9350///////////////////
///Vui lòng tôn trọng bản quyền tác giả////
/////////Không xoá dòng này //////////////
/////////////////////////////////////////

!-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Bệnh Án</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff9800;
            --primary-light: #ffe0b2;
            --primary-dark: #f57c00;
            --bg-color: #ffffff;
            --border-color: #ffcc80;
            --text-color: #333;
            --light-text: #666;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f9f9f9; color: var(--text-color); line-height: 1.6; padding: 10px; }

        .container { max-width: 1400px; margin: 0 auto; display: flex; gap: 20px; }
        .header { background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header h1 { font-size: 28px; font-weight: 600; }
        .header i { margin-right: 10px; }

        .left-panel, .right-panel { flex: 1; background-color: var(--bg-color); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .right-panel { flex: 2; }

        .panel-header { background-color: var(--primary-light); padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h2 { color: var(--primary-dark); font-size: 20px; }

        .panel-content { padding: 20px; flex: 1; overflow-y: auto; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: #f0f0f0; color: var(--text-color); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .notification-bar { background-color: #fff3e0; border-left: 5px solid var(--warning-color); padding: 15px; margin-bottom: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .notification-bar i { color: var(--warning-color); margin-right: 10px; }

        .search-filter { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .search-filter input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; min-width: 200px; }
        .search-filter select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }

        .patient-room-group { margin-bottom: 20px; }
        .patient-room-group h3 { color: var(--primary-dark); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid var(--border-color); }
        .patient-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: center; }
        .patient-item:hover { background-color: #fff9f0; border-color: var(--border-color); }
        .patient-item.active { background-color: var(--primary-light); border-color: var(--primary-color); }

        .patient-type.inpatient { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2); }
        .patient-type.outpatient { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2); }

        .status-ok { display: inline-block; padding: 8px 16px; background: #34d399; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-error { display: inline-block; padding: 8px 16px; background: #fb7185; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .status-warning { display: inline-block; padding: 8px 16px; background: #fbbf24; color: white; border-radius: 20px; font-weight: 600; font-size: 14px; }

        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .stats-table th, .stats-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .stats-table th { background-color: #f9f9f9; color: var(--primary-dark); font-weight: 600; }

        .patient-form { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 600; color: var(--light-text); }
        .form-group input, .form-group select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.2); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background-color: white; border-radius: var(--radius); width: 90%; max-width: 900px; max-height: 90vh; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; }
        .modal-content { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--light-text); }

        .hidden { display: none; }

        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 300px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); animation: slideIn 0.4s ease; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        footer { text-align: center; padding: 20px; color: var(--light-text); font-size: 14px; margin-top: 30px; }

/* ================== RESPONSIVE MOBILE ================== */
@media (max-width: 768px) {

    body {
        padding: 6px;
        font-size: 14px;
    }

    /* Header */
    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        padding: 15px;
    }

    .header h1 {
        font-size: 20px;
    }

    .header p {
        font-size: 13px;
    }

    #newPatientBtn {
        width: 100%;
        justify-content: center;
    }

    /* Container: 2 cột -> 1 cột */
    .container {
        flex-direction: column;
        gap: 12px;
    }

    .left-panel,
    .right-panel {
        flex: unset;
        width: 100%;
    }

    /* Panel */
    .panel-header h2 {
        font-size: 16px;
    }

    .panel-content {
        padding: 12px;
    }

    /* Search */
    .search-filter {
        flex-direction: column;
    }

    .search-filter input,
    .search-filter select {
        width: 100%;
        font-size: 14px;
    }

    /* Patient item */
    .patient-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 12px;
    }

    .patient-type {
        font-size: 12px;
        padding: 6px 12px;
    }

    /* Table -> scroll ngang */
    .stats-table {
        font-size: 13px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }

    /* Form */
    .patient-form {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .form-group input,
    .form-group select {
        font-size: 14px;
        padding: 10px;
    }

    /* Modal */
    .modal {
        width: 95%;
        max-height: 90vh;
    }

    .modal-header {
        font-size: 16px;
        padding: 12px;
    }

    /* Button */
    .btn {
        padding: 10px 14px;
        font-size: 14px;
    }

    /* Toast */
    .toast {
        min-width: unset;
        width: calc(100vw - 40px);
        font-size: 13px;
    }

    footer {
        font-size: 12px;
    }
}

/* Mobile rất nhỏ (≤480px) */
@media (max-width: 480px) {

    .header h1 {
        font-size: 18px;
    }

    .panel-header h2 {
        font-size: 15px;
    }

    .btn {
        font-size: 13px;
    }

    .patient-item {
        padding: 10px;
    }
}
.date-wrapper{
    position: relative;
    display: flex;
    align-items: center;
}

/* chừa chỗ cho chữ + icon */
.date-wrapper input{
    width: 100%;
    padding-right: 110px;
}

/* chữ Thứ nằm TRƯỚC icon */
.date-wrapper span{
    position: absolute;
    right: 55px;
    font-weight: 600;
    color: #ff5722;
}

/* icon lịch nằm mép phải */
.date-wrapper input::-webkit-calendar-picker-indicator{
    position: absolute;
    right: 10px;
    cursor: pointer;
}

    .action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: flex-end; /* Đẩy toàn bộ nút sang bên phải */
}
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1><i class="fas fa-heartbeat"></i>Electronic Medical Record</h1>
            <p>Dr.Chau</p>
        </div>
        <button id="newPatientBtn" class="btn btn-primary">
            <i class="fas fa-plus-circle"></i> Thêm bệnh nhân mới
        </button>
    </div>

 <div class="notification-bar hidden" id="notificationContainer">
    <div id="notificationContent">
        <i class="fas fa-bell"></i><span id="notificationText">Không có thông báo nào</span>
    </div>
    <div id="notificationLoading" class="hidden" style="align-items:center; gap:10px; color:#ff9800;">
        <i class="fas fa-spinner fa-spin"></i><p>Đang tải thông báo...</p>
    </div>
</div>

    <div class="container">
        <div class="left-panel">
            <div class="panel-header"><h2><i class="fas fa-users"></i> DANH SÁCH BỆNH NHÂN</h2></div>
            <div class="panel-content">
                <div class="search-filter">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm bệnh nhân...">
                    <select id="filterStatus">   <option value="all">Tất cả</option><option value="discharged">Đã ra viện</option>
                        <option value="active"selected>Chưa ra viện</option>
                        
                     
                    </select>
                </div>
                <div id="patientListContainer"><div class="loading"><center><i class="fas fa-spinner fa-spin"></i><p>Đang tải dữ liệu...</p></center></div></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-header">
                <h2 id="rightPanelTitle"><i class="fas fa-chart-bar"></i> THỐNG KÊ GIỜ KHÁM</h2>
                <button id="viewStatsBtn" class="btn btn-secondary"><i class="fas fa-chart-bar"></i> Xem thống kê</button>
            </div>
            <div class="panel-content" id="rightPanelContent">
                <div id="statsContent">
    <div id="statsTableContainer">
        <table class="stats-table">
            <thead>
                <tr>
                    <th>STT</th><th>Tên</th><th>Phòng</th><th>Giờ khám</th><th>Số ngày</th><th>Loại</th><th>Trạng thái</th>
                </tr>
            </thead>
            <tbody id="statsTableBody"></tbody>
        </table>
    </div>
    <div id="statsLoading" style="text-align:center; padding:40px; color:#666;">
        <i class="fas fa-spinner fa-spin" style="font-size:24px;"></i>
        <p>Đang tải dữ liệu thống kê...</p>
    </div>
</div>
                <div id="patientDetailContent" class="hidden"></div>
            </div>
        </div>
    </div>

    <footer>© 2014-2026 By Dr.Châu</footer>
    <div id="toastContainer"></div>

    <!-- Password Modal - Ẩn lúc đầu -->
    <div id="passwordModal" class="overlay hidden">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header"><h3>Nhập mật khẩu để tiếp tục</h3></div>
            <div class="modal-content">
                <input type="password" id="passwordInput" placeholder="Mật khẩu" style="width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="passwordOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal thêm/sửa bệnh nhân -->
    <div id="patientModal" class="overlay hidden">
        <div class="modal">
            <div class="modal-header" id="modalTitle">Thêm bệnh nhân mới<button class="close-btn" id="closeModalBtn">×</button></div>
            <div class="modal-content">
                <form id="patientForm">
                    <div class="patient-form">
                        <div class="form-group"><label for="fullName">Họ tên *</label><input type="text" id="fullName" required></div>
                        <div class="form-group"><label for="age">Tuổi *</label><input type="number" id="age" min="1" max="120" required></div>
                        <div class="form-group"><label for="gender">Giới tính *</label><select id="gender" required><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div>
                        <div class="form-group"><label for="diagnosis">Chẩn đoán *</label><input type="text" id="diagnosis" required></div>
                       <div class="form-group">
					  <label for="admissionDate">Ngày vào viện *
					  <span id="admissionLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>

					  
					  </label>
                        

    <div class="date-wrapper">
        <input type="date" id="admissionDate" required>
        <span id="admissionWeekday"></span>
    </div>
</div>

                        <div class="form-group"><label for="admissionTime">Giờ vào viện *</label><input type="time" id="admissionTime" required></div>
                        <div class="form-group"><label for="examinationTime">Giờ khám bệnh *</label><input type="time" id="examinationTime" required></div>
                        <div class="form-group"><label for="room">Phòng *</label><select id="room" required><option value="9">Phòng 9</option><option value="11">Phòng 11</option></select></div>
                        <div class="form-group"><label for="patientType">Loại bệnh nhân *</label><select id="patientType" required><option value="Nội trú">Nội trú</option><option value="Ban ngày">Ban ngày</option></select></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Đóng</button>
                <button type="button" class="btn btn-success" id="savePatientBtn">Lưu thông tin</button>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div id="confirmModal" class="overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">Xác nhận xóa<button class="close-btn" id="closeConfirmModalBtn">×</button></div>
            <div class="modal-content"><p>Bạn có chắc chắn muốn xóa bệnh nhân này không? Hành động này không thể hoàn tác.</p></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>

    <script>
     const PASSWORD = "1!"; // ← Đổi mật khẩu ở đây
    const REFRESH_KEY = "yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr";
    const APP_KEY = "qzy5kclrf827aey";
    const APP_SECRET = "6jlsunzjqr3s3nh";

    let patients = [];
    let accessToken = "";
    let isAuthenticated = false;        // Sẽ được kiểm tra từ localStorage
    let pendingAction = null;
    let currentPatientId = null;
    let currentView = 'stats';

    // =================== THÊM MỚI: Quản lý đăng nhập bằng localStorage ===================
    const AUTH_STORAGE_KEY = "hospital_app_authenticated";

    // Kiểm tra xem đã đăng nhập chưa (khi load trang)
    function checkStoredAuth() {
        const stored = localStorage.getItem(AUTH_STORAGE_KEY);
        if (stored === "true") {
            isAuthenticated = true;
        }
    }

    // Lưu trạng thái đăng nhập
    function setAuthenticated(value) {
        isAuthenticated = value;
        localStorage.setItem(AUTH_STORAGE_KEY, value.toString());
    }

    // Đăng xuất: xóa trạng thái xác thực
    function logout() {
        setAuthenticated(false);
        showToast('Đã đăng xuất thành công!', 'info');
        // Có thể reload lại trang để làm sạch giao diện nếu muốn
        location.reload();
    }
    // ================================================================================

    function showToast(msg, type = 'info') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 4000);
    }

    // Chỉ hiện mật khẩu khi chưa xác thực
    function requirePassword(action) {
        if (isAuthenticated) {
            action();
            return;
        }
        pendingAction = action;
        document.getElementById('passwordModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('passwordInput').focus(), 100);
    }

    document.getElementById('passwordOk').onclick = () => {
        if (document.getElementById('passwordInput').value === PASSWORD) {
            setAuthenticated(true);  // ← Lưu vào localStorage
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            if (pendingAction) { pendingAction(); pendingAction = null; }
            showToast('Đăng nhập thành công!', 'success');
        } else {
            showToast('Mật khẩu sai!', 'error');
        }
    };


        document.getElementById('passwordInput').onkeyup = e => { if (e.key === 'Enter') document.getElementById('passwordOk').click(); };

        // Dropbox
        async function getAccessToken() {
            const res = await fetch('https://api.dropbox.com/oauth2/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `grant_type=refresh_token&refresh_token=${REFRESH_KEY}&client_id=${APP_KEY}&client_secret=${APP_SECRET}` });
            if (!res.ok) throw new Error('Token error');
            const data = await res.json();
            accessToken = data.access_token;
        }

        async function loadFromDropbox() {
            try {
                await getAccessToken();
                const res = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json' }) }
                });
                if (res.status === 409) return [];
                if (!res.ok) throw new Error('Download failed');
                return await res.json();
            } catch { return []; }
        }

        async function saveToDropbox(data) {
            await getAccessToken();
            await fetch('https://content.dropboxapi.com/2/files/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Dropbox-API-Arg': JSON.stringify({ path: '/patients.json', mode: 'overwrite' }), 'Content-Type': 'application/octet-stream' },
                body: JSON.stringify(data)
            });
        }

        function isDischarged(p) {
            if (!p.dischargeDate || !p.dischargeTime) return false;
            return new Date(`${p.dischargeDate}T${p.dischargeTime}`) < new Date();
        }

        function filterPatients(list) {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const f = document.getElementById('filterStatus').value;
            return list.filter(p => {
                const match = p.fullName.toLowerCase().includes(q);
                const discharged = isDischarged(p);
                if (f === 'active') return match && !discharged;
                if (f === 'discharged') return match && discharged;
                return match;
            });
        }

        function formatDate(d) { const date = new Date(d); return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear()}`; }

        function renderPatientList() {
            const filtered = filterPatients(patients);
            const rooms = {};
            filtered.forEach(p => { if (!rooms[p.room]) rooms[p.room] = []; rooms[p.room].push(p); });

            let html = '';
            Object.keys(rooms).sort().forEach(room => {
                html += `<div class="patient-room-group"><h3>Phòng ${room}</h3>`;
                rooms[room].forEach(p => {
                    const discharged = isDischarged(p);
                    html += `<div class="patient-item ${currentPatientId === p.id ? 'active' : ''}" onclick="requirePassword(() => showPatientDetail('${p.id}'))">
                        <span class="patient-name">${p.fullName}</span> ${p.age} tuổi  
                        <span class="patient-details">
                            <span class="patient-type ${p.patientType === 'Nội trú' ? 'inpatient' : 'outpatient'}">${p.patientType}</span>
                            ${discharged ? '<small style="color:#888;margin-left:8px">(Đã ra viện)</small>' : ''}
                        </span>
                    </div>`;
                });
                html += '</div>';
            });

            document.getElementById('patientListContainer').innerHTML = html || '<div class="empty-state"><i class="fas fa-users-slash"></i><p>Không có bệnh nhân nào</p></div>';
        }

        function renderStatsTable() {
		showStatsLoading(true);
            const now = new Date();
            const filtered = filterPatients(patients).filter(p => !isDischarged(p)).sort((a,b) => a.examinationTime.localeCompare(b.examinationTime));
            let html = '', stt = 1;
            filtered.forEach(p => {
                const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
                let statusText = 'Đang điều trị', statusClass = 'status-ok';
                if (p.dischargeDate) {
                    const d = new Date(`${p.dischargeDate}T${p.dischargeTime || '00:00'}`);
                    if (d < now) return;
                    const today = now.toISOString().split('T')[0];
                    statusText = p.dischargeDate === today ? `Ra viện hôm nay - ${p.dischargeTime}` : `Ra viện ${formatDate(p.dischargeDate)} - ${p.dischargeTime}`;
                    statusClass = p.dischargeDate === today ? 'status-warning' : 'status-error';
                }
                html += `<tr style="cursor: pointer;" onclick="requirePassword(() => showPatientDetail('${p.id}'))"><td>${stt++}</td><td>${p.fullName}</td><td>${p.room}</td><td>${formatHourHM(p.examinationTime)}</td><td>${days} ngày</td><td>${p.patientType}</td><td><span class="${statusClass}">${statusText}</span></td></tr>`;
            });
            document.getElementById('statsTableBody').innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;">Không có dữ liệu</td></tr>';
        showStatsLoading(false);
		}

function updateNotifications() {
    showNotificationLoading(true);  // Bắt đầu loading

    const now = new Date();
    const overdue = patients.filter(p => {
        if (isDischarged(p)) return false;
        const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
        return (p.patientType === 'Nội trú' && days > 21) || (p.patientType === 'Ban ngày' && days > 14);
    });

    // Xử lý kết quả
    if (overdue.length === 0) {
        // Không có cảnh báo → ẩn toàn bộ bar
        document.getElementById('notificationContainer').classList.add('hidden');
    } else {
        // Có cảnh báo → hiện nội dung
        let txt = '<strong>Cảnh báo quá ngày nằm viện:</strong><br>';
        overdue.forEach(p => {
            const days = Math.ceil((now - new Date(p.admissionDate)) / 86400000);
            txt += `• <strong>${p.fullName}</strong> (Phòng ${p.room}) - ${p.patientType} nằm ${days} ngày<br>`;
        });
        document.getElementById('notificationText').innerHTML = txt;
    }

    // Luôn ẩn loading khi xong (dù có hay không có cảnh báo)
    showNotificationLoading(false);
}

        function showPatientDetail(id) {
            currentPatientId = id; currentView = 'patient';
            const p = patients.find(x => x.id === id);
            document.getElementById('rightPanelTitle').innerHTML = `<i class="fas fa-user"></i> Thông tin bệnh nhân: ${p.fullName}`;
            document.getElementById('patientDetailContent').innerHTML = `
                <form id="detailForm">
                    <div class="patient-form">
                        <div class="form-group"><label>Họ tên *</label><input id="detailFullName" value="${p.fullName}" required></div>
                        <div class="form-group"><label>Tuổi *</label><input type="number" id="detailAge" value="${p.age}" required></div>
                        <div class="form-group"><label>Giới tính *</label><select id="detailGender" required><option value="Nam" ${p.gender==='Nam'?'selected':''}>Nam</option><option value="Nữ" ${p.gender==='Nữ'?'selected':''}>Nữ</option></select></div>
                        <div class="form-group"><label>Chẩn đoán *</label><input id="detailDiagnosis" value="${p.diagnosis}" required></div>
                        <div class="form-group">
    <label>Ngày vào viện *
     <span id="detailAdmissionLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>
    
    </label>
    <div class="date-wrapper">
        <input type="date" id="detailAdmissionDate" value="${p.admissionDate}" required>
        <span id="detailAdmissionWeekday"></span>
    </div>
</div>


                        <div class="form-group"><label>Giờ vào viện *</label><input type="time" id="detailAdmissionTime" value="${p.admissionTime}" required></div>
                        <div class="form-group"><label>Giờ khám bệnh *</label><input type="time" id="detailExaminationTime" value="${p.examinationTime}" required></div>
                        <div class="form-group"><label>Phòng *</label><select id="detailRoom" required><option value="9" ${p.room==='9'?'selected':''}>Phòng 9</option><option value="11" ${p.room==='11'?'selected':''}>Phòng 11</option></select></div>
                        <div class="form-group"><label>Loại bệnh nhân *</label><select id="detailPatientType" required><option value="Nội trú" ${p.patientType==='Nội trú'?'selected':''}>Nội trú</option><option value="Ban ngày" ${p.patientType==='Ban ngày'?'selected':''}>Ban ngày</option></select></div>
                       <div class="form-group">
    <label>Ngày ra viện
    <span id="detailDischargeLunar" style="margin-left:6px;color:#009688;font-weight:600"></span>
    
    </label>
    <div class="date-wrapper">
        <input type="date" id="detailDischargeDate" value="${p.dischargeDate||''}">
        <span id="detailDischargeWeekday"></span>
    </div>
</div>

    <div class="form-group"><label>Giờ ra viện</label><input type="time" id="detailDischargeTime" value="${p.dischargeTime||''}"></div>
	
	<div class="form-group">
  <label>Tổng ngày:</label>
  <input type="text" id="totalDays" readonly>
</div>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="btn btn-success" onclick="requirePassword(() => updatePatient('${id}'))">Cập nhật</button>
                        <button type="button" class="btn btn-danger" onclick="requirePassword(() => showConfirmDeleteModal('${id}'))">Xóa bệnh nhân</button>
                    </div>
                </form>`;
				// Đặt giá trị ban đầu cho ô Tổng ngày
				document.getElementById("totalDays").value = calcHospitalDays(p.admissionDate, p.dischargeDate);
// Gắn sự kiện tự động cập nhật thứ trong			
setTimeout(() => {

    bindWeekdayAutoUpdate(
        "detailAdmissionDate",
        "detailAdmissionWeekday",
        "detailAdmissionLunar"
    );

    bindWeekdayAutoUpdate(
        "detailDischargeDate",
        "detailDischargeWeekday",
        "detailDischargeLunar"
    );

}, 100);
// === THÊM MỚI: Tự động tính tổng ngày khi thay đổi ngày vào hoặc ngày ra ===
    const admissionDateInput = document.getElementById('detailAdmissionDate');
    const dischargeDateInput = document.getElementById('detailDischargeDate');
    const totalDaysInput = document.getElementById('totalDays');

    function updateTotalDays() {
        const admit = admissionDateInput.value;
        const discharge = dischargeDateInput.value;
        totalDaysInput.value = calcHospitalDays(admit, discharge);
    }

    // Lắng nghe sự kiện thay đổi trên cả hai ô ngày
    admissionDateInput.addEventListener('input', updateTotalDays);
    dischargeDateInput.addEventListener('input', updateTotalDays);

    // Nếu người dùng xóa ngày ra viện → ô tổng ngày sẽ trống
    // (hàm calcHospitalDays đã xử lý trường hợp thiếu discharge)
            document.getElementById('statsContent').classList.add('hidden');
            document.getElementById('patientDetailContent').classList.remove('hidden');
            renderPatientList();
        }

    function showStatsView() {
    currentView = 'stats'; currentPatientId = null;
    document.getElementById('rightPanelTitle').innerHTML = '<i class="fas fa-chart-bar"></i> THỐNG KÊ GIỜ KHÁM';
    document.getElementById('statsContent').classList.remove('hidden');
    document.getElementById('patientDetailContent').classList.add('hidden');
    
    showStatsLoading(true);  // <<< THÊM
    renderStatsTable();      // renderStatsTable đã tự ẩn loading khi xong
    renderPatientList();
}

        function showAddPatientModal() {
    document.getElementById('modalTitle').textContent = 'Thêm bệnh nhân mới';
    document.getElementById('patientForm').reset();

    const now = new Date();
    document.getElementById('admissionDate').value = now.toISOString().split('T')[0];
    document.getElementById('admissionTime').value = now.toTimeString().slice(0,5);
    document.getElementById('examinationTime').value = "07:00";

    document.getElementById('patientModal').classList.remove('hidden');

    // ✅ GỌI HÀM TẠI ĐÂY
    bindWeekdayAutoUpdate(
        "admissionDate",
        "admissionWeekday",
        "admissionLunar"
    );
}

        async function savePatient() {
            if (!document.getElementById('patientForm').checkValidity()) { showToast('Vui lòng điền đầy đủ thông tin', 'error'); return; }
            const id = 'patient_' + Date.now();
            const newP = { id, fullName: document.getElementById('fullName').value, age: +document.getElementById('age').value, gender: document.getElementById('gender').value,
                diagnosis: document.getElementById('diagnosis').value, admissionDate: document.getElementById('admissionDate').value,
                admissionTime: document.getElementById('admissionTime').value, examinationTime: document.getElementById('examinationTime').value,
                room: document.getElementById('room').value, patientType: document.getElementById('patientType').value,
                dischargeDate: '', dischargeTime: '' };
            patients.push(newP);
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                document.getElementById('patientModal').classList.add('hidden');
                showToast('Thêm thành công!', 'success');
                showPatientDetail(id);
            } catch { showToast('Lỗi lưu dữ liệu', 'error'); }
        }

        async function updatePatient(id) {
            const i = patients.findIndex(p => p.id === id);
            patients[i] = { ...patients[i],
                fullName: document.getElementById('detailFullName').value, age: +document.getElementById('detailAge').value,
                gender: document.getElementById('detailGender').value, diagnosis: document.getElementById('detailDiagnosis').value,
                admissionDate: document.getElementById('detailAdmissionDate').value, admissionTime: document.getElementById('detailAdmissionTime').value,
                examinationTime: document.getElementById('detailExaminationTime').value, room: document.getElementById('detailRoom').value,
                patientType: document.getElementById('detailPatientType').value,
                dischargeDate: document.getElementById('detailDischargeDate').value || '',
                dischargeTime: document.getElementById('detailDischargeTime').value || '' };
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                showToast('Cập nhật thành công!', 'success');
            } catch { showToast('Lỗi cập nhật', 'error'); }
        }

        async function deletePatient(id) {
            patients = patients.filter(p => p.id !== id);
            try {
                await saveToDropbox(patients);
                renderPatientList(); renderStatsTable(); updateNotifications();
                showStatsView();
                document.getElementById('confirmModal').classList.add('hidden');
                showToast('Xóa thành công!', 'success');
            } catch { showToast('Lỗi xóa', 'error'); }
        }

        function showConfirmDeleteModal(id) {
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmDeleteBtn').onclick = () => deletePatient(id);
        }

        // Sự kiện (đều qua requirePassword)
        document.getElementById('newPatientBtn').onclick = () => requirePassword(showAddPatientModal);
        document.getElementById('viewStatsBtn').onclick = () => requirePassword(showStatsView);
        document.getElementById('savePatientBtn').onclick = () => requirePassword(savePatient);
        document.getElementById('searchInput').oninput = () => requirePassword(() => { renderPatientList(); renderStatsTable(); });
        document.getElementById('filterStatus').onchange = () => requirePassword(() => { renderPatientList(); renderStatsTable(); });

        document.getElementById('closeModalBtn').onclick = document.getElementById('cancelBtn').onclick = () => document.getElementById('patientModal').classList.add('hidden');
        document.getElementById('closeConfirmModalBtn').onclick = document.getElementById('cancelDeleteBtn').onclick = () => document.getElementById('confirmModal').classList.add('hidden');

        document.getElementById('fullName').oninput = function() {
            if (this.value.toLowerCase().includes('thị')) document.getElementById('gender').value = 'Nữ';
        };

        // Phím tắt
       document.onkeydown = e => {
        if (e.ctrlKey && e.key === 'n') { 
            e.preventDefault(); 
            requirePassword(showAddPatientModal); 
        }
        if (e.key === 'Escape') requirePassword(showStatsView);
        if (e.key === 'F5') location.reload();
    if (e.ctrlKey && e.key === 's') {
            e.preventDefault(); // Ngăn hành vi lưu trang mặc định của trình duyệt

            requirePassword(() => {
                if (currentView === 'stats' && !currentPatientId) {
                    // Đang ở modal Thêm bệnh nhân mới (modal đang mở)
                    if (!document.getElementById('patientModal').classList.contains('hidden')) {
                        savePatient(); // Gọi hàm lưu bệnh nhân mới
                    } else {
                        showToast('Không có hành động lưu nào đang mở', 'info');
                    }
                } else if (currentPatientId) {
                    // Đang xem chi tiết bệnh nhân → Cập nhật
                    updatePatient(currentPatientId);
                } else {
                    showToast('Không có hành động lưu nào', 'info');
                }
            });
        }
        if (e.key === 'F1') { 
            e.preventDefault(); 
            if (currentPatientId) requirePassword(() => showConfirmDeleteModal(currentPatientId)); 
        }
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            const sel = document.getElementById('filterStatus');
            sel.value = sel.value === 'all' ? 'active' : 'all';
            requirePassword(() => sel.dispatchEvent(new Event('change')));
        }

        // ← THÊM MỚI: Phím F2 để đăng xuất
        if (e.key === 'F2') {
            e.preventDefault();
            if (isAuthenticated) {
             
                    logout();
               
            } else {
                showToast('Bạn chưa đăng nhập', 'info');
            }
        }
    };

        // Khởi động ngay - hiển thị giao diện luôn
async function initApp() {
    checkStoredAuth();               
    showStatsLoading(true);
    showNotificationLoading(true);
    
    patients = await loadFromDropbox();
    renderPatientList();
    renderStatsTable();       // sẽ tự ẩn loading
    updateNotifications();    // sẽ tự ẩn loading
    showStatsView();
}

        document.addEventListener('DOMContentLoaded', initApp);
		
	


function getVNWeekday(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    const days = ["Chủ Nhật","Thứ 2","Thứ 3","Thứ 4","Thứ 5","Thứ 6","Thứ 7"];
    return days[d.getDay()];
}

function bindWeekdayAutoUpdate(inputId, spanId, lunarId){
    const input = document.getElementById(inputId);
    const span = document.getElementById(spanId);
    const lunar = document.getElementById(lunarId);
    if(!input) return;

    function update(){
        if(span) span.textContent = getVNWeekday(input.value);
        if(lunar) lunar.textContent = getLunarText(input.value);
    }

    input.addEventListener("input", update);
    update();
}
function formatHourHM(timeStr){
    if(!timeStr) return "";
    const [h, m] = timeStr.split(":");
    return `${h.padStart(2,'0')}:${m.padStart(2,'0')}`;
}
function calcHospitalDays(admit, discharge){
    if(!admit || !discharge) return "";
    const a = new Date(admit);
    const r = new Date(discharge);
    const diff = Math.round((r - a) / (1000*60*60*24));
    return diff + " ngày";
}
/* ====== AM LICH VIET NAM - HO NGOC DUC (CHUAN) ====== */
const CAN = ["Giáp","Ất","Bính","Đinh","Mậu","Kỷ","Canh","Tân","Nhâm","Quý"];
const CHI = ["Tý","Sửu","Dần","Mão","Thìn","Tỵ","Ngọ","Mùi","Thân","Dậu","Tuất","Hợi"];

function INT(d) {
    return Math.floor(d);
}

function jdFromDate(dd, mm, yy) {
    var a = INT((14 - mm) / 12);
    var y = yy + 4800 - a;
    var m = mm + 12 * a - 3;
    var jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - INT(y / 100) + INT(y / 400) - 32045;
    if (jd < 2299161) {
        jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - 32083;
    }
    return jd;
}

function NewMoon(k) {
    var T = k / 1236.85;
    var T2 = T * T;
    var T3 = T2 * T;
    var dr = Math.PI / 180;
    var Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
    Jd1 += 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
    var M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
    var Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
    var F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
    var C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
    C1 -= 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
    C1 -= 0.0004 * Math.sin(dr * 3 * Mpr);
    C1 += 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
    C1 -= 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
    C1 -= 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
    C1 += 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
    var deltat;
    if (T < -11) {
        deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
    } else {
        deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
    }
    var JdNew = Jd1 + C1 - deltat;
    return JdNew;
}

function SunLongitude(jdn) {
    var T = (jdn - 2451545.0) / 36525;
    var T2 = T * T;
    var dr = Math.PI / 180;
    var M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
    var L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
    var DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
    DL += (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
    var L = L0 + DL;
    L = L * dr;
    L = L - Math.PI * 2 * (INT(L / (Math.PI * 2)));
    return L;
}

function getSunLongitude(dayNumber, timeZone) {
    return INT(SunLongitude(dayNumber - 0.5 - timeZone / 24) / Math.PI * 6);
}

function getNewMoonDay(k, timeZone) {
    return INT(NewMoon(k) + 0.5 + timeZone / 24);
}

function getLunarMonth11(yy, timeZone) {
    var off = jdFromDate(31, 12, yy) - 2415021;
    var k = INT(off / 29.530588853);
    var nm = getNewMoonDay(k, timeZone);
    var sunLong = getSunLongitude(nm, timeZone);
    if (sunLong >= 9) {
        nm = getNewMoonDay(k - 1, timeZone);
    }
    return nm;
}

function getLeapMonthOffset(a11, timeZone) {
    var k = INT((a11 - 2415021.076998695) / 29.530588853 + 0.5);
    var last = 0;
    var i = 1;
    var arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
    } while (arc != last && i < 14);
    return i - 1;
}

function getLunarDate(dd, mm, yy) {
    const tz = 7; // Timezone cho Việt Nam (UTC+7)
    var dayNumber = jdFromDate(dd, mm, yy);
    var k = INT((dayNumber - 2415021.076998695) / 29.530588853);
    var monthStart = getNewMoonDay(k + 1, tz);
    if (monthStart > dayNumber) {
        monthStart = getNewMoonDay(k, tz);
    }
    var a11 = getLunarMonth11(yy, tz);
    var b11 = a11;
    var lunarYear;
    if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, tz);
    } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, tz);
    }
    var lunarDay = dayNumber - monthStart + 1;
    var diff = INT((monthStart - a11) / 29);
    var lunarLeap = 0;
    var lunarMonth = diff + 11;
    if (b11 - a11 > 365) {
        var leapMonthDiff = getLeapMonthOffset(a11, tz);
        if (diff >= leapMonthDiff) {
            lunarMonth = diff + 10;
            if (diff == leapMonthDiff) {
                lunarLeap = 1;
            }
        }
    }
    if (lunarMonth > 12) {
        lunarMonth -= 12;
    }
    if (lunarMonth >= 11 && diff < 4) {
        lunarYear -= 1;
    }
    return {
        day: lunarDay,
        month: lunarMonth,
        year: lunarYear,
        canChi: `${CAN[(lunarYear + 6) % 10]} ${CHI[(lunarYear + 8) % 12]}`
    };
}

function getLunarText(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    const l = getLunarDate(d.getDate(), d.getMonth() + 1, d.getFullYear());

    // Thêm số 0 vào ngày và tháng nếu < 10
    const dayStr = l.day.toString().padStart(2, '0');
    const monthStr = l.month.toString().padStart(2, '0');

    return `${dayStr}/${monthStr}/${l.year} (${l.canChi})`;
}


function showStatsLoading(show = true) {
    if (show) {
        document.getElementById('statsTableContainer').classList.add('hidden');
        document.getElementById('statsLoading').classList.remove('hidden');
    } else {
        document.getElementById('statsTableContainer').classList.remove('hidden');
        document.getElementById('statsLoading').classList.add('hidden');
    }
}

function showNotificationLoading(show = true) {
    const container = document.getElementById('notificationContainer');
    const content = document.getElementById('notificationContent');
    const loading = document.getElementById('notificationLoading');

    if (show) {
        container.classList.remove('hidden');
        content.style.display = 'none';  // Ẩn content
        loading.style.display = 'flex';  // Hiện loading với flex
    } else {
        loading.style.display = 'none';  // Ẩn loading
        content.style.display = '';      // Hiện content (trở về mặc định, thường là block hoặc flex tùy CSS)
    }
}
</script>
</body>
</html>
