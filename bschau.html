
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Doctor Ch√¢u</title><script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script>
const REFRESH_KEY = "yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr";
const APP_KEY = "qzy5kclrf827aey";
const APP_SECRET = "6jlsunzjqr3s3nh";

let dropboxToken = null;

// ‚öôÔ∏è L·∫•y access_token t·ª´ refresh_token
async function getAccessToken() {
  const resp = await fetch("https://api.dropboxapi.com/oauth2/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      grant_type: "refresh_token",
      refresh_token: REFRESH_KEY,
      client_id: APP_KEY,
      client_secret: APP_SECRET
    })
  });
  const data = await resp.json();
  dropboxToken = data.access_token;

}
</script>
<script>
// üì• T·∫£i /patients_v1.json t·ª´ Dropbox
async function loadPatientsFromDropbox() {
  if (!dropboxToken) await getAccessToken();
  const resp = await fetch("https://content.dropboxapi.com/2/files/download", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + dropboxToken,
      "Dropbox-API-Arg": JSON.stringify({ path: "/patients_v1.json" })
    }
  });

  if (!resp.ok) {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y file tr√™n Dropbox, t·∫°o danh s√°ch tr·ªëng.");
    return [];
  }

  const text = await resp.text();
  try {
    const data = JSON.parse(text);
   
    return data;
  } catch (e) {
    console.error("‚ùå JSON b·ªã l·ªói:", e);
    return [];
  }
}
</script>
<script>
// üíæ Ghi ƒë√® /patients_v1.json l√™n Dropbox
async function savePatientsToDropbox(patients) {
  if (!dropboxToken) await getAccessToken();
  const resp = await fetch("https://content.dropboxapi.com/2/files/upload", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + dropboxToken,
      "Dropbox-API-Arg": JSON.stringify({
        path: "/patients_v1.json",
        mode: "overwrite",
        autorename: false
      }),
      "Content-Type": "application/octet-stream"
    },
    body: JSON.stringify(patients, null, 2)
  });
  if (resp.ok) {

  } else {
    console.error("‚ùå L∆∞u th·∫•t b·∫°i:", await resp.text());
  }
}
</script>
  <style>
    :root{
      --bg:#fff7f0; --accent:#ff7a18; --muted:#6b6b6b; --card:#ffffff; --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#fffaf5 0%, #fff1e6 100%);color:#222}
    .app{display:flex;gap:20px;height:100vh;padding:18px}
   .sidebar{
  width:220px;
  background:var(--card);
  border-radius:14px;
  padding:14px;
  box-shadow:var(--shadow);
  overflow:auto;
   resize: none;        /* ‚úÖ Cho ph√©p k√©o ngang */
  min-width:150px;           /* Gi·ªõi h·∫°n nh·ªè nh·∫•t */
  max-width:400px;           /* Gi·ªõi h·∫°n l·ªõn nh·∫•t */
}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h2{margin:0;color:var(--accent)}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(255,122,24,0.15)}
    .patient-list{display:flex;flex-direction:column;gap:8px}
    .patient-item{padding:10px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .patient-item:hover{background:linear-gradient(90deg,rgba(255,122,24,0.06),transparent)}
    .patient-meta{font-size:13px;color:var(--muted)}
.app{
  display:flex;
  gap:20px;
  height:100vh;
  padding:18px;
  align-items: stretch;  /* ‚úÖ ƒë·ªÉ hai kh·ªëi c√πng cao */
}

  .main{
  flex:1;
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:var(--shadow);
  overflow:auto;
 resize: none; 
  min-width:400px;
  min-height:300px;
  max-height:100vh;
}    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px}
    input,select,textarea{width:90%;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff}
    .section{background:var(--glass);padding:12px;border-radius:10px}
    .med-list,.thang-list,.procedure-list{display:flex;flex-direction:column;gap:8px}
.med-row{
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #f0e6de;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  align-items: center;
}

/* Thu·ªëc s·∫Øc: 5 c·ªôt gi√£n ƒë·ªÅu h∆°n */
.thang-row,.proc-row {
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #f0e6de;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 40px;
  align-items: center;
}


   .med-row .full{grid-column:1/-1}
    .med-row input, .thang-row input, .proc-row input{padding:6px}
    .small{font-size:12px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* modal form */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35)}
    .modal.open{display:flex}
    .card{background:#fff;padding:18px;border-radius:12px;width:720px;box-shadow:0 10px 30px rgba(0,0,0,0.2)}

    .right-top{display:flex;gap:12px;align-items:center}
    .meta-block{background:#fff;padding:10px;border-radius:8px;border:1px solid #f2e7df}

    footer{margin-top:16px;font-size:12px;color:var(--muted)}

    @media (max-width:900px){.app{flex-direction:column}.sidebar{width:100%;height:260px}.main{height:auto}}
	.med-row,thang-row{
  gap: 20px; /* tƒÉng kho·∫£ng c√°ch chung gi·ªØa c√°c √¥ */
}#divider {
  width: 6px;
  cursor: col-resize;               /* ‚úÖ hi·ªán con tr·ªè k√©o ngang */
  background: linear-gradient(to right, #f8d5b2, #ffd7a0);
  border-radius: 3px;
  transition: background 0.2s;
}
#divider:hover {
  background: linear-gradient(to right, #ffb56b, #ff9a3c);
#popupContent ul { list-style-type: none; padding-left: 15px; }
#popupContent li strong { color: #2c3e50; }
#popupContent h4 { margin-top: 15px; margin-bottom: 5px; }
#thongBaoChung {
  transition: all 0.3s ease;
}
#hiddenPatientsNotice {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
  
    <div class="header">
  <button class="btn" id="addPatientBtn">üë©‚Äç‚öïÔ∏è Th√™m</button>
  <button id="btnFuture" class="btn secondary">üëè Future</button>

 
</div>
  <div class="header">   <button class="btn secondary" id="btnTiem">üíâ Ti√™m</button>
  <button class="btn secondary" id="btnVien">üíä Vi√™n</button>
  <button class="btn secondary" id="btnSac">üçµ S·∫Øc</button>
  <button class="btn secondary" id="btnGio">üïí Gi·ªù</button></div>
  
  
    <input id="search" placeholder="T√¨m ki·∫øm t√™n / tu·ªïi / gi·ªõi" style="width:90%;padding:8px;border-radius:10px;border:1px solid #fde9d8;margin-bottom:10px" />
    <div class="patient-list" id="patientList"></div>
  </aside>
<div id="divider"></div>
  <main class="main">
    <div class="right-top"style="display:none">
      <div class="meta-block" id="patientHeader">Ch·ªçn m·ªôt b·ªánh nh√¢n ƒë·ªÉ xem chi ti·∫øt</div>
      <div style="flex:1"></div>
     
    </div>

    <div id="patientDetailArea" style="margin-top:12px;display:none">
<div style="display:flex;gap:12px;flex-wrap:wrap;">
          <div style="flex:1;min-width:320px;display:none" class="section">
          <h3>Th√¥ng tin c∆° b·∫£n</h3>
          <div class="grid">
            <div>
              <label>T√™n b·ªánh nh√¢n</label>
              <input id="p_name" />
            </div>
            <div>
              <label>Tu·ªïi</label>
              <input id="p_age" type="number"/>
            </div>
<div style="grid-column:1/-1; display:flex; align-items:center; gap:20px;">
  <div style="display:flex; align-items:center; gap:6px;">
    <label>Gi·ªõi</label>
    <select id="p_gender" style="width:80px;">
      <option>Nam</option><option>N·ªØ</option><option>Kh√°c</option>
    </select>
  </div>


  
  
  <!-- Custom checkbox thay th·∫ø ƒë·ªÉ hi·ªÉn th·ªã ƒë∆∞·ª£c trong Nativefier -->
<div style="display:flex; align-items:center; gap:6px; cursor:pointer;" onclick="toggleOutpatient()">
  <span id="fake_outpatient" 
        style="width:18px;height:18px;border:2px solid #666;border-radius:4px;
               display:inline-block;position:relative;vertical-align:middle;background-color:#fff;">
  </span>
      <label for="p_outpatient" style="margin:0;cursor:pointer;">Ngo·∫°i tr√∫</label>
  <input type="hidden" id="p_outpatient" value="false" />
</div>

<script>
function toggleOutpatient() {
  const fake = document.getElementById('fake_outpatient');
  const real = document.getElementById('p_outpatient');
  const checked = real.value === 'true';
  if (checked) {
    fake.innerHTML = '';
    real.value = 'false';
  } else {
    fake.innerHTML = '<div style="position:absolute;left:4px;top:0;width:5px;height:10px;border:solid #ff6600;border-width:0 2px 2px 0;transform:rotate(45deg);"></div>';
    real.value = 'true';
  }
}
</script>
  
</div>


            <div>
              <label>ƒê·ªãa ch·ªâ</label>
              <input id="p_address" />
            </div>
            <div style="grid-column:1/-1">
              <label>Ch·∫©n ƒëo√°n</label>
              <textarea id="p_dx" rows="2"></textarea>
            </div>
			
			<div>
  <label>Ph√≤ng</label>
  <input id="p_room" placeholder="" />
</div>
          </div>
        </div>
<div style="flex:1;min-width:600px" class="section">
  <div class="grid">
    <div>
      <label>Gi·ªù kh√°m</label>
      <input id="exam_time" type="time" />
    </div>
  </div>
</div>

      <div style="flex:1;min-width:320px" class="section">
          <h3>Thu·ªëc t√¢n d∆∞·ª£c v√† ch·∫ø ph·∫©m <button class="btn secondary" id="addMedicineBtn" style="float:right">Th√™m Thu·ªëc</button></h3>
          <div class="med-list" id="medList"></div>
        </div>

</div>
        <div style="flex:1;min-width:320px" class="section">
          <h3>Thu·ªëc s·∫Øc <button class="btn secondary" id="addThangBtn" style="float:right">Th√™m Thu·ªëc</button></h3>
          <div class="thang-list" id="thangList"></div>
        </div>
<div style="flex:1;min-width:320px" class="section">
  <h3>Th·ªß thu·∫≠t <button class="btn secondary" id="addProcBtn" style="float:right">Th√™m Th·ªß thu·∫≠t</button></h3>
  <div class="procedure-list" id="procList"></div>
</div>

        <div style="flex:1;min-width:320px" class="section">
          <h3>Ng√†y v√†o / ra vi·ªán</h3>
         <div class="grid">
  <div>
    <label>Ng√†y v√†o vi·ªán</label>
    <input id="admit_date" type="date" />
  </div>
  <div>
    <label>Gi·ªù v√†o vi·ªán</label>
    <input id="admit_time" type="time" />
  </div>
  <div>
    <label>Ng√†y ra vi·ªán</label>
    <input id="discharge_date" type="date" />
  </div>
  <div>
    <label>Gi·ªù ra vi·ªán</label>
    <input id="discharge_time" type="time" />
  </div>
  <div style="grid-column:1/-1">
    <label>T·ªïng s·ªë ng√†y n·∫±m vi·ªán</label>
    <input id="total_days" readonly />
  </div>
</div>
        </div>
   <div class="actions">
        <button class="btn" id="saveWordBtn">L∆∞u Word</button>
		<button class="btn secondary" id="deletePatientBtn" style="background:#ffeded;color:#c0392b;border:1px solid #ffcfcf;">üóë X√≥a</button>
        <button class="btn secondary" id="cancelBtn">H·ªßy</button>
        <button class="btn" id="savePatientBtn">L∆∞u b·ªánh nh√¢n</button>
      

      </div> <footer>Design By Dr. Ch√¢u</footer>
      </div>

   
  
    </div>
  </main>


<!-- modal th√™m b·ªánh nh√¢n -->
<div class="modal" id="modal">
  <div class="card">
    <h3>Th√™m b·ªánh nh√¢n m·ªõi</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
      <div>
        <label>T√™n</label>
        <input id="new_name" />
      </div>
      <div>
        <label>Tu·ªïi</label>
        <input id="new_age" type="number" />
      </div>
<div style="grid-column:1/-1; display:flex; align-items:center; gap:20px;">
  <div style="display:flex; align-items:center; gap:6px;">
    <label>Gi·ªõi</label>
    <select id="new_gender" style="width:90px;">
      <option>Nam</option><option>N·ªØ</option><option>Kh√°c</option>
    </select>
  </div>

<!-- Custom checkbox thay th·∫ø ƒë·ªÉ hi·ªÉn th·ªã ƒë∆∞·ª£c trong Nativefier -->
<div style="display:flex; align-items:center; gap:6px; cursor:pointer;" onclick="toggleOutpatient()">
  <span id="fake_outpatient" 
        style="width:18px;height:18px;border:2px solid #666;border-radius:4px;
               display:inline-block;position:relative;vertical-align:middle;background-color:#fff;">
  </span>
  <label style="margin:0;cursor:pointer;">Ngo·∫°i tr√∫</label>
  <input type="hidden" id="new_outpatient" value="false" />
</div>

<script>
function toggleOutpatient() {
  const fake = document.getElementById('fake_outpatient');
  const real = document.getElementById('new_outpatient');
  const checked = real.value === 'true';
  if (checked) {
    fake.innerHTML = '';
    real.value = 'false';
  } else {
    fake.innerHTML = '<div style="position:absolute;left:4px;top:0;width:5px;height:10px;border:solid #ff6600;border-width:0 2px 2px 0;transform:rotate(45deg);"></div>';
    real.value = 'true';
  }
}
</script>
</div>

	  
      <div> <!-- S·ª≠a th√†nh chi·∫øm 2 c·ªôt -->
        <label>Ch·∫©n ƒëo√°n</label>
        <textarea id="new_dx" rows="2"></textarea> <!-- ƒê·ªïi id th√†nh new_dx -->
      </div>
      <div> <!-- ƒê·ªãa ch·ªâ c≈©ng chi·∫øm 2 c·ªôt -->
        <label>ƒê·ªãa ch·ªâ</label>
        <input id="new_address" />
      </div>
	  <div>
  <label>Ph√≤ng</label>
  <input id="new_room" placeholder="" />
</div>
<div>
  <label>Ng√†y v√†o vi·ªán</label>
  <input id="new_admit_date" type="date" />
</div>
<div>
  <label>Gi·ªù v√†o vi·ªán</label>
  <input id="new_admit_time" type="time" />
</div>

    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn secondary" id="modalClose">ƒê√≥ng</button>
      <button class="btn" id="modalSave">Th√™m</button>
    </div>
  </div>
</div><script>
document.getElementById('new_name').addEventListener('input', function () {
  const name = this.value.trim().toLowerCase();
  const genderSelect = document.getElementById('new_gender');
  if (name.includes('th·ªã')) {
    genderSelect.value = 'N·ªØ';
  }
});</script>
<script>
// Helper
const medsSuggest = ['Dubemin','Kamelox','Mimosa','Amlodipin','Piracetam','Reumokam'];
// ‚úÖ H√ÄM DATE CHU·∫®N CHO VI·ªÜT NAM
function todayStr(){
  const d = new Date();
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function addDays(dateStr, n){
  const d = new Date(dateStr);
  d.setDate(d.getDate() + n);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function daysBetween(a,b){
  if(!a||!b) return '';
  // ‚úÖ S·ª≠a: d√πng local date ƒë·ªÉ t√≠nh
  const A = new Date(a);
  const B = new Date(b);
  const diff = Math.round((B - A)/(1000 * 60 * 60 * 24));
  return diff >= 0 ? diff : '';
}

// App state
let patients = [];
window.addEventListener('load', async () => {
  patients = await loadPatientsFromDropbox();
  showAllPatients = false; // ‚úÖ TH√äM D√íNG N√ÄY - M·∫∑c ƒë·ªãnh ·∫©n b·ªánh nh√¢n ƒë√£ ra vi·ªán
  renderPatientList();
capNhatThongBao();
canhBaoSoNgayNamVien();

});

let currentPatientId = null;
let showAllPatients = false; // ‚úÖ TH√äM D√íNG N√ÄY - Bi·∫øn ƒë·ªÉ theo d√µi c√≥ hi·ªán t·∫•t c·∫£ b·ªánh nh√¢n kh√¥ng
// DOM
const patientListEl = document.getElementById('patientList');
const addPatientBtn = document.getElementById('addPatientBtn');
const modal = document.getElementById('modal');
const modalSave = document.getElementById('modalSave');
const modalClose = document.getElementById('modalClose');
const savePatientBtn = document.getElementById('savePatientBtn');
const deletePatientBtn = document.getElementById('deletePatientBtn');
const cancelBtn = document.getElementById('cancelBtn');
cancelBtn.addEventListener('click', () => {
  // ·∫®n khu chi ti·∫øt b·ªánh nh√¢n, hi·ªán l·∫°i m√†n h√¨nh gi·ªõi thi·ªáu
  document.getElementById('patientDetailArea').style.display = 'none';
  const intro = document.getElementById('introScreen');
  if (intro) intro.style.display = 'block';
  currentPatientId = null;
});
const patientDetailArea = document.getElementById('patientDetailArea');
const patientHeader = document.getElementById('patientHeader');
const saveWordBtn = document.getElementById('saveWordBtn');

const inputs = {
  name: document.getElementById('p_name'),
  age: document.getElementById('p_age'),
  gender: document.getElementById('p_gender'),
  address: document.getElementById('p_address'),
  dx: document.getElementById('p_dx'),
  admit: document.getElementById('admit_date'),
  discharge: document.getElementById('discharge_date'),
  total: document.getElementById('total_days')
};

const medList = document.getElementById('medList');
const addMedBtn = document.getElementById('addMedicineBtn');
const thangList = document.getElementById('thangList');
const addThangBtn = document.getElementById('addThangBtn');
const procList = document.getElementById('procList');
const addProcBtn = document.getElementById('addProcBtn');
addProcBtn.addEventListener('click', () => procList.appendChild(createProcRow({})));
// init
function renderPatientList(filter=''){
  patientListEl.innerHTML='';
  const now = new Date();
  const currentDate = now.toISOString().slice(0,10);
  const currentTime = now.toTimeString().slice(0,5);
  
  const arr = patients.filter(p=> {
    // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
    const matchSearch = (p.name||'').toLowerCase().includes(filter.toLowerCase()) || 
                       (''+p.age).includes(filter) || 
                       (p.gender||'').toLowerCase().includes(filter.toLowerCase());
    
    if (!matchSearch) return false;
    
    // N·∫øu ƒëang hi·ªán t·∫•t c·∫£ (Ctrl+Q) ho·∫∑c ch∆∞a c√≥ ng√†y ra vi·ªán -> hi·ªÉn th·ªã
    if (showAllPatients || !p.discharge) return true;
    
    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán ·∫©n: c√≥ ng√†y ra vi·ªán V√Ä ƒë√£ t·ªõi ng√†y V√Ä ƒë√£ t·ªõi gi·ªù
    const dischargeDate = p.discharge;
    const dischargeTime = p.discharge_time || '23:59'; // M·∫∑c ƒë·ªãnh cu·ªëi ng√†y n·∫øu kh√¥ng c√≥ gi·ªù
    
    // N·∫øu ng√†y ra vi·ªán > ng√†y hi·ªán t·∫°i -> v·∫´n hi·ªÉn th·ªã
    if (dischargeDate > currentDate) return true;
    
    // N·∫øu ng√†y ra vi·ªán = ng√†y hi·ªán t·∫°i nh∆∞ng ch∆∞a t·ªõi gi·ªù ra vi·ªán -> v·∫´n hi·ªÉn th·ªã
    if (dischargeDate === currentDate && dischargeTime > currentTime) return true;
    
    // Ng∆∞·ª£c l·∫°i -> ·∫©n ƒëi
    return false;
  });
  
  arr.forEach(p=>{
    const el = document.createElement('div'); el.className='patient-item';
    el.innerHTML = `<div>
      <div style="font-weight:600">${p.name||'(ch∆∞a c√≥ t√™n)'}</div>
      <div class="patient-meta">Tu·ªïi: ${p.age||''} ‚Ä¢ ${p.gender||''} ‚Ä¢ P${p.room||''}</div>
    </div>
    <div style="text-align:right;min-width:80px"><div style="text-align:right;min-width:120px">
  <div style="font-size:13px;color:#ff7a18;"><button class="btn secondary">
    ${p.admit && !p.discharge ? `${daysBetween(p.admit, todayStr()) + 1}` : (p.total || '')}</button>
  </div>
</div>
</div>`;
   
    el.addEventListener('click',()=>openPatient(p.id));
  /*  el.querySelector('button').addEventListener('click',e=>{
      e.stopPropagation();
      openPatient(p.id);
    });
   */ 
    patientListEl.appendChild(el);
  });
  
  // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu ƒëang ·∫©n b·ªánh nh√¢n
  updateHiddenPatientsNotice();
}
function updateHiddenPatientsNotice() {
  // X√≥a th√¥ng b√°o c≈© n·∫øu c√≥
  const oldNotice = document.getElementById('hiddenPatientsNotice');
  if (oldNotice) oldNotice.remove();
  
  if (!showAllPatients) {
    const now = new Date();
    const currentDate = now.toISOString().slice(0,10);
    const currentTime = now.toTimeString().slice(0,5);
    
    const hiddenCount = patients.filter(p => {
      if (!p.discharge) return false;
      
      const dischargeDate = p.discharge;
      const dischargeTime = p.discharge_time || '23:59';
      
      return dischargeDate <= currentDate && 
             (dischargeDate < currentDate || dischargeTime <= currentTime);
    }).length;
    
    if (hiddenCount > 0) {
      const notice = document.createElement('div');
      notice.id = 'hiddenPatientsNotice';
      notice.innerHTML = `
        <div style="
          background: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 8px;
          padding: 8px 12px;
          margin: 10px 0;
          font-size: 13px;
          color: #856404;
          text-align: center;display:none
        ">
          üïí ƒêang ·∫©n ${hiddenCount} b·ªánh nh√¢n ƒë√£ ra vi·ªán 
          (B·∫•m <strong>Ctrl+Q</strong> ƒë·ªÉ hi·ªán t·∫•t c·∫£)
        </div>
      `;
      patientListEl.parentNode.insertBefore(notice, patientListEl);
    }
  }
}
function openPatient(id){
  const p = patients.find(x=>x.id===id); 
  if(!p) return;
  
  const intro = document.getElementById('introScreen');
  if(intro) intro.style.display = 'none';
  currentPatientId=id;
  patientDetailArea.style.display='block';
  patientHeader.innerHTML = `<strong>${p.name||''}</strong><div class="patient-meta">Tu·ªïi ${p.age||''} ‚Ä¢ ${p.gender||''}<br/> ${p.address||''}</div>`;
  
  // Hi·ªÉn th·ªã th√¥ng tin c∆° b·∫£n
  inputs.name.value = p.name||''; 
  inputs.age.value = p.age||''; 
  inputs.gender.value = p.gender||'Nam'; 
  inputs.address.value = p.address||''; 
  inputs.dx.value = p.dx||''; // ‚úÖ Hi·ªÉn th·ªã ch·∫©n ƒëo√°n
  document.getElementById('p_room').value = p.room || '';
  document.getElementById('p_outpatient').checked = !!p.outpatient;

  // C√°c ph·∫ßn kh√°c...
  medList.innerHTML=''; (p.meds||[]).forEach(m=>medList.appendChild(createMedRow(m)));
  thangList.innerHTML=''; (p.thangs||[]).forEach(t=>thangList.appendChild(createThangRow(t)));
  procList.innerHTML=''; (p.procs||[]).forEach(pr=>procList.appendChild(createProcRow(pr)));
  inputs.admit.value = p.admit||''; 
  inputs.discharge.value = p.discharge||''; 
  inputs.total.value = p.total||'';
  document.getElementById('admit_time').value = p.admit_time || '';
  document.getElementById('discharge_time').value = p.discharge_time || '';
  document.getElementById('exam_time').value = p.exam_time || '';
}

function createMedRow(model){
  const row = document.createElement('div'); row.className='med-row';
  row.innerHTML = `
    <input list="mednames" class="med-name" placeholder="T√™n thu·ªëc..." />
    <input class="med-qty" placeholder="S·ªë l∆∞·ª£ng" />
    <input class="med-times" placeholder="S·ªë l·∫ßn/ng√†y" />
    <input class="med-timeinfo" placeholder="Th·ªùi gian d√πng" />
    <select class="med-route">
      <option>U·ªëng</option>
      <option>Ti√™m</option>
      <option>Thu·ª∑ ch√¢m</option>
    </select>
    <div style="display:flex;gap:6px">
      <input type="date" class="med-start" />
      <input type="date" class="med-end" style="display:none" />
      <button class="btn secondary small stopBtn">Ng∆∞ng thu·ªëc</button>
      <button class="btn small removeMed">X√≥a</button>
    </div>`;

  // attach datalist
  if(!document.getElementById('mednames')){
    const dl = document.createElement('datalist'); dl.id='mednames';
    medsSuggest.forEach(m=>{
      const o=document.createElement('option'); o.value=m; dl.appendChild(o);
    });
    document.body.appendChild(dl);
  }

  const nameIn = row.querySelector('.med-name');
  const qtyIn = row.querySelector('.med-qty');
  const timesIn = row.querySelector('.med-times');
  const timeinfo = row.querySelector('.med-timeinfo');
  const route = row.querySelector('.med-route');
  const start = row.querySelector('.med-start');
  const end = row.querySelector('.med-end');
  const stopBtn = row.querySelector('.stopBtn');

  start.value = model?.start || todayStr();
  end.value = model?.end || '';
  nameIn.value = model?.name || '';
  qtyIn.value = model?.qty || '';
  timesIn.value = model?.times || '';
  timeinfo.value = model?.timeinfo || '';
  route.value = model?.route || 'U·ªëng';
  if(end.value) end.style.display='block';

  // preset logic on select name
  nameIn.addEventListener('input',()=>{
    const v = nameIn.value.trim().toLowerCase();
    if(v==='dubemin'){
      qtyIn.value=1;
      timesIn.value=1;
      timeinfo.value='Bu·ªïi s√°ng';
      route.value='Thu·ª∑ ch√¢m';
      themLuaChonThuyCham(row); // ‚úÖ t·ª± hi·ªán ch·ªçn Li√™n ti·∫øp/C√°ch ng√†y
    } else if(v==='mimosa'){
      qtyIn.value=2; timesIn.value=1; timeinfo.value='20:00'; route.value='U·ªëng';
    } else if(v==='piracetam'){
      qtyIn.value=3; timesIn.value=3; timeinfo.value='08:00-14:00-20:00'; route.value='U·ªëng';
    } else if(v==='kamelox'){
      qtyIn.value=1; timesIn.value=1; timeinfo.value='18:00 sau ƒÉn'; route.value='U·ªëng';
    } else if(v==='reumokam'){
      qtyIn.value=1; timesIn.value=1; timeinfo.value='Bu·ªïi t·ªëi 18:00 sau ƒÉn'; route.value='Ti√™m';
    }
  });

  stopBtn.addEventListener('click',()=>{ end.value = todayStr(); end.style.display='block'; });
  row.querySelector('.removeMed').addEventListener('click',()=>{ row.remove(); });
// ‚úÖ N·∫øu thu·ªëc ƒë√£ c√≥ Thu·ª∑ ch√¢m, kh√¥i ph·ª•c l·ª±a ch·ªçn mode
if(model?.route === 'Thu·ª∑ ch√¢m') {
  themLuaChonThuyCham(row); // th√™m dropdown Li√™n ti·∫øp / C√°ch ng√†y
  const select = row.querySelector('.thuycham-mode');
  if(select && model.mode) select.value = model.mode; // ch·ªçn l·∫°i gi√° tr·ªã ƒë√£ l∆∞u
}
  return row;
}

function createThangRow(model){
  const row = document.createElement('div'); row.className='thang-row';
  row.innerHTML = `
    <input class="thang-name" placeholder="T√™n thang..." />
    <input type="date" class="thang-start" />
    <input type="date" class="thang-end" />
    <input class="thang-count" readonly placeholder="S·ªë thang" />
    <div style="display:flex;gap:6px">
      <button class="btn small calcThang"style="display:none">T√≠nh</button>
      <button class="btn small removeThang">X√≥a</button>
    </div>`;
  const name = row.querySelector('.thang-name'); const s = row.querySelector('.thang-start'); const e = row.querySelector('.thang-end'); const cnt = row.querySelector('.thang-count');
  s.value = model?.start||''; e.value = model?.end||''; name.value = model?.name||'';
  function calc(){ if(s.value && e.value){ const a=new Date(s.value), b=new Date(e.value); const diff = Math.round((b-a)/(1000*60*60*24))+1; cnt.value = diff>0? diff:0 } }
  row.querySelector('.calcThang').addEventListener('click',calc);
  [s,e].forEach(el=>el.addEventListener('change',calc));
  row.querySelector('.removeThang').addEventListener('click',()=>row.remove());
  return row;
}

function createProcRow(model){
  const row = document.createElement('div'); row.className='proc-row';
  row.innerHTML = `
    <select class="proc-type"><option>ƒêi·ªán ch√¢m</option><option>H·ªìng ngo·∫°i</option><option>Xoa b√≥p</option><option>Thu·ª∑ ch√¢m</option><option>Gi√°c h∆°i</option></select>
    <input type="date" class="proc-start" />
    <input type="date" class="proc-end" />
    <input class="proc-days" readonly placeholder="S·ªë ng√†y" />
    <div style="display:flex;gap:6px">
      <button class="btn small calcProc"style="display:none">T√≠nh</button>
      <button class="btn small removeProc">X√≥a</button>
    </div>`;
  const type = row.querySelector('.proc-type'); const s = row.querySelector('.proc-start'); const e = row.querySelector('.proc-end'); const days = row.querySelector('.proc-days');
  s.value = model?.start||''; e.value = model?.end||''; type.value = model?.type||'ƒêi·ªán ch√¢m';
  function calc(){ if(type.value==='Thu·ª∑ ch√¢m'){ s.value = todayStr(); e.value = todayStr(); days.value=1; return;} if(type.value==='Gi√°c h∆°i'){ s.value = todayStr(); e.value = addDays(s.value,4); days.value = 5; return;} if(s.value && e.value){ const d = daysBetween(s.value,e.value); days.value = d!==''? d+1 : '';} }
  row.querySelector('.calcProc').addEventListener('click',calc);
  type.addEventListener('change',calc);
  [s,e].forEach(el=>el.addEventListener('change',()=>{ if(s.value && e.value){ const d = daysBetween(s.value,e.value); days.value = d!==''? d+1 : '';} }));
  row.querySelector('.removeProc').addEventListener('click',()=>row.remove());
  return row;
}

// events
addPatientBtn.addEventListener('click', () => {
  // ‚úÖ ki·ªÉm tra ƒëƒÉng nh·∫≠p
  if (!localStorage.getItem('isLoggedIn')) {
    pendingOpenId = null;
    loginModal.style.display = 'flex';
    loginPassword.value = '';
    loginError.style.display = 'none';
    setTimeout(() => loginPassword.focus(), 100);
    return;
  }

  // ‚úÖ L√†m tr·ªëng form th√™m b·ªánh nh√¢n
  document.getElementById('new_name').value = '';
  document.getElementById('new_age').value = '';
  document.getElementById('new_gender').value = 'Nam';
  document.getElementById('new_address').value = '';
  document.getElementById('new_dx').value = '';
document.getElementById('new_room').value = '';  // L√†m tr·ªëng ch·∫©n ƒëo√°n
  // ‚úÖ L·∫•y ng√†y gi·ªù hi·ªán t·∫°i
  const now = new Date();
  const today = now.toISOString().slice(0,10);
  const time = now.toTimeString().slice(0,5);
  document.getElementById('new_admit_date').value = today;
  document.getElementById('new_admit_time').value = time;

  // ‚úÖ Hi·ªÉn th·ªã modal
  modal.classList.add('open');
});
modalClose.addEventListener('click',()=>modal.classList.remove('open'));
modalSave.addEventListener('click', async ()=>{
  const name = document.getElementById('new_name').value.trim();
  const age = document.getElementById('new_age').value; 
  const gender = document.getElementById('new_gender').value; 
  const address = document.getElementById('new_address').value;
  const dx = document.getElementById('new_dx').value; // L·∫•y ch·∫©n ƒëo√°n t·ª´ new_dx
  const room = document.getElementById('new_room').value;
const admit_date = document.getElementById('new_admit_date').value;
const admit_time = document.getElementById('new_admit_time').value;

  if (!name) {
    alert('Vui l√≤ng nh·∫≠p t√™n b·ªánh nh√¢n');
    return;
  }
  
  const id = 'p_'+Date.now();
  const p = {
    id, 
    name, 
    age, 
    gender, 
	outpatient: document.getElementById('new_outpatient').checked,
    address, 
    dx, // Th√™m ch·∫©n ƒëo√°n v√†o object b·ªánh nh√¢n
	room,
    meds:[], 
    thangs:[], 
    procs:[], 
	admit: admit_date,
    admit_time: admit_time,
    discharge:'', 
    total:'',
    discharge_time: '',
    exam_time: '',
	
  };
  
  patients.push(p); 
  await savePatientsToDropbox(patients); 
  modal.classList.remove('open'); 
  renderPatientList(); 
  openPatient(id);
});

document.getElementById('search').addEventListener('input',e=>renderPatientList(e.target.value));

addMedBtn.addEventListener('click',()=>{
  const newRow = createMedRow({});
  medList.prepend(newRow); // ‚úÖ th√™m thu·ªëc m·ªõi l√™n tr√™n c√πng
});
addThangBtn.addEventListener('click',()=> thangList.appendChild(createThangRow({})));

// add default one med/thang/proc when new open
function ensureSections(){ if(medList.children.length===0) medList.appendChild(createMedRow({})); if(thangList.children.length===0) thangList.appendChild(createThangRow({})); if(procList.children.length===0) procList.appendChild(createProcRow({})); }

savePatientBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  p.name = inputs.name.value.trim(); p.age = inputs.age.value; p.gender = inputs.gender.value; p.address = inputs.address.value; p.dx = inputs.dx.value;p.room = document.getElementById('p_room').value;p.outpatient = document.getElementById('p_outpatient').checked;


  // meds
  p.meds = Array.from(medList.children).map(r=>({
    name: r.querySelector('.med-name').value,
    qty: r.querySelector('.med-qty').value,
    times: r.querySelector('.med-times').value,
    timeinfo: r.querySelector('.med-timeinfo').value,
    route: r.querySelector('.med-route').value,
    start: r.querySelector('.med-start').value,
  end: r.querySelector('.med-end').value,
  mode: r.querySelector('.thuycham-mode') ? r.querySelector('.thuycham-mode').value : 'Li√™n ti·∫øp'  // ‚úÖ th√™m d√≤ng n√†y
})).filter(m=>m.name||m.qty||m.times);
  // thangs
  p.thangs = Array.from(thangList.children).map(r=>({
    name: r.querySelector('.thang-name').value,
    start: r.querySelector('.thang-start').value,
    end: r.querySelector('.thang-end').value,
    count: r.querySelector('.thang-count').value
  })).filter(t=>t.name||t.start||t.end);
  // procs
  p.procs = Array.from(procList.children).map(r=>({
    type: r.querySelector('.proc-type').value,
    start: r.querySelector('.proc-start').value,
    end: r.querySelector('.proc-end').value,
    days: r.querySelector('.proc-days').value
  })).filter(x=>x.type);
  // dates
  p.admit = inputs.admit.value; p.discharge = inputs.discharge.value;
  p.admit_time = document.getElementById('admit_time').value;
p.discharge_time = document.getElementById('discharge_time').value;
p.exam_time = document.getElementById('exam_time').value;
  if(p.admit && p.discharge){ const tot = parseInt(daysBetween(p.admit,p.discharge)); p.total = isNaN(tot)?'': tot+1; } else p.total=''; inputs.total.value = p.total;
// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
  // Hi·ªÉn th·ªã th√¥ng b√°o l∆∞u th√†nh c√¥ng
const toast = document.getElementById('saveToast');
toast.style.opacity = '1';
setTimeout(()=>{ toast.style.opacity = '0'; }, 1000); // ·∫©n sau 1 gi√¢y

})();
  savePatientBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  p.name = inputs.name.value.trim(); 
  p.age = inputs.age.value; 
  p.gender = inputs.gender.value; 
  p.address = inputs.address.value; 
  p.dx = inputs.dx.value;
  p.room = document.getElementById('p_room').value;
  p.outpatient = document.getElementById('p_outpatient').checked;

  // meds
  p.meds = Array.from(medList.children).map(r=>({
    name: r.querySelector('.med-name').value,
    qty: r.querySelector('.med-qty').value,
    times: r.querySelector('.med-times').value,
    timeinfo: r.querySelector('.med-timeinfo').value,
    route: r.querySelector('.med-route').value,
    start: r.querySelector('.med-start').value,
    end: r.querySelector('.med-end').value,
    mode: r.querySelector('.thuycham-mode') ? r.querySelector('.thuycham-mode').value : 'Li√™n ti·∫øp' // ‚úÖ th√™m d√≤ng n√†y n·∫øu ch∆∞a c√≥
  })).filter(m=>m.name||m.qty||m.times);

  // thangs
  p.thangs = Array.from(thangList.children).map(r=>({
    name: r.querySelector('.thang-name').value,
    start: r.querySelector('.thang-start').value,
    end: r.querySelector('.thang-end').value,
    count: r.querySelector('.thang-count').value
  })).filter(t=>t.name||t.start||t.end);

  // procs
  p.procs = Array.from(procList.children).map(r=>({
    type: r.querySelector('.proc-type').value,
    start: r.querySelector('.proc-start').value,
    end: r.querySelector('.proc-end').value,
    days: r.querySelector('.proc-days').value
  })).filter(x=>x.type);

  // dates
  p.admit = inputs.admit.value; 
  p.discharge = inputs.discharge.value;
  p.admit_time = document.getElementById('admit_time').value;
p.discharge_time = document.getElementById('discharge_time').value;
p.exam_time = document.getElementById('exam_time').value;
  if(p.admit && p.discharge){
    const tot = parseInt(daysBetween(p.admit,p.discharge));
    p.total = isNaN(tot)?'': tot+1;
  } else p.total='';
  inputs.total.value = p.total;

// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
})();
  capNhatThongBao();
canhBaoSoNgayNamVien();

});
});

saveWordBtn.addEventListener('click',()=>{
  if(!currentPatientId) return alert('Ch·ªçn b·ªánh nh√¢n tr∆∞·ªõc');
  const p = patients.find(x=>x.id===currentPatientId);
  // build html content for doc
  let html = `<html><head><meta charset="utf-8"><title>H·ªì s∆° ${p.name}</title></head><body>`;
  html += `<h2>H·ªì s∆° b·ªánh nh√¢n: ${p.name}</h2>`;
  html += `<p>Tu·ªïi: ${p.age} ‚Ä¢ Gi·ªõi: ${p.gender}</p>`;
  html += `<p>ƒê·ªãa ch·ªâ: ${p.address||''}</p>`;
  html += `<h3>Ch·∫©n ƒëo√°n</h3><p>${p.dx||''}</p>`;
  html += `<h3>Thu·ªëc t√¢n d∆∞·ª£c</h3><ul>`;
  (p.meds||[]).forEach(m=>{ html += `<li>${m.name} ‚Äî SL:${m.qty} ‚Ä¢ l·∫ßn/ng√†y:${m.times} ‚Ä¢ ${m.timeinfo} ‚Ä¢ ƒë∆∞·ªùng: ${m.route} ‚Ä¢ ${m.start||''} ‚Üí ${m.end||''}</li>`}); html += `</ul>`;
  html += `<h3>Thu·ªëc s·∫Øc</h3><ul>`; (p.thangs||[]).forEach(t=>{ html += `<li>${t.name} ‚Äî ${t.start||''} ‚Üí ${t.end||''} ‚Ä¢ ${t.count||''} thang</li>`}); html += `</ul>`;
  html += `<h3>Th·ªß thu·∫≠t</h3><ul>`; (p.procs||[]).forEach(pr=>{ html += `<li>${pr.type} ‚Äî ${pr.start||''} ‚Üí ${pr.end||''} ‚Ä¢ ${pr.days||''} ng√†y</li>`}); html += `</ul>`;
html += `<p>Ng√†y v√†o: ${p.admit||''} ${p.admit_time ? '('+p.admit_time+')' : ''} ‚Ä¢ 
Ng√†y ra: ${p.discharge||''} ${p.discharge_time ? '('+p.discharge_time+')' : ''} ‚Ä¢ 
T·ªïng: ${p.total||''}</p>`;
html += `<p>Gi·ªù kh√°m: ${p.exam_time||''}</p>`;
  html += `</body></html>`;

  // save into localStorage per patient
  localStorage.setItem('patient_doc_'+p.id, html);
  // create downloadable .doc
  const blob = new Blob([html], {type:'application/msword'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `${p.name||'patient'}_${p.id}.doc`; a.click(); URL.revokeObjectURL(url);

});



// ====== N√öT X√ìA B·ªÜNH NH√ÇN (C√ì POPUP) ======
window.addEventListener('load', () => {
  const deleteModal = document.getElementById('deleteConfirm');
  const deleteText = document.getElementById('deleteText');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');
  const deletePatientBtn = document.getElementById('deletePatientBtn');

  if (!deleteModal || !deletePatientBtn) return; // n·∫øu popup ch∆∞a c√≥ th√¨ tho√°t

  deletePatientBtn.addEventListener('click', () => {
    if (!currentPatientId) return alert('Ch∆∞a ch·ªçn b·ªánh nh√¢n!');
    const p = patients.find(x => x.id === currentPatientId);
    if (!p) return;

    deleteText.innerHTML = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a <b>${p.name}</b> kh·ªèi danh s√°ch kh√¥ng?`;
    deleteModal.style.display = 'flex';
  });

  // H·ªßy x√≥a
  cancelDelete.addEventListener('click', () => {
    deleteModal.style.display = 'none';
  });

  // X√°c nh·∫≠n x√≥a
confirmDelete.addEventListener('click', async () => {
    const p = patients.find(x => x.id === currentPatientId);
    if (!p) return;

    patients = patients.filter(x => x.id !== currentPatientId);
await savePatientsToDropbox(patients);


    deleteModal.style.display = 'none';
    document.getElementById('patientDetailArea').style.display = 'none';
    const intro = document.getElementById('introScreen');
    if (intro) intro.style.display = 'block';
    currentPatientId = null;
    renderPatientList();
  });
});



// when opening patient ensure sections exist
document.addEventListener('click',(e)=>{
  if(e.target && e.target.matches('.patient-item')){
    const id = e.target.getAttribute('data-id'); if(id) openPatient(id);
  }
});

// update total days when admit/discharge change
inputs.admit.addEventListener('change',()=>{ if(inputs.admit.value && inputs.discharge.value){ const tot=daysBetween(inputs.admit.value, inputs.discharge.value); inputs.total.value = tot!==''? tot+1 : ''; } });
inputs.discharge.addEventListener('change',()=>{ if(inputs.admit.value && inputs.discharge.value){ const tot=daysBetween(inputs.admit.value, inputs.discharge.value); inputs.total.value = tot!==''? tot+1 : ''; } });

// initial render
renderPatientList();
// ‚úÖ Hi·ªÉn th·ªã m√†n h√¨nh gi·ªõi thi·ªáu thay v√¨ m·ªü b·ªánh nh√¢n ƒë·∫ßu ti√™n
// ‚úÖ T·∫°o div ri√™ng cho trang gi·ªõi thi·ªáu, th√™m v√†o ph√≠a tr√™n
const introDiv = document.createElement("div");
introDiv.id = "introScreen";
introDiv.innerHTML = `
  <div style="text-align:center;padding:60px 20px;color:#444;line-height:1.6">
    <h1 style="color:#ff7a18;font-size:28px;margin-bottom:16px">üè• Ph·∫ßn m·ªÅm Qu·∫£n l√Ω B·ªánh nh√¢n</h1>
	  <h3 style="color:#ff7a18;font-size:28px;margin-bottom:16px">Bs.Ch√¢u - 079.567.9350</h3>
    <p style="font-size:16px">
      Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <strong>Doctor Ch√¢u Clinic System</strong> ‚Äî n·ªÅn t·∫£ng qu·∫£n l√Ω h·ªì s∆° b·ªánh nh√¢n hi·ªán ƒë·∫°i, t·ª± ƒë·ªông v√† th√¢n thi·ªán.<br>
      H·ªá th·ªëng h·ªó tr·ª£:
    </p>
    <ul style="text-align:left;display:inline-block;margin:16px auto;font-size:15px;line-height:1.8">
      <li>üîπ Qu·∫£n l√Ω th√¥ng tin b·ªánh nh√¢n, thu·ªëc, th·ªß thu·∫≠t, ng√†y v√†o ‚Äì ra vi·ªán</li>
      <li>üîπ Theo d√µi v√† c·∫£nh b√°o t·ª± ƒë·ªông Th·ªßy ch√¢m, Ti√™m</li>
      <li>üîπ L∆∞u, xu·∫•t h·ªì s∆° sang Word nhanh ch√≥ng</li>
    </ul>
    <p style="margin-top:20px;font-size:14px;color:#666">
      üëâ H√£y ch·ªçn b·ªánh nh√¢n ·ªü khung b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu xem v√† ch·ªânh s·ª≠a h·ªì s∆°.
    </p>
  </div>   
`;
document.querySelector('.main').appendChild(introDiv);



// open first patient by default
//if(patients[0]) openPatient(patients[0].id); ensureSections();

/* ====== TH√îNG B√ÅO THU·ª∂ CH√ÇM + TI√äM ====== */
const thongBaoChung = document.createElement('div');
thongBaoChung.id = 'thongBaoChung';
thongBaoChung.style.cssText = `
  background:#fff3e0;
  border:1px solid #ffc085;
  border-radius:10px;
  padding:10px 14px;
  margin-top:15px;
  font-size:14px;
  color:#b34700;
  line-height:1.5;
`;
document.querySelector('.main').prepend(thongBaoChung);

function laCuoiTuan(d){
  const day = d.getDay();
  return day===5 || day===6 || day===0; // T6-T7-CN
}

function tinhNgayCanLen(route, startDate, mode, dischargeDate, patient) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  const start = new Date(startDate);
  const discharge = dischargeDate ? new Date(dischargeDate) : null;
  const danhSach = [];

  if (route !== 'Thu·ª∑ ch√¢m' && route !== 'Ti√™m') return danhSach;

  // L·∫•y t·∫•t c·∫£ thu·ªëc c√πng t√™n v√† c√πng route
  const medsCungLoai = (patient.meds || []).filter(m => 
    m.route === route && 
    m.name?.trim().toLowerCase() === patient.meds.find(x => x.start === startDate)?.name?.trim().toLowerCase()
  );

  // ‚úÖ L·∫•y ng√†y start m·ªõi nh·∫•t (l·∫ßn l√™n g·∫ßn nh·∫•t)
  const latest = medsCungLoai.reduce((a,b)=> new Date(a.start) > new Date(b.start) ? a : b, medsCungLoai[0]);
  const lastDate = latest ? new Date(latest.start) : start;

  if (discharge && discharge < today) return danhSach; // ra vi·ªán r·ªìi

  const maxDate = discharge && discharge < tomorrow ? discharge : tomorrow;

  if (route === 'Thu·ª∑ ch√¢m') {
    const isCachNgay = (mode === 'C√°ch ng√†y');
    const nextDate = new Date(lastDate);
    nextDate.setDate(nextDate.getDate() + (isCachNgay ? 2 : 1));

    // ‚öôÔ∏è N·∫øu ng√†y ti·∫øp theo > h√¥m nay m√† <= ng√†y mai th√¨ m·ªõi b√°o
    if (nextDate.toDateString() === tomorrow.toDateString()) {
      danhSach.push(nextDate);
    }
  } else if (route === 'Ti√™m') {
    if (tomorrow <= maxDate) danhSach.push(tomorrow);
  }

  return danhSach;
}



function dinhDangNgayVN(d){return d.toLocaleDateString('vi-VN',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'})}
// ‚ö†Ô∏è Ki·ªÉm tra b·ªánh nh√¢n n·∫±m qu√° ng√†y (ngo·∫°i tr√∫ >14, n·ªôi tr√∫ >24)
function canhBaoSoNgayNamVien() {
  let html = '';
  const today = todayStr();

  patients.forEach(p => {
    if (p.admit && !p.discharge) {
      const days = daysBetween(p.admit, today) + 1;
      if (p.outpatient && days > 14) {
        html += `<div><strong style="color:red">${p.name}</strong> (Ngo·∫°i tr√∫) n·∫±m ${days} ng√†y</div>`;
        // t√¥ ƒë·ªè t√™n b√™n danh s√°ch
        const item = [...document.querySelectorAll('.patient-item')]
          .find(el => el.textContent.includes(p.name));
        if (item) item.style.color = 'red';
      } else if (!p.outpatient && days > 24) {
        html += `<div><strong style="color:red">${p.name}</strong> (N·ªôi tr√∫) n·∫±m ${days} ng√†y</div>`;
        const item = [...document.querySelectorAll('.patient-item')]
          .find(el => el.textContent.includes(p.name));
        if (item) item.style.color = 'red';
      }
    }
  });

  if (html) {
    thongBaoChung.innerHTML = html + '<hr>' + thongBaoChung.innerHTML;
  }
}

function capNhatThongBao(){
  let html = '';
  const today = new Date();
  
  // D√πng Set ƒë·ªÉ theo d√µi c√°c th√¥ng b√°o ƒë√£ hi·ªÉn th·ªã
  const daThongBao = new Set();
  
  patients.forEach(p => {
    // Ki·ªÉm tra n·∫øu b·ªánh nh√¢n ƒë√£ ra vi·ªán v√† ng√†y ra vi·ªán ƒë√£ qua th√¨ b·ªè qua
    if (p.discharge) {
      const dischargeDate = new Date(p.discharge);
      if (dischargeDate < today) {
        return; // b·ªè qua b·ªánh nh√¢n n√†y
      }
    }

    const tiems = (p.meds||[]).filter(m => m.route === 'Ti√™m' && !m.end);
    const demThuocTiem = {};

    // ƒê·∫øm s·ªë l·∫ßn ti√™m theo t√™n thu·ªëc
    tiems.forEach(m => {
      const ten = m.name?.trim().toLowerCase() || '(ch∆∞a ƒë·∫∑t t√™n)';
      demThuocTiem[ten] = (demThuocTiem[ten] || 0) + 1;
    });

    // N·∫øu t√™n thu·ªëc ti√™m c√≥ h∆°n 3 l·∫ßn -> c·∫£nh b√°o
    Object.keys(demThuocTiem).forEach(ten => {
      if(demThuocTiem[ten] > 3){
        const key = `${p.id}_${ten}_tiem`;
        if (!daThongBao.has(key)) {
          html += `<div><strong>${p.name}</strong>: Thu·ªëc <b>${ten}</b> ti√™m qu√° 3 l·∫ßn (${demThuocTiem[ten]} l·∫ßn).</div>`;
          daThongBao.add(key);
        }
      }
    });

    // Th·ªßy ch√¢m v√† Ti√™m - CH·ªà L·∫§Y THU·ªêC CH∆ØA C√ì END
    (p.meds||[]).forEach(m => {
      if((m.route === 'Thu·ª∑ ch√¢m' || m.route === 'Ti√™m') && m.start && !m.end){
        const danhSach = tinhNgayCanLen(m.route, m.start, m.mode || 'Li√™n ti·∫øp', p.discharge, p);

        if(danhSach.length > 0){
          const ngayText = danhSach.map(d => dinhDangNgayVN(d)).join(', ');
          const key = `${p.id}_${m.route}_${m.name}_${ngayText}`;
          
          // Ch·ªâ th√™m th√¥ng b√°o n·∫øu ch∆∞a c√≥
          if (!daThongBao.has(key)) {
            html += `<div><strong>${p.name}</strong>: Ch∆∞a l√™n thu·ªëc <b>${m.route}</b> cho c√°c ng√†y: ${ngayText}</div>`;
            daThongBao.add(key);
          }
        }
      }
    });
  });
  
  thongBaoChung.innerHTML = html || '‚úÖ Kh√¥ng c√≥ th√¥ng b√°o c·∫ßn nh·∫Øc.';
}
/* ====== Th√™m 2 selection khi ch·ªçn Thu·ª∑ ch√¢m ====== */
function themLuaChonThuyCham(row){
  if(row.querySelector('.thuycham-mode')) return;
  const select = document.createElement('select');
  select.className='thuycham-mode';
  select.innerHTML = `<option>Li√™n ti·∫øp</option><option>C√°ch ng√†y</option>`;
  row.querySelector('.med-route').after(select);
  select.addEventListener('change',()=> {
    const p = patients.find(x=>x.id===currentPatientId);
    if(!p) return;
    const tenThuoc = row.querySelector('.med-name').value;
    const med = (p.meds||[]).find(m=>m.name===tenThuoc);
    if(med) { med.mode = select.value; 
	
// persist list
(async ()=>{
  await savePatientsToDropbox(patients);
  renderPatientList();
  // Hi·ªÉn th·ªã th√¥ng b√°o l∆∞u th√†nh c√¥ng
const toast = document.getElementById('saveToast');
toast.style.opacity = '1';
setTimeout(()=>{ toast.style.opacity = '0'; }, 1000); // ·∫©n sau 1 gi√¢y

})();
	
	
	capNhatThongBao();
canhBaoSoNgayNamVien();
 }
  });
}

document.addEventListener('change',e=>{
  if(e.target && e.target.classList.contains('med-route')){
    const row = e.target.closest('.med-row');
    if(e.target.value==='Thu·ª∑ ch√¢m'){ themLuaChonThuyCham(row); }
  }
});
// ‚úÖ T·ª± ƒë·ªông hi·ªán ch·ªçn Li√™n ti·∫øp / C√°ch ng√†y n·∫øu load form c√≥ s·∫µn Thu·ª∑ ch√¢m
document.querySelectorAll('.med-route').forEach(sel=>{
  if(sel.value==='Thu·ª∑ ch√¢m'){
    const row = sel.closest('.med-row');
    themLuaChonThuyCham(row);
  }
});


</script>







<script>
// ‚úÖ Cho ph√©p k√©o gi√£n sidebar b·∫±ng divider
const sidebar = document.querySelector('.sidebar');
const divider = document.getElementById('divider');
const main = document.querySelector('.main');

let isDragging = false;

divider.addEventListener('mousedown', e => {
  isDragging = true;
  document.body.style.userSelect = 'none';
});

window.addEventListener('mouseup', e => {
  if(isDragging){
    isDragging = false;
    document.body.style.userSelect = 'auto';
    // ‚úÖ l∆∞u l·∫°i ƒë·ªô r·ªông sidebar ƒë·ªÉ nh·ªõ l·∫ßn sau
    localStorage.setItem('sidebarWidth', sidebar.offsetWidth);
  }
});

window.addEventListener('mousemove', e => {
  if(!isDragging) return;
  const newWidth = e.clientX - sidebar.getBoundingClientRect().left;
  if(newWidth > 150 && newWidth < 500){
    sidebar.style.width = newWidth + 'px';
  }
});

// ‚úÖ kh√¥i ph·ª•c ƒë·ªô r·ªông sidebar khi t·∫£i l·∫°i trang
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('sidebarWidth');
  if(saved) sidebar.style.width = saved + 'px';
});
/* ====== PH√çM T·∫ÆT: Ctrl+S, Ctrl+Shift+S ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + S ‚Üí L∆∞u b·ªánh nh√¢n
  if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 's') {
    e.preventDefault(); // ch·∫∑n tr√¨nh duy·ªát l∆∞u trang
    const saveBtn = document.getElementById('savePatientBtn');
    if (saveBtn) saveBtn.click();
  }

  // Ctrl + Shift + S ‚Üí L∆∞u Word
  if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 's') {
    e.preventDefault();
    const saveWordBtn = document.getElementById('saveWordBtn');
    if (saveWordBtn) saveWordBtn.click();
  }
});/* ====== PH√çM T·∫ÆT: Ctrl+L ·∫©n/hi·ªán Th√¥ng tin c∆° b·∫£n ====== */
document.addEventListener('keydown', function(e) {
  // Ki·ªÉm tra Ctrl + L
  if (e.ctrlKey && e.key.toLowerCase() === 'l') {
    e.preventDefault();
    // T√¨m ph·∫ßn Th√¥ng tin c∆° b·∫£n
    const infoSection = document.querySelector('h3')?.textContent.includes('Th√¥ng tin c∆° b·∫£n')
      ? document.querySelector('h3').closest('.section')
      : document.querySelector('.section:nth-of-type(1)'); // fallback n·∫øu c√≥ thay ƒë·ªïi
    if (!infoSection) return;

    // Toggle display
    if (infoSection.style.display === 'none') {
      infoSection.style.display = ''; // hi·ªán l·∫°i
    } else {
      infoSection.style.display = 'none'; // ·∫©n ƒëi
    }
	
  }
});
/* ====== PH√çM T·∫ÆT: Ctrl+S, Ctrl+Shift+S ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + S ‚Üí L∆∞u b·ªánh nh√¢n
    if (e.key === 'Escape') {
   e.preventDefault();
    const cancelBtn = document.getElementById('cancelBtn');
    if (cancelBtn) cancelBtn.click();
  }
});
/* ===== B·∫ÆT PH√çM F5 ƒê·ªÇ RELOAD TRANG ===== */
document.addEventListener('keydown', function(e) {
  if (e.key === 'F5') {
    
    location.reload();  // ‚úÖ reload l·∫°i to√†n b·ªô trang theo √Ω m√¨nh
  }
});
</script>


<style>
@keyframes fadeIn {
  from {opacity:0; transform:translateY(-10px);}
  to {opacity:1; transform:translateY(0);}
}
</style>
<!-- ===== POPUP X√ÅC NH·∫¨N X√ìA ===== -->
<div id="deleteConfirm" class="modal" style="display:none;">
  <div class="card" style="width:360px;backdrop-filter:blur(10px);background:rgba(255,255,255,0.95);text-align:center;animation:fadeIn 0.3s ease;">
    <h3 style="color:#c0392b;">üóë X√≥a b·ªánh nh√¢n</h3>
    <p id="deleteText" style="margin:12px 0 18px;color:#555;">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·ªánh nh√¢n n√†y kh√¥ng?</p>
    <div style="display:flex;justify-content:center;gap:10px;">
      <button class="btn secondary" id="cancelDelete">H·ªßy</button>
      <button class="btn" id="confirmDelete" style="background:#e74c3c;">X√≥a</button>
    </div>
  </div>
</div>


<!-- ===== POPUP ƒêƒÇNG NH·∫¨P ===== -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="card" style="width:340px;backdrop-filter:blur(10px);background:rgba(255,255,255,0.95);text-align:center;animation:fadeIn 0.3s ease;">
    <h3 style="color:#ff7a18;">üîí ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
    <p style="margin:12px 0 8px;color:#555;">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ xem chi ti·∫øt b·ªánh nh√¢n</p>
    <input id="loginPassword" type="password" placeholder="M·∫≠t kh·∫©u" style="padding:8px;width:80%;border-radius:8px;border:1px solid #ffd9b0;">
    <div style="display:flex;justify-content:center;gap:10px;margin-top:16px;">
      <button class="btn secondary" id="cancelLogin">H·ªßy</button>
      <button class="btn" id="confirmLogin">ƒêƒÉng nh·∫≠p</button>
    </div>
    <p id="loginError" style="color:#c0392b;font-size:13px;margin-top:10px;display:none;">Sai m·∫≠t kh·∫©u!</p>
  </div>
</div>
<!-- ===== POPUP TH·ªêNG K√ä ===== -->
<div id="popupThongKe" class="modal" style="display:none;">
  <div class="card" style="width:800px;max-height:90vh;overflow:auto;">
    <h3 id="popupTitle" style="color:#ff7a18;margin-bottom:10px;">Th·ªëng k√™</h3>
    <div id="popupContent" style="font-size:14px;line-height:1.6;color:#444;"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;">
      <button class="btn secondary" id="closePopup">ƒê√≥ng</button>
    </div>
  </div>
</div>
<script>/* ===== ƒêƒÇNG NH·∫¨P XEM H·ªí S∆† ===== */
const loginModal = document.getElementById('loginModal');
const loginPassword = document.getElementById('loginPassword');
const loginError = document.getElementById('loginError');
const cancelLogin = document.getElementById('cancelLogin');
const confirmLogin = document.getElementById('confirmLogin');

let pendingOpenId = null; // l∆∞u b·ªánh nh√¢n ƒë·ªãnh m·ªü tr∆∞·ªõc khi ƒëƒÉng nh·∫≠p
const CORRECT_PASSWORD = "1!"; // üîë thay m·∫≠t kh·∫©u t·∫°i ƒë√¢y

// --- B·ªçc l·∫°i h√†m openPatient ƒë·ªÉ y√™u c·∫ßu ƒëƒÉng nh·∫≠p ---
const originalOpenPatient = openPatient;
openPatient = function(id) {
  if (!localStorage.getItem('isLoggedIn')) {
    pendingOpenId = id;
    loginModal.style.display = 'flex';
    loginPassword.value = '';
    loginError.style.display = 'none';
    // üëá t·ª± ƒë·ªông focus v√†o √¥ nh·∫≠p m·∫≠t kh·∫©u
    setTimeout(() => loginPassword.focus(), 100);
    return;
  }
  originalOpenPatient(id);
};

// --- X·ª≠ l√Ω ƒëƒÉng nh·∫≠p ---
function doLogin() {
  if (loginPassword.value === CORRECT_PASSWORD) {
    localStorage.setItem('isLoggedIn', 'true');
    loginModal.style.display = 'none';
    loginError.style.display = 'none';
    showLogoutButton();
    if (pendingOpenId) {
      originalOpenPatient(pendingOpenId);
      pendingOpenId = null;
    }
  } else {
    loginError.style.display = 'block';
  }
}

confirmLogin.addEventListener('click', doLogin);
cancelLogin.addEventListener('click', () => {
  loginModal.style.display = 'none';
});

// ‚úÖ B·∫•m Enter trong √¥ m·∫≠t kh·∫©u c≈©ng ƒëƒÉng nh·∫≠p
loginPassword.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    doLogin();
  }
});

// --- H√†m t·∫°o n√∫t ƒëƒÉng xu·∫•t ---
function showLogoutButton() {
  if (document.getElementById('logoutBtn')) return; // ƒë√£ c√≥ th√¨ th√¥i
  const logoutBtn = document.createElement('button');
  logoutBtn.id = 'logoutBtn';
  logoutBtn.textContent = 'üö™ ƒêƒÉng xu·∫•t (Bs.Ch√¢u)';
  logoutBtn.className = 'btn secondary';
  logoutBtn.style.float = 'right';
  logoutBtn.style.marginLeft = '10px';
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('isLoggedIn');

    document.getElementById('logoutBtn').remove();
    // ·∫®n chi ti·∫øt b·ªánh nh√¢n n·∫øu ƒëang xem
    document.getElementById('patientDetailArea').style.display = 'none';
    const intro = document.getElementById('introScreen');
    if (intro) intro.style.display = 'block';
  });
  document.querySelector('.header').appendChild(logoutBtn);
}

// --- N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p tr∆∞·ªõc ƒë√≥, t·ª± hi·ªán n√∫t ---
window.addEventListener('load', () => {
  if (localStorage.getItem('isLoggedIn')) {
    showLogoutButton();
  }
});






/* ===== TH·ªêNG K√ä NHANH: TI√äM / VI√äN / S·∫ÆC / GI·ªú ===== */
const popup = document.getElementById('popupThongKe');
const popupTitle = document.getElementById('popupTitle');
const popupContent = document.getElementById('popupContent');
const closePopup = document.getElementById('closePopup');
closePopup.addEventListener('click',()=>popup.style.display='none');

function showPopup(title, html){
  popupTitle.textContent = title;
  popupContent.innerHTML = html;
  popup.style.display = 'flex';
}

/* === TI√äM === */
document.getElementById('btnTiem').addEventListener('click',()=>{
  let html = '';
  const now = new Date();
  const currentDate = now.toISOString().slice(0,10);
  const currentTime = now.toTimeString().slice(0,5);
  
  patients.forEach(p=>{
    // ‚úÖ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN RA VI·ªÜN: c√≥ ng√†y ra V√Ä ƒë√£ t·ªõi ng√†y V√Ä ƒë√£ t·ªõi gi·ªù
    if (p.discharge) {
      const dischargeDate = p.discharge;
      const dischargeTime = p.discharge_time || '23:59';
      
      // N·∫øu ƒë√£ t·ªõi ng√†y ra vi·ªán V√Ä ƒë√£ t·ªõi gi·ªù ra vi·ªán -> b·ªè qua
      if (dischargeDate <= currentDate && 
          (dischargeDate < currentDate || dischargeTime <= currentTime)) {
        return; // b·ªè qua b·ªánh nh√¢n n√†y
      }
    }

    const tiemList = (p.meds||[]).filter(m=>m.route==='Ti√™m' || m.route==='Thu·ª∑ ch√¢m');
    if(tiemList.length){
      // Gom nh√≥m theo t√™n thu·ªëc
      const grouped = {};
      tiemList.forEach(m=>{
        const name = m.name?.trim() || '(Kh√¥ng t√™n)';
        if(!grouped[name]) grouped[name] = [];
        grouped[name].push(m.start || '');
      });

      // Xu·∫•t HTML
      html += `<h4 style="margin-top:10px;color:#e67e22;">B·ªánh nh√¢n: ${p.name} <span style="color:#FF0000;">${formatDateVN(p.discharge)} ${p.discharge_time}</span></h4>`;
      html += `<ul style="margin-left:15px;">`;
      Object.keys(grouped).forEach(name=>{
        const dates = grouped[name].filter(d=>d!=='').join(', ');
        html += `<li><strong>${name}</strong> (${grouped[name].length} l·∫ßn):</li>`;
        html += `<ul style="margin-left:20px;">`;
        grouped[name].forEach(date=>{
          html += `<li>${date||'Kh√¥ng r√µ ng√†y'}</li>`;
        });
        html += `</ul>`;
      });
      html += `</ul>`;
    }
  });

  if (!html) html = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu ti√™m ho·∫∑c thu·ª∑ ch√¢m.</p>';
  showPopup('üíâ Th·ªëng k√™ Ti√™m / Thu·ª∑ ch√¢m', html);
});

/* === VI√äN === */
document.getElementById('btnVien').addEventListener('click',()=>{
  let html = '';
  const now = new Date();
  const currentDate = now.toISOString().slice(0,10);
  const currentTime = now.toTimeString().slice(0,5);
  
  patients.forEach(p=>{
    // ‚úÖ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN RA VI·ªÜN: c√≥ ng√†y ra V√Ä ƒë√£ t·ªõi ng√†y V√Ä ƒë√£ t·ªõi gi·ªù
    if (p.discharge) {
      const dischargeDate = p.discharge;
      const dischargeTime = p.discharge_time || '23:59';
      
      if (dischargeDate <= currentDate && 
          (dischargeDate < currentDate || dischargeTime <= currentTime)) {
        return; // b·ªè qua b·ªánh nh√¢n n√†y
      }
    }

    const vienList = (p.meds||[]).filter(m=>m.route==='U·ªëng');
    if(vienList.length){
      const grouped = {};
      vienList.forEach(m=>{
        const name = m.name?.trim() || '(Kh√¥ng t√™n)';
        if(!grouped[name]) grouped[name] = [];
        grouped[name].push(m.start || '');
      });

      html += `<h4 style="color:#27ae60;">B·ªánh nh√¢n: ${p.name}</h4><ul>`;
      Object.keys(grouped).forEach(name=>{
        html += `<li><strong>${name}</strong> (${grouped[name].length} l·∫ßn):</li><ul>`;
        grouped[name].forEach(date=>{
          html += `<li>${date||'Kh√¥ng r√µ ng√†y'}</li>`;
        });
        html += `</ul>`;
      });
      html += `</ul>`;
    }
  });

  if (!html) html = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu thu·ªëc U·ªëng.</p>';
  showPopup('üíä Th·ªëng k√™ thu·ªëc Vi√™n (U·ªëng)', html);
});


/* === S·∫ÆC === */
document.getElementById('btnSac').addEventListener('click',()=>{
  let html = '';
  const now = new Date();
  const currentDate = now.toISOString().slice(0,10);
  const currentTime = now.toTimeString().slice(0,5);
  
  patients.forEach(p=>{
    // ‚úÖ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN RA VI·ªÜN: c√≥ ng√†y ra V√Ä ƒë√£ t·ªõi ng√†y V√Ä ƒë√£ t·ªõi gi·ªù
    if (p.discharge) {
      const dischargeDate = p.discharge;
      const dischargeTime = p.discharge_time || '23:59';
      
      if (dischargeDate <= currentDate && 
          (dischargeDate < currentDate || dischargeTime <= currentTime)) {
        return; // b·ªè qua b·ªánh nh√¢n n√†y
      }
    }

    const thangList = (p.thangs||[]);
    if(thangList.length){
      const grouped = {};
      thangList.forEach(t=>{
        const name = t.name?.trim() || '(Kh√¥ng t√™n)';
        if(!grouped[name]) grouped[name] = [];
        grouped[name].push(`${t.start||''} ‚Üí ${t.end||''} (${t.count||0} thang)`);
      });

      html += `<h4 style="color:#8e44ad;">B·ªánh nh√¢n: ${p.name}</h4><ul>`;
      Object.keys(grouped).forEach(name=>{
        html += `<li><strong>${name}</strong> (${grouped[name].length} l·∫ßn k√™):</li><ul>`;
        grouped[name].forEach(info=>{
          html += `<li>${info}</li>`;
        });
        html += `</ul>`;
      });
      html += `</ul>`;
    }
  });

  if (!html) html = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu thu·ªëc S·∫Øc.</p>';
  showPopup('üçµ Th·ªëng k√™ thu·ªëc S·∫Øc (Thang)', html);
});
/* === GI·ªú === */
document.getElementById('btnGio').addEventListener('click',()=>{
  const now = new Date();
  const currentDate = formatDateForComparison(now);
  const currentTime = now.toTimeString().slice(0,5);
  
  // L·ªçc b·ªánh nh√¢n c√≥ gi·ªù kh√°m v√† ch∆∞a ra vi·ªán HO·∫∂C ƒë√£ ra vi·ªán nh∆∞ng ch∆∞a t·ªõi gi·ªù ra vi·ªán
  const ds = patients
    .filter(p => {
      if (!p.exam_time) return false;
      
      // N·∫øu ch∆∞a c√≥ ng√†y ra vi·ªán -> hi·ªÉn th·ªã
      if (!p.discharge) return true;
      
      const dischargeDate = formatDateForComparison(new Date(p.discharge));
      
      // N·∫øu ng√†y ra vi·ªán > ng√†y hi·ªán t·∫°i -> hi·ªÉn th·ªã
      if (dischargeDate > currentDate) return true;
      
      // N·∫øu ng√†y ra vi·ªán = ng√†y hi·ªán t·∫°i v√† ch∆∞a t·ªõi gi·ªù ra vi·ªán -> hi·ªÉn th·ªã
      if (dischargeDate === currentDate && p.discharge_time && p.discharge_time > currentTime) {
        return true;
      }
      
      return false;
    })
    .sort((a,b)=>{
      // s·∫Øp x·∫øp tƒÉng d·∫ßn theo gi·ªù kh√°m
      if (!a.exam_time) return 1;
      if (!b.exam_time) return -1;
      return a.exam_time.localeCompare(b.exam_time);
    });

  let html = '';

  if (ds.length){
   html += `
  <table style="width:100%;border-collapse:collapse;font-size:14px;">
    <thead>
      <tr style="background:#f8f8f8;text-align:left;">
        <th style="border-bottom:1px solid #ccc;padding:6px;">STT</th>
        <th style="border-bottom:1px solid #ccc;padding:6px;">T√™n b·ªánh nh√¢n</th>
        <th style="border-bottom:1px solid #ccc;padding:6px;">Ph√≤ng</th>
        <th style="border-bottom:1px solid #ccc;padding:6px;">Gi·ªù kh√°m</th>
        <th style="border-bottom:1px solid #ccc;padding:6px;">S·ªë ng√†y ƒëi·ªÅu tr·ªã</th>
        <th style="border-bottom:1px solid #ccc;padding:6px;">Tr·∫°ng th√°i</th>
      </tr>
    </thead>
    <tbody>
`;


    ds.forEach((p, i)=>{
      let status = '';
      if (!p.discharge) {
        status = '<span style="color:#2e7d32;">ƒêang ƒëi·ªÅu tr·ªã</span>';
      } else {
        const dischargeDate = formatDateForComparison(new Date(p.discharge));
        if (dischargeDate === currentDate && p.discharge_time && p.discharge_time > currentTime) {
          status = `<span style="color:#ff9800;">Ra vi·ªán l√∫c ${p.discharge_time} (${formatDateVN(p.discharge)})</span>`;
        } else if (dischargeDate > currentDate) {
          status = `<span style="color:#FF0000;">Ra vi·ªán ng√†y ${formatDateVN(p.discharge)} (${p.discharge_time})</span>`;
        }
      }
        const songay = p.admit && !p.discharge ? `${daysBetween(p.admit, todayStr()) + 1}` : (p.total || '');

      html += `
    <tr>
      <td style="border-bottom:1px solid #eee;padding:6px;">${i+1}</td>
      <td style="border-bottom:1px solid #eee;padding:6px;">${p.name || ''}</td>
      <td style="border-bottom:1px solid #eee;padding:6px;">${p.room || ''}</td>
      <td style="border-bottom:1px solid #eee;padding:6px;">${p.exam_time || ''}</td>
      <td style="border-bottom:1px solid #eee;padding:6px;color:#ff7a18;font-weight:600;">${songay ? songay + ' ng√†y' : ''}</td>
      <td style="border-bottom:1px solid #eee;padding:6px;">${status}</td>
    </tr>
  `;

    });

    html += `
        </tbody>
      </table>
    `;
  } else {
    html = '<p>Kh√¥ng c√≥ b·ªánh nh√¢n n√†o c√≥ gi·ªù kh√°m h·ª£p l·ªá.</p>';
  }

  showPopup('üïí Th·ªëng k√™ Gi·ªù kh√°m', html);
});
// H√†m ph·ª• tr·ª£ ƒë·ªÉ ƒë·ªãnh d·∫°ng ng√†y cho so s√°nh (yyyy-mm-dd)
function formatDateForComparison(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
/* === FUTURE: CH·ªà HI·ªÇN TH·ªä ƒê√É L√äN (T·ª™ JSON) V√Ä CH∆ØA L√äN (T·ª™ TH√îNG B√ÅO) === */
document.getElementById('btnFuture').addEventListener('click',()=>{
  let html = `
    <table style="width:100%;border-collapse:collapse;font-size:14px;">
      <thead>
        <tr style="background:#fff3e0;">
          <th style="padding:6px;">STT</th>
          <th style="padding:6px;">T√™n B·ªánh Nh√¢n</th>
          <th style="padding:6px;">T√™n Thu·ªëc</th>
          <th style="padding:6px;">Ng√†y</th>
          <th style="padding:6px;">T√¨nh Tr·∫°ng</th>
        </tr>
      </thead>
      <tbody>
  `;

  let stt = 1;
  const todayStr = new Date().toISOString().slice(0,10);
  const today = new Date(todayStr);

  // D√πng Set ƒë·ªÉ tr√°nh tr√πng l·∫∑p
  const displayedRecords = new Set();

  patients.forEach(p => {
    // Ki·ªÉm tra b·ªánh nh√¢n ƒë√£ ra vi·ªán ch∆∞a
    if (p.discharge) {
      const dischargeDate = new Date(p.discharge);
      if (dischargeDate < today) return; // B·ªè qua b·ªánh nh√¢n ƒë√£ ra vi·ªán
    }

    const listThuoc = (p.meds || []).filter(m => 
      (m.route === 'Thu·ª∑ ch√¢m' || m.route === 'Ti√™m') && 
      m.start && 
      !m.end
    );

    if (!listThuoc.length) return;

    let coDongNao = false;
    
    // HI·ªÇN TH·ªä C√ÅC THU·ªêC ƒê√É L√äN (t·ª´ JSON)
    listThuoc.forEach(m => {
      const startStr = m.start;
      if (!startStr) return;
      
      const tenThuoc = m.name || '(Kh√¥ng t√™n)';

      // Hi·ªÉn th·ªã ng√†y start nh∆∞ l√† "ƒë√£ l√™n"
      const recordKey = `${p.id}_${tenThuoc}_${startStr}`;
      
      if (!displayedRecords.has(recordKey)) {
        html += `
          <tr>
            <td style="padding:6px;border-bottom:1px solid #eee;">${stt++}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${p.name}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${tenThuoc}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${new Date(startStr).toLocaleDateString('vi-VN')}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;"><span style="color:green;">‚úÖ ƒê√£ l√™n</span></td>
          </tr>`;
        
        displayedRecords.add(recordKey);
        coDongNao = true;
      }
    });

    // HI·ªÇN TH·ªä C√ÅC THU·ªêC CH∆ØA L√äN (t·ª´ th√¥ng b√°o)
    const danhSachChuaLen = layDanhSachChuaLenTuThongBao(p);
    danhSachChuaLen.forEach(item => {
      const recordKey = `${p.id}_${item.tenThuoc}_${item.ngay}`;
      
      if (!displayedRecords.has(recordKey)) {
        html += `
          <tr>
            <td style="padding:6px;border-bottom:1px solid #eee;">${stt++}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${p.name}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${item.tenThuoc}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;">${item.ngay}</td>
            <td style="padding:6px;border-bottom:1px solid #eee;"><span style="color:red;font-weight:bold;">‚ùå Ch∆∞a l√™n</span></td>
          </tr>`;
        
        displayedRecords.add(recordKey);
        coDongNao = true;
      }
    });

    // Th√™m d√≤ng tr·ªëng ngƒÉn c√°ch gi·ªØa c√°c b·ªánh nh√¢n
    if (coDongNao) {
      html += '<tr style="height:8px;background:#f9f9f9;"><td colspan="5"></td></tr>';
    }
  });

  if (stt === 1) {
    html += `<tr><td colspan="5" style="padding:10px;text-align:center;color:#777;">‚úÖ Kh√¥ng c√≥ b·ªánh nh√¢n n√†o c√≥ th·ªßy ch√¢m ho·∫∑c ti√™m.</td></tr>`;
  }
  
  html += '</tbody></table>';
  showPopup('üìÖ Th·ªëng k√™ Future (Thu·ª∑ ch√¢m / Ti√™m)', html);
});

// H√†m l·∫•y danh s√°ch thu·ªëc ch∆∞a l√™n t·ª´ th√¥ng b√°o
function layDanhSachChuaLenTuThongBao(p) {
  const danhSach = [];
  const today = new Date();
  
  (p.meds || []).forEach(m => {
    if ((m.route === 'Thu·ª∑ ch√¢m' || m.route === 'Ti√™m') && m.start && !m.end) {
      const danhSachNgay = tinhNgayCanLen(m.route, m.start, m.mode || 'Li√™n ti·∫øp', p.discharge, p);
      
      if (danhSachNgay.length > 0) {
        danhSachNgay.forEach(ngay => {
          danhSach.push({
            tenThuoc: m.name || '(Kh√¥ng t√™n)',
            ngay: dinhDangNgayVN(ngay)
          });
        });
      }
    }
  });
  
  return danhSach;
}

// H√†m m·ªõi: l·∫•y t·∫•t c·∫£ ng√†y ƒëi·ªÅu tr·ªã t·ª´ start ƒë·∫øn ng√†y mai (ho·∫∑c discharge)
function getAllTreatmentDates(route, startDate, mode, dischargeDate) {
  if (!startDate) return [];
  
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  
  const start = new Date(startDate);
  const discharge = dischargeDate ? new Date(dischargeDate) : null;
  const dates = [];
  
  // N·∫øu c√≥ ng√†y ra vi·ªán v√† ƒë√£ qua th√¨ kh√¥ng l·∫•y ng√†y n√†o
  if (discharge && discharge < today) {
    return dates;
  }
  
  // Gi·ªõi h·∫°n t·ªëi ƒëa ƒë·∫øn ng√†y ra vi·ªán (n·∫øu c√≥) ho·∫∑c ng√†y mai
  const maxDate = discharge && discharge < tomorrow ? discharge : tomorrow;
  
  if (route === 'Thu·ª∑ ch√¢m') {
    const isCachNgay = (mode === 'C√°ch ng√†y');
    let currentDate = new Date(start);
    
    // L·∫•y t·∫•t c·∫£ c√°c ng√†y t·ª´ start ƒë·∫øn maxDate
    while (currentDate <= maxDate) {
      dates.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + (isCachNgay ? 2 : 1));
    }
  } else if (route === 'Ti√™m') {
    // Ti√™m: l·∫•y t·∫•t c·∫£ c√°c ng√†y t·ª´ start ƒë·∫øn maxDate (m·ªói ng√†y 1 l·∫ßn)
    let currentDate = new Date(start);
    while (currentDate <= maxDate) {
      dates.push(new Date(currentDate));
      currentDate.setDate(currentDate.getDate() + 1);
    }
  }
  
  return dates;
}



// H√†m l·∫•y 2 ng√†y: h√¥m nay v√† ng√†y mai
function getNextTwoDays(route, startDate, mode, dischargeDate) { // ‚úÖ B·ªé THAM S·ªê medEnd
  if (!startDate) return []; // ‚úÖ CH·ªà KI·ªÇM TRA startDate
  
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  
  const start = new Date(startDate);
  const discharge = dischargeDate ? new Date(dischargeDate) : null;
  const dates = [];
  
  // N·∫øu c√≥ ng√†y ra vi·ªán v√† ƒë√£ qua th√¨ kh√¥ng l·∫•y ng√†y n√†o
  if (discharge && discharge < today) {
    return dates;
  }
  
  // Gi·ªõi h·∫°n t·ªëi ƒëa ƒë·∫øn ng√†y ra vi·ªán (n·∫øu c√≥) ho·∫∑c ng√†y mai
  const maxDate = discharge && discharge < tomorrow ? discharge : tomorrow;
  
  if (route === 'Thu·ª∑ ch√¢m') {
    const isCachNgay = (mode === 'C√°ch ng√†y');
    let currentDate = new Date(start);
    
    // T√¨m c√°c ng√†y h√¥m nay v√† ng√†y mai trong l·ªãch tr√¨nh (kh√¥ng v∆∞·ª£t qu√° ng√†y ra vi·ªán)
    while (currentDate <= maxDate) {
      if (currentDate.toDateString() === today.toDateString() || 
          currentDate.toDateString() === tomorrow.toDateString()) {
        dates.push(new Date(currentDate));
      }
      currentDate.setDate(currentDate.getDate() + (isCachNgay ? 2 : 1));
    }
  } else if (route === 'Ti√™m') {
    // Ti√™m: l·∫•y ng√†y h√¥m nay v√† ng√†y mai (n·∫øu kh√¥ng v∆∞·ª£t qu√° ng√†y ra vi·ªán)
    if (today <= maxDate) {
      dates.push(new Date(today));
    }
    if (tomorrow <= maxDate) {
      dates.push(new Date(tomorrow));
    }
  }
  
  return dates;
}
// H√†m ƒë·ªãnh d·∫°ng ng√†y VN (dd/mm/yyyy)
function formatDateVN(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleDateString('vi-VN');
}

</script>

<div id="saveToast" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #4caf50;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 9999;
  pointer-events: none;
">
  üíæ ƒê√£ l∆∞u th√†nh c√¥ng!
</div>
<script>
/* ====== ·∫®N/HI·ªÜN TH√îNG B√ÅO V·ªöI CTRL+Z ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + Z ‚Üí ·∫®n/hi·ªán th√¥ng b√°o
  if (e.ctrlKey && e.key.toLowerCase() === 'z') {
    e.preventDefault();
    toggleThongBao();
  }
});

// H√†m ·∫©n/hi·ªán th√¥ng b√°o
function toggleThongBao() {
  const thongBaoChung = document.getElementById('thongBaoChung');
  if (!thongBaoChung) return;
  
  const isHidden = thongBaoChung.style.display === 'none';
  
  if (isHidden) {
    // Hi·ªán th√¥ng b√°o
    thongBaoChung.style.display = '';
    localStorage.setItem('thongBaoHidden', 'false');
  } else {
    // ·∫®n th√¥ng b√°o
    thongBaoChung.style.display = 'none';
    localStorage.setItem('thongBaoHidden', 'true');
  }
}

// Kh√¥i ph·ª•c tr·∫°ng th√°i th√¥ng b√°o khi t·∫£i trang
window.addEventListener('load', () => {
  const thongBaoHidden = localStorage.getItem('thongBaoHidden');
  const thongBaoChung = document.getElementById('thongBaoChung');
  
  if (thongBaoChung && thongBaoHidden === 'true') {
    thongBaoChung.style.display = 'none';
  }
});



/* ====== PH√çM T·∫ÆT: Ctrl+Q HI·ªÜN/·∫®N B·ªÜNH NH√ÇN ƒê√É RA VI·ªÜN ====== */
document.addEventListener('keydown', function(e) {
  // Ctrl + Q ‚Üí Hi·ªán/·∫©n b·ªánh nh√¢n ƒë√£ ra vi·ªán
  if (e.ctrlKey && e.key.toLowerCase() === 'q') {
    e.preventDefault();
    showAllPatients = !showAllPatients;
    
    // Hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi
    const toast = document.getElementById('saveToast');
    if (toast) {
      toast.textContent = showAllPatients ? 'üëÅ ƒêang hi·ªán T·∫§T C·∫¢ b·ªánh nh√¢n' : 'üëÅ ƒêang ·∫©n b·ªánh nh√¢n ƒë√£ ra vi·ªán';
      toast.style.background = showAllPatients ? '#3498db' : '#e67e22';
      toast.style.opacity = '1';
      setTimeout(()=>{ toast.style.opacity = '0'; }, 2000);
    }
    
    renderPatientList(document.getElementById('search').value);
  }
});


</script>
</body>
</html>
