
<!-- 

///////////////////////////////////////////////
/////Code ƒë∆∞·ª£c vi·∫øt b·ªüi Chauhuynh0104/////////
////http://fb.com/chauhuynh0104//////////////
/////////////079.567.9350///////////////////
///Vui l√≤ng t√¥n tr·ªçng b·∫£n quy·ªÅn t√°c gi·∫£////
/////////Kh√¥ng xo√° d√≤ng n√†y //////////////
/////////////////////////////////////////

!-->
<!DOCTYPE html>

<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Qu·∫£n l√Ω B·ªánh √Ån</title>
<!-- Docx UMD (primary) -->
<script defer="" onload="window.__DOCX_LOADED__=true" src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js">
async function fetchWithAutoRetry(url, options, maxRetries = 1) {
  try {
    let res = await fetch(url, options);
    if (res.status === 401 && maxRetries > 0) {
      console.warn('Token h·∫øt h·∫°n, ƒëang l√†m m·ªõi...');
      await getNewAccessToken(localStorage.getItem(REFRESH_KEY));
      options.headers['Authorization'] = 'Bearer ' + localStorage.getItem(TOKEN_KEY);
      return await fetchWithAutoRetry(url, options, maxRetries - 1);
    }
    return res;
  } catch (err) {
    console.error('L·ªói fetch:', err);
    throw err;
  }
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- Fallback loader if primary CDN fails -->
<script>
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (!window.docx) {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.3/docx.umd.min.js';
          s.defer = true;
          s.onload = () => console.log('docx fallback loaded');
          document.head.appendChild(s);
        }
      }, 1200);
    });
	
window.addEventListener('DOMContentLoaded', () => {
  const data = JSON.parse(localStorage.getItem('benhAnData_v2') || '[]');
  if (!data.length) {
    fetchDropboxFiles().then(() => renderList());
  } else {
    renderList();
  }
});
	
  
async function fetchWithAutoRetry(url, options, maxRetries = 1) {
  try {
    let res = await fetch(url, options);
    if (res.status === 401 && maxRetries > 0) {
      console.warn('Access token expired. Refreshing...');
      await getNewAccessToken(localStorage.getItem(REFRESH_KEY));
      options.headers['Authorization'] = 'Bearer ' + localStorage.getItem(TOKEN_KEY);
      return await fetchWithAutoRetry(url, options, maxRetries - 1);
    }
    return res;
  } catch (err) {
    console.error('fetchWithAutoRetry failed:', err);
    throw err;
  }
}
</script>
<style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
    .container { max-width: 1100px; margin: auto; }
    h1 { text-align: center; color: var(--secondary-color); }
    .section { background: #fff; padding: 20px; border-radius: 8px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    label { font-weight: 600; display: block; margin: 8px 0 4px; }
    input { width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
	  textarea { width: 95%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
  
    .row { display: flex; gap: 12px; }
    .row .col { flex: 1; }
    button { background: var(--primary-color); color: #fff; border: 0; padding: 10px 14px; border-radius: 6px; cursor: pointer; }
    button.secondary { background: var(--secondary-color); }
    button.danger { background: var(--accent-color); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px;}
    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
    th { background: #e9f3fb; }
    .status { padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none; }
    .status.show { display: block; }
    .status.ok { background: #e8f5e9; color: #1b5e20; }
    .status.err { background: #ffebee; color: #b71c1c; }
    .muted { color: #666; font-size: 12px; }
    .token { font-family: monospace; background: #f3f4f6; padding: 6px 8px; border-radius: 6px; display: inline-block; }
  

/* Animation cho form */
#formBenhAn {
  transition: all 0.3s ease-in-out;
}

/* N√∫t hover */
button:hover {
  opacity: 0.9;
  transform: scale(1.03);
}

/* B·∫£ng loading popup ƒë·∫πp h∆°n */
#loadingPopup div {
  animation: fadeIn 0.3s ease-out;
}
@keyframes fadeIn {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

#loginScreen input:focus {
  outline: none;
  border-color: #3498db;
  box-shadow: 0 0 5px #3498db44;
}
#loginScreen button:hover {
  background: #2980b9;
}
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin: auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


</style>
</head>
<body><div id="darkModeToggle"><button id="darkToggle" style="padding: 8px 14px; border-radius: 6px; background: #222; color: white; cursor: pointer; border: none;">üåô Dark Mode</button></div>
<div id="loginScreen" style="
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:linear-gradient(to right, #4facfe, #00f2fe);
  display:flex;align-items:center;justify-content:center;
  z-index:10000;font-family:'Segoe UI',sans-serif;
">
<div style="background:white;padding:40px 30px;border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.3);width:100%;max-width:400px;">
<h2 style="margin-top:0;text-align:center;color:#333;">üîê ƒêƒÉng nh·∫≠p</h2>
<input id="loginUser" placeholder="T√†i kho·∫£n" style="width:95%;padding:12px;border-radius:8px;border:1px solid #ccc;margin-bottom:12px;" type="text"/>
<input id="loginPass" placeholder="M·∫≠t kh·∫©u" style="width:95%;padding:12px;border-radius:8px;border:1px solid #ccc;margin-bottom:16px;" type="password"/>
<button id="loginBtn" style="width:100%;padding:12px;border:none;border-radius:8px;background:#3498db;color:#fff;font-size:16px;cursor:pointer;">ƒêƒÉng nh·∫≠p</button>
<p id="loginMsg" style="text-align:center;color:#e74c3c;margin-top:10px;"></p>
</div>
</div>

<div id="loadingPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#00000088;z-index:9999;align-items:center;justify-content:center;">
  <div style="text-align:center;">
    <div class="spinner"></div>
    <div style="margin-top:12px;color:white;font-weight:bold;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  </div>
</div>


<div class="container">
<div style="text-align:right;"><button id="logoutBtn" style="display:none;background:#e74c3c;color:white;padding:8px 14px;border:none;border-radius:6px;cursor:pointer;">ƒêƒÉng xu·∫•t</button></div><h1>Qu·∫£n l√Ω B·ªánh √Ån</h1>
<div class="section" style="border: 2px solid #3498db;">
<h2>Nh·∫≠p/S·ª≠a B·ªánh √Ån</h2>
<div class="status" id="statusBox"></div>
<button id="toggleFormBtn" style="margin-bottom:10px;background:#2ecc71;color:white;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;">üìù Nh·∫≠p b·ªánh √°n</button><form id="formBenhAn" style="display:none;">
<div class="row">
<div class="col">
<label>H·ªç t√™n</label>
<input name="ten" required="" type="text"/>
</div>
<div class="col">
<label>Tu·ªïi</label>
<input name="tuoi" required="" type="number"/>
</div>
</div>
<div class="row">
<div class="col">
<label>M√£ BN</label>
<input name="maBN" required="" type="text"/>
</div>
<div class="col">
<label>Ng√†y v√†o vi·ªán</label>
<input name="ngayvao" required="" type="date"/>
</div>
</div>
<label>Ch·∫©n ƒëo√°n T√¢y y</label>
<textarea name="cdtayy" rows="2"></textarea>
<label>Ch·∫©n ƒëo√°n ƒê√¥ng y</label>
<textarea name="cddongy" rows="2"></textarea>
<label>N·ªôi dung b·ªánh √°n</label>
<textarea name="ndba" rows="4" style="white-space: pre-wrap;"></textarea>
<label>Th·ªß Thu·∫≠t - Thu·ªëc</label>
<textarea name="ttt" rows="4" style="white-space: pre-wrap;"></textarea>
<div style="margin-top:10px;">
<button id="submitBtn" type="submit">L∆∞u b·ªánh √°n</button>
<button class="secondary" id="cancelEditBtn" style="display:none;" type="button">H·ªßy s·ª≠a</button>
</div>
</form>
</div>
<div class="section" style="border: 2px solid #3498db;">
<div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
<div class="row" style="margin-bottom: 16px; gap: 10px; flex-wrap: wrap;">
<input id="searchName" placeholder="T√¨m theo h·ªç t√™n" style="flex: 1; padding: 8px;"/>
<input id="searchMaBN" placeholder="T√¨m theo m√£ BN" style="flex: 1; padding: 8px;"/>
<input id="searchChanDoan" placeholder="T√¨m theo ch·∫©n ƒëo√°n" style="flex: 1; padding: 8px;"/>
<input id="fromDate" placeholder="T·ª´ ng√†y" style="padding: 8px;width: 20%;" type="date"/>
<input id="toDate" placeholder="ƒê·∫øn ng√†y" style="padding: 8px;width: 20%;" type="date"/>
<button onclick="applyFilters()" style="padding: 8px 16px;">üîç L·ªçc</button>
</div></div>
<div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 10px;">
<h2 style="margin:0; line-height: 1;">Danh s√°ch B·ªánh √Ån</h2>
<div style="display: flex; gap: 8px; align-items: center;">
<button class="danger" id="clearAllBtn" style="height: 36px;">X√≥a cache</button>
<button id="toggleCardBtn" style="height: 36px; background:#8e44ad;color:white;border:none;border-radius:6px;cursor:pointer;">Hi·ªÉn th·ªã th·∫ª</button></div>
</div>
<table>
<thead>
<tr>
<th>H·ªç t√™n</th>
<th>Tu·ªïi</th>
<th>M√£ BN</th>
<th>Ng√†y v√†o</th>
<th>Ch·∫©n ƒëo√°n T√¢y y</th>
<th>Thao t√°c</th>
</tr>
</thead>
<tbody id="listBody"></tbody>
</table>
<div id="cardContainer" style="display:none;gap:16px;flex-wrap:wrap;"></div></div>
</div>
<script>
    // ====== C·∫•u h√¨nh l∆∞u tr·ªØ ======
    const STORAGE_KEY = 'benhAnData_v2';
    const TOKEN_KEY = 'access_token'; // localStorage key cho access token
const REFRESH_KEY = 'refresh_token';
localStorage.setItem(REFRESH_KEY, 'yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr'); // l∆∞u refresh token
const APP_KEY = 'qzy5kclrf827aey';
const APP_SECRET = '6jlsunzjqr3s3nh';

// H√†m l·∫•y access token m·ªõi t·ª´ refresh token
async function getNewAccessToken(refresh_token) {
  const response = await fetchWithAutoRetry('https://api.dropbox.com/oauth2/token', {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + btoa(`${APP_KEY}:${APP_SECRET}`),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: refresh_token
    })
  });

  const data = await response.json();
  if (data.access_token) {
    localStorage.setItem(TOKEN_KEY, data.access_token);
    return data.access_token;
  } else {
    throw new Error("L·∫•y token th·∫•t b·∫°i: " + JSON.stringify(data));
  }
}

// H√†m l·∫•y token: n·∫øu h·∫øt h·∫°n th√¨ t·ª± l√†m m·ªõi
async function getAccessToken() {
  let token = localStorage.getItem(TOKEN_KEY);
  // Gi·∫£ s·ª≠ b·∫°n t·ª± ki·ªÉm tra token c√≥ h·ª£p l·ªá hay kh√¥ng, ho·∫∑c lu√¥n l√†m m·ªõi
  const refreshToken = localStorage.getItem(REFRESH_KEY);

  if (!token && refreshToken) {
    token = await getNewAccessToken(refreshToken);
  }

  return token;
}




    let benhAnData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let editingId = null;

    // ====== Token removed for embedding ======

    // ====== Utils UI ======
    const statusBox = document.getElementById('statusBox');
    function toast(msg, ok=false) {
      statusBox.textContent = msg;
      statusBox.className = 'status show ' + (ok? 'ok' : 'err');
      setTimeout(() => { statusBox.className = 'status'; }, 4000);
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      return date.toLocaleDateString('vi-VN');
    }

    // ====== Ki·ªÉm tra th∆∞ vi·ªán docx ======
    const libStatus = document.getElementById('libStatus');
function updateLibStatus() {
  const libStatus = document.getElementById('libStatus');
  if (libStatus) {
    libStatus.textContent = window.docx 
      ? 'Th∆∞ vi·ªán docx ƒë√£ s·∫µn s√†ng.' 
      : 'Ch∆∞a t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán docx. V·∫´n c√≥ th·ªÉ l∆∞u d·∫°ng .doc (t∆∞∆°ng th√≠ch Word).';
  }
}
    setTimeout(updateLibStatus, 1500);
    setInterval(updateLibStatus, 3000);

    function waitForDocx(timeoutMs=6000) {
      return new Promise((resolve) => {
        const start = Date.now();
        const t = setInterval(() => {
          if (window.docx) { clearInterval(t); resolve(true); }
          else if (Date.now() - start > timeoutMs) { clearInterval(t); resolve(false); }
        }, 200);
      });
    }

    // ====== T·∫°o file Word (.docx ho·∫∑c fallback .doc) ======
    async function buildDocxBlob(ba) {
      const ok = await waitForDocx();
      if (!ok) return null;
      try {
        const { Document, Packer, Paragraph, TextRun } = window.docx;
        const doc = new Document({
          sections: [{
            children: [
              new Paragraph({ children: [ new TextRun({ text: 'B·ªÜNH √ÅN', bold: true, size: 32 }) ] }),
              new Paragraph(''),
              new Paragraph({ children: [ new TextRun({ text: `H·ªç t√™n: ${ba.ten}`, bold: true }) ] }),
              new Paragraph(`Tu·ªïi: ${ba.tuoi}`),
              new Paragraph(`M√£ BN: ${ba.maBN}`),
              new Paragraph(`ƒê·ªãa ch·ªâ: ${ba.diachi||''}`),
              new Paragraph(`Ng√†y v√†o vi·ªán: ${ba.ngayvao}`),
              new Paragraph(`Ch·∫©n ƒëo√°n T√¢y y: ${ba.cdtayy||''}`),
              new Paragraph(`Ch·∫©n ƒëo√°n ƒê√¥ng y: ${ba.cddongy||''}`),
              new Paragraph('N·ªôi dung b·ªánh √°n:'),
              new Paragraph(ba.ndba || ''),
			     new Paragraph('Th·ªß Thu·∫≠t - Thu·ªëc:'),
              new Paragraph(ba.ttt || '')
			  
			  
            ]
          }]
        });
        const blob = await Packer.toBlob(doc);
        return blob;
      } catch (e) {
        console.error('docx error', e);
        return null;
      }
    }

    function buildDocHtmlBlob(ba) {
      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="utf-8"><title>BenhAn</title></head>
        <body>
          <h2 style="text-align:center;">B·ªÜNH √ÅN</h2>
          <p><b>H·ªç t√™n:</b> ${ba.ten}</p>
          <p><b>Tu·ªïi:</b> ${ba.tuoi}</p>
          <p><b>M√£ BN:</b> ${ba.maBN}</p>
          <p><b>ƒê·ªãa ch·ªâ:</b> ${ba.diachi||''}</p>
          <p><b>Ng√†y v√†o vi·ªán:</b> ${ba.ngayvao}</p>
          <p><b>Ch·∫©n ƒëo√°n T√¢y y:</b> ${ba.cdtayy||''}</p>
          <p><b>Ch·∫©n ƒëo√°n ƒê√¥ng y:</b> ${ba.cddongy||''}</p>
          <p><b>N·ªôi dung b·ªánh √°n:</b><br/>${(ba.ndba||'').replace(/\n/g,'<br/>')}</p>
		    <p><b>Th·ªß Thu·∫≠t - Thu·ªëc :</b><br/>${(ba.ttt||'').replace(/\n/g,'<br/>')}</p>
        
<!-- Popup x√°c nh·∫≠n -->
<div id="popupConfirm" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#00000088;display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:90%;box-shadow:0 4px 10px rgba(0,0,0,0.3);text-align:center;">
    <p id="popupConfirmMsg" style="margin-bottom:20px;font-size:16px;"></p>
    <button id="popupOk" style="margin-right:10px;background:#3498db;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">OK</button>
    <button id="popupCancel" style="background:#ccc;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">H·ªßy</button>
  </div>
</div>

</body></html>`;
      return new Blob([html], { type: 'application/msword' });
    }

    async function createWordBlob(ba) {
      const docxBlob = await buildDocxBlob(ba);
      if (docxBlob) return { blob: docxBlob, ext: '.docx' };
      // Fallback to .doc (Word-compatible)
      return { blob: buildDocHtmlBlob(ba), ext: '.doc' };
    }

    // ====== Dropbox upload ======
   async function uploadToDropbox(filename, blob) {
  const path = `/BenhAn/${filename}`;
  const res = await fetchWithAutoRetry('https://content.dropboxapi.com/2/files/upload', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + (await getAccessToken()),
      'Dropbox-API-Arg': JSON.stringify({ path, mode: 'overwrite', autorename: false }),
      'Content-Type': 'application/octet-stream'
    },
    body: blob
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error('Dropbox upload failed: ' + txt);
  }

  return path;
}

    async function deleteFromDropbox(path) {
      const token = TOKEN_KEY;
      if (!path || !token) return;
      await fetchWithAutoRetry('https://api.dropboxapi.com/2/files/delete_v2', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + (await getAccessToken()),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ path })
      });
    }


    // ====== Render list ======
    const listBody = document.getElementById('listBody');
    function renderList(data = benhAnData) {
      listBody.innerHTML = '';
      if (!data.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center;color:#666;">Ch∆∞a c√≥ b·ªánh √°n</td>';
        listBody.appendChild(tr);
        return;
      }
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.ten}</td>
          <td>${item.tuoi}</td>
          <td>${item.maBN}</td>
          <td>${formatDate(item.ngayvao)}</td>
          <td>${(item.cdtayy||'').slice(0,30)}${(item.cdtayy||'').length>30?'...':''}</td>
          <td>
            <button class="secondary" data-id="${item.id}" data-act="edit"> S·ª≠a</button>
            <button class="danger" data-id="${item.id}" data-act="del">X√≥a</button>
			  <button data-id="${item.id}" data-act="view">Xem</button>
			  <button data-id="${item.id}" data-act="print">In</button>

          </td>
        `;
        listBody.appendChild(tr);
      });
    }
    renderList();

    listBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
	    const item = benhAnData.find(x => x.id === id);
		if (act === 'print') {
    printBenhAn(item);
  }
		
		
      if (act === 'del') {
        if (await showConfirm('X√≥a b·ªánh √°n n√†y?')) {
        
          if (item && item.dropboxPath) {
            try {
              await deleteFromDropbox(item.dropboxPath);
            } catch (err) {
              console.error('L·ªói khi x√≥a file Dropbox:', err);
            }
          }
          benhAnData = benhAnData.filter(x => x.id !== id);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
          renderList();
          toast('ƒê√£ x√≥a.', true);
        }
      } else if (act === 'edit') {
        const item = benhAnData.find(x => x.id === id);
        if (!item) return;
        editingId = id;
        fillForm(item);
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        document.getElementById('submitBtn').textContent = 'C·∫≠p nh·∫≠t b·ªánh √°n';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }else if (act === 'view') {
  viewBenhAn(item);
}
    });

    function fillForm(ba) {
  const form = document.getElementById('formBenhAn');
  for (const k in ba) {
    const field = form.querySelector(`[name="${k}"]`);
    if (field) field.value = ba[k];
  }
}
    

    document.getElementById('cancelEditBtn').onclick = () => {
      editingId = null;
      document.getElementById('formBenhAn').reset();
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('submitBtn').textContent = 'L∆∞u b·ªánh √°n';
    };

 document.getElementById('clearAllBtn').onclick = async () => {
      if (await showConfirm('X√≥a cache?')) {
        benhAnData = [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
        renderList();
        toast('ƒê√£ x√≥a t·∫•t c·∫£.', true);
      }
    };

    
    // ====== Popup Confirm thay cho confirm() ======
    function showConfirm(message) {
      return new Promise((resolve) => {
        const popup = document.getElementById('popupConfirm');
        const msg = document.getElementById('popupConfirmMsg');
        const okBtn = document.getElementById('popupOk');
        const cancelBtn = document.getElementById('popupCancel');
        msg.textContent = message;
        popup.style.display = 'flex';
        okBtn.onclick = () => { popup.style.display = 'none'; resolve(true); };
        cancelBtn.onclick = () => { popup.style.display = 'none'; resolve(false); };
      });
    }

    // ====== Submit form ======
    const form = document.getElementById('formBenhAn');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const ba = {
        id: editingId || Date.now().toString(),
        ten: data.get('ten'),
        tuoi: data.get('tuoi'),
        maBN: data.get('maBN'),
        diachi: data.get('diachi'),
        ngayvao: data.get('ngayvao'),
        cdtayy: data.get('cdtayy'),
        cddongy: data.get('cddongy'),
        ndba: data.get('ndba'),
		     ttt: data.get('ttt'),
      };

      try {
        // 1) T·∫°o file (docx n·∫øu ƒë∆∞·ª£c, fallback .doc n·∫øu kh√¥ng)
        const { blob, ext } = await createWordBlob(ba);
        const fileName = `${ba.maBN}_${ba.ngayvao}${ext}`;


        // 2) Upload Dropbox
        const path = await uploadToDropbox(fileName, blob);
        ba.dropboxPath = path;

        // 3) L∆∞u/ c·∫≠p nh·∫≠t localStorage
        if (editingId) {
          const idx = benhAnData.findIndex(x => x.id === editingId);
          if (idx >= 0) benhAnData[idx] = ba;
          editingId = null;
          document.getElementById('cancelEditBtn').style.display = 'none';
          document.getElementById('submitBtn').textContent = 'L∆∞u b·ªánh √°n';
          toast('ƒê√£ c·∫≠p nh·∫≠t b·ªánh √°n', true);
        } else {
          benhAnData.unshift(ba);
          toast('ƒê√£ l∆∞u b·ªánh √°n', true);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
        renderList();
        form.reset();
      } catch (err) {
        console.error(err);
        toast(err.message || 'C√≥ l·ªói khi t·∫°o/ t·∫£i l√™n file.', false);
      }
    });
  

function applyFilters() {
  const nameVal = document.getElementById('searchName').value.toLowerCase();
  const maBNVal = document.getElementById('searchMaBN').value.toLowerCase();
  const cdVal = document.getElementById('searchChanDoan').value.toLowerCase();
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;

  const filtered = benhAnData.filter(item => {
    const matchName = !nameVal || (item.ten || '').toLowerCase().includes(nameVal);
    const matchMaBN = !maBNVal || (item.maBN || '').toLowerCase().includes(maBNVal);
    const matchCD = !cdVal || (item.cdtayy || '').toLowerCase().includes(cdVal);

    const date = item.ngayvao || '';
    const matchDate =
      (!from || date >= from) &&
      (!to || date <= to);

    return matchName && matchMaBN && matchCD && matchDate;
  });

  renderList(filtered);
}
</script>
<!-- Popup x√°c nh·∫≠n -->
<div id="popupConfirm" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#00000088;display:none;align-items:center;justify-content:center;z-index:9999;">
<div style="background:white;padding:20px;border-radius:8px;max-width:90%;box-shadow:0 4px 10px rgba(0,0,0,0.3);text-align:center;">
<p id="popupConfirmMsg" style="margin-bottom:20px;font-size:16px;"></p>
<button id="popupOk" style="margin-right:10px;background:#3498db;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">OK</button>
<button id="popupCancel" style="background:#ccc;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">H·ªßy</button>
</div>
</div>
<script>
async function fetchDropboxFiles() {
  const token = TOKEN_KEY;
  const STORAGE_KEY = 'benhAnData_v2';
  let benhAnData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

  try {
    const listRes = await fetchWithAutoRetry('https://api.dropboxapi.com/2/files/list_folder', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + (await getAccessToken()),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: '/BenhAn' })
    });
    const listJson = await listRes.json();
    const entries = listJson.entries || [];

    for (const file of entries) {
      if (!file.name.endsWith('.docx')) continue;

      const downloadRes = await fetchWithAutoRetry('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + (await getAccessToken()),
          'Dropbox-API-Arg': JSON.stringify({ path: file.path_lower })
        }
      });

      const blob = await downloadRes.blob();
      const arrayBuffer = await blob.arrayBuffer();
      const zip = await JSZip.loadAsync(arrayBuffer);
      const documentXml = await zip.file("word/document.xml").async("text");

      const match = (label) => {
        const regex = new RegExp(label + ': ([^<]+)');
        const found = documentXml.match(regex);
        return found ? found[1] : '';
      };

      const plain = documentXml
  .replace(/<w:p[^>]*>/g, '\n')
  .replace(/<[^>]+>/g, '')
  .replace(/\n\s+\n/g, '\n')
  .replace(/&nbsp;/g, ' ')
  .trim();

const ba = {
  id: Date.now().toString() + Math.random(),
  ten: match('H·ªç t√™n'),
  tuoi: match('Tu·ªïi'),
  maBN: match('M√£ BN'),
  diachi: match('ƒê·ªãa ch·ªâ'),
  ngayvao: match('Ng√†y v√†o vi·ªán'),
  cdtayy: match('Ch·∫©n ƒëo√°n T√¢y y'),
  cddongy: match('Ch·∫©n ƒëo√°n ƒê√¥ng y'),
  ndba: extractContent(plain, 'N·ªôi dung b·ªánh √°n'),
  ttt: extractContent(plain, 'Th·ªß Thu·∫≠t - Thu·ªëc'),
  dropboxPath: file.path_lower
};

      if (ba.maBN && !benhAnData.some(x => x.maBN === ba.maBN)) {
        benhAnData.push(ba);
      }
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
    renderList(benhAnData);
  } catch (err) {
    console.error('L·ªói khi t·∫£i file t·ª´ Dropbox:', err);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const data = JSON.parse(localStorage.getItem('benhAnData_v2') || '[]');

  
  if (!data.length) fetchDropboxFiles();
  
});



async function viewBenhAn(item) {
  try {
    const res = await fetchWithAutoRetry('https://content.dropboxapi.com/2/files/download', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + (await getAccessToken()),
        'Dropbox-API-Arg': JSON.stringify({ path: item.dropboxPath })
      }
    });
    const blob = await res.blob();
    const buffer = await blob.arrayBuffer();
    const zip = await JSZip.loadAsync(buffer);
    const doc = await zip.file('word/document.xml').async('text');
    const plain = doc
  .replace(/<w:p[^>]*>/g, '\n')            // m·ªói ƒëo·∫°n <w:p> = 1 d√≤ng m·ªõi
  .replace(/<[^>]+>/g, '')                 // xo√° tag XML kh√°c
  .replace(/\n\s+\n/g, '\n')               // b·ªè d√≤ng tr·∫Øng d∆∞
  .replace(/&nbsp;/g, ' ')
  .trim();
  item.ndba = extractContent(plain, 'N·ªôi dung b·ªánh √°n');
item.ttt = extractContent(plain, 'Th·ªß Thu·∫≠t - Thu·ªëc');

  
    showPopupView(plain);
  } catch (err) {
    toast('Kh√¥ng th·ªÉ xem b·ªánh √°n: ' + err.message);
  }
}
function showPopupView(content) {
  const popup = document.createElement('div');
  popup.style = `
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: #0008;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;

  `;
  popup.id = 'viewPopupOverlay';

  popup.innerHTML = `
    <div style="
      background: #fff;
      padding: 90px 30px;
      max-width: 90%;
      max-height: 60%;
      overflow: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
      position: relative;
      font-size: 18px;
	    border: 2px solid #3498db; 
      line-height: 1.6;
      font-family: 'Segoe UI', sans-serif;
    " id="viewPopupContent">
     

      <pre style="
        white-space: pre-wrap;
        word-break: break-word;
      
      ">${content}</pre>
    </div>
  `;

  // Th√™m s·ª± ki·ªán click ra ngo√†i ƒë·ªÉ t·∫Øt popup
  popup.addEventListener('click', function(e) {
    if (e.target.id === 'viewPopupOverlay') {
      popup.remove();
    }
  });

  document.body.appendChild(popup);
  
  // Th√™m ph√≠m ESC ƒë·ªÉ t·∫Øt popup
  document.addEventListener('keydown', function escClose(e) {
    if (e.key === 'Escape') {
      popup.remove();
      document.removeEventListener('keydown', escClose);
    }
  });
}


</script>
<script>
document.getElementById('toggleFormBtn').onclick = function() {
  const form = document.getElementById('formBenhAn');
  if (form.style.display === 'none') {
    form.style.display = 'block';
    this.textContent = 'üîΩ ·∫®n form nh·∫≠p';
  } else {
    form.style.display = 'none';
    this.textContent = 'üìù Nh·∫≠p b·ªánh √°n';
  }
};

function showLoading(show) {
  const popup = document.getElementById('loadingPopup');
  if (popup) popup.style.display = show ? 'flex' : 'none';
}

// Hook loading popup into fetchDropboxFiles()
const originalFetchDropbox = window.fetchDropboxFiles;
window.fetchDropboxFiles = async function() {
  showLoading(true);
  try {
    return await originalFetchDropbox.apply(this, arguments);
  } finally {
    showLoading(false);
  }
};


// Hi·ªán form n·∫øu ƒëang ·∫©n khi b·∫•m n√∫t S·ª≠a
document.addEventListener('click', function(e) {
  const btn = e.target.closest('button[data-act="edit"]');
  if (btn) {
    const form = document.getElementById('formBenhAn');
    const toggleBtn = document.getElementById('toggleFormBtn');
    if (form && form.style.display === 'none') {
      form.style.display = 'block';
      if (toggleBtn) toggleBtn.textContent = 'üîΩ ·∫®n form nh·∫≠p';
    }
  }
});
</script><script>
window.addEventListener("DOMContentLoaded", () => {
  const loginScreen = document.getElementById('loginScreen');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const userField = document.getElementById('loginUser');
  const passField = document.getElementById('loginPass');
  const logoutBtn = document.getElementById('logoutBtn');

  const USERS = [
    { user: "bschau", pass: "1!" },
    { user: "Bschau", pass: "1!" }
  ];

  function showLoginError(msg) {
    loginMsg.textContent = msg;
  }

  loginBtn.onclick = function() {
    const u = userField.value.trim();
    const p = passField.value.trim();
    const matched = USERS.find(x => x.user === u && x.pass === p);
    if (matched) {
      localStorage.setItem("loggedIn", "yes");
      loginScreen.style.display = "none";
      logoutBtn.style.display = "inline-block";
    } else {
      showLoginError("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u.");
    }
  };

  [userField, passField].forEach(input => {
    input.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        loginBtn.click();
      }
    });
  });

  const ok = localStorage.getItem("loggedIn") === "yes";
  if (!ok) {
    loginScreen.style.display = "flex";
    logoutBtn.style.display = "none";
  } else {
    loginScreen.style.display = "none";
    logoutBtn.style.display = "inline-block";
  }

  logoutBtn.onclick = function() {
    localStorage.removeItem("loggedIn");
    location.reload();
  };
});
</script>
<style>

.dark-mode, 
.dark-mode * {
  background-color: #121212 !important;
  color: #ffffff !important;
  border-color: #444 !important;
}

.dark-mode {
  background: #121212 !important;
  color: #eee !important;
}
.dark-mode .section {
  background: #1e1e1e !important;
  color: #eee;
}
.dark-mode input, .dark-mode textarea {
  background: #2c2c2c;
  color: #fff;
  border: 1px solid #555;
}
.dark-mode table th, .dark-mode table td {
  border-color: #444;
}

.dark-mode thead {
  background-color: #333 !important;
  color: #fff !important;
}
.dark-mode pre {
  background: #222;
  color: #eee;
  border: 1px solid #444;
}

.dark-mode thead th {
  background-color: #222 !important;
  color: #eee !important;
  border-color: #444 !important;
}

#darkModeToggle {
  position: absolute;
  top: 20px;
  left: 130px;
  z-index: 9999;
}
</style>
<script>
(function() {
  let isCardView = false;

  function toggleView(view) {
    const table = document.querySelector("table");
    const cardContainer = document.getElementById("cardContainer");
    if (view === "card") {
      table.style.display = "none";
      cardContainer.style.display = "flex";
      renderCardView();
    } else {
      table.style.display = "";
      cardContainer.style.display = "none";
    }
  }

  function renderCardView() {
    const data = JSON.parse(localStorage.getItem('benhAnData_v2') || '[]');
    const container = document.getElementById("cardContainer");
    container.innerHTML = '';
    if (!data.length) {
      container.innerHTML = '<p style="color:#888;">Ch∆∞a c√≥ b·ªánh √°n.</p>';
      return;
    }
    data.forEach(item => {
      const div = document.createElement("div");
      div.style = "background:#fff;padding:16px;margin:10px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);width:100%;max-width:350px;";
      div.innerHTML = `
        <h3>${item.ten} (${item.tuoi} tu·ªïi)</h3>
        <p><b>M√£ BN:</b> ${item.maBN}</p>
        <p><b>Ng√†y v√†o:</b> ${item.ngayvao}</p>
        <p><b>Ch·∫©n ƒëo√°n:</b> ${item.cdtayy}</p>
        <div style="margin-top:10px;">
          <button data-id="${item.id}" data-act="edit" style="background:#2c3e50;color:#fff;padding:6px 10px;border:none;border-radius:4px;">S·ª≠a</button>
          <button data-id="${item.id}"data-act="del" style="background:#e74c3c;color:#fff;padding:6px 10px;border:none;border-radius:4px;">X√≥a</button>
          <button data-id="${item.id}"data-act="view" style="background:#3498db;color:#fff;padding:6px 10px;border:none;border-radius:4px;">Xem</button>
		  <button data-id="${item.id}" data-act="print" style="background:#27ae60;color:#fff;padding:6px 10px;border:none;border-radius:4px;">In</button>

        </div>
      `;
      container.appendChild(div);
    });
  }

  function editCard(id) {
    const btn = document.querySelector(`button[data-id="${id}"][data-act="edit"]`);
    if (btn) btn.click();
  }
  function deleteCard(id) {
    const btn = document.querySelector(`button[data-id="${id}"][data-act="del"]`);
    if (btn) btn.click();
  }
  function viewCard(id) {
    const btn = document.querySelector(`button[data-id="${id}"][data-act="view"]`);
    if (btn) btn.click();
  }

  window.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.getElementById("toggleCardBtn");
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        isCardView = !isCardView;
        toggleView(isCardView ? 'card' : 'table');
        toggleBtn.textContent = isCardView ? "Hi·ªÉn th·ªã b·∫£ng" : "Hi·ªÉn th·ªã th·∫ª";
      });
    }
  });
})();
</script><script>
window.addEventListener('DOMContentLoaded', () => {
  const darkToggle = document.getElementById('darkToggle');
  const isDark = localStorage.getItem('darkMode') === 'true';
  if (isDark) document.body.classList.add('dark-mode');

  if (darkToggle) {
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isNowDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isNowDark);
      darkToggle.textContent = isNowDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    });
    darkToggle.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  }
});
</script>
<div id="textareaPopup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#0008;z-index:9999;align-items:center;justify-content:center;">
<div id="popupContent" style="background:white;padding:10px;border-radius:10px;height:90%; max-width:90%;width:1000px;box-shadow:0 0 20px rgba(0,0,0,0.3);position:relative;">
<h3 style="margin-top:0;">üìù Ch·ªânh s·ª≠a chi ti·∫øt</h3>
<textarea id="popupTextarea" style="width:98%;height:80%;padding:10px;border:1px solid #ccc;border-radius:6px;"></textarea>
<div style="margin-top:10px;text-align:right;">
<button id="popupSave" style="background:#3498db;color:white;padding:8px 14px;" type="button">L∆∞u</button>
</div>
</div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  const popup = document.getElementById('textareaPopup');
  const popupTextarea = document.getElementById('popupTextarea');
  const popupSave = document.getElementById('popupSave');
  const popupCancel = document.getElementById('popupCancel');
  const popupContent = document.getElementById('popupContent');

  let targetTextarea = null;

  // G√°n dblclick cho t·∫•t c·∫£ textarea hi·ªán c√≥
  document.querySelectorAll('textarea').forEach(area => {
    area.addEventListener('dblclick', () => {
      targetTextarea = area;
      popupTextarea.value = area.value;
      popup.style.display = 'flex';
      popupTextarea.focus();
    });
  });

  // L∆∞u n·ªôi dung ƒë√£ s·ª≠a
  popupSave.addEventListener('click', () => {
    if (targetTextarea) {
      targetTextarea.value = popupTextarea.value;
    }
    popup.style.display = 'none';
  });


  // Click ra ngo√†i th√¨ ƒë√≥ng popup
  popup.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.style.display = 'none';
    }
  });

  // Nh·∫•n ESC c≈©ng ƒë√≥ng
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      popup.style.display = 'none';
    }
  });
});



document.getElementById('cardContainer').addEventListener('click', async (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-act');
  const item = benhAnData.find(x => x.id === id);
  if (!item) return;

  if (act === 'edit') {
    editingId = id;
    fillForm(item);
    document.getElementById('cancelEditBtn').style.display = 'inline-block';
    document.getElementById('submitBtn').textContent = 'C·∫≠p nh·∫≠t b·ªánh √°n';
    document.getElementById('formBenhAn').style.display = 'block';
    document.getElementById('toggleFormBtn').textContent = 'üîΩ ·∫®n form nh·∫≠p';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } else if (act === 'del') {
    if (await showConfirm('X√≥a b·ªánh √°n n√†y?')) {
      if (item.dropboxPath) {
        try {
          await deleteFromDropbox(item.dropboxPath);
        } catch (err) {
          console.error('L·ªói khi x√≥a Dropbox:', err);
        }
      }
      benhAnData = benhAnData.filter(x => x.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
      renderList();
      document.getElementById('toggleCardBtn').click(); // c·∫≠p nh·∫≠t card
      toast('ƒê√£ x√≥a.', true);
    }
  } else if (act === 'view') {
    viewBenhAn(item);
  }else if (act === 'print') {
  printBenhAn(item);
}
});



function printBenhAn(item) {
  const newWin = window.open('', '_blank');
  newWin.document.write(`
  <html>
  <head>
    <title>In b·ªánh √°n</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        padding: 40px;
        line-height: 1.6;
        background: #fdfdfd;
      }
      .print-container {
        max-width: 800px;
        margin: auto;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 30px;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 24px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      p {
        margin: 8px 0;
        font-size: 16px;
      }
      b {
        display: inline-block;
        width: 180px;
        color: #2c3e50;
      }
      .btn-print {
        display: block;
        margin: 30px auto 0;
        background: #27ae60;
        color: #fff;
        padding: 10px 18px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      @media print {
        .btn-print { display: none; }
        body { background: white; box-shadow: none; }
        .print-container { border: none; box-shadow: none; }
      }
    </style>
  </head>
  <body>
    <div class="print-container">
      <h2>B·ªánh √Ån</h2>
      <p><b>H·ªç t√™n:</b> ${item.ten}</p>
      <p><b>Tu·ªïi:</b> ${item.tuoi}</p>
      <p><b>M√£ BN:</b> ${item.maBN}</p>
      <p><b>ƒê·ªãa ch·ªâ:</b> ${item.diachi || ''}</p>
      <p><b>Ng√†y v√†o vi·ªán:</b> ${item.ngayvao}</p>
      <p><b>Ch·∫©n ƒëo√°n T√¢y y:</b> ${item.cdtayy}</p>
      <p><b>Ch·∫©n ƒëo√°n ƒê√¥ng y:</b> ${item.cddongy}</p>
      <p><b>N·ªôi dung b·ªánh √°n:</b><br>${(item.ndba || '').replace(/\n/g, '<br>')}</p>
  
      <button class="btn-print" onclick="window.print()">üñ® In b·ªánh √°n</button>
    </div>
  </body>
  </html>
  `);
  newWin.document.close();
}



function extractContent(text, label) {
  const regex = new RegExp(label + '[:Ôºö]?\\s*([\\s\\S]*?)(\\n[A-Z√Ä-·ª¥a-z√†-·ªµ]+\\s*[:Ôºö]|$)', 'i');
  const match = text.match(regex);
  return match ? match[1].trim() : '';
}





</script>
<center> 
<div class="procedure-info">
Design By <a href="http://fb.com/chauhuynh0104" target="_blank"> Dr.Ch√¢u</a>
               </center>
</div></center>
<style>
    .procedure-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,.06); }

</style>
</body>
</html>
