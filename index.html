<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω B·ªánh √Ån</title>
  <!-- Docx UMD (primary) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js" defer onload="window.__DOCX_LOADED__=true"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <!-- Fallback loader if primary CDN fails -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (!window.docx) {
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/docx/8.0.3/docx.umd.min.js';
          s.defer = true;
          s.onload = () => console.log('docx fallback loaded');
          document.head.appendChild(s);
        }
      }, 1200);
    });
	
window.addEventListener('DOMContentLoaded', () => {
  const data = JSON.parse(localStorage.getItem('benhAnData_v2') || '[]');
  if (!data.length) {
    fetchDropboxFiles().then(() => renderList());
  } else {
    renderList();
  }
});
	
  </script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f7fa; color: #333; }
    .container { max-width: 1100px; margin: auto; }
    h1 { text-align: center; color: var(--secondary-color); }
    .section { background: #fff; padding: 20px; border-radius: 8px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    label { font-weight: 600; display: block; margin: 8px 0 4px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .row { display: flex; gap: 12px; }
    .row .col { flex: 1; }
    button { background: var(--primary-color); color: #fff; border: 0; padding: 10px 14px; border-radius: 6px; cursor: pointer; }
    button.secondary { background: var(--secondary-color); }
    button.danger { background: var(--accent-color); }
    table { width: 100%; border-collapse: collapse; margin-top: 12px;}
    th, td { border: 1px solid #e5e7eb; padding: 10px; text-align: left; }
    th { background: #e9f3fb; }
    .status { padding: 10px; border-radius: 6px; margin-bottom: 10px; display: none; }
    .status.show { display: block; }
    .status.ok { background: #e8f5e9; color: #1b5e20; }
    .status.err { background: #ffebee; color: #b71c1c; }
    .muted { color: #666; font-size: 12px; }
    .token { font-family: monospace; background: #f3f4f6; padding: 6px 8px; border-radius: 6px; display: inline-block; }
  </style>
</head>
<body>



  <div class="container">
    <h1>Qu·∫£n l√Ω B·ªánh √Ån</h1>

    

    <div class="section">
      <h2>Nh·∫≠p/S·ª≠a B·ªánh √Ån</h2>
      <div id="statusBox" class="status"></div>
      <form id="formBenhAn">
        <div class="row">
          <div class="col">
            <label>H·ªç t√™n</label>
            <input type="text" name="ten" required />
          </div>
          <div class="col">
            <label>Tu·ªïi</label>
            <input type="number" name="tuoi" required />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>M√£ BN</label>
            <input type="text" name="maBN" required />
          </div>
          <div class="col">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" name="diachi" />
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Ng√†y v√†o vi·ªán</label>
            <input type="date" name="ngayvao" required />
          </div>
          <div class="col"></div>
        </div>
        <label>Ch·∫©n ƒëo√°n T√¢y y</label>
        <textarea name="cdtayy" rows="2"></textarea>
        <label>Ch·∫©n ƒëo√°n ƒê√¥ng y</label>
        <textarea name="cddongy" rows="2"></textarea>
        <label>N·ªôi dung b·ªánh √°n</label>
        <textarea name="ndba" rows="4" style="white-space: pre-wrap;"></textarea>
		  <label>Th·ªß Thu·∫≠t - Thu·ªëc</label>
        <textarea name="ttt" rows="4" style="white-space: pre-wrap;"></textarea>
		
        <div style="margin-top:10px;">
          <button type="submit" id="submitBtn">L∆∞u b·ªánh √°n</button>
          <button type="button" id="cancelEditBtn" class="secondary" style="display:none;">H·ªßy s·ª≠a</button>
        </div>
      </form>
    </div>

    <div class="section">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <h2 style="margin:0;">Danh s√°ch B·ªánh √Ån</h2>
        <button id="clearAllBtn" class="danger">X√≥a t·∫•t c·∫£</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>H·ªç t√™n</th>
            <th>Tu·ªïi</th>
            <th>M√£ BN</th>
            <th>Ng√†y v√†o</th>
            <th>Ch·∫©n ƒëo√°n T√¢y y</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== C·∫•u h√¨nh l∆∞u tr·ªØ ======
    const STORAGE_KEY = 'benhAnData_v2';
    const TOKEN_KEY = 'sl.u.AF7_xf_oBbyMkDcMxIvXoxbJQwzymfuubzIvVON-ivHM_aR87XkEJGUEDlbqo330vlYFw4nc64c_Ok8svAz6EXb6-Pw16qRQ-EwPUzvOrB3cu51ZIVipCMZtbDEAUWoLl3lG2kWN9ArjcR-sSgJ2-z4cjatEGL_LYLPgy3GJBMZUE3aoCJVbzDdTcW9jWUlf_Q1K9oQn5WzQ_s585Ixy6QJ1QOO0i2NfNWe62KxtL35oaiQMEXlRimZ-BKiaYODsv-XyGIe8ucFd6eAsDP6u00ILVZ8aLL7P-U2zGb70uFGEPveT-3Mn7HzQGGih0tR6frGmouw-XFSpvvZeKNPX8nxKDVyynXu5QTp2LvmtTA9DcWxtoT6TF4IoxrHExxisAwRNMRoNrM6HF4ayX83IqFLj3z9IcqLEPGBVbWNHvcY8wHPqXxty1qP_SHaU42eTfzRl9NUvm8LBoF1-48wGMUNOnTSy2QK-ZIMKSftINNLDg3XLqYMftu7-tgP5mQkM5ezBQetkCjW_Zdvp_Ndt41RSxw5dc7t1gELbRqf7IiXxTpIk6lMpeowG3K5ISFKy2PuLougECNi4JvUt2iaxT525mB2C49LCgPn0cUDagqb4ZK2OnY0mMU_Tv5vZHiGzG-MkwkgBkCgNfygAwAh8p6And7Y3Xt_D1-8LxWlYebVzLf2OlpBPYthqJqD5XH_A6J-YpC60oeiYhVSOvEvkXuPpLEVK7E7eXvsbC7D7hDmcI1OrAP2F2Em3thG1LWdRqJGCYPslOudcz-j7dKX1239Cq2__F0zyxOZzCfUjUe8cGDHO-K3AwEtOXLV2VSRXNULiouR6H_51_ibl3zXmioGu0Uy5PA9svLrTvLGPxI_3G8OnMN855q15HGzSIDq25kGDvR4rApq69svoMRmsD66Ih3gn28clz4iDj7vF1Rl0G74Jyw5CkMm618H6w1qMdo0S-dE92l3fVlhn77Rpvvdvl37LI9nBWHdxtidGZI-7Y-L_avtVemisHePj_yiz6FX0IdVGKFFbqU5NfihsJWILAd0FIqUkoC1ANaSIfFhkOaGxoJogMnvIVcayCZFWqWz8UtNDrVfZVzT6DeRnsaRr5XOzCITZzfyRQSqdguBz33F-swxccVM0yLnVkgbGUVgY9IsFvqK5mOD4cGxABVpFemI3qJOadZErnqgFNe6kkkxKPhK1AffIDRKOQAtzkNWL-52o1VhMBHb73XOxRiIJym0vD67MGOadUlPJK1UCWijWRrA3YWHpcMCAvmqsWSIpklbztXK66w1vNvSw_PY5YlXKy6ScOQItp7jiabU6u9DlRCdoj2bcYBgniNgkSeRy6JyMEyMPIMXRJTV9--Zn29RuG-toPjs5ydCva2pGTO6i2mPNlvhAo66Si1RRYpIDsIXiaSlWFGGQ0e_-3SFG '; // localStorage key cho access token
const REFRESH_KEY = 'refresh_token'; // l∆∞u refresh token
const APP_KEY = 'qzy5kclrf827aey ';
const APP_SECRET = '6jlsunzjqr3s3nh ';

// H√†m l·∫•y access token m·ªõi t·ª´ refresh token
async function getNewAccessToken(refresh_token) {
  const response = await fetch('https://api.dropbox.com/oauth2/token', {
    method: 'POST',
    headers: {
      'Authorization': 'Basic ' + btoa(`${APP_KEY}:${APP_SECRET}`),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: new URLSearchParams({
      grant_type: 'refresh_token',
      refresh_token: refresh_token
    })
  });

  const data = await response.json();
  if (data.access_token) {
    localStorage.setItem(TOKEN_KEY, data.access_token);
    return data.access_token;
  } else {
    throw new Error("L·∫•y token th·∫•t b·∫°i: " + JSON.stringify(data));
  }
}

// H√†m l·∫•y token: n·∫øu h·∫øt h·∫°n th√¨ t·ª± l√†m m·ªõi
async function getAccessToken() {
  let token = localStorage.getItem(TOKEN_KEY);
  // Gi·∫£ s·ª≠ b·∫°n t·ª± ki·ªÉm tra token c√≥ h·ª£p l·ªá hay kh√¥ng, ho·∫∑c lu√¥n l√†m m·ªõi
  const refreshToken = localStorage.getItem(REFRESH_KEY);

  if (!token && refreshToken) {
    token = await getNewAccessToken(refreshToken);
  }

  return token;
}




    let benhAnData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let editingId = null;

    // ====== Token removed for embedding ======

    // ====== Utils UI ======
    const statusBox = document.getElementById('statusBox');
    function toast(msg, ok=false) {
      statusBox.textContent = msg;
      statusBox.className = 'status show ' + (ok? 'ok' : 'err');
      setTimeout(() => { statusBox.className = 'status'; }, 4000);
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date)) return dateString;
      return date.toLocaleDateString('vi-VN');
    }

    // ====== Ki·ªÉm tra th∆∞ vi·ªán docx ======
    const libStatus = document.getElementById('libStatus');
function updateLibStatus() {
  const libStatus = document.getElementById('libStatus');
  if (libStatus) {
    libStatus.textContent = window.docx 
      ? 'Th∆∞ vi·ªán docx ƒë√£ s·∫µn s√†ng.' 
      : 'Ch∆∞a t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán docx. V·∫´n c√≥ th·ªÉ l∆∞u d·∫°ng .doc (t∆∞∆°ng th√≠ch Word).';
  }
}
    setTimeout(updateLibStatus, 1500);
    setInterval(updateLibStatus, 3000);

    function waitForDocx(timeoutMs=6000) {
      return new Promise((resolve) => {
        const start = Date.now();
        const t = setInterval(() => {
          if (window.docx) { clearInterval(t); resolve(true); }
          else if (Date.now() - start > timeoutMs) { clearInterval(t); resolve(false); }
        }, 200);
      });
    }

    // ====== T·∫°o file Word (.docx ho·∫∑c fallback .doc) ======
    async function buildDocxBlob(ba) {
      const ok = await waitForDocx();
      if (!ok) return null;
      try {
        const { Document, Packer, Paragraph, TextRun } = window.docx;
        const doc = new Document({
          sections: [{
            children: [
              new Paragraph({ children: [ new TextRun({ text: 'B·ªÜNH √ÅN', bold: true, size: 32 }) ] }),
              new Paragraph(''),
              new Paragraph({ children: [ new TextRun({ text: `H·ªç t√™n: ${ba.ten}`, bold: true }) ] }),
              new Paragraph(`Tu·ªïi: ${ba.tuoi}`),
              new Paragraph(`M√£ BN: ${ba.maBN}`),
              new Paragraph(`ƒê·ªãa ch·ªâ: ${ba.diachi||''}`),
              new Paragraph(`Ng√†y v√†o vi·ªán: ${ba.ngayvao}`),
              new Paragraph(`Ch·∫©n ƒëo√°n T√¢y y: ${ba.cdtayy||''}`),
              new Paragraph(`Ch·∫©n ƒëo√°n ƒê√¥ng y: ${ba.cddongy||''}`),
              new Paragraph('N·ªôi dung b·ªánh √°n:'),
              new Paragraph(ba.ndba || ''),
			     new Paragraph('Th·ªß Thu·∫≠t - Thu·ªëc:'),
              new Paragraph(ba.ttt || '')
			  
			  
            ]
          }]
        });
        const blob = await Packer.toBlob(doc);
        return blob;
      } catch (e) {
        console.error('docx error', e);
        return null;
      }
    }

    function buildDocHtmlBlob(ba) {
      const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head><meta charset="utf-8"><title>BenhAn</title></head>
        <body>
          <h2 style="text-align:center;">B·ªÜNH √ÅN</h2>
          <p><b>H·ªç t√™n:</b> ${ba.ten}</p>
          <p><b>Tu·ªïi:</b> ${ba.tuoi}</p>
          <p><b>M√£ BN:</b> ${ba.maBN}</p>
          <p><b>ƒê·ªãa ch·ªâ:</b> ${ba.diachi||''}</p>
          <p><b>Ng√†y v√†o vi·ªán:</b> ${ba.ngayvao}</p>
          <p><b>Ch·∫©n ƒëo√°n T√¢y y:</b> ${ba.cdtayy||''}</p>
          <p><b>Ch·∫©n ƒëo√°n ƒê√¥ng y:</b> ${ba.cddongy||''}</p>
          <p><b>N·ªôi dung b·ªánh √°n:</b><br/>${(ba.ndba||'').replace(/\n/g,'<br/>')}</p>
		    <p><b>Th·ªß Thu·∫≠t - Thu·ªëc :</b><br/>${(ba.ttt||'').replace(/\n/g,'<br/>')}</p>
        
<!-- Popup x√°c nh·∫≠n -->
<div id="popupConfirm" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#00000088;display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:90%;box-shadow:0 4px 10px rgba(0,0,0,0.3);text-align:center;">
    <p id="popupConfirmMsg" style="margin-bottom:20px;font-size:16px;"></p>
    <button id="popupOk" style="margin-right:10px;background:#3498db;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">OK</button>
    <button id="popupCancel" style="background:#ccc;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">H·ªßy</button>
  </div>
</div>

</body></html>`;
      return new Blob([html], { type: 'application/msword' });
    }

    async function createWordBlob(ba) {
      const docxBlob = await buildDocxBlob(ba);
      if (docxBlob) return { blob: docxBlob, ext: '.docx' };
      // Fallback to .doc (Word-compatible)
      return { blob: buildDocHtmlBlob(ba), ext: '.doc' };
    }

    // ====== Dropbox upload ======
   async function uploadToDropbox(filename, blob) {
  const path = `/BenhAn/${filename}`;
  const res = await fetch('https://content.dropboxapi.com/2/files/upload', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + TOKEN_KEY,
      'Dropbox-API-Arg': JSON.stringify({ path, mode: 'overwrite', autorename: false }),
      'Content-Type': 'application/octet-stream'
    },
    body: blob
  });

  if (!res.ok) {
    const txt = await res.text();
    throw new Error('Dropbox upload failed: ' + txt);
  }

  return path;
}

    async function deleteFromDropbox(path) {
      const token = TOKEN_KEY;
      if (!path || !token) return;
      await fetch('https://api.dropboxapi.com/2/files/delete_v2', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + TOKEN_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ path })
      });
    }


    // ====== Render list ======
    const listBody = document.getElementById('listBody');
    function renderList(data = benhAnData) {
      listBody.innerHTML = '';
      if (!data.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center;color:#666;">Ch∆∞a c√≥ b·ªánh √°n</td>';
        listBody.appendChild(tr);
        return;
      }
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.ten}</td>
          <td>${item.tuoi}</td>
          <td>${item.maBN}</td>
          <td>${formatDate(item.ngayvao)}</td>
          <td>${(item.cdtayy||'').slice(0,30)}${(item.cdtayy||'').length>30?'...':''}</td>
          <td>
            <button class="secondary" data-id="${item.id}" data-act="edit">‚úèÔ∏è S·ª≠a</button>
            <button class="danger" data-id="${item.id}" data-act="del">üóëÔ∏è X√≥a</button>
			  <button data-id="${item.id}" data-act="view">üëÅÔ∏è Xem</button>
          </td>
        `;
        listBody.appendChild(tr);
      });
    }
    renderList();

    listBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
	    const item = benhAnData.find(x => x.id === id);
      if (act === 'del') {
        if (await showConfirm('X√≥a b·ªánh √°n n√†y?')) {
        
          if (item && item.dropboxPath) {
            try {
              await deleteFromDropbox(item.dropboxPath);
            } catch (err) {
              console.error('L·ªói khi x√≥a file Dropbox:', err);
            }
          }
          benhAnData = benhAnData.filter(x => x.id !== id);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
          renderList();
          toast('ƒê√£ x√≥a.', true);
        }
      } else if (act === 'edit') {
        const item = benhAnData.find(x => x.id === id);
        if (!item) return;
        editingId = id;
        fillForm(item);
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        document.getElementById('submitBtn').textContent = 'C·∫≠p nh·∫≠t b·ªánh √°n';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }else if (act === 'view') {
  viewBenhAn(item);
}
    });

    function fillForm(ba) {
  const form = document.getElementById('formBenhAn');
  for (const k in ba) {
    const field = form.querySelector(`[name="${k}"]`);
    if (field) field.value = ba[k];
  }
}
    

    document.getElementById('cancelEditBtn').onclick = () => {
      editingId = null;
      document.getElementById('formBenhAn').reset();
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('submitBtn').textContent = 'L∆∞u b·ªánh √°n';
    };

 document.getElementById('clearAllBtn').onclick = async () => {
      if (await showConfirm('X√≥a T·∫§T C·∫¢ b·ªánh √°n?')) {
        benhAnData = [];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
        renderList();
        toast('ƒê√£ x√≥a t·∫•t c·∫£.', true);
      }
    };

    
    // ====== Popup Confirm thay cho confirm() ======
    function showConfirm(message) {
      return new Promise((resolve) => {
        const popup = document.getElementById('popupConfirm');
        const msg = document.getElementById('popupConfirmMsg');
        const okBtn = document.getElementById('popupOk');
        const cancelBtn = document.getElementById('popupCancel');
        msg.textContent = message;
        popup.style.display = 'flex';
        okBtn.onclick = () => { popup.style.display = 'none'; resolve(true); };
        cancelBtn.onclick = () => { popup.style.display = 'none'; resolve(false); };
      });
    }

    // ====== Submit form ======
    const form = document.getElementById('formBenhAn');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const ba = {
        id: editingId || Date.now().toString(),
        ten: data.get('ten'),
        tuoi: data.get('tuoi'),
        maBN: data.get('maBN'),
        diachi: data.get('diachi'),
        ngayvao: data.get('ngayvao'),
        cdtayy: data.get('cdtayy'),
        cddongy: data.get('cddongy'),
        ndba: data.get('ndba'),
		     ttt: data.get('ttt'),
      };

      try {
        // 1) T·∫°o file (docx n·∫øu ƒë∆∞·ª£c, fallback .doc n·∫øu kh√¥ng)
        const { blob, ext } = await createWordBlob(ba);
        const fileName = `${ba.maBN}_${ba.ngayvao}${ext}`;


        // 2) Upload Dropbox
        const path = await uploadToDropbox(fileName, blob);
        ba.dropboxPath = path;

        // 3) L∆∞u/ c·∫≠p nh·∫≠t localStorage
        if (editingId) {
          const idx = benhAnData.findIndex(x => x.id === editingId);
          if (idx >= 0) benhAnData[idx] = ba;
          editingId = null;
          document.getElementById('cancelEditBtn').style.display = 'none';
          document.getElementById('submitBtn').textContent = 'L∆∞u b·ªánh √°n';
          toast('ƒê√£ c·∫≠p nh·∫≠t b·ªánh √°n & file Word tr√™n Dropbox.', true);
        } else {
          benhAnData.unshift(ba);
          toast('ƒê√£ l∆∞u b·ªánh √°n & t·∫°o file Word tr√™n Dropbox.', true);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
        renderList();
        form.reset();
      } catch (err) {
        console.error(err);
        toast(err.message || 'C√≥ l·ªói khi t·∫°o/ t·∫£i l√™n file.', false);
      }
    });
  </script>

<!-- Popup x√°c nh·∫≠n -->
<div id="popupConfirm" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#00000088;display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:90%;box-shadow:0 4px 10px rgba(0,0,0,0.3);text-align:center;">
    <p id="popupConfirmMsg" style="margin-bottom:20px;font-size:16px;"></p>
    <button id="popupOk" style="margin-right:10px;background:#3498db;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">OK</button>
    <button id="popupCancel" style="background:#ccc;border:none;padding:8px 16px;border-radius:5px;cursor:pointer;">H·ªßy</button>
  </div>
</div>




<script>
async function fetchDropboxFiles() {
  const token = TOKEN_KEY;
  const STORAGE_KEY = 'benhAnData_v2';
  let benhAnData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

  try {
    const listRes = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + TOKEN_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ path: '/BenhAn' })
    });
    const listJson = await listRes.json();
    const entries = listJson.entries || [];

    for (const file of entries) {
      if (!file.name.endsWith('.docx')) continue;

      const downloadRes = await fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + TOKEN_KEY,
          'Dropbox-API-Arg': JSON.stringify({ path: file.path_lower })
        }
      });

      const blob = await downloadRes.blob();
      const arrayBuffer = await blob.arrayBuffer();
      const zip = await JSZip.loadAsync(arrayBuffer);
      const documentXml = await zip.file("word/document.xml").async("text");

      const match = (label) => {
        const regex = new RegExp(label + ': ([^<]+)');
        const found = documentXml.match(regex);
        return found ? found[1] : '';
      };

      const ba = {
        id: Date.now().toString() + Math.random(),
        ten: match('H·ªç t√™n'),
        tuoi: match('Tu·ªïi'),
        maBN: match('M√£ BN'),
        diachi: match('ƒê·ªãa ch·ªâ'),
        ngayvao: match('Ng√†y v√†o vi·ªán'),
        cdtayy: match('Ch·∫©n ƒëo√°n T√¢y y'),
        cddongy: match('Ch·∫©n ƒëo√°n ƒê√¥ng y'),
        ndba: match('N·ªôi dung b·ªánh √°n'),
		  ttt: match('Th·ªß Thu·∫≠t - Thu·ªëc'),
        dropboxPath: file.path_lower
      };

      if (ba.maBN && !benhAnData.some(x => x.maBN === ba.maBN)) {
        benhAnData.push(ba);
      }
    }

    localStorage.setItem(STORAGE_KEY, JSON.stringify(benhAnData));
    renderList(benhAnData);
  } catch (err) {
    console.error('L·ªói khi t·∫£i file t·ª´ Dropbox:', err);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const data = JSON.parse(localStorage.getItem('benhAnData_v2') || '[]');

  
  if (!data.length) fetchDropboxFiles();
  
});



async function viewBenhAn(item) {
  try {
    const res = await fetch('https://content.dropboxapi.com/2/files/download', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + TOKEN_KEY,
        'Dropbox-API-Arg': JSON.stringify({ path: item.dropboxPath })
      }
    });
    const blob = await res.blob();
    const buffer = await blob.arrayBuffer();
    const zip = await JSZip.loadAsync(buffer);
    const doc = await zip.file('word/document.xml').async('text');
    const plain = doc
  .replace(/<w:p[^>]*>/g, '\n')            // m·ªói ƒëo·∫°n <w:p> = 1 d√≤ng m·ªõi
  .replace(/<[^>]+>/g, '')                 // xo√° tag XML kh√°c
  .replace(/\n\s+\n/g, '\n')               // b·ªè d√≤ng tr·∫Øng d∆∞
  .replace(/&nbsp;/g, ' ')
  .trim();
    showPopupView(plain);
  } catch (err) {
    toast('Kh√¥ng th·ªÉ xem b·ªánh √°n: ' + err.message);
  }
}
function showPopupView(content) {
  const popup = document.createElement('div');
  popup.style = `
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: #0008;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  popup.id = 'viewPopupOverlay';

  popup.innerHTML = `
    <div style="
      background: #fff;
      padding: 150px 60px;
      max-width: 1000px;
      max-height: 90%;
      overflow: auto;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
      position: relative;
      font-size: 16px;
      line-height: 1.6;
      font-family: 'Segoe UI', sans-serif;
    " id="viewPopupContent">
      <button onclick="this.parentNode.parentNode.remove()" style="
        position: absolute;
        top: 12px;
        right: 12px;
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
      ">√ó</button>

      <pre style="
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 16px;
        line-height: 1.6;
      ">${content}</pre>
    </div>
  `;

  // Th√™m s·ª± ki·ªán click ra ngo√†i ƒë·ªÉ t·∫Øt popup
  popup.addEventListener('click', function(e) {
    if (e.target.id === 'viewPopupOverlay') {
      popup.remove();
    }
  });

  document.body.appendChild(popup);
  
  // Th√™m ph√≠m ESC ƒë·ªÉ t·∫Øt popup
  document.addEventListener('keydown', function escClose(e) {
    if (e.key === 'Escape') {
      popup.remove();
      document.removeEventListener('keydown', escClose);
    }
  });
}


</script>


</body>
</html>
