<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chauhuynh0104 - Ki·ªÉm tra t·ªù ƒëi·ªÅu tr·ªã</title>
<style>
:root {
    --bg: #f1f5f9;
    --card: #ffffff;
    --primary: #2563eb;
    --primary-soft: #dbeafe;
    --danger: #dc2626;
    --danger-soft: #fee2e2;
    --success: #16a34a;
    --success-soft: #dcfce7;
    --border: #e5e7eb;
    --text: #0f172a;
    --muted: #64748b;
    --table-border: #93c5fd;
    --table-header: #dbeafe;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    min-height: 100vh;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, #f8fafc, #eef2ff);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 40px;
}

.container {
    width: 100%;
    max-width: 920px;
    background: var(--card);
    border-radius: 18px;
    padding: 28px 34px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
}

h1 {
    margin-top: 0;
    font-size: 26px;
    font-weight: 600;
    text-align: center;
    color: var(--primary);
}

.upload-box {
    margin: 26px 0;
    border: 2px dashed #c7d2fe;
    border-radius: 16px;
    padding: 30px;
    text-align: center;
    background: #f8fafc;
    transition: all 0.25s ease;
}

.upload-box:hover {
    border-color: var(--primary);
    background: var(--primary-soft);
}

input[type="file"] {
    display: none;
}

.upload-label {
    display: inline-block;
    padding: 14px 28px;
    border-radius: 14px;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: #ffffff;
    font-weight: 600;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease;
    box-shadow: 0 10px 22px rgba(37,99,235,0.25);
}

.upload-label:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 30px rgba(37,99,235,0.35);
}

#fileName {
    margin-top: 14px;
    font-size: 14px;
    color: var(--muted);
}

h2 {
    margin-top: 30px;
    font-size: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
}

.ok {
    color: var(--success);
    background: var(--success-soft);
    border-left: 5px solid var(--success);
    padding: 12px 16px;
    border-radius: 12px;
    margin: 12px 0;
    font-weight: 600;
    font-size: 15px;
}

/* B·∫£ng chung (l·ªói + b√°o thu·ªëc) */
.common-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 15px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
	border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.common-table th {
   padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            word-break: break-word;
            max-width: 200px;
			background: #f2f2f2;
            position: sticky;
            top: 0;
			 background: linear-gradient(90deg, #3498db, #2980b9) !important;
  color: #fff !important;
  font-weight: bold;
  
  
}
 .hang {
        background-color: #e0f7fa;
    }
tr:hover td {
  background: rgba(0,0,0,0.03);
}
.common-table td {
    padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
            word-break: break-word;
            max-width: 200px;
			transition: background 0.2s ease-in-out;
			
}

.common-table tr:last-child td {
    border-bottom: none;
}

.common-table tr:nth-child(even) {
    background: #f0f9ff;
}

td hr {
    border: none;
    height: 1px;
    background: #ddd;        /* m√†u gi·ªëng vi·ªÅn b·∫£ng */
    margin: 12px 0;
}

.common-table .date-col {
    font-weight: 600;
    white-space: nowrap;
    width: 180px;
}
/* C·∫£i thi·ªán b·∫£ng l·ªói - tho√°ng h∆°n, cao h√†ng g·∫•p ƒë√¥i */
.error-msg-item {
    margin-bottom: 12px;
    line-height: 1.6;
    padding: 8px 0;
}

.error-msg-divider {
    height: 1px;
    background: #ddd;
    margin: 14px 0;
}

/* TƒÉng chi·ªÅu cao h√†ng b·∫£ng chung cho ƒë·∫πp */
.common-table td {
    padding: 20px 12px !important;  /* TƒÉng padding d·ªçc ‚Üí h√†ng cao h∆°n */
    vertical-align: top;
}

.common-table th {
    padding: 16px 12px !important;
}

/* ƒê·∫£m b·∫£o h√†ng xen k·∫Ω v·∫´n n·ªïi b·∫≠t nh·∫π */
.hang {
    background-color: #f8fbff;
    transition: background 0.2s ease;
}

.hang:hover {
    background-color: #eef4ff !important;
}
#result h3 {
    margin-top: 28px;
    color: var(--primary);
}
.footer {
    margin-top: 60px;
    text-align: center;
    color: var(--muted);
    font-size: 15px;
    padding: 25px 0;
    border-top: 1px solid var(--border);
}
</style>
</head>
<body>

<div class="container">


<div class="upload-box">
    <label for="fileInput" class="upload-label">
        üìÇ Ch·ªçn file HTML ƒë·ªÉ ki·ªÉm tra
    </label>
    <input type="file" id="fileInput" accept=".html">
    <div id="fileName"></div>
</div>
<div id="result"></div>

<div class="footer">
        Design By <strong>Dr.Ch√¢u</strong>
    </div>
</div>

<script>
// H√†m ƒë·ªãnh d·∫°ng ng√†y + th·ª©
function formatDateWithDay(dateStr) {
    const [dd, mm, yyyy] = dateStr.split("/").map(Number);
    const date = new Date(yyyy, mm - 1, dd);
    const days = ["Ch·ªß nh·∫≠t", "Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7"];
    const dayName = days[date.getDay()];
    return `${dayName} - ${dateStr}`;
}

function hasText(content, text) {
    return content.toLowerCase().includes(text.toLowerCase());
}

function dateToNumber(d) {
    const [dd, mm, yyyy] = d.split("/");
    return new Date(yyyy, mm - 1, dd).getTime();
}

function getDateRange(start, end) {
    const dates = [];
    let cur = new Date(start.split("/").reverse().join("-"));
    const last = new Date(end.split("/").reverse().join("-"));

    while (cur <= last) {
        const dd = String(cur.getDate()).padStart(2, "0");
        const mm = String(cur.getMonth() + 1).padStart(2, "0");
        const yyyy = cur.getFullYear();
        dates.push(`${dd}/${mm}/${yyyy}`);
        cur.setDate(cur.getDate() + 1);
    }
    return dates;
}

function runCheck() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Ch∆∞a ch·ªçn file HTML");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const html = e.target.result;
        processHTML(html);
    };
    reader.readAsText(file);
}





function processHTML(html) {
const patient = getPatientInfo(html);
    const rawErrors = [];
    const days = [];

// ==== Info b·ªánh nh√¢n ======

function getPatientInfo(html) {
    const info = {
        name: "",
        age: "",
        gender: ""
    };

    // H·ªç t√™n ng∆∞·ªùi b·ªánh
    const nameRegex =
        /H·ªç&nbsp;t&#234;n&nbsp;ng∆∞·ªùi&nbsp;b·ªánh:<\/nobr>\s*<\/td>[\s\S]*?<nobr>(.*?)<\/nobr>/i;
    const nameMatch = html.match(nameRegex);
    if (nameMatch) info.name = nameMatch[1];

    // Tu·ªïi
    const ageRegex =
        /Tu·ªïi:<\/nobr>\s*<\/td>[\s\S]*?<nobr>(.*?)<\/nobr>/i;
    const ageMatch = html.match(ageRegex);
    if (ageMatch) info.age = ageMatch[1];

    // Gi·ªõi t√≠nh
    const genderRegex =
        /Gi·ªõi&nbsp;t&#237;nh:<\/nobr>\s*<\/td>[\s\S]*?<nobr>(.*?)<\/nobr>/i;
    const genderMatch = html.match(genderRegex);
    if (genderMatch) info.gender = genderMatch[1];

    return info;
}



    // ===== 1. T√°ch ng√†y =====
    const dayRegex = /<td\b[^>]*>\s*<nobr>\d{2}\/\d{2}\/\d{4}<\/nobr>[\s\S]*?<\/td>/gi;
    const matches = html.match(dayRegex) || [];
    for (let i = 0; i < matches.length; i++) {
        const start = html.indexOf(matches[i]);
        const end = (i < matches.length - 1) ? html.indexOf(matches[i + 1]) : html.length;
        const block = html.substring(start, end);

        const dateMatch = matches[i].match(/<nobr>(\d{2}\/\d{2}\/\d{4})<\/nobr>/);
        const date = dateMatch ? dateMatch[1] : "Kh√¥ng x√°c ƒë·ªãnh";

        days.push({ date, content: block });
    }

    const validDays = days.filter(d => !d.content.includes("ra vi·ªán"));

    // ===== 2. Th·ªß thu·∫≠t =====
    const techniques = [
        { key: "[kim ng·∫Øn]", label: "ƒêi·ªán ch√¢m [kim ng·∫Øn]" },
        { key: "b·∫•m huy·ªát b·∫±ng tay", label: "Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay" },
        { key: "ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i", label: "ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i" },
        { key: "K·ªπ thu·∫≠t xoa", label: "K·ªπ thu·∫≠t xoa b√≥p v√πng" }
    ];

    techniques.forEach(t => {
        let mustHave = false;
        validDays.forEach(d => {
            if (hasText(d.content, "Th·ª© b·∫£y") || hasText(d.content, "Ch·ªß nh·∫≠t")) return;
            if (d.content.includes(t.key)) mustHave = true;
            if (mustHave && !d.content.includes(t.key)) {
                rawErrors.push({
                    date: d.date,
                    msg: `Thi·∫øu th·ªß thu·∫≠t: ${t.label}`
                });
            }
        });
    });

    // ===== 3. V·ªã thu·ªëc + S·∫Øc thu·ªëc =====
    const vtBlockRegex = /V·ªã thu·ªëc y h·ªçc c·ªï truy·ªÅn[\s\S]*?(x\s*\d+\s*thang)/g;
    let vtMatch;
    while ((vtMatch = vtBlockRegex.exec(html)) !== null) {
        const block = vtMatch[0];
        const dateMatch = block.match(/ng&agrave;y (\d{2}\/\d{2}\/\d{4}) ƒë·∫øn ng&agrave;y (\d{2}\/\d{2}\/\d{4})/);
        if (!dateMatch) continue;

        const start = dateMatch[1];
        const end = dateMatch[2];

        const [dd1, mm1, yyyy1] = start.split("/").map(Number);
        const [dd2, mm2, yyyy2] = end.split("/").map(Number);
        const startDate = new Date(yyyy1, mm1 - 1, dd1);
        const endDate = new Date(yyyy2, mm2 - 1, dd2);
        const realDays = Math.floor((endDate - startDate) / (1000*60*60*24)) + 1;

        const thangMatch = block.match(/x\s*(\d+)\s*thang/);
        const declaredThang = thangMatch ? parseInt(thangMatch[1]) : null;

        if (declaredThang !== realDays) {
            rawErrors.push({
                date: start,
                msg: `Sai s·ªë thang thu·ªëc (${formatDateWithDay(start)} ‚Üí ${formatDateWithDay(end)}): ghi x ${declaredThang} thang, ƒë√∫ng ph·∫£i l√† x ${realDays} thang`
            });
        }

        const daysInRange = validDays.filter(
            d => dateToNumber(d.date) >= dateToNumber(start) && dateToNumber(d.date) <= dateToNumber(end)
        );

        daysInRange.forEach(d => {
            if (!d.content.includes("S·∫Øc thu·ªëc thang")) {
                rawErrors.push({
                    date: d.date,
                    msg: `Thi·∫øu th·ªß thu·∫≠t S·∫Øc thu·ªëc thang`
                });
            } else {
                const startRegex = new RegExp(start.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*,');
                if (!startRegex.test(d.content)) {
                    rawErrors.push({
                        date: d.date,
                        msg: `Th·ªß thu·∫≠t s·∫Øc thu·ªëc thang kh√¥ng ƒë√∫ng ng√†y b·∫Øt ƒë·∫ßu (${formatDateWithDay(start)})`
                    });
                }
            }
        });
    }

/*  
  // ===== 4. Thu·ªëc vi√™n =====
    const pills = ["Amlodipine 5 mg Cap"];
    pills.forEach(p => {
        let must = false;
        validDays.forEach(d => {
            if (d.content.includes(p)) must = true;
            if (must && !d.content.includes(p)) {
                rawErrors.push({
                    date: d.date,
                    msg: `Thi·∫øu thu·ªëc: ${p}`
                });
            }
        });
    });
*/

    // ===== 5. Thu·ªëc ti√™m =====
    validDays.forEach(d => {
        if (d.content.includes("Dubemin injection") && !d.content.includes("Th·ªßy ch&acirc;m:")) {
            rawErrors.push({
                date: d.date,
                msg: `C√≥ Dubemin injection nh∆∞ng thi·∫øu Th·ªßy ch&acirc;m`
            });
        }
    });

    // ===== 6. C·∫≠n l√¢m s√†ng =====
    for (let i = 0; i < validDays.length - 1; i++) {
        const d = validDays[i];
        if (d.content.includes("ƒë·∫øm t·ªïng tr·ªü") || d.content.includes("Ch·∫©n ƒëo&aacute;n h&igrave;nh ·∫£nh")) {
            let j = i + 1;
            while (j < validDays.length && (hasText(validDays[j].content, "Th·ª© b·∫£y") || hasText(validDays[j].content, "Ch·ªß nh·∫≠t"))) {
                j++;
            }
            if (j < validDays.length && !validDays[j].content.includes("K·∫øt qu·∫£ CLS")) {
                rawErrors.push({
                    date: validDays[j].date,
                    msg: `Thi·∫øu "K·∫øt qu·∫£ CLS"`
                });
            }
        }
    }

   // ===== 7. B√°o thu·ªëc ƒë√£ d√πng (theo y√™u c·∫ßu m·ªõi) =====
    // C√°c thu·ªëc ch·ªâ hi·ªÉn th·ªã ng√†y ƒë·∫ßu - ng√†y cu·ªëi + ki·ªÉm tra thi·∫øu
    const rangeDisplayItems = ["Amlodipine 5 mg Cap", "Mimosa", "Kamelox 15", "Gi√°c h∆°i", "Khang minh thanh"];
    // Thu·ªëc li·ªát k√™ t·ª´ng ng√†y, kh√¥ng ki·ªÉm tra thi·∫øu
    const listEachDayItems = ["Dubemin injection"];

    const allTrackedItems = [...rangeDisplayItems, ...listEachDayItems];
    const used = {};
    allTrackedItems.forEach(t => used[t] = []);

    validDays.forEach(d => {
        allTrackedItems.forEach(t => {
            if (d.content.includes(t)) used[t].push(d.date);
        });
    });
let patientInfoHTML = `
<div style="
    margin: 20px 0;
    padding: 16px 20px;
    background: #eef2ff;
    border-left: 6px solid #2563eb;
    border-radius: 12px;
    font-size: 15px;
    line-height: 1.6;
">
    <strong>üë§ TH√îNG TIN NG∆Ø·ªúI B·ªÜNH</strong><br>
    H·ªç t√™n: <strong>${patient.name || "Kh√¥ng x√°c ƒë·ªãnh"}</strong><br>
    Tu·ªïi: <strong>${patient.age || "Kh√¥ng x√°c ƒë·ªãnh"}</strong><br>
    Gi·ªõi t√≠nh: <strong>${patient.gender || "Kh√¥ng x√°c ƒë·ªãnh"}</strong>
</div>
`;
    let reportTable = `
    <table class="common-table">
        <thead>
            <tr>
                <th style="width:240px;">T√™n</th>
                <th style="width:300px;">Ng√†y ƒë√£ d√πng</th>
                <th>Thi·∫øu ng√†y</th>
            </tr>
        </thead>
        <tbody>`;

    allTrackedItems.filter(t => used[t].length > 0).forEach(t => {
        let datesHTML = "";
        let missingHTML = "";

        if (listEachDayItems.includes(t)) {
            // Dubemin: li·ªát k√™ t·ª´ng ng√†y, xu·ªëng d√≤ng, kh√¥ng ki·ªÉm tra thi·∫øu
            datesHTML = used[t].map(d => formatDateWithDay(d)).join("<br>");
        } else {
            // C√°c thu·ªëc c√≤n l·∫°i: ch·ªâ hi·ªÉn th·ªã ng√†y ƒë·∫ßu v√† ng√†y cu·ªëi
            const start = used[t][0];
            const end = used[t][used[t].length - 1];
            datesHTML = `${formatDateWithDay(start)}<br>${formatDateWithDay(end)}`;

            // Ki·ªÉm tra thi·∫øu ng√†y trong kho·∫£ng
            const fullRange = getDateRange(start, end);
            const missing = fullRange.filter(d => !used[t].includes(d));
            if (missing.length > 0) {
                const formattedMissing = missing.map(d => formatDateWithDay(d)).join("<br> ");
                missingHTML = `<span style="color:#dc2626">${formattedMissing}</span>`;
            }
        }

        reportTable += `
        <tr class="hang">
            <td><strong>${t}</strong></td>
            <td>${datesHTML}</td>
            <td>${missingHTML}</td>
        </tr>`;
    });

    reportTable += `</tbody></table>`;

    // ===== HI·ªÇN TH·ªä K·∫æT QU·∫¢ =====
    const out = document.getElementById("result");
    out.innerHTML = patientInfoHTML + reportTable;


    if (rawErrors.length === 0) {
        out.innerHTML += `<div class="ok">Kh√¥ng ph√°t hi·ªán l·ªói</div>`;
        return;
    }

    // G·ªôp l·ªói theo ng√†y
    const errorsByDate = {};
    rawErrors.forEach(err => {
        if (!errorsByDate[err.date]) errorsByDate[err.date] = [];
        errorsByDate[err.date].push(err.msg);
    });

    // S·∫Øp x·∫øp theo ng√†y
    const sortedDates = Object.keys(errorsByDate).sort((a, b) => dateToNumber(a) - dateToNumber(b));

    // T·∫°o b·∫£ng l·ªói
// T·∫°o b·∫£ng l·ªói - CƒÇN GI·ªÆA NG√ÄY THEO CHI·ªÄU D·ªåC, ƒê·∫∏P H∆†N
let errorTableHTML = `
    <table class="common-table" style="margin-top: 40px;">
        <thead>
            <tr>
                <th style="width: 200px;">Ng√†y</th>
                <th>N·ªôi dung l·ªói</th>
            </tr>
        </thead>
        <tbody>`;

    sortedDates.forEach(date => {
        const formattedDate = formatDateWithDay(date);
        
        // Danh s√°ch l·ªói, m·ªói l·ªói m·ªôt div ri√™ng, kho·∫£ng c√°ch ƒë·∫πp
        const messagesHTML = errorsByDate[date]
            .map(msg => `<div style="margin-bottom: 14px; line-height: 1.5;">${msg}</div>`)
            .join('<hr style="margin: 14px 0; border: none; height: 1px; background: #ddd;">');

        errorTableHTML += `
        <tr class="hang" style="vertical-align: middle;">
            <td class="date-col" style="padding: 24px 12px; font-weight: 600; text-align: left;">
                ${formattedDate}
            </td>
            <td style="padding: 24px 16px;">
                ${messagesHTML}
            </td>
        </tr>`;
    });

    errorTableHTML += `</tbody></table>`;
    out.innerHTML += errorTableHTML;
	
	// === T·ª∞ ƒê·ªòNG CU·ªòN XU·ªêNG K·∫æT QU·∫¢ ===
   setTimeout(() => {
        const firstTable = out.querySelector(".common-table");
        if (firstTable) {
            firstTable.scrollIntoView({
                behavior: "smooth",
                block: "start"  // ƒê∆∞a ph·∫ßn ƒë·∫ßu b·∫£ng l√™n g·∫ßn ƒë·ªânh m√†n h√¨nh
            });
        } else {
            // N·∫øu ch·ªâ c√≥ d√≤ng "Kh√¥ng ph√°t hi·ªán l·ªói"
            out.scrollIntoView({
                behavior: "smooth",
                block: "start"
            });
        }
    }, 100);  // 100ms l√† ƒë·ªß ƒë·ªÉ browser render xong n·ªôi dung m·ªõi

	
}

document.getElementById("fileInput").addEventListener("change", function () {
    if (this.files.length) {
        document.getElementById("fileName").textContent = this.files[0].name;
        runCheck();
    }
});
</script>

</body>
</html>

