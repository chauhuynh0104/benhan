<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ki·ªÉm tra t·ªù ƒëi·ªÅu tr·ªã b·ªánh √°n</title>
<style>
:root {
    --bg: #f1f5f9;
    --card: #ffffff;
    --primary: #2563eb;
    --primary-soft: #dbeafe;
    --danger: #dc2626;
    --danger-soft: #fee2e2;
    --success: #16a34a;
    --success-soft: #dcfce7;
    --border: #e5e7eb;
    --text: #0f172a;
    --muted: #64748b;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    min-height: 100vh;
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, #f8fafc, #eef2ff);
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 40px;
}

.container {
    width: 100%;
    max-width: 920px;
    background: var(--card);
    border-radius: 18px;
    padding: 28px 34px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
}

h1 {
    margin-top: 0;
    font-size: 26px;
    font-weight: 600;
    text-align: center;
    color: var(--primary);
}

.upload-box {
    margin: 26px 0;
    border: 2px dashed #c7d2fe;
    border-radius: 16px;
    padding: 30px;
    text-align: center;
    background: #f8fafc;
    transition: all 0.25s ease;
}

.upload-box:hover {
    border-color: var(--primary);
    background: var(--primary-soft);
}

input[type="file"] {
    display: none;
}

.upload-label {
    display: inline-block;
    padding: 14px 28px;
    border-radius: 14px;
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: #ffffff;
    font-weight: 600;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease;
    box-shadow: 0 10px 22px rgba(37,99,235,0.25);
}

.upload-label:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 30px rgba(37,99,235,0.35);
}

#fileName {
    margin-top: 14px;
    font-size: 14px;
    color: var(--muted);
}

h2 {
    margin-top: 30px;
    font-size: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 8px;
}

.error {
    color: var(--danger);
    background: var(--danger-soft);
    border-left: 5px solid var(--danger);
    padding: 10px 14px;
    border-radius: 10px;
    margin: 8px 0;
    font-size: 15px;
}

.ok {
    color: var(--success);
    background: var(--success-soft);
    border-left: 5px solid var(--success);
    padding: 12px 16px;
    border-radius: 12px;
    margin: 12px 0;
    font-weight: 600;
    font-size: 15px;
}

#result h3 {
    margin-top: 28px;
    color: var(--primary);
}
</style>

</head>
<body>

<div class="container">

<h1>Ki·ªÉm tra t·ªù ƒëi·ªÅu tr·ªã b·ªánh √°n</h1>

<div class="upload-box">
    <label for="fileInput" class="upload-label">
        üìÇ Ch·ªçn file HTML ƒë·ªÉ ki·ªÉm tra
    </label>
    <input type="file" id="fileInput" accept=".html">
    <div id="fileName">Ch∆∞a ch·ªçn file</div>
</div>

<h2>K·∫øt qu·∫£</h2>
<div id="result"></div>

</div>
<script>
document.getElementById("fileInput").addEventListener("change", function () {
    if (this.files.length) {
        document.getElementById("fileName").textContent = this.files[0].name;
        runCheck(); // ‚≠ê t·ª± ƒë·ªông ch·∫°y ki·ªÉm tra
    }
});
function hasText(content, text) {
    return content.toLowerCase().includes(text.toLowerCase());
}
function dateToNumber(d) {
    const [dd, mm, yyyy] = d.split("/");
    return new Date(yyyy, mm - 1, dd).getTime();
}
function getDateRange(start, end) {
    const dates = [];
    let cur = new Date(start.split("/").reverse().join("-"));
    const last = new Date(end.split("/").reverse().join("-"));

    while (cur <= last) {
        const dd = String(cur.getDate()).padStart(2, "0");
        const mm = String(cur.getMonth() + 1).padStart(2, "0");
        const yyyy = cur.getFullYear();
        dates.push(`${dd}/${mm}/${yyyy}`);
        cur.setDate(cur.getDate() + 1);
    }
    return dates;
}

function runCheck() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Ch∆∞a ch·ªçn file HTML");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const html = e.target.result;
        processHTML(html);
    };
    reader.readAsText(file);
}

function processHTML(html) {
    const result = [];
    const days = [];

    // ===== 1. T√ÅCH NG√ÄY =====
    const dayRegex = /<td class="csD113743C"[\s\S]*?<\/td>/g;
    const matches = html.match(dayRegex) || [];

    for (let i = 0; i < matches.length; i++) {
        const start = html.indexOf(matches[i]);
        const end = (i < matches.length - 1)
            ? html.indexOf(matches[i + 1])
            : html.length;

        const block = html.substring(start, end);

        const dateMatch = matches[i].match(/<nobr>(\d{2}\/\d{2}\/\d{4})<\/nobr>/);
        const date = dateMatch ? dateMatch[1] : "Kh√¥ng x√°c ƒë·ªãnh";

        days.push({
            date,
            content: block
        });
    }

    // ===== B·ªé NG√ÄY RA VI·ªÜN =====
    const validDays = days.filter(d => !d.content.includes("ra vi·ªán"));

    // ===== 2. TH·ª¶ THU·∫¨T =====
    const techniques = [
    { key: "[kim ng·∫Øn]", label: "ƒêi·ªán ch√¢m [kim ng·∫Øn]" },
    { key: "b·∫•m huy·ªát b·∫±ng tay", label: "Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay" },
    { key: "ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i", label: "ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i" },
    { key: "K·ªπ thu·∫≠t xoa", label: "K·ªπ thu·∫≠t xoa b√≥p v√πng" }
];

   techniques.forEach(t => {
    let mustHave = false;

    validDays.forEach(d => {
        if (hasText(d.content, "Th·ª© b·∫£y") || hasText(d.content, "Ch·ªß nh·∫≠t")) return;

        if (d.content.includes(t.key)) mustHave = true;

        if (mustHave && !d.content.includes(t.key)) {
            result.push(`‚ùå ${d.date} thi·∫øu th·ªß thu·∫≠t: ${t.label}`);
        }
    });
});

// ===== 3. V·ªä THU·ªêC + S·∫ÆC THU·ªêC (ƒê·∫¶Y ƒê·ª¶ LOGIC) =====
const vtBlockRegex = /V·ªã thu·ªëc y h·ªçc c·ªï truy·ªÅn[\s\S]*?(x\s*\d+\s*thang)/g;
let vtMatch;

while ((vtMatch = vtBlockRegex.exec(html)) !== null) {

    const block = vtMatch[0];

    // L·∫•y ng√†y b·∫Øt ƒë·∫ßu ‚Äì k·∫øt th√∫c
    const dateMatch = block.match(
        /ng&agrave;y (\d{2}\/\d{2}\/\d{4}) ƒë·∫øn ng&agrave;y (\d{2}\/\d{2}\/\d{4})/
    );
    if (!dateMatch) continue;

    const start = dateMatch[1];
    const end = dateMatch[2];

    // ===== 3.1 T√çNH S·ªê NG√ÄY TH·ª∞C T·∫æ =====
    const daysInRange = validDays.filter(
        d => d.date >= start && d.date <= end
    );

    const realDays = daysInRange.length;

    // ===== 3.2 L·∫§Y S·ªê THANG GHI TRONG B√ÄI =====
    const thangMatch = block.match(/x\s*(\d+)\s*thang/);
    const declaredThang = thangMatch ? parseInt(thangMatch[1]) : null;

   if (declaredThang !== realDays) {

    const refDate = daysInRange.length ? daysInRange[0].date : start;

    result.push(
        `‚ùå ${refDate} Sai s·ªë thang thu·ªëc (${start} ‚Üí ${end}): ghi x ${declaredThang} thang, ƒë√∫ng ph·∫£i l√† x ${realDays} thang`
    );
}


    // ===== 3.3 KI·ªÇM TRA S·∫ÆC THU·ªêC T·ª™NG NG√ÄY =====
    daysInRange.forEach(d => {

        if (!d.content.includes("S·∫Øc thu·ªëc thang")) {
            result.push(`‚ùå ${d.date} thi·∫øu "S·∫Øc thu·ªëc thang"`);
            return;
        }

        // ‚≠ê LOGIC B·∫†N NH·∫ÆC: PH·∫¢I C√ì NG√ÄY B·∫ÆT ƒê·∫¶U
     const startRegex = new RegExp(start.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*,');

if (!startRegex.test(d.content)) {
    result.push(
        `‚ùå ${d.date} "S·∫Øc thu·ªëc thang" kh√¥ng ƒë√∫ng ng√†y b·∫Øt ƒë·∫ßu (${start})`
    );
}
    });
}



    // ===== 4. THU·ªêC VI√äN =====
    const pills = ["Amlodipine 5 mg Cap"];
    pills.forEach(p => {
        let must = false;
        validDays.forEach(d => {
            if (d.content.includes(p)) must = true;
            if (must && !d.content.includes(p)) {
                result.push(`‚ùå ${d.date} thi·∫øu thu·ªëc vi√™n: ${p}`);
            }
        });
    });

    // ===== 5. THU·ªêC TI√äM =====
    validDays.forEach(d => {
        if (d.content.includes("Dubemin injection") && !d.content.includes("Th·ªßy ch&acirc;m:")) {
            result.push(`‚ùå ${d.date} c√≥ Dubemin injection nh∆∞ng thi·∫øu Th·ªßy ch&acirc;m`);
        }
    });

    // ===== 6. C·∫¨N L√ÇM S√ÄNG =====
    for (let i = 0; i < validDays.length - 1; i++) {
        const d = validDays[i];
        if (d.content.includes("ƒë·∫øm t·ªïng tr·ªü") || d.content.includes("Ch·∫©n ƒëo&aacute;n h&igrave;nh ·∫£nh")) {
            let j = i + 1;
            while (j < validDays.length &&
    (hasText(validDays[j].content, "Th·ª© b·∫£y") ||
     hasText(validDays[j].content, "Ch·ªß nh·∫≠t"))) {
    j++;
}
            if (j < validDays.length && !validDays[j].content.includes("K·∫øt qu·∫£ CLS")) {
                result.push(`‚ùå ${validDays[j].date} thi·∫øu "K·∫øt qu·∫£ CLS"`);
            }
        }
    }

  // ===== 7. B√ÅO THU·ªêC ƒê√É D√ôNG =====
 const noMissingCheck = ["Dubemin injection", "Gi√°c h∆°i", "Khang minh thanh"];

const reportPills = ["Amlodipine 5 mg Cap", "Mimosa", "Kamelox 15"];

const used = {};
reportPills
  .concat("Dubemin injection", "Gi√°c h∆°i", "Khang minh thanh")
  .forEach(t => used[t] = []);
validDays.forEach(d => {
    Object.keys(used).forEach(t => {
        if (d.content.includes(t)) used[t].push(d.date);
    });
});

let report = "<h3>B√°o thu·ªëc ƒë√£ d√πng</h3>";

Object.keys(used).forEach(t => {
    if (!used[t].length) return;

    // ‚ùó Dubemin injection & Gi√°c h∆°i: KH√îNG b√°o thi·∫øu
    if (noMissingCheck.includes(t)) {
        report += `<div>‚Ä¢ ${t}: ${used[t].join(", ")}</div>`;
        return;
    }

    // ‚úÖ Thu·ªëc vi√™n: b√°o t·ª´‚Äìƒë·∫øn + ng√†y thi·∫øu
    const start = used[t][0];
    const end = used[t][used[t].length - 1];

    report += `<div>‚Ä¢ ${t}: ${start} ‚Üí ${end}</div>`;

    const fullRange = getDateRange(start, end);
    const missing = fullRange.filter(d => !used[t].includes(d));

    if (missing.length) {
        report += `<div style="margin-left:18px;color:#dc2626">
            ‚ö† Thi·∫øu ng√†y: ${missing.join(", ")}
        </div>`;
    }
});


    // ===== HI·ªÇN TH·ªä =====
    const out = document.getElementById("result");
    out.innerHTML = "";
   out.innerHTML += report;
    if (result.length === 0) {
    out.innerHTML += `<div class="ok">‚úÖ Kh√¥ng ph√°t hi·ªán l·ªói</div>`;
} else {

    result.sort((a, b) => {
        const da = a.match(/(\d{2}\/\d{2}\/\d{4})/);
        const db = b.match(/(\d{2}\/\d{2}\/\d{4})/);
        if (!da || !db) return 0;
        return dateToNumber(da[1]) - dateToNumber(db[1]);
    });

    result.forEach(e => out.innerHTML += `<div class="error">${e}</div>`);
}

 
}
</script>

</body>
</html>
