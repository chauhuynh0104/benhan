

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ki·ªÉm tra t·ªù ƒëi·ªÅu tr·ªã</title>
<!-- GOOGLE FONT + ICON -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root {
    --primary: #2962ff;
    --primary-light: #6fa1ff;
    --bg: #f5f7fb;
    --card: #ffffff;
    --text: #2b2b2b;
  }

  body.dark {
    --bg: #0f0f0f;
    --card: #171717;
    --text: #efefef;
  }
body.dark .result-box {
  background: #1e1e1e !important;
  border-left-color: var(--primary-light);
  color: #fff !important;
}

body.dark .success {
  background: #123c1a !important;
  border-left-color: #4caf50 !important;
}

body.dark .error {
  background: #3b0c0c !important;
  border-left-color: #ff6b6b !important;
}

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 0;
    transition: .3s;
  }

  header {
    background: linear-gradient(135deg, #2962ff, #03a9f4);
    color: white;
    padding: 20px 40px;
    box-shadow: 0 2px 15px rgba(0,0,0,0.15);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header h1 {
    margin: 0;
    font-weight: 600;
    font-size: 24px;
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .theme-toggle {
    background: rgba(255,255,255,0.2);
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
  }

  .theme-toggle:hover {
    background: rgba(255,255,255,0.35);
  }

  main {
    max-width: 900px;
    margin: 40px auto;
    background: var(--card);
    padding: 35px 45px;
    border-radius: 18px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(20px)}
    to {opacity: 1; transform: translateY(0)}
  }

  .upload-box {
    border: 2px dashed var(--primary);
    background: rgba(41,98,255,0.04);
    padding: 30px;
    border-radius: 14px;
    text-align: center;
    transition: .3s;
  }

  .upload-box:hover {
    background: rgba(41,98,255,0.1);
  }

  button {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.25s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  button:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
  }

  #fileName {
    margin-top: 12px;
    font-style: italic;
    color: var(--text);
  }

  #resultSection {
    display: none;
    margin-top: 30px;
  }

  h2 {
    margin-bottom: 10px;
    font-weight: 600;
  }

  .result-box {
    margin-top: 10px;
    padding: 22px;
    border-radius: 10px;
    background: #fff8f3;
    border-left: 6px solid var(--primary);
    white-space: pre-wrap;
    line-height: 1.55;
    font-size: 15px;
  }

  .success {
    background: #ecffef;
    border-left-color: #4caf50;
  }

  .error {
    background: #ffe8e8;
    border-left-color: #e53935;
  }

  .footer-note {
    margin-top: 30px;
    font-size: 14px;
    opacity: 0.7;
    text-align: center;
    letter-spacing: 0.5px;
  }

  /* LOADING SPINNER */
  .loader {
    border: 4px solid #ddd;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    width: 26px;
    height: 26px;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    margin-right: 10px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg) }
    100% { transform: rotate(360deg) }
  }


</style>
</head>
<body>

<header>
  <h1><i class="fa-solid fa-file-medical"></i> KI·ªÇM TRA T·ªú ƒêI·ªÄU TR·ªä</h1>
  <div class="theme-toggle" onclick="toggleTheme()">
    <i class="fa-solid fa-moon"></i> / <i class="fa-solid fa-sun"></i>
  </div>
</header>

<main>
  <div class="upload-box">
    <input type="file" id="fileInput" accept=".html" style="display:none">
    <input type="file" id="folderInput" webkitdirectory directory style="display:none">

   <button  onclick="document.getElementById('fileInput').click()">
  <i class="fa-solid fa-file-arrow-up"></i> Ch·ªçn file th·ªß c√¥ng
</button>

<button onclick="document.getElementById('folderInput').click()">
  <i class="fa-solid fa-folder-open"></i> Ch·ªçn th∆∞ m·ª•c 
</button>


    <div id="fileName"></div>
  </div>

  <div id="resultSection">
    <h2>K·∫øt qu·∫£ ki·ªÉm tra:</h2>
    <div id="output" class="result-box"></div>
  </div>

  <p class="footer-note">Design by Dr.Ch√¢u</p>
</main>


<script>
let selectedFile = null;

document.getElementById('fileInput').addEventListener('change', function() {
  if (this.files.length > 0) {
    selectedFile = this.files[0];
    document.getElementById('fileName').textContent = `‚úÖ ƒê√£ ch·ªçn file: ${selectedFile.name}`;
    checkFile();
  }
});

document.getElementById('folderInput').addEventListener('change', function() {
  const files = Array.from(this.files).filter(f => f.name.endsWith('.html'));
  if (files.length === 0) {
    alert('Kh√¥ng t√¨m th·∫•y file HTML n√†o trong th∆∞ m·ª•c.');
    return;
  }

  const readPromises = files.map(f =>
    new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        resolve({ file: f, valid: text.includes('cs53A8CA98') });
      };
      reader.readAsText(f);
    })
  );

  Promise.all(readPromises).then(results => {
    const validFiles = results.filter(r => r.valid).map(r => r.file);
    if (validFiles.length === 0) {
      alert('Kh√¥ng c√≥ file HTML h·ª£p l·ªá trong th∆∞ m·ª•c!');
      return;
    }
    validFiles.sort((a, b) => b.lastModified - a.lastModified);
    selectedFile = validFiles[0];
    document.getElementById('fileName').textContent = `‚úÖ ƒê√£ ch·ªçn file m·ªõi nh·∫•t: ${selectedFile.name}`;
    checkFile();
  });
});

function checkFile() {
  const resultSection = document.getElementById('resultSection');
  const output = document.getElementById('output');
  resultSection.style.display = "block";
  output.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
  output.className = 'result-box';

  if (!selectedFile) {
    output.textContent = '‚ö†Ô∏è Vui l√≤ng ch·ªçn file ho·∫∑c th∆∞ m·ª•c!';
    output.classList.add('error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(e.target.result, 'text/html');
    const dateCells = doc.querySelectorAll('td.cs53A8CA98[rowspan], td.csD113743C[rowspan]');
    const days = [];

    dateCells.forEach(td => {
      const fullText = td.innerText.trim().replace(/\s+/g, ' ');
      const dateMatch = fullText.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
      const dateStr = dateMatch ? dateMatch[1] : '';
      const dateObj = parseVietnameseDate(dateStr);
      const weekday = dateObj ? getWeekdayName(dateObj) : 'Kh√¥ng x√°c ƒë·ªãnh';

      let html = '';
      let next = td.parentElement.nextElementSibling;
      while (next && !next.querySelector('td.cs53A8CA98[rowspan], td.csD113743C[rowspan]')) {
        html += next.innerText + '\n';
        next = next.nextElementSibling;
      }

      days.push({ date: dateStr, weekday, content: html, dateObj });
    });

    if (days.length === 0) {
      output.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng√†y trong file.';
      output.classList.add('error');
      return;
    }

    const errors = [];

    // ======================
    // ‚úÖ √ù 1: Ki·ªÉm tra "ƒë·∫øm t·ªïng tr·ªü / X-quang" ‚Üí "K·∫øt qu·∫£ CLS"
    // ======================
    for (let i = 0; i < days.length; i++) {
      const txt = days[i].content.toLowerCase();
      if (txt.includes('ƒë·∫øm t·ªïng tr·ªü') || txt.includes('Ch·∫©n ƒëo&aacute;n h&igrave;nh ·∫£nh')) {
        let j = i + 1;
        // B·ªè qua c√°c ng√†y cu·ªëi tu·∫ßn
        while (j < days.length && isWeekend(days[j].dateObj)) j++;
        if (j < days.length) {
          const nextDay = days[j];
          if (!nextDay.content.toLowerCase().includes('k·∫øt qu·∫£ cls')) {
            errors.push(`‚ùå Ng√†y ${nextDay.date} (${nextDay.weekday}) thi·∫øu "K·∫øt qu·∫£ CLS" (Ng√†y ch·ªâ ƒë·ªãnh: ${days[i].date})`);
          }
        }
      }
    }
// --- Y√äU C·∫¶U 2 & 3: Hi·ªÉn th·ªã kho·∫£ng d√πng thu·ªëc ---
const drugList = ['Amlodipine', 'Mimosa', 'Piracetam'];
const drugPeriods = {};

for (const drug of drugList) {
  let start = null;
  for (let i = 0; i < days.length; i++) {
    const hasDrug = days[i].content.includes(drug);
    if (hasDrug && !start) start = i;
    if ((!hasDrug || i === days.length - 1) && start !== null) {
      const endIdx = hasDrug && i === days.length - 1 ? i : i - 1;
      const startDate = days[start].date;
      const endDate = days[endIdx].date;
      if (!drugPeriods[drug]) drugPeriods[drug] = [];
      drugPeriods[drug].push({ startDate, endDate });
      start = null;
    }
  }
}

// --- Hi·ªÉn th·ªã k·∫øt qu·∫£ d√πng thu·ªëc ---
for (const [drug, periods] of Object.entries(drugPeriods)) {
  for (const p of periods) {
    if (drug === 'Piracetam') {
      errors.push(`üíä ${drug} t·ª´ ng√†y ${p.startDate} ‚Üí ${p.endDate}`);
    } else {
      errors.push(`üíä ${drug} t·ª´ ng√†y ${p.startDate} ‚Üí ${p.endDate}`);
    }
  }
}
    // ======================
    // ‚úÖ √ù 2: Thay ƒë·ªïi logic ki·ªÉm tra th·ªß thu·∫≠t
    // ======================
    const checks = [
      { key: 'S·∫Øc thu·ªëc thang', label:'S·∫Øc thu·ªëc thang' },
      { key: '[kim ng·∫Øn]', label:'ƒêi·ªán ch√¢m' },
      { key: 'tia h·ªìng ngo·∫°i', label:'ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i' },
      { key: 'b·∫•m huy·ªát b·∫±ng tay', label:'Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay' },
      { key: 'K·ªπ thu·∫≠t xoa', label:'K·ªπ thu·∫≠t xoa b√≥p v√πng' }
    ];
   const ongoingChecks = [
      { key: 'Amlodipine', active: false },
      { key: 'Mimosa', active: false }
    ];
    for (const chk of checks) {
      let startIndex = -1;
      for (let i = 0; i < days.length; i++) {
        const text = days[i].content;
        const isDischarge = /ra vi·ªán/i.test(text);
        if (isDischarge) continue;
        if (startIndex === -1 && text.includes(chk.key)) {
          startIndex = i;
        }
        if (startIndex !== -1 && i > startIndex) {
          if (!text.includes(chk.key) && !isWeekend(days[i].dateObj)) {
            errors.push(`‚ùå Ng√†y ${days[i].date} (${days[i].weekday}) thi·∫øu ${chk.label}`);
          }
        }
      }
    }

    // ======================
    // ‚úÖ C√°c ph·∫ßn c≈© v·∫´n gi·ªØ nguy√™n
    // ======================
    for (const d of days) {
      if (d.content.includes('Dubemin') && !d.content.includes('m·ªói huy·ªát')) {
        errors.push(`‚ùå Ng√†y ${d.date} (${d.weekday}) c√≥ Dubemin nh∆∞ng thi·∫øu th·ªß thu·∫≠t th·ªßy ch√¢m`);
      }
    }
for (const chk of ongoingChecks) {
  let activeFrom = -1;
  for (let i = 0; i < days.length; i++) {
    const text = days[i].content;
    const isDischarge = /ra vi·ªán/i.test(text); // üîπ ki·ªÉm tra ng√†y c√≥ "ra vi·ªán"
    if (isDischarge) continue; // üîπ b·ªè qua ki·ªÉm tra ng√†y ƒë√≥

    if (text.includes(chk.key)) {
      if (activeFrom === -1) activeFrom = i;
    } else if (activeFrom !== -1) {
      errors.push(`‚ùå Ng√†y ${days[i].date} (${days[i].weekday}) thi·∫øu ${chk.key}`);
    }
  }
}
// Gom nh√≥m l·ªói theo lo·∫°i
const grouped = {
  cls: [],
  drug: [],
  procedure: []
};

// Ph√¢n lo·∫°i l·ªói v√†o nh√≥m
errors.forEach(err => {
  if (err.includes('CLS')) grouped.cls.push(err);
  else if (err.includes('üíä') || err.toLowerCase().includes('amlodipine') || err.toLowerCase().includes('mimosa')) grouped.drug.push(err);
  else grouped.procedure.push(err);
});
function renderGroupedErrors() {
  let html = '';

  if (grouped.cls.length) {
    html += `<strong>üìã L·ªói CLS:</strong><br>${grouped.cls.join('<br>')}<hr>`;
  }

  if (grouped.drug.length) {
    html += `<strong>üíä Thu·ªëc:</strong><br>${grouped.drug.join('<br>')}<hr>`;
  }

  if (grouped.procedure.length) {
    html += `<strong>‚ö° Th·ªß thu·∫≠t:</strong><br>${grouped.procedure.join('<br>')}<hr>`;
  }

  return html;
}


    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    if (errors.length === 0) {
      output.innerHTML = '‚úÖ T·∫•t c·∫£ ki·ªÉm tra ƒë·ªÅu h·ª£p l·ªá.';
      output.classList.add('success');
    } else {
  output.innerHTML = renderGroupedErrors();
      output.classList.add('error');
    }
  };
  reader.readAsText(selectedFile);
}

// ======================
// H√†m ph·ª• tr·ª£
// ======================
function parseVietnameseDate(str) {
  const match = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (!match) return null;
  const [_, d, m, y] = match;
  return new Date(`${y}-${m}-${d}T00:00:00`);
}

function isWeekend(date) {
  if (!date) return false;
  const dow = date.getDay();
  return dow === 0 || dow === 6;
}

function getWeekdayName(date) {
  const weekdays = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
  return weekdays[date.getDay()];
}
function toggleTheme() {
  document.body.classList.toggle("dark");
}
</script>

</body>
</html>

