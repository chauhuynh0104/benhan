<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ki·ªÉm tra t·ªù ƒëi·ªÅu tr·ªã</title>
<style>
  body {
    font-family: 'Segoe UI', Roboto, sans-serif;
    background: #fff7f0;
    color: #333;
    margin: 0;
    padding: 0;
  }

  header {
    background: linear-gradient(90deg, #0066FF, #66FFFF);
    color: white;
    padding: 20px 40px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  header h1 {
    margin: 0;
    font-size: 26px;
  }

  main {
    max-width: 900px;
    margin: 40px auto;
    background: white;
    padding: 30px 40px;
    border-radius: 16px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .upload-box {
    border: 2px dashed #3498db;
    background: #fffaf3;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
  }

  .upload-box:hover {
    background: #fff3e0;
  }

  button {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 22px;
    margin: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  button:hover {
    background: #e96b00;
  }

  #fileName {
    margin-top: 10px;
    color: #444;
    font-style: italic;
  }

  #resultSection {
    display: none; /* üîπ ·∫®n to√†n b·ªô k·∫øt qu·∫£ ban ƒë·∫ßu */
    margin-top: 30px;
  }

  .result-box {
    margin-top: 10px;
    padding: 20px;
    border-radius: 10px;
    background: #fff8f3;
    border-left: 5px solid #3498db;
    white-space: pre-wrap;
    line-height: 1.6;
    font-size: 15px;
  }

  .success {
    background: #f1fff2;
    border-left: 5px solid #4caf50;
  }

  .error {
    background: #fff1f1;
    border-left: 5px solid #f44336;
  }

  .footer-note {
    margin-top: 15px;
    font-size: 13px;
    color: #777;
    text-align: center;
  }
</style>
</head>
<body>


<main>
  <div class="upload-box">
   

    <!-- input ·∫©n -->
    <input type="file" id="fileInput" accept=".html" style="display:none">
    <input type="file" id="folderInput" webkitdirectory directory style="display:none">

    <!-- N√∫t hi·ªÉn th·ªã -->
    <button onclick="document.getElementById('fileInput').click()">üìÑ Ch·ªçn file th·ªß c√¥ng</button><br>
    <button onclick="document.getElementById('folderInput').click()">üìÅ Ch·ªçn th∆∞ m·ª•c (T·ª± ƒë·ªông t√¨m file)</button>

    <!-- T√™n file ƒë∆∞·ª£c ch·ªçn -->
    <div id="fileName"></div>
  </div>

  <!-- ·∫®n to√†n b·ªô k·∫øt qu·∫£ ban ƒë·∫ßu -->
  <div id="resultSection">
    <h2>K·∫øt qu·∫£ ki·ªÉm tra:</h2>
    <div id="output" class="result-box"></div>
  </div>

  <p class="footer-note">Design By Dr.Ch√¢u</p>
</main>

<script>
let selectedFile = null;

document.getElementById('fileInput').addEventListener('change', function() {
  if (this.files.length > 0) {
    selectedFile = this.files[0];
    document.getElementById('fileName').textContent = `‚úÖ ƒê√£ ch·ªçn file: ${selectedFile.name}`;
    checkFile(); // t·ª± ƒë·ªông ki·ªÉm tra
  }
});

document.getElementById('folderInput').addEventListener('change', function() {
  const files = Array.from(this.files).filter(f => f.name.endsWith('.html'));
  if (files.length === 0) {
    alert('Kh√¥ng t√¨m th·∫•y file HTML n√†o trong th∆∞ m·ª•c.');
    return;
  }

  const readPromises = files.map(f =>
    new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const text = e.target.result;
        resolve({ file: f, valid: text.includes('cs53A8CA98') });
      };
      reader.readAsText(f);
    })
  );

  Promise.all(readPromises).then(results => {
    const validFiles = results.filter(r => r.valid).map(r => r.file);
    if (validFiles.length === 0) {
      alert('Kh√¥ng c√≥ file HTML h·ª£p l·ªá trong th∆∞ m·ª•c!');
      return;
    }

    validFiles.sort((a, b) => b.lastModified - a.lastModified);
    selectedFile = validFiles[0];
    document.getElementById('fileName').textContent = `‚úÖ ƒê√£ ch·ªçn file m·ªõi nh·∫•t: ${selectedFile.name}`;
    checkFile(); // t·ª± ƒë·ªông ki·ªÉm tra
  });
});

function checkFile() {
  const resultSection = document.getElementById('resultSection');
  const output = document.getElementById('output');
  resultSection.style.display = "block"; // üîπ Hi·ªán ph·∫ßn k·∫øt qu·∫£ khi b·∫Øt ƒë·∫ßu x·ª≠ l√Ω
  output.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';
  output.className = 'result-box';

  if (!selectedFile) {
    output.textContent = '‚ö†Ô∏è Vui l√≤ng ch·ªçn file ho·∫∑c th∆∞ m·ª•c!';
    output.classList.add('error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(e.target.result, 'text/html');
const dateCells = doc.querySelectorAll('td.cs53A8CA98[rowspan], td.csD113743C[rowspan]');
    const days = [];

    dateCells.forEach(td => {
      const fullText = td.innerText.trim().replace(/\s+/g, ' ');
      const dateMatch = fullText.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
      const dateStr = dateMatch ? dateMatch[1] : '';
      const dateObj = parseVietnameseDate(dateStr);
      const weekday = dateObj ? getWeekdayName(dateObj) : 'Kh√¥ng x√°c ƒë·ªãnh';

      let html = '';
      let next = td.parentElement.nextElementSibling;
      while (next && !next.querySelector('td.cs53A8CA98[rowspan], td.csD113743C[rowspan]')) {
        html += next.innerText + '\n';
        next = next.nextElementSibling;
      }

      days.push({ date: dateStr, weekday, content: html, dateObj });
    });

    if (days.length === 0) {
      output.textContent = '‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng√†y trong file.';
      output.classList.add('error');
      return;
    }

    const errors = [];
    const checks = [
      { key: 'S·∫Øc thu·ªëc thang', type: 'always', label:'S·∫Øc thu·ªëc thang' },
      { key: '[kim ng·∫Øn]', type: 'skipWeekend', label:'ƒêi·ªán ch√¢m' },
      { key: 'tia h·ªìng ngo·∫°i', type: 'skipWeekend',label: 'ƒêi·ªÅu tr·ªã b·∫±ng tia h·ªìng ngo·∫°i'},
      { key: 'b·∫•m huy·ªát b·∫±ng tay', type: 'skipWeekend',label:'Xoa b√≥p b·∫•m huy·ªát b·∫±ng tay' },
      { key: 'K·ªπ thu·∫≠t xoa', type: 'skipWeekend', label:'K·ªπ thu·∫≠t xoa b√≥p v√πng'}
    ];

    const ongoingChecks = [
      { key: 'Amlodipine', active: false },
      { key: 'Mimosa', active: false }
    ];

    const firstDay = days[0];

for (const chk of checks) {
  if (firstDay.content.includes(chk.key)) {
    for (let i = 1; i < days.length; i++) {
      const d = days[i];
      const skip = chk.type === 'skipWeekend' && isWeekend(d.dateObj);
      const isDischarge = /ra vi·ªán/i.test(d.content); // üîπ ki·ªÉm tra ng√†y c√≥ "ra vi·ªán"
      if (isDischarge) continue; // üîπ b·ªè qua ng√†y ra vi·ªán
      if (!skip && !d.content.includes(chk.key)) {
        errors.push(`‚ùå Ng√†y ${d.date} (${d.weekday}) thi·∫øu "${chk.label}"`);
      }
    }
  }
}


    for (const d of days) {
      if (d.content.includes('Dubemin') && !d.content.includes('m·ªói huy·ªát')) {
        errors.push(`‚ùå Ng√†y ${d.date} (${d.weekday}) c√≥ Dubemin nh∆∞ng thi·∫øu th·ªß thu·∫≠t th·ªßy ch√¢m`);
      }
    }

for (const chk of ongoingChecks) {
  let activeFrom = -1;
  for (let i = 0; i < days.length; i++) {
    const text = days[i].content;
    const isDischarge = /ra vi·ªán/i.test(text); // üîπ ki·ªÉm tra ng√†y c√≥ "ra vi·ªán"
    if (isDischarge) continue; // üîπ b·ªè qua ki·ªÉm tra ng√†y ƒë√≥

    if (text.includes(chk.key)) {
      if (activeFrom === -1) activeFrom = i;
    } else if (activeFrom !== -1) {
      errors.push(`‚ùå Ng√†y ${days[i].date} (${days[i].weekday}) thi·∫øu ${chk.key}`);
    }
  }
}



    if (errors.length === 0) {
      output.innerHTML = '‚úÖ M√°y ch·ªß ki·ªÉm tra th·ªß thu·∫≠t v√† thu·ªëc ƒë√£ hi·ªÉn th·ªã tr√™n t·ªù ƒëi·ªÅu tr·ªã ƒë√∫ng.';
      output.classList.add('success');
    } else {
      output.innerHTML = errors.join('\n');
      output.classList.add('error');
    }
  };
  reader.readAsText(selectedFile);
}

function parseVietnameseDate(str) {
  const match = str.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if (!match) return null;
  const [_, d, m, y] = match;
  return new Date(`${y}-${m}-${d}T00:00:00`);
}

function isWeekend(date) {
  if (!date) return false;
  const dow = date.getDay();
  return dow === 0 || dow === 6;
}

function getWeekdayName(date) {
  const weekdays = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
  return weekdays[date.getDay()];
}
</script>
</body>
</html>
