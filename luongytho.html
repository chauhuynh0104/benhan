<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω b·ªánh √°n</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/docx@8.0.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E55A2B;
            --primary-light: #FF8E5C;
            --secondary: #2D3047;
            --light: #F8F9FA;
            --gray: #6C757D;
            --danger: #DC3545;
            --success: #28A745;
            --warning: #FFC107;
            --info: #17A2B8;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
        }

        .logo h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .logo span {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a3d5c;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--primary);
        }
body.dark .btn-light {
    background-color: var(--secondary) !important;
    color: #ffffff !important;
    border-color: var(--primary) !important;
}

        .btn-light:hover {
            background-color: var(--primary-light);
            color: white;
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .search-container {
            background-color: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .table-container {
            background-color: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: var(--secondary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn {
            background-color: rgba(23, 162, 184, 0.1);
            color: var(--info);
        }

        .view-btn:hover {
            background-color: var(--info);
            color: white;
        }

        .history-btn {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }

        .history-btn:hover {
            background-color: var(--warning);
            color: white;
        }

        .print-btn {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .print-btn:hover {
            background-color: var(--success);
            color: white;
        }

        .download-btn {
            background-color: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }

        .download-btn:hover {
            background-color: var(--gray);
            color: white;
        }

        .delete-btn {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        .delete-btn:hover {
            background-color: var(--danger);
            color: white;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            margin: 0 auto;
            max-width: 900px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .textarea-double-click {
            min-height: 100px;
            border: 1px dashed #ccc;
            border-radius: var(--radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .textarea-double-click:hover {
            border-color: var(--primary);
            background-color: rgba(255, 107, 53, 0.05);
        }

        .table-input {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .table-input th, .table-input td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .table-input th {
            background-color: #000000;
            font-weight: 600;
        }

        .table-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .table-input input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .subtotal-row {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .toggle-price {
            margin-bottom: 15px;
        }

        .toggle-price label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

      
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-new {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .gender-select {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .gender-radio {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .toast-success {
            background-color: var(--success);
        }

        .toast-error {
            background-color: var(--danger);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
.textarea-with-expand {
    position: relative;
}

.expand-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: rgba(255, 107, 53, 0.1);
    color: var(--primary);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid var(--primary-light);
    z-index: 10;
}

.expand-btn:hover {
    background-color: rgba(255, 107, 53, 0.2);
    transform: scale(1.1);
}

.expand-btn i {
    font-size: 0.9rem;
}

#diagnosis {
    min-height: 120px;
    resize: vertical;
    padding-right: 45px; /* ƒê·ªÉ kh√¥ng b·ªã ch·ªØ che n√∫t expand */
}

/* Th√™m cho ph·∫ßn th·ªß thu·∫≠t v√† thu·ªëc v·∫´n gi·ªØ click ƒë√∫p */
.textarea-double-click {
    min-height: 60px;
    border: 1px dashed #ccc;
    border-radius: var(--radius);
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.textarea-double-click:hover {
    border-color: var(--primary);
    background-color: rgba(255, 107, 53, 0.05);
}

.textarea-double-click i {
    color: var(--primary);
}
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
                margin-top: 15px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box {
                flex-direction: column;
            }
        }
		.app-footer {
    margin-top: 40px;
    padding: 15px 10px;
    text-align: center;
    font-size: 0.9rem;
    color: #6c757d;
    background: #ffffff;
    border-top: 1px solid #eee;
}
body.dark .app-footer {
 margin-top: 40px;
    padding: 15px 10px;
    text-align: center;
    font-size: 0.9rem;
    color: #6c757d;
    background: #000000;
    border-top: 1px solid #eee;
}
.app-footer strong {
    color: var(--primary);
}
.theme-toolbar {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f5f5f5;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

.theme-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    outline: 2px solid transparent;
}

.theme-dot:hover {
    outline: 2px solid #00000030;
}

.theme-blue { background: #0d6efd; }
.theme-red { background: #dc3545; }
.theme-green { background: #198754; }
.theme-orange { background: #FF6B35; }

.theme-dark-toggle {
    margin-left: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: white;
    cursor: pointer;
    font-size: 13px;
}
body.dark .theme-dark-toggle {
    margin-left: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #000000;
    cursor: pointer;
    font-size: 13px;
}
/* ===== DARK MODE ===== */
body.dark {
    background: #121212;
    color: #e0e0e0;
}

body.dark .table-container,
body.dark .search-container,
body.dark .modal-content {
    background: #1e1e1e;
}

body.dark th {
    background: #2c2c2c;
}

body.dark .theme-toolbar {
    background: #1f1f1f;
    border-color: #333;
}
/* =======================
   DARK MODE ‚Äì FORCE STYLE
   ======================= */

body.dark,
body.dark * {
    color: #ffffff !important;
}

/* Input, textarea, select */
body.dark input,
body.dark textarea,
body.dark select {
    background: #000000 !important;
    color: #ffffff !important;
    border: 1px solid #555 !important;
}

/* Placeholder */
body.dark input::placeholder,
body.dark textarea::placeholder {
    color: #bbbbbb !important;
}

/* Button */
body.dark button {
    color: #ffffff !important;
}

/* Table */
body.dark table {
    background: #1b1b1b !important;
}

body.dark th {
    background: #2a2a2a !important;
}

body.dark td {
    background: #1e1e1e !important;
}

/* Checkbox, radio */
body.dark input[type="checkbox"],
body.dark input[type="radio"] {
    accent-color: var(--primary);
}

/* Modal */
body.dark .modal-content {
    background: #1a1a1a !important;
}

/* Dropdown / option */
body.dark option {
    background: #000000;
    color: #ffffff;
}

/* Disabled */
body.dark input:disabled,
body.dark textarea:disabled {
    background: #111 !important;
    color: #777 !important;
}
/* CSS cho √¥ click ƒë√∫p trong modal di·ªÖn bi·∫øn */
.progress-textarea {
    min-height: 60px;
    border: 1px dashed #ccc;
    border-radius: var(--radius);
    padding: 12px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #f9f9f9;
    margin-bottom: 10px;
}

.progress-textarea:hover {
    border-color: var(--primary);
    background-color: rgba(255, 107, 53, 0.05);
}

.progress-textarea i {
    color: var(--primary);
    font-size: 0.9rem;
}

.progress-summary {
    font-size: 0.9rem;
    color: var(--gray);
    margin-top: 5px;
    max-height: 100px;
    overflow-y: auto;
    white-space: pre-wrap;
    padding: 8px;
    background: #f1f1f1;
    border-radius: 4px;
}
.progress-textarea-input {
    width: 100%;
    min-height: 70px;
    resize: vertical;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
}

.progress-textarea-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(255,107,53,0.15);
}
/* LOGIN OVERLAY */
#loginOverlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #ffffff, #f1f3f5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
}

.login-box {
    width: 360px;
    padding: 35px;
    border-radius: 18px;
    background:#ff6b35;
    backdrop-filter: blur(15px);
    box-shadow: 0 25px 60px rgba(0,0,0,0.25);
    text-align: center;
    color: #fff;
}

.login-box h2 {
    font-size: 26px;
    margin-bottom: 5px;
}

.login-box p {
    opacity: 0.9;
    margin-bottom: 25px;
}

.login-box input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 10px;
    border: none;
    outline: none;
    font-size: 15px;
}

.login-box button {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: #ffffff;
    color: #ff6b35;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

.login-box button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

#loginError {
    margin-top: 12px;
    color: #ffdddd;
    font-size: 14px;
}
.download-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    font-size: 1.2rem;
}
/* CSS cho modal xu·∫•t hi·ªán ƒë·∫°i */
.export-tabs {
    display: flex;
    background: #f8f9fa;
    padding: 4px;
    border-radius: 12px;
    margin-bottom: 25px;
}

.export-tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    color: var(--gray);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.export-tab.active {
    background: white;
    color: var(--primary);
    box-shadow: var(--shadow);
}

.export-content {
    display: none;
}

.export-content.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.option-grid {
    display: grid;
    gap: 12px;
}

.export-option {
    display: flex;
    align-items: center;
    padding: 16px;
    background: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    gap: 15px;
}

.export-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    border-color: var(--primary-light);
}

.export-option.print-option {
    color: white;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
}

.export-option.print-option .option-icon {
    background: rgba(255,255,255,0.2);
}

.export-option.print-option .option-arrow {
    color: rgba(255,255,255,0.8);
}

.option-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: var(--primary-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
    flex-shrink: 0;
}

.option-content {
    flex: 1;
}

.option-title {
    font-weight: 700;
    font-size: 1.05rem;
    margin-bottom: 4px;
}

.option-desc {
    font-size: 0.85rem;
    opacity: 0.8;
}

.option-arrow {
    font-size: 0.9rem;
    color: var(--gray);
    transition: transform 0.3s ease;
}

.export-option:hover .option-arrow {
    transform: translateX(3px);
    color: var(--primary);
}



.format-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-weight: 600;
    color: var(--gray);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.format-btn.active {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}

.format-btn:hover:not(.active) {
    border-color: var(--primary-light);
    background: #f9f9f9;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Dark mode support */
body.dark .export-tabs {
    background: #2a2a2a;
}

body.dark .export-tab {
    color: #aaa;
}

body.dark .export-tab.active {
    background: #333;
    color: var(--primary-light);
}

body.dark .export-option:not(.print-option) {
    background: #333;
    border-color: #444;
}

body.dark .format-btn {
    background: #333;
    border-color: #444;
    color: #aaa;
}

body.dark .format-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}
<style>
.pdf-preview-wrapper {
    background: #888;
    padding: 30px;
    overflow-y: auto;
    max-height: 80vh;
}

.pdf-page {
    width: 210mm;
    min-height: 297mm;
    background: white;
    margin: 0 auto 20px auto;
    padding: 20mm;
    box-shadow: 0 0 15px rgba(0,0,0,0.4);
    font-family: "Times New Roman";
    font-size: 14px;
}

.pdf-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
</style>

    </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
    <div class="login-box">
        <h2>B·ªÜNH √ÅN ƒêI·ªÜN T·ª¨</h2>
        <p>ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</p>

        <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u">

        <button onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>

        <div id="loginError"></div>
    </div>
</div>
    <!-- Toast th√¥ng b√°o -->
    <div id="toast" class="toast"></div>

    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-file-medical-alt"></i>
                <div>
                    <h1>B·ªánh √Ån ƒêi·ªán T·ª≠</h1>
                 
							<div class="theme-toolbar">
    <button class="theme-dot theme-blue" data-color="#0d6efd"></button>
    <button class="theme-dot theme-red" data-color="#dc3545"></button>
    <button class="theme-dot theme-green" data-color="#198754"></button>
    <button class="theme-dot theme-orange" data-color="#FF6B35"></button>

    <button class="theme-dark-toggle" id="darkModeToggle" title="S√°ng / T·ªëi">
        üåô T·ªëi
    </button>
</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="newRecordBtn">
                    <i class="fas fa-plus-circle"></i> Nh·∫≠p b·ªánh √°n m·ªõi
                </button>
            </div>
	<button class="btn btn-danger" onclick="logout()">
    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
</button>


        </header>

        <main>
            <div class="search-container">
                <h2 class="section-title">T√¨m ki·∫øm b·ªánh √°n</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="T√¨m theo t√™n, ch·∫©n ƒëo√°n, ng√†y kh√°m, m√£ b·ªánh nh√¢n...">
                    <button class="btn btn-primary" id="searchBtn">
                        <i class="fas fa-search"></i> T√¨m ki·∫øm
                    </button>
                    <button class="btn btn-light" id="resetSearchBtn">
                        <i class="fas fa-redo"></i> L√†m m·ªõi
                    </button>
                </div>
            </div>

            <div class="table-container">
                <h2 class="section-title">Danh s√°ch b·ªánh √°n</h2>
                
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>M√£ b·ªánh nh√¢n</th>
                            <th>T√™n b·ªánh nh√¢n</th>
                            <th>Tu·ªïi</th>
                            <th>Ng√†y kh√°m</th>
                            <th>Ch·∫©n ƒëo√°n</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody">
					
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </tbody>
                </table>
				<div id="loadingState" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu b·ªánh √°n...</p>
                </div>
                <div id="emptyState" class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>Ch∆∞a c√≥ b·ªánh √°n n√†o</h3>
                    <p>Nh·∫•n n√∫t "Nh·∫≠p b·ªánh √°n m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal th√™m/s·ª≠a b·ªánh √°n -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Th√™m b·ªánh √°n m·ªõi</h3>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="patientName">H·ªç t√™n *</label>
                            <input type="text" id="patientName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gi·ªõi t√≠nh *</label>
                            <div class="gender-select">
                                <label class="gender-option">
                                    <input type="radio" name="gender" value="Nam" class="gender-radio" checked> Nam
                                </label>
                                <label class="gender-option">
                                    <input type="radio" name="gender" value="N·ªØ" class="gender-radio"> N·ªØ
                                </label>
                                <label class="gender-option">
                                    <input type="radio" name="gender" value="Kh√°c" class="gender-radio"> Kh√°c
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="patientAge">Tu·ªïi *</label>
                            <input type="number" id="patientAge" class="form-control" min="0" max="150" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="patientAddress">ƒê·ªãa ch·ªâ</label>
                            <input type="text" id="patientAddress" class="form-control">
                        </div>
                    </div>

               <div class="form-row">
    <div class="form-group">
        <label class="form-label" for="patientCode">M√£ b·ªánh nh√¢n *</label>
        <input type="text" id="patientCode" class="form-control" required>
    </div>
    <div class="form-group">
        <label class="form-label" for="primaryDiagnosis">Ch·∫©n ƒëo√°n ch√≠nh *</label>
        <input type="text" id="primaryDiagnosis" class="form-control" required>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <label class="form-label" for="examinationDate">Ng√†y kh√°m *</label>
        <input type="date" id="examinationDate" class="form-control" required>
    </div>
    <div class="form-group">
        <label class="form-label" for="examinationTime">Gi·ªù kh√°m *</label>
        <input type="time" id="examinationTime" class="form-control" required>
    </div>
</div>

                   <div class="form-group">
    <label class="form-label" for="diagnosis">N·ªôi dung b·ªánh √°n</label>
    <div class="textarea-with-expand">
        <textarea id="diagnosis" class="form-control" rows="4" placeholder="Nh·∫≠p n·ªôi dung b·ªánh √°n t·∫°i ƒë√¢y..."></textarea>
        <div class="expand-btn" id="expandDiagnosisBtn" title="M·ªü r·ªông ƒë·ªÉ nh·∫≠p nhi·ªÅu h∆°n">
            <i class="fas fa-expand-alt"></i>
        </div>
    </div>
</div>

                  <div class="form-group">
    <label class="form-label">Th·ªß thu·∫≠t</label>
    <div class="textarea-double-click" id="procedureText" data-target="procedureModal">
        <i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ th√™m th·ªß thu·∫≠t
    </div>
    <div id="procedureSummary"></div>
</div>

<div class="form-group">
    <label class="form-label">Thu·ªëc</label>
    <div class="textarea-double-click" id="medicineText" data-target="medicineModal">
        <i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ th√™m thu·ªëc
    </div>
    <div id="medicineSummary"></div>
</div>

                    <div class="form-group">
                        <label class="form-label" for="followUpDate">H·∫πn ng√†y t√°i kh√°m</label>
                        <input type="date" id="followUpDate" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="loading" id="saveLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>ƒêang l∆∞u...</p>
                </div>
                <button class="btn btn-light" id="cancelBtn">H·ªßy</button>
                <button class="btn btn-success" id="saveRecordBtn">L∆∞u b·ªánh √°n</button>
            </div>
        </div>
    </div>

    <!-- Modal nh·∫≠p n·ªôi dung b·ªánh √°n -->
    <div id="diagnosisModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Nh·∫≠p n·ªôi dung b·ªánh √°n</h3>
                <button class="close-btn close-diagnosis-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">N·ªôi dung chi ti·∫øt</label>
                    <textarea id="diagnosisDetail" class="form-control" rows="12" placeholder="Nh·∫≠p n·ªôi dung b·ªánh √°n chi ti·∫øt..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-diagnosis-modal">H·ªßy</button>
                <button class="btn btn-success" id="saveDiagnosisBtn">L∆∞u n·ªôi dung</button>
            </div>
        </div>
    </div>

    <!-- Modal nh·∫≠p th·ªß thu·∫≠t -->
    <div id="procedureModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Nh·∫≠p th·ªß thu·∫≠t</h3>
                <button class="close-btn close-procedure-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toggle-price">
                    <label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleProcedurePrice"checked>
                            <span class="slider"></span>
                        </div>
                        <span>Hi·ªÉn th·ªã c·ªôt gi√° ti·ªÅn</span>
                    </label>
                </div>
                <table class="table-input" id="procedureTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n th·ªß thu·∫≠t</th> 
							<th>Ghi ch√∫</th>
                            <th>S·ªë l·∫ßn</th>
                            <th class="price-column">Gi√° ti·ªÅn</th>
                            <th>X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="procedureTableBody">
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="procedure-name" placeholder="Nh·∫≠p t√™n th·ªß thu·∫≠t"></td>
							<td><input type="text" class="procedure-note" placeholder="Ghi ch√∫"></td> 
                              <td><input type="number" class="procedure-quantity" placeholder="S·ªë l·∫ßn" min="1" value="1"></td>
                        <td class="price-column"><input type="number" class="procedure-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
                        <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="subtotal-row">
                        <td colspan="3">T·ªïng c·ªông</td> <!-- ƒê·ªïi t·ª´ colspan="2" th√†nh "3" -->
                        <td id="procedureTotalQuantity">0</td>
                        <td class="price-column" id="procedureTotalPrice">0</td>
                        <td></td>
                    </tr>
                    <tr id="procedureTotalRow" style="display: none;">
                        <td colspan="4">T·ªïng gi√° ti·ªÅn</td> <!-- ƒê·ªïi t·ª´ colspan="3" th√†nh "4" -->
                        <td><input type="number" id="procedureTotalAmount" placeholder="Nh·∫≠p t·ªïng gi√° ti·ªÅn" min="0"></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            <button class="btn btn-primary" id="addProcedureRow">
                <i class="fas fa-plus"></i> Th√™m h√†ng m·ªõi
            </button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light close-procedure-modal">H·ªßy</button>
            <button class="btn btn-success" id="saveProcedureBtn">L∆∞u th·ªß thu·∫≠t</button>
        </div>
    </div>
</div>

    <!-- Modal nh·∫≠p thu·ªëc -->
    <div id="medicineModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Nh·∫≠p thu·ªëc</h3>
                <button class="close-btn close-medicine-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="toggle-price">
                    <label>
                        <div class="toggle-switch">
                            <input type="checkbox" id="toggleMedicinePrice" checked>
                            <span class="slider"></span>
                        </div>
                        <span>Hi·ªÉn th·ªã c·ªôt gi√° ti·ªÅn</span>
                    </label>
                </div>
                <table class="table-input" id="medicineTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n thu·ªëc</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th class="price-column">Gi√° ti·ªÅn</th>
                            <th>X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="medicineTableBody">
                        <tr>
                            <td>1</td>
                            <td><input type="text" class="medicine-name" placeholder="Nh·∫≠p t√™n thu·ªëc"></td>
                            <td><input type="number" class="medicine-quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1"></td>
                            <td class="price-column"><input type="number" class="medicine-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
                            <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="subtotal-row">
                            <td colspan="2">T·ªïng c·ªông</td>
                            <td id="medicineTotalQuantity">0</td>
                            <td class="price-column" id="medicineTotalPrice">0</td>
                            <td></td>
                        </tr>
                        <tr id="medicineTotalRow" style="display: none;">
                            <td colspan="3">T·ªïng gi√° ti·ªÅn</td>
                            <td><input type="number" id="medicineTotalAmount" placeholder="Nh·∫≠p t·ªïng gi√° ti·ªÅn" min="0"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <button class="btn btn-primary" id="addMedicineRow">
                    <i class="fas fa-plus"></i> Th√™m h√†ng m·ªõi
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-medicine-modal">H·ªßy</button>
                <button class="btn btn-success" id="saveMedicineBtn">L∆∞u thu·ªëc</button>
            </div>
        </div>
    </div>

    <!-- Modal di·ªÖn bi·∫øn b·ªánh -->
   <!-- Modal di·ªÖn bi·∫øn b·ªánh -->
<div id="progressModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3>Di·ªÖn bi·∫øn b·ªánh</h3>
            <button class="close-btn close-progress-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">T√™n b·ªánh nh√¢n</label>
                    <input type="text" id="progressPatientName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Tu·ªïi</label>
                    <input type="text" id="progressPatientAge" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">M√£ b·ªánh nh√¢n</label>
                    <input type="text" id="progressPatientCode" class="form-control" readonly>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Ch·∫©n ƒëo√°n</label>
                <input type="text" id="progressDiagnosis" class="form-control" readonly>
            </div>
            
            <h4 class="section-title">L·ªãch s·ª≠ di·ªÖn bi·∫øn</h4>
            <table class="table-input" id="progressTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Gi·ªù v√† ng√†y</th>
                        <th>Di·ªÖn bi·∫øn</th>
                        <th>Y l·ªánh</th>
                        <th>X√≥a</th>
                    </tr>
                </thead>
                <tbody id="progressTableBody">
                    <!-- Rows s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                </tbody>
            </table>
            <button class="btn btn-primary" id="addProgressRow">
                <i class="fas fa-plus"></i> Th√™m di·ªÖn bi·∫øn
            </button>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light close-progress-modal">H·ªßy</button>
            <button class="btn btn-success" id="saveProgressBtn">L∆∞u di·ªÖn bi·∫øn</button>
        </div>
    </div>
</div>

<!-- Modal nh·∫≠p di·ªÖn bi·∫øn chi ti·∫øt -->
<div id="progressDetailModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="progressDetailTitle">Nh·∫≠p di·ªÖn bi·∫øn</h3>
            <button class="close-btn close-progress-detail-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label" id="progressDetailLabel">N·ªôi dung chi ti·∫øt</label>
                <textarea id="progressDetailText" class="form-control" rows="12" placeholder="Nh·∫≠p n·ªôi dung chi ti·∫øt..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-light close-progress-detail-modal">H·ªßy</button>
            <button class="btn btn-success" id="saveProgressDetailBtn">L∆∞u n·ªôi dung</button>
        </div>
    </div>
</div>

    <!-- Modal x√°c nh·∫≠n x√≥a -->
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>X√°c nh·∫≠n x√≥a</h3>
                <button class="close-btn close-delete-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·ªánh √°n n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-delete-modal">H·ªßy</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">X√≥a b·ªánh √°n</button>
            </div>
        </div>
    </div>

    <!-- Modal t√πy ch·ªçn in/t·∫£i -->
  <!-- Modal t√πy ch·ªçn in/t·∫£i - HI·ªÜN ƒê·∫†I -->
<div id="printOptionsModal" class="modal">
    <div class="modal-content" style="max-width: 500px; border-radius: 16px;">
        <div class="modal-header" style="border-radius: 16px 16px 0 0; background: linear-gradient(135deg, var(--primary), var(--secondary));">
            <h3 style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-export" style="font-size: 1.3rem;"></i>
                Xu·∫•t b·ªánh √°n
            </h3>
            <button class="close-btn close-print-modal" style="background: rgba(255,255,255,0.2);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body" style="padding: 25px;">
            <!-- Tabs chuy·ªÉn ƒë·ªïi -->
            <div class="export-tabs" style="display: flex; gap: 5px; margin-bottom: 25px; background: #f8f9fa; padding: 5px; border-radius: 12px;">
                <button class="export-tab active" data-tab="print">
                    <i class="fas fa-print"></i> In
                </button>
                <button class="export-tab" data-tab="download">
                    <i class="fas fa-download"></i> T·∫£i xu·ªëng
                </button>
            </div>
            
            <!-- Tab In ·∫•n -->
            <div class="export-content active" id="printTab">
                <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-print" style="color: var(--primary);"></i>
                    Ch·ªçn lo·∫°i in ·∫•n
                </h4>
                
                <div class="option-grid">
                    <div class="export-option print-option" data-type="full" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="option-icon">
                            <i class="fas fa-file-medical-alt"></i>
                        </div>
                        <div class="option-content">
                            <div class="option-title">To√†n b·ªô b·ªánh √°n</div>
                            <div class="option-desc">In ƒë·∫ßy ƒë·ªß th√¥ng tin</div>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="export-option print-option" data-type="medicine" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="option-icon">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="option-content">
                            <div class="option-title">ƒê∆°n thu·ªëc</div>
                            <div class="option-desc">Danh s√°ch thu·ªëc k√™ ƒë∆°n</div>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="export-option print-option" data-type="procedure" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="option-icon">
                            <i class="fas fa-procedures"></i>
                        </div>
                        <div class="option-content">
                            <div class="option-title">Th·ªß thu·∫≠t</div>
                            <div class="option-desc">C√°c th·ªß thu·∫≠t ƒë√£ th·ª±c hi·ªán</div>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="export-option print-option" data-type="progress" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="option-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="option-content">
                            <div class="option-title">Di·ªÖn bi·∫øn</div>
                            <div class="option-desc">L·ªãch s·ª≠ di·ªÖn bi·∫øn b·ªánh</div>
                        </div>
                        <div class="option-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab T·∫£i xu·ªëng -->
           <!-- Tab T·∫£i xu·ªëng - CH·ªà C√ì DOCX -->
<div class="export-content" id="downloadTab">
    <h4 style="color: var(--secondary); margin-bottom: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-file-word" style="color: var(--primary);"></i>
        T·∫£i xu·ªëng file DOCX
    </h4>
    
    <div class="option-grid">
        <div class="export-option download-option" data-type="full">
            <div class="option-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-file-archive"></i>
            </div>
            <div class="option-content">
                <div class="option-title">To√†n b·ªô b·ªánh √°n</div>
                <div class="option-desc">T·∫£i ƒë·∫ßy ƒë·ªß th√¥ng tin</div>
            </div>
            <div class="option-arrow">
                <i class="fas fa-download"></i>
            </div>
        </div>
        
        <div class="export-option download-option" data-type="medicine">
            <div class="option-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="fas fa-prescription-bottle-alt"></i>
            </div>
            <div class="option-content">
                <div class="option-title">ƒê∆°n thu·ªëc</div>
                <div class="option-desc">Danh s√°ch thu·ªëc</div>
            </div>
            <div class="option-arrow">
                <i class="fas fa-download"></i>
            </div>
        </div>
        
        <div class="export-option download-option" data-type="procedure">
            <div class="option-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <i class="fas fa-syringe"></i>
            </div>
            <div class="option-content">
                <div class="option-title">Th·ªß thu·∫≠t</div>
                <div class="option-desc">C√°c th·ªß thu·∫≠t</div>
            </div>
            <div class="option-arrow">
                <i class="fas fa-download"></i>
            </div>
        </div>
        
        <div class="export-option download-option" data-type="progress">
            <div class="option-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="option-content">
                <div class="option-title">Di·ªÖn bi·∫øn</div>
                <div class="option-desc">L·ªãch s·ª≠ b·ªánh</div>
            </div>
            <div class="option-arrow">
                <i class="fas fa-download"></i>
            </div>
        </div>
    </div>
</div>
        </div>
        
        <div class="modal-footer" style="border-top: 1px solid #eee; padding: 15px 25px; display: flex; justify-content: space-between;">
            <button class="btn btn-light close-print-modal" style="border-radius: 30px; padding: 8px 20px;">
                <i class="fas fa-times"></i> ƒê√≥ng
            </button>
            <div class="export-info" style="font-size: 0.9rem; color: var(--gray); display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-info-circle"></i>
                <span id="selectedOptionText">Ch·ªçn m·ªôt t√πy ch·ªçn</span>
            </div>
        </div>
    </div>
</div>

    <script>
	/* ================= LOGIN SYSTEM ================= */

// T√ÄI KHO·∫¢N M·∫∂C ƒê·ªäNH (ANH ƒê·ªîI SAU)
const AUTH_ACCOUNT = {
    username: "admin",
    password: "123456"
};

// Ki·ªÉm tra ƒëƒÉng nh·∫≠p khi load
document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem("isLoggedIn") === "true") {
        hideLogin();
    }
});

function handleLogin() {
    const u = document.getElementById("loginUsername").value.trim();
    const p = document.getElementById("loginPassword").value.trim();
    const errorBox = document.getElementById("loginError");

    if (!u || !p) {
        errorBox.textContent = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin";
        return;
    }

    if (u === AUTH_ACCOUNT.username && p === AUTH_ACCOUNT.password) {
        localStorage.setItem("isLoggedIn", "true");
        hideLogin();
        showToast("ƒêƒÉng nh·∫≠p th√†nh c√¥ng", "success");
    } else {
        errorBox.textContent = "Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u";
    }
}

function hideLogin() {
    document.getElementById("loginOverlay").style.display = "none";
}

function logout() {
    localStorage.removeItem("isLoggedIn");
    location.reload();
}

	// Enter ƒë·ªÉ ƒëƒÉng nh·∫≠p
document.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        const loginOverlay = document.getElementById("loginOverlay");
        if (loginOverlay && loginOverlay.style.display !== "none") {
            handleLogin();
        }
    }
});

	
        // Kh·ªüi t·∫°o bi·∫øn to√†n c·ª•c
        let medicalRecords = [];
        let currentRecordId = null;
        let currentProgressRecordId = null;
        let isEditing = false;
		let currentEditingRecordId = null; 
		let currentEditingProgressCell = null; 
        // H√†m t·∫°o m√£ b·ªánh nh√¢n t·ª± ƒë·ªông 
function generatePatientCode() {
    if (medicalRecords.length === 0) {
        return '0000001';
    }
    
    // T√¨m m√£ l·ªõn nh·∫•t hi·ªán c√≥
    let maxCode = 0;
    medicalRecords.forEach(record => {
        if (record.patientCode && /^\d+$/.test(record.patientCode)) {
            const codeNum = parseInt(record.patientCode);
            if (codeNum > maxCode) {
                maxCode = codeNum;
            }
        }
    });
    
    // T·∫°o m√£ m·ªõi
    const newCode = maxCode + 1;
    return newCode.toString().padStart(7, '0');
}
        // C·∫•u h√¨nh Dropbox
        const DROPBOX_CONFIG = {
            refreshToken: 'yvVdSnOoxgsAAAAAAAAAAYwqRQmU9NPgvKrMmzAL2JY9QqutemeEsykD9LmlQcRr',
            appKey: 'qzy5kclrf827aey',
            appSecret: '6jlsunzjqr3s3nh',
            filePath: '/medical_records.json'
        };

        let dropboxAccessToken = null;

        // DOM Elements
        const newRecordBtn = document.getElementById('newRecordBtn');
        const recordModal = document.getElementById('recordModal');
		
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resetSearchBtn = document.getElementById('resetSearchBtn');
        const recordsTableBody = document.getElementById('recordsTableBody');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');
        const toast = document.getElementById('toast');
        
        // Hi·ªÉn th·ªã toast th√¥ng b√°o
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast toast-${type}`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // L·∫•y access token t·ª´ refresh token
        async function getDropboxAccessToken() {
            try {
                const response = await fetch('https://api.dropbox.com/oauth2/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'grant_type': 'refresh_token',
                        'refresh_token': DROPBOX_CONFIG.refreshToken,
                        'client_id': DROPBOX_CONFIG.appKey,
                        'client_secret': DROPBOX_CONFIG.appSecret
                    })
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y access token t·ª´ Dropbox');
                }

                const data = await response.json();
                dropboxAccessToken = data.access_token;
                return data.access_token;
            } catch (error) {
                console.error('L·ªói khi l·∫•y access token:', error);
                showToast('L·ªói k·∫øt n·ªëi Dropbox: ' + error.message, 'error');
                return null;
            }
        }

        // L∆∞u d·ªØ li·ªáu l√™n Dropbox
        async function saveToDropbox() {
            try {
                if (!dropboxAccessToken) {
                    dropboxAccessToken = await getDropboxAccessToken();
                    if (!dropboxAccessToken) {
                        throw new Error('Kh√¥ng c√≥ access token');
                    }
                }

                const data = {
                    medicalRecords: medicalRecords,
                    lastSync: new Date().toISOString(),
                    totalRecords: medicalRecords.length
                };

                const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${dropboxAccessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: DROPBOX_CONFIG.filePath,
                            mode: 'overwrite',
                            autorename: false,
                            mute: true
                        })
                    },
                    body: JSON.stringify(data, null, 2)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error_summary || 'Upload failed');
                }

                return true;
            } catch (error) {
                console.error('L·ªói khi l∆∞u :', error);
                showToast('L·ªói khi l∆∞u : ' + error.message, 'error');
                return false;
            }
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ Dropbox
        async function loadFromDropbox() {
            try {
                if (!dropboxAccessToken) {
                    dropboxAccessToken = await getDropboxAccessToken();
                    if (!dropboxAccessToken) {
                        throw new Error('Kh√¥ng c√≥ access token');
                    }
                }

                const response = await fetch('https://content.dropboxapi.com/2/files/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${dropboxAccessToken}`,
                        'Dropbox-API-Arg': JSON.stringify({
                            path: DROPBOX_CONFIG.filePath
                        })
                    }
                });

                if (!response.ok) {
                    if (response.status === 409) {
                        // File kh√¥ng t·ªìn t·∫°i, t·∫°o file m·ªõi
                        medicalRecords = [];
                        await saveToDropbox();
                        return true;
                    }
                    throw new Error('Download failed');
                }

                const data = await response.json();
                
                if (data.medicalRecords && Array.isArray(data.medicalRecords)) {
                    medicalRecords = data.medicalRecords;
                    return true;
                } else {
                    throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá');
                }
            } catch (error) {
                console.error('L·ªói khi t·∫£i:', error);
                showToast('L·ªói khi t·∫£i t·ª´: ' + error.message, 'error');
                return false;
            }
        }

        // T·∫£i d·ªØ li·ªáu khi kh·ªüi ƒë·ªông
        async function loadData() {
            loadingState.style.display = 'flex';
            recordsTableBody.innerHTML = '';
            emptyState.style.display = 'none';
            
            const success = await loadFromDropbox();
            
            loadingState.style.display = 'none';
            
            if (success) {
                renderRecordsTable();
                showToast(`ƒê√£ t·∫£i ${medicalRecords.length} b·ªánh √°n`, 'success');
            } else {
                emptyState.style.display = 'block';
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch b·ªánh √°n
function renderRecordsTable(filteredRecords = null) {
    const records = filteredRecords || medicalRecords;
    
    if (records.length === 0) {
        recordsTableBody.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // S·∫Øp x·∫øp m·ªõi l√™n tr∆∞·ªõc
    const sortedRecords = [...records].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    let tableHTML = '';
    sortedRecords.forEach((record, index) => {
        // S·ª¨A D√íNG N√ÄY: d√πng primaryDiagnosis thay v√¨ diagnosis
        const shortDiagnosis = record.primaryDiagnosis && record.primaryDiagnosis.length > 50 ? 
            record.primaryDiagnosis.substring(0, 50) + '...' : record.primaryDiagnosis || '';
        
        tableHTML += `
            <tr data-id="${record.id}">
                <td>${index + 1}</td>
                <td><strong>${record.patientCode}</strong></td>
                <td>${record.patientName}</td>
                <td>${record.age}</td>
                <td>${formatDate(record.examinationDate)}</td>
                <td>${shortDiagnosis}</td> <!-- Hi·ªÉn th·ªã ch·∫©n ƒëo√°n ch√≠nh -->
                <td>
                    <div class="actions">
                        <div class="action-btn view-btn" title="S·ª≠a" onclick="viewRecord('${record.id}')">
                            <i class="fas fa-eye"></i>
                        </div>
                        <!-- TH√äM L·∫†I N√öT DI·ªÑN BI·∫æN -->
                        <div class="action-btn history-btn" title="Di·ªÖn bi·∫øn" onclick="showProgressModal('${record.id}')">
                            <i class="fas fa-history"></i>
                        </div>
						<div class="action-btn view-btn" onclick="showPreview('${record.id}')" title="Xem">
    <i class="fas fa-file-pdf"></i>
</div>
                       <div class="action-btn print-btn" 
     title="In / T·∫£i"
     onclick="showPrintOptions('${record.id}')">
    <i class="fas fa-print"></i>
</div>

                        <div class="action-btn delete-btn" title="X√≥a" onclick="confirmDeleteRecord('${record.id}')">
                            <i class="fas fa-trash"></i>
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });
    
    recordsTableBody.innerHTML = tableHTML;
}

        // ƒê·ªãnh d·∫°ng ng√†y th√°ng
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        // T√¨m ki·∫øm b·ªánh √°n
  // T√¨m h√†m n√†y v√† th√™m t√¨m ki·∫øm theo ch·∫©n ƒëo√°n ch√≠nh:
function searchRecords() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (!searchTerm) {
        renderRecordsTable();
        return;
    }
    
    const filteredRecords = medicalRecords.filter(record => {
        return (
            (record.patientName && record.patientName.toLowerCase().includes(searchTerm)) ||
            (record.patientCode && record.patientCode.toLowerCase().includes(searchTerm)) ||
            (record.primaryDiagnosis && record.primaryDiagnosis.toLowerCase().includes(searchTerm)) || // TH√äM D√íNG N√ÄY
            (record.diagnosis && record.diagnosis.toLowerCase().includes(searchTerm)) ||
            (record.examinationDate && record.examinationDate.includes(searchTerm))
        );
    });
    
    renderRecordsTable(filteredRecords);
}

        // Reset t√¨m ki·∫øm
        function resetSearch() {
            searchInput.value = '';
            renderRecordsTable();
        }

        // Hi·ªÉn th·ªã modal th√™m b·ªánh √°n m·ªõi
// Hi·ªÉn th·ªã modal th√™m b·ªánh √°n m·ªõi
function showNewRecordModal() {
    currentRecordId = null;
	currentEditingRecordId = null;
    isEditing = false;
    document.getElementById('modalTitle').textContent = 'Th√™m b·ªánh √°n m·ªõi';
    document.getElementById('recordForm').reset();
    
    // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('examinationDate').value = today;
    
    // ƒê·∫∑t gi·ªù m·∫∑c ƒë·ªãnh l√† hi·ªán t·∫°i
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('examinationTime').value = `${hours}:${minutes}`;
    
    // T·∫†O M√É B·ªÜNH NH√ÇN T·ª∞ ƒê·ªòNG (TH√äM ƒêO·∫†N N√ÄY)
    const autoCode = generatePatientCode();
    document.getElementById('patientCode').value = autoCode;
    
    // Reset c√°c textarea
    document.getElementById('diagnosis').value = '';
    document.getElementById('primaryDiagnosis').value = ''; // TH√äM D√íNG N√ÄY
    document.getElementById('procedureText').innerHTML = '<i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ th√™m th·ªß thu·∫≠t';
    document.getElementById('procedureSummary').innerHTML = '';
    document.getElementById('medicineText').innerHTML = '<i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ th√™m thu·ªëc';
    document.getElementById('medicineSummary').innerHTML = '';
    
    // T·ª± ƒë·ªông ch·ªçn gi·ªõi t√≠nh n·∫øu t√™n c√≥ "th·ªã"
    document.getElementById('patientName').addEventListener('input', function() {
        const name = this.value.toLowerCase();
        if (name.includes('th·ªã')) {
            document.querySelector('input[name="gender"][value="N·ªØ"]').checked = true;
        }
    });
    
    recordModal.style.display = 'block';
}

       // Xem/s·ª≠a b·ªánh √°n
function viewRecord(id) {
    const record = medicalRecords.find(r => r.id === id);
    if (!record) return;
    
    currentRecordId = id;
 currentEditingRecordId = id;
    isEditing = true;
    document.getElementById('modalTitle').textContent = 'S·ª≠a b·ªánh √°n';
    
    // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
    document.getElementById('patientName').value = record.patientName;
    const genderRadio = document.querySelector(`input[name="gender"][value="${record.gender || 'Nam'}"]`);
    if (genderRadio) genderRadio.checked = true;
    document.getElementById('patientAge').value = record.age;
    document.getElementById('patientAddress').value = record.address || '';
    document.getElementById('patientCode').value = record.patientCode;
    document.getElementById('examinationDate').value = record.examinationDate;
    document.getElementById('examinationTime').value = record.examinationTime || '09:00';
    document.getElementById('diagnosis').value = record.diagnosis || ''; // CH·ªà D√íNG N√ÄY THAY ƒê·ªîI
    document.getElementById('followUpDate').value = record.followUpDate || '';
     document.getElementById('primaryDiagnosis').value = record.primaryDiagnosis || '';
    // Hi·ªÉn th·ªã th·ªß thu·∫≠t
    if (record.procedures && record.procedures.length > 0) {
        let procedureHTML = '<ul>';
        record.procedures.forEach(proc => {
            procedureHTML += `<li>${proc.name} - S·ªë l·∫ßn: ${proc.quantity}${proc.price ? ` - Gi√°: ${formatCurrency(proc.price)}` : ''}</li>`;
        });
        procedureHTML += '</ul>';
        document.getElementById('procedureSummary').innerHTML = procedureHTML;
        document.getElementById('procedureText').innerHTML = '<i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ ch·ªânh s·ª≠a th·ªß thu·∫≠t';
    }
    
    // Hi·ªÉn th·ªã thu·ªëc
    if (record.medicines && record.medicines.length > 0) {
        let medicineHTML = '<ul>';
        record.medicines.forEach(med => {
            medicineHTML += `<li>${med.name} - S·ªë l∆∞·ª£ng: ${med.quantity}${med.price ? ` - Gi√°: ${formatCurrency(med.price)}` : ''}</li>`;
        });
        medicineHTML += '</ul>';
        document.getElementById('medicineSummary').innerHTML = medicineHTML;
        document.getElementById('medicineText').innerHTML = '<i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ ch·ªânh s·ª≠a thu·ªëc';
    }
    
    recordModal.style.display = 'block';
}

        // ƒê·ªãnh d·∫°ng ti·ªÅn t·ªá
      function formatCurrency(amount) {
    if (!amount && amount !== 0) return '0 ‚Ç´';
    if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

        // L∆∞u b·ªánh √°n
        async function saveRecord() {
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const patientName = document.getElementById('patientName').value;
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const age = document.getElementById('patientAge').value;
            const address = document.getElementById('patientAddress').value;
            const patientCode = document.getElementById('patientCode').value;
            const examinationDate = document.getElementById('examinationDate').value;
            const examinationTime = document.getElementById('examinationTime').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const followUpDate = document.getElementById('followUpDate').value;
               const primaryDiagnosis = document.getElementById('primaryDiagnosis').value;
            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
            if (!patientName || !age || !patientCode || !examinationDate || !examinationTime || !primaryDiagnosis) {
                showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'error');
                return;
            }
            
            // L·∫•y d·ªØ li·ªáu th·ªß thu·∫≠t v√† thu·ªëc t·ª´ localStorage t·∫°m th·ªùi
            const tempProcedures = JSON.parse(localStorage.getItem('tempProcedures')) || [];
            const tempMedicines = JSON.parse(localStorage.getItem('tempMedicines')) || [];
            
            // Hi·ªÉn th·ªã loading
            document.getElementById('saveLoading').style.display = 'flex';
            document.getElementById('saveRecordBtn').disabled = true;
            
            try {
                if (isEditing) {
                    // C·∫≠p nh·∫≠t b·ªánh √°n hi·ªán c√≥
                    const recordIndex = medicalRecords.findIndex(r => r.id === currentRecordId);
                    if (recordIndex !== -1) {
                        medicalRecords[recordIndex] = {
                            ...medicalRecords[recordIndex],
                            patientName,
                            gender,
                            age: parseInt(age),
                            address,
                            patientCode,
							primaryDiagnosis,
                            examinationDate,
                            examinationTime,
                            diagnosis,
                            procedures: tempProcedures.length > 0 ? tempProcedures : (medicalRecords[recordIndex].procedures || []),
                            medicines: tempMedicines.length > 0 ? tempMedicines : (medicalRecords[recordIndex].medicines || []),
                            followUpDate: followUpDate || null,
                            updatedAt: new Date().toISOString()
                        };
                    }
                } else {
                    // T·∫°o b·ªánh √°n m·ªõi
                    const newRecord = {
                        id: 'record_' + Date.now(),
                        patientName,
                        gender,
                        age: parseInt(age),
                        address,
                        patientCode,
                        examinationDate,
                        examinationTime,
                        diagnosis,
						 primaryDiagnosis,
                        procedures: tempProcedures,
                        medicines: tempMedicines,
                        followUpDate: followUpDate || null,
                        progress: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    medicalRecords.unshift(newRecord);
                }
                
                // X√≥a d·ªØ li·ªáu t·∫°m
                localStorage.removeItem('tempProcedures');
                localStorage.removeItem('tempMedicines');
                
                // L∆∞u l√™n Dropbox
                const success = await saveToDropbox();
                
                if (success) {
                    // C·∫≠p nh·∫≠t giao di·ªán
                    renderRecordsTable();
                    recordModal.style.display = 'none';
                    showToast(`${isEditing ? 'C·∫≠p nh·∫≠t' : 'Th√™m'} b·ªánh √°n th√†nh c√¥ng!`, 'success');
                } else {
                    showToast('L·ªói khi l∆∞u', 'error');
                }
            } catch (error) {
                console.error('L·ªói khi l∆∞u:', error);
                showToast('L·ªói: ' + error.message, 'error');
            } finally {
                // ·∫®n loading
                document.getElementById('saveLoading').style.display = 'none';
                document.getElementById('saveRecordBtn').disabled = false;
            }
        }

        // X√°c nh·∫≠n x√≥a b·ªánh √°n
        function confirmDeleteRecord(id) {
            currentRecordId = id;
            confirmDeleteModal.style.display = 'block';
        }

        // X√≥a b·ªánh √°n
        async function deleteRecord() {
            try {
                document.getElementById('confirmDeleteBtn').disabled = true;
                document.getElementById('confirmDeleteBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x√≥a...';
                
                medicalRecords = medicalRecords.filter(record => record.id !== currentRecordId);
                
                // L∆∞u l√™n Dropbox
                const success = await saveToDropbox();
                
                if (success) {
                    renderRecordsTable();
                    confirmDeleteModal.style.display = 'none';
                    showToast('ƒê√£ x√≥a b·ªánh √°n th√†nh c√¥ng!', 'success');
                } else {
                    showToast('L·ªói khi x√≥a b·ªánh √°n', 'error');
                }
            } catch (error) {
                console.error('L·ªói khi x√≥a:', error);
                showToast('L·ªói: ' + error.message, 'error');
            } finally {
                document.getElementById('confirmDeleteBtn').disabled = false;
                document.getElementById('confirmDeleteBtn').innerHTML = 'X√≥a b·ªánh √°n';
            }
        }


        // Hi·ªÉn th·ªã modal di·ªÖn bi·∫øn
       function showProgressModal(id) {
    const record = medicalRecords.find(r => r.id === id);
    if (!record) return;
    
    currentProgressRecordId = id;
    
    // ƒêi·ªÅn th√¥ng tin b·ªánh nh√¢n
    document.getElementById('progressPatientName').value = record.patientName;
    document.getElementById('progressPatientAge').value = record.age;
    document.getElementById('progressPatientCode').value = record.patientCode;
    document.getElementById('progressDiagnosis').value = record.primaryDiagnosis || '';
    
    // Hi·ªÉn th·ªã di·ªÖn bi·∫øn
    const progressTableBody = document.getElementById('progressTableBody');
    progressTableBody.innerHTML = '';
    
    if (record.progress && record.progress.length > 0) {
        record.progress.forEach((item, index) => {
            const row = createProgressRow(index + 1, item);
            progressTableBody.appendChild(row);
        });
    } else {
        const row = createProgressRow(1);
        progressTableBody.appendChild(row);
    }
    
    progressModal.style.display = 'block';
}

        // L∆∞u di·ªÖn bi·∫øn
      async function saveProgress() {
    const recordIndex = medicalRecords.findIndex(r => r.id === currentProgressRecordId);
    if (recordIndex === -1) return;
    
    // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng
    const progressRows = document.querySelectorAll('#progressTableBody tr');
    const progress = [];
    
    progressRows.forEach(row => {
        const datetime = row.querySelector('.progress-datetime').value;
        const detail = row.querySelector('.progress-detail').value;
        const order = row.querySelector('.progress-order').value;
        
        if (datetime) {
            progress.push({ 
                datetime, 
                detail: detail || '', 
                order: order || '' 
            });
        }
    });
    
    // C·∫≠p nh·∫≠t di·ªÖn bi·∫øn
    medicalRecords[recordIndex].progress = progress;
    
    // L∆∞u l√™n Dropbox
    const success = await saveToDropbox();
    
    if (success) {
        progressModal.style.display = 'none';
        showToast('ƒê√£ l∆∞u di·ªÖn bi·∫øn th√†nh c√¥ng!', 'success');
    } else {
        showToast('L·ªói khi l∆∞u di·ªÖn bi·∫øn', 'error');
    }
}
		
		
		
function createProgressRow(index, data = null) {
    const row = document.createElement('tr');

    const detailText = data?.detail || '';
    const orderText  = data?.order || '';
    const datetimeValue = data?.datetime || '';

    row.innerHTML = `
        <td>${index}</td>
        <td>
            <input type="datetime-local"
                   class="progress-datetime"
                   value="${datetimeValue}">
        </td>

        <!-- DI·ªÑN BI·∫æN -->
        <td>
            <textarea class="progress-textarea-input progress-detail"
                placeholder="Nh·∫≠p di·ªÖn bi·∫øn..."
                ondblclick="openProgressDetailModal(this, 'detail')"
            >${detailText}</textarea>
        </td>

        <!-- Y L·ªÜNH -->
        <td>
            <textarea class="progress-textarea-input progress-order"
                placeholder="Nh·∫≠p y l·ªánh..."
                ondblclick="openProgressDetailModal(this, 'order')"
            >${orderText}</textarea>
        </td>

        <td>
            <button class="btn btn-danger btn-sm remove-progress-row">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    return row;
}

// M·ªü modal nh·∫≠p chi ti·∫øt di·ªÖn bi·∫øn/y l·ªánh
function openProgressDetailModal(textarea, type) {
    currentEditingProgressCell = {
        textarea,
        type
    };

    const title = type === 'detail' ? 'Di·ªÖn bi·∫øn' : 'Y l·ªánh';

    document.getElementById('progressDetailTitle').textContent = `Nh·∫≠p ${title}`;
    document.getElementById('progressDetailLabel').textContent = title;
    document.getElementById('progressDetailText').value = textarea.value;

    document.getElementById('progressDetailModal').style.display = 'block';
}
		
		
		
		
		
		

        // Hi·ªÉn th·ªã t√πy ch·ªçn in/t·∫£i
        function showPrintOptions(id) {
            currentRecordId = id;
            printOptionsModal.style.display = 'block';
        }

        // X·ª≠ l√Ω in ·∫•n
       function handlePrint(type) {
    const record = medicalRecords.find(r => r.id === currentRecordId);
    if (!record) return;

    let printContent = '';

    switch(type) {
        case 'full':
            printContent = generateFullPrintContent(record);
            break;
        case 'medicine':
            printContent = generateMedicinePrintContent(record);
            break;
        case 'procedure':
            printContent = generateProcedurePrintContent(record);
            break;
        case 'progress':
            printContent = generateProgressPrintContent(record);
            break;
    }

    printByIframe(`
        <h1 style="color:#FF6B35">B·ªánh √°n - ${record.patientCode}</h1>
        ${printContent}
    `);
}

       // T·∫°o n·ªôi dung in full
function generateFullPrintContent(record) {
    // Thay th·∫ø xu·ªëng d√≤ng \n th√†nh <br> ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng
    const diagnosisWithBreaks = (record.diagnosis || '').replace(/\n/g, '<br>');
    
    return `
        <h1>B·ªánh √°n - ${record.patientCode}</h1>
        <p><strong>H·ªç t√™n:</strong> ${record.patientName}</p>
        <p><strong>Gi·ªõi t√≠nh:</strong> ${record.gender}</p>
        <p><strong>Tu·ªïi:</strong> ${record.age}</p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${record.address || ''}</p>
        <p><strong>Ng√†y kh√°m:</strong> ${formatDate(record.examinationDate)} ${record.examinationTime || ''}</p>
        <p><strong>Ch·∫©n ƒëo√°n ch√≠nh:</strong> ${record.primaryDiagnosis || ''}</p>
        <p><strong>N·ªôi dung:</strong></p>
        <div style="white-space: pre-wrap; border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f9f9f9;">
            ${diagnosisWithBreaks}
        </div>
        
        ${record.procedures && record.procedures.length > 0 ? `
            <h2>Th·ªß thu·∫≠t</h2>
            <table>
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n th·ªß thu·∫≠t</th>
                        <th>Ghi ch√∫</th>
                        <th>S·ªë l·∫ßn</th>
                        <th>Gi√° ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    ${record.procedures.map((proc, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${proc.name}</td>
                            <td style="white-space: pre-wrap;">${proc.note || ''}</td>
                            <td>${proc.quantity}</td>
                            <td>${formatCurrency(proc.price)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : ''}
        
        ${record.medicines && record.medicines.length > 0 ? `
            <h2>Thu·ªëc</h2>
            <table>
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n thu·ªëc</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Gi√° ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    ${record.medicines.map((med, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${med.name}</td>
                            <td>${med.quantity}</td>
                            <td>${formatCurrency(med.price)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        ` : ''}
        
        ${record.followUpDate ? `<p><strong>H·∫πn t√°i kh√°m:</strong> ${formatDate(record.followUpDate)}</p>` : ''}
    `;
}

        // T·∫°o n·ªôi dung in thu·ªëc
        function generateMedicinePrintContent(record) {
            return `
                <h1>ƒê∆°n thu·ªëc - ${record.patientCode}</h1>
                <p><strong>H·ªç t√™n:</strong> ${record.patientName}</p>
                <p><strong>Ng√†y kh√°m:</strong> ${formatDate(record.examinationDate)}</p>
                
                <h2>ƒê∆°n thu·ªëc</h2>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n thu·ªëc</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√° ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${record.medicines && record.medicines.length > 0 ? 
                            record.medicines.map((med, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${med.name}</td>
                                    <td>${med.quantity}</td>
                                    <td>${formatCurrency(med.price)}</td>
                                </tr>
                            `).join('') : 
                            '<tr><td colspan="4">Kh√¥ng c√≥ thu·ªëc</td></tr>'
                        }
                    </tbody>
                </table>
            `;
        }

        // T·∫°o n·ªôi dung in th·ªß thu·∫≠t
        function generateProcedurePrintContent(record) {
            return `
                <h1>Th·ªß thu·∫≠t - ${record.patientCode}</h1>
                <p><strong>H·ªç t√™n:</strong> ${record.patientName}</p>
                <p><strong>Ng√†y kh√°m:</strong> ${formatDate(record.examinationDate)}</p>
                
                <h2>Th·ªß thu·∫≠t</h2>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n th·ªß thu·∫≠t</th>
							<th>Ghi ch√∫</th>
                            <th>S·ªë l·∫ßn</th>
                            <th>Gi√° ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${record.procedures && record.procedures.length > 0 ? 
                            record.procedures.map((proc, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${proc.name}</td>
									<td>${proc.note || ''}</td>
                                    <td>${proc.quantity}</td>
                                    <td>${formatCurrency(proc.price)}</td>
                                </tr>
                            `).join('') : 
                            '<tr><td colspan="4">Kh√¥ng c√≥ th·ªß thu·∫≠t</td></tr>'
                        }
                    </tbody>
                </table>
            `;
        }

        // T·∫°o n·ªôi dung in di·ªÖn bi·∫øn
        function generateProgressPrintContent(record) {
            return `
                <h1>Di·ªÖn bi·∫øn b·ªánh - ${record.patientCode}</h1>
                <p><strong>H·ªç t√™n:</strong> ${record.patientName}</p>
                <p><strong>Tu·ªïi:</strong> ${record.age}</p>
                <p><strong>Ch·∫©n ƒëo√°n:</strong> ${record.diagnosis || ''}</p>
                
                <h2>Di·ªÖn bi·∫øn</h2>
                <table>
                    <thead>
                        <tr>
                           
                            <th>Gi·ªù v√† ng√†y</th>
                            <th>Di·ªÖn bi·∫øn</th>
                            <th>Y l·ªánh</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${record.progress && record.progress.length > 0 ? 
                            record.progress.map((item, index) => {
                                const date = new Date(item.datetime);
                                const dateStr = date.toLocaleString('vi-VN');
                                return `
                                    <tr>
                                        
                                        <td>${dateStr}</td>
                                        <td>${item.detail}</td>
                                        <td>${item.order || ''}</td>
                                    </tr>
                                `;
                            }).join('') : 
                            '<tr><td colspan="4">Kh√¥ng c√≥ di·ªÖn bi·∫øn</td></tr>'
                        }
                    </tbody>
                </table>
            `;
        }

       

// H√†m t·∫°o DOCX to√†n b·ªô b·ªánh √°n - T·∫§T C·∫¢ TRONG M·ªòT SECTION
async function generateFullDocx(record) {
    const { Document, Paragraph, TextRun, Table, TableRow, TableCell, HeadingLevel, AlignmentType } = docx;
    
    const children = [
        new Paragraph({
            text: "B·ªÜNH √ÅN ƒêI·ªÜN T·ª¨",
            heading: HeadingLevel.HEADING_1,
            alignment: AlignmentType.CENTER,
            spacing: { after: 100 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "M√£ b·ªánh nh√¢n: ", bold: true }),
                new TextRun(record.patientCode)
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "H·ªç t√™n: ", bold: true }),
                new TextRun(record.patientName)
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Gi·ªõi t√≠nh: ", bold: true }),
                new TextRun(record.gender)
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Tu·ªïi: ", bold: true }),
                new TextRun(record.age.toString())
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "ƒê·ªãa ch·ªâ: ", bold: true }),
                new TextRun(record.address || 'Kh√¥ng c√≥')
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Ng√†y kh√°m: ", bold: true }),
                new TextRun(`${formatDate(record.examinationDate)} ${record.examinationTime || ''}`)
            ],
            spacing: { after: 20 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Ch·∫©n ƒëo√°n ch√≠nh: ", bold: true }),
                new TextRun(record.primaryDiagnosis || '')
            ],
            spacing: { after: 40 }
        }),
        
        new Paragraph({
            text: "N·ªòI DUNG B·ªÜNH √ÅN",
            heading: HeadingLevel.HEADING_2,
            spacing: { before: 40, after: 20 }
        })
    ];
    
    // Th√™m n·ªôi dung b·ªánh √°n v·ªõi XU·ªêNG D√íNG ƒê√öNG C√ÅCH
    if (record.diagnosis) {
        // T√°ch n·ªôi dung th√†nh c√°c d√≤ng
        const lines = record.diagnosis.split('\n');
        
        // Th√™m t·ª´ng d√≤ng nh∆∞ m·ªôt Paragraph ri√™ng
        lines.forEach(line => {
            if (line.trim() !== '') {
                children.push(
                    new Paragraph({
                        text: line,
                        spacing: { after: 10 }
                    })
                );
            }
        });
        
        // Th√™m kho·∫£ng c√°ch sau ph·∫ßn n·ªôi dung
        children.push(
            new Paragraph({
                text: '',
                spacing: { after: 40 }
            })
        );
    } else {
        children.push(
            new Paragraph({
                text: "Kh√¥ng c√≥ n·ªôi dung",
                spacing: { after: 40 }
            })
        );
    }
    
    // Th√™m th·ªß thu·∫≠t n·∫øu c√≥
    if (record.procedures && record.procedures.length > 0) {
        children.push(
            new Paragraph({
                text: "TH·ª¶ THU·∫¨T",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 20, after: 10 }
            }),
            
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "STT", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "T√™n th·ªß thu·∫≠t", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Ghi ch√∫", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "S·ªë l·∫ßn", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Gi√° ti·ªÅn", bold: true })]
                                })] 
                            })
                        ]
                    }),
                    ...record.procedures.map((proc, index) => 
                        new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ children: [new Paragraph(proc.name)] }),
                                new TableCell({ children: [new Paragraph(proc.note || '-')] }),
                                new TableCell({ children: [new Paragraph(proc.quantity.toString())] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(proc.price))] })
                            ]
                        })
                    )
                ]
            })
        );
    }
    
    // Th√™m thu·ªëc n·∫øu c√≥
    if (record.medicines && record.medicines.length > 0) {
        children.push(
            new Paragraph({
                text: "ƒê∆†N THU·ªêC",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 20, after: 10 }
            }),
            
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "STT", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "T√™n thu·ªëc", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "S·ªë l∆∞·ª£ng", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Gi√° ti·ªÅn", bold: true })]
                                })] 
                            })
                        ]
                    }),
                    ...record.medicines.map((med, index) => 
                        new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ children: [new Paragraph(med.name)] }),
                                new TableCell({ children: [new Paragraph(med.quantity.toString())] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(med.price))] })
                            ]
                        })
                    )
                ]
            })
        );
    }
    
    // Th√™m di·ªÖn bi·∫øn n·∫øu c√≥
    if (record.progress && record.progress.length > 0) {
        children.push(
            new Paragraph({
                text: "DI·ªÑN BI·∫æN B·ªÜNH",
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 20, after: 10 }
            }),
            
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "STT", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Th·ªùi gian", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Di·ªÖn bi·∫øn", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Y l·ªánh", bold: true })]
                                })] 
                            })
                        ]
                    }),
                    ...record.progress.map((item, index) => {
                        const date = new Date(item.datetime);
                        const dateStr = date.toLocaleString('vi-VN');
                        return new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ children: [new Paragraph(dateStr)] }),
                                new TableCell({ 
                                    children: [new Paragraph({
                                        children: item.detail ? 
                                            // X·ª≠ l√Ω xu·ªëng d√≤ng cho di·ªÖn bi·∫øn
                                            item.detail.split('\n').map(line => 
                                                new TextRun({ text: line, break: 1 })
                                            ) : [new TextRun('')]
                                    })] 
                                }),
                                new TableCell({ 
                                    children: [new Paragraph({
                                        children: item.order ? 
                                            // X·ª≠ l√Ω xu·ªëng d√≤ng cho y l·ªánh
                                            item.order.split('\n').map(line => 
                                                new TextRun({ text: line, break: 1 })
                                            ) : [new TextRun('')]
                                    })] 
                                })
                            ]
                        });
                    })
                ]
            })
        );
    }
    
    // Th√™m h·∫πn t√°i kh√°m n·∫øu c√≥
    if (record.followUpDate) {
        children.push(
            new Paragraph({
                children: [
                    new TextRun({ text: "H·∫πn t√°i kh√°m: ", bold: true }),
                    new TextRun(formatDate(record.followUpDate))
                ],
                spacing: { before: 20, after: 40 }
            })
        );
    }
    
    // Th√™m footer
    children.push(
    
        
        new Paragraph({
            children: [
                new TextRun(`Ng√†y xu·∫•t b·ªánh √°n: ${new Date().toLocaleDateString('vi-VN')}`)
            ],
            alignment: AlignmentType.RIGHT,
            spacing: { before: 20 }
        })
    );
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: children
        }]
    });
    
    // T·∫°o blob
    const blob = await docx.Packer.toBlob(doc);
    return blob;
}


// H√†m t·∫°o DOCX ƒë∆°n thu·ªëc
// H√†m t·∫°o DOCX ƒë∆°n thu·ªëc - s·ª≠a ph·∫ßn xu·ªëng d√≤ng trong table cell
async function generateMedicineDocx(record) {
    const { Document, Paragraph, TextRun, Table, TableRow, TableCell, HeadingLevel, AlignmentType } = docx;
    
    const children = [
        new Paragraph({
            text: "ƒê∆†N THU·ªêC",
            heading: HeadingLevel.HEADING_1,
            alignment: AlignmentType.CENTER,
            spacing: { after: 80 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "M√£ b·ªánh nh√¢n: ", bold: true }),
                new TextRun(record.patientCode)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "H·ªç t√™n: ", bold: true }),
                new TextRun(record.patientName)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Ng√†y kh√°m: ", bold: true }),
                new TextRun(formatDate(record.examinationDate))
            ],
            spacing: { after: 30 }
        })
    ];
    
    // Th√™m b·∫£ng thu·ªëc
    if (record.medicines && record.medicines.length > 0) {
        children.push(
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "STT", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "T√™n thu·ªëc", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "S·ªë l∆∞·ª£ng", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "ƒê∆°n gi√°", bold: true })]
                                })] 
                            }),
                            new TableCell({ 
                                children: [new Paragraph({ 
                                    children: [new TextRun({ text: "Th√†nh ti·ªÅn", bold: true })]
                                })] 
                            })
                        ]
                    }),
                    ...record.medicines.map((med, index) => {
                        const total = (med.price || 0) * (med.quantity || 0);
                        return new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ 
                                    children: [new Paragraph({
                                        children: med.name ? 
                                            // X·ª≠ l√Ω xu·ªëng d√≤ng cho t√™n thu·ªëc n·∫øu c√≥ \n
                                            med.name.split('\n').map((line, i, arr) => 
                                                new TextRun({ 
                                                    text: line, 
                                                    break: i < arr.length - 1 ? 1 : 0 
                                                })
                                            ) : [new TextRun('')]
                                    })] 
                                }),
                                new TableCell({ children: [new Paragraph(med.quantity.toString())] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(med.price))] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(total))] })
                            ]
                        });
                    })
                ]
            })
        );
        
        // Th√™m t·ªïng c·ªông
        const grandTotal = record.medicines.reduce((sum, med) => 
            sum + ((med.price || 0) * (med.quantity || 0)), 0);
        
        children.push(
            new Paragraph({
                children: [
                    new TextRun({ text: "T·ªîNG C·ªòNG: ", bold: true, size: 24 }),
                    new TextRun({ text: formatCurrency(grandTotal), bold: true, size: 24 })
                ],
                alignment: AlignmentType.RIGHT,
                spacing: { before: 20, after: 40 }
            })
        );
    } else {
        children.push(
            new Paragraph({
                text: "Kh√¥ng c√≥ thu·ªëc trong ƒë∆°n",
                alignment: AlignmentType.CENTER,
                spacing: { before: 20 }
            })
        );
    }
    
    // Th√™m footer
    children.push(
     
        
        new Paragraph({
            children: [
                new TextRun(`Ng√†y xu·∫•t ƒë∆°n: ${new Date().toLocaleDateString('vi-VN')}`)
            ],
            alignment: AlignmentType.RIGHT
        })
    );
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: children
        }]
    });
    
    const blob = await docx.Packer.toBlob(doc);
    return blob;
}


// H√†m t·∫°o DOCX th·ªß thu·∫≠t
async function generateProcedureDocx(record) {
    const { Document, Paragraph, TextRun, Table, TableRow, TableCell, HeadingLevel, AlignmentType } = docx;
    
    const children = [
        new Paragraph({
            text: "TH·ª¶ THU·∫¨T",
            heading: HeadingLevel.HEADING_1,
            alignment: AlignmentType.CENTER,
            spacing: { after: 80 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "M√£ b·ªánh nh√¢n: ", bold: true }),
                new TextRun(record.patientCode)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "H·ªç t√™n: ", bold: true }),
                new TextRun(record.patientName)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Ng√†y kh√°m: ", bold: true }),
                new TextRun(formatDate(record.examinationDate))
            ],
            spacing: { after: 30 }
        })
    ];
    
    // Th√™m b·∫£ng th·ªß thu·∫≠t
    if (record.procedures && record.procedures.length > 0) {
        children.push(
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ children: [new Paragraph({ text: "STT", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "T√™n th·ªß thu·∫≠t", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "Ghi ch√∫", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "S·ªë l·∫ßn", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "ƒê∆°n gi√°", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "Th√†nh ti·ªÅn", bold: true })] })
                        ]
                    }),
                    ...record.procedures.map((proc, index) => {
                        const total = (proc.price || 0) * (proc.quantity || 0);
                        return new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ children: [new Paragraph(proc.name)] }),
                                new TableCell({ children: [new Paragraph(proc.note || '-')] }),
                                new TableCell({ children: [new Paragraph(proc.quantity.toString())] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(proc.price))] }),
                                new TableCell({ children: [new Paragraph(formatCurrency(total))] })
                            ]
                        });
                    })
                ]
            })
        );
        
        // Th√™m t·ªïng c·ªông
        const grandTotal = record.procedures.reduce((sum, proc) => 
            sum + ((proc.price || 0) * (proc.quantity || 0)), 0);
        
        children.push(
            new Paragraph({
                children: [
                    new TextRun({ text: "T·ªîNG C·ªòNG: ", bold: true, size: 24 }),
                    new TextRun({ text: formatCurrency(grandTotal), bold: true, size: 24 })
                ],
                alignment: AlignmentType.RIGHT,
                spacing: { before: 20, after: 40 }
            })
        );
    } else {
        children.push(
            new Paragraph({
                text: "Kh√¥ng c√≥ th·ªß thu·∫≠t",
                alignment: AlignmentType.CENTER,
                spacing: { before: 20 }
            })
        );
    }
    
    // Th√™m footer
    children.push(
     
        
        new Paragraph({
            children: [
                new TextRun(`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`)
            ],
            alignment: AlignmentType.RIGHT
        })
    );
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: children
        }]
    });
    
    const blob = await docx.Packer.toBlob(doc);
    return blob;
}

// H√†m t·∫°o DOCX di·ªÖn bi·∫øn
async function generateProgressDocx(record) {
    const { Document, Paragraph, TextRun, Table, TableRow, TableCell, HeadingLevel, AlignmentType } = docx;
    
    const children = [
        new Paragraph({
            text: "DI·ªÑN BI·∫æN B·ªÜNH",
            heading: HeadingLevel.HEADING_1,
            alignment: AlignmentType.CENTER,
            spacing: { after: 80 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "M√£ b·ªánh nh√¢n: ", bold: true }),
                new TextRun(record.patientCode)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "H·ªç t√™n: ", bold: true }),
                new TextRun(record.patientName)
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Tu·ªïi: ", bold: true }),
                new TextRun(record.age.toString())
            ],
            spacing: { after: 10 }
        }),
        
        new Paragraph({
            children: [
                new TextRun({ text: "Ch·∫©n ƒëo√°n: ", bold: true }),
                new TextRun(record.primaryDiagnosis || record.diagnosis || '')
            ],
            spacing: { after: 30 }
        })
    ];
    
    // Th√™m b·∫£ng di·ªÖn bi·∫øn
    if (record.progress && record.progress.length > 0) {
        children.push(
            new Table({
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ children: [new Paragraph({ text: "STT", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "Th·ªùi gian", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "Di·ªÖn bi·∫øn", bold: true })] }),
                            new TableCell({ children: [new Paragraph({ text: "Y l·ªánh", bold: true })] })
                        ]
                    }),
                    ...record.progress.map((item, index) => {
                        const date = new Date(item.datetime);
                        const dateStr = date.toLocaleString('vi-VN');
                        return new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph((index + 1).toString())] }),
                                new TableCell({ children: [new Paragraph(dateStr)] }),
                                new TableCell({ children: [new Paragraph(item.detail || '')] }),
                                new TableCell({ children: [new Paragraph(item.order || '')] })
                            ]
                        });
                    })
                ]
            })
        );
    } else {
        children.push(
            new Paragraph({
                text: "Kh√¥ng c√≥ di·ªÖn bi·∫øn",
                alignment: AlignmentType.CENTER,
                spacing: { before: 20 }
            })
        );
    }
    
    // Th√™m footer
    children.push(
    
        
        new Paragraph({
            children: [
                new TextRun(`Ng√†y xu·∫•t: ${new Date().toLocaleDateString('vi-VN')}`)
            ],
            alignment: AlignmentType.RIGHT
        })
    );
    
    const doc = new Document({
        sections: [{
            properties: {},
            children: children
        }]
    });
    
    const blob = await docx.Packer.toBlob(doc);
    return blob;
}

	   // X·ª≠ l√Ω t·∫£i xu·ªëng
       async function handleDownload(type) {
    const record = medicalRecords.find(r => r.id === currentRecordId);
    if (!record) {
        showToast('Kh√¥ng t√¨m th·∫•y b·ªánh √°n!', 'error');
        return;
    }
    
    try {
        // Hi·ªÉn th·ªã loading
        showToast('ƒêang t·∫°o file DOCX...', 'success');
        
        let docxContent;
        let fileName;
        
        switch(type) {
            case 'full':
                docxContent = await generateFullDocx(record);
                fileName = `BENH_AN_${record.patientCode}_${record.patientName}.docx`;
                break;
            case 'medicine':
                docxContent = await generateMedicineDocx(record);
                fileName = `DON_THUOC_${record.patientCode}_${record.patientName}.docx`;
                break;
            case 'procedure':
                docxContent = await generateProcedureDocx(record);
                fileName = `THU_THUAT_${record.patientCode}_${record.patientName}.docx`;
                break;
            case 'progress':
                docxContent = await generateProgressDocx(record);
                fileName = `DIEN_BIEN_${record.patientCode}_${record.patientName}.docx`;
                break;
            default:
                throw new Error('Lo·∫°i t·∫£i kh√¥ng h·ª£p l·ªá');
        }
        
        // T·∫£i file xu·ªëng
        const blob = docxContent;
        saveAs(blob, fileName);
        
        showToast(`ƒê√£ t·∫£i xu·ªëng file ${fileName}!`, 'success');
        
    } catch (error) {
        console.error('L·ªói khi t·∫°o DOCX:', error);
        showToast('L·ªói khi t·∫°o file: ' + error.message, 'error');
    }
}

        // Kh·ªüi t·∫°o c√°c s·ª± ki·ªán
        document.addEventListener('DOMContentLoaded', function() {
		
            // T·∫£i d·ªØ li·ªáu t·ª´ Dropbox khi kh·ªüi ƒë·ªông
            loadData();
            
            // S·ª± ki·ªán cho modal b·ªánh √°n ch√≠nh
            newRecordBtn.addEventListener('click', showNewRecordModal);
            // Th√™m v√†o s·ª± ki·ªán ƒë√≥ng modal
closeModalBtn.addEventListener('click', () => {
    recordModal.style.display = 'none';
    currentEditingRecordId = null; // Th√™m d√≤ng n√†y
});

cancelBtn.addEventListener('click', () => {
    recordModal.style.display = 'none';
    currentEditingRecordId = null; // Th√™m d√≤ng n√†y
});
            saveRecordBtn.addEventListener('click', saveRecord);
            
			
			
			
			
			
			
            // S·ª± ki·ªán t√¨m ki·∫øm
            searchBtn.addEventListener('click', searchRecords);
            resetSearchBtn.addEventListener('click', resetSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchRecords();
            });
            
            // S·ª± ki·ªán cho modal x√°c nh·∫≠n x√≥a
            document.querySelectorAll('.close-delete-modal').forEach(btn => {
                btn.addEventListener('click', () => confirmDeleteModal.style.display = 'none');
            });
			
	
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteRecord);
            
            // S·ª± ki·ªán cho modal di·ªÖn bi·∫øn
   


document.getElementById('saveProgressDetailBtn').onclick = () => {
    if (!currentEditingProgressCell) return;

    const value = document.getElementById('progressDetailText').value;
    currentEditingProgressCell.textarea.value = value;

    document.getElementById('progressDetailModal').style.display = 'none';
};

// ƒê√≥ng modal progress detail
document.querySelectorAll('.close-progress-detail-modal').forEach(btn => {
    btn.addEventListener('click', () => {
        document.getElementById('progressDetailModal').style.display = 'none';
        currentEditingProgressCell = null;
    });
});




   document.querySelectorAll('.close-progress-modal').forEach(btn => {
                btn.addEventListener('click', () => progressModal.style.display = 'none');
            });
            document.getElementById('saveProgressBtn').addEventListener('click', saveProgress);
           // S·ª± ki·ªán th√™m h√†ng m·ªõi trong progress
document.getElementById('addProgressRow').addEventListener('click', function() {
    const progressTableBody = document.getElementById('progressTableBody');
    const rowCount = progressTableBody.children.length + 1;
    const newRow = createProgressRow(rowCount);
    progressTableBody.appendChild(newRow);
});
            
			
			
			
            // X·ª≠ l√Ω x√≥a h√†ng di·ªÖn bi·∫øn
         document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-progress-row')) {
        const row = e.target.closest('tr');
        row.remove();
        
        // C·∫≠p nh·∫≠t STT
        const rows = document.querySelectorAll('#progressTableBody tr');
        rows.forEach((row, index) => {
            row.dataset.index = index + 1;
            row.cells[0].textContent = index + 1;
        });
    }
});
			
			
			
            
            // S·ª± ki·ªán cho modal t√πy ch·ªçn in/t·∫£i
            document.querySelectorAll('.close-print-modal').forEach(btn => {
                btn.addEventListener('click', () => printOptionsModal.style.display = 'none');
            });
            
       // Tab chuy·ªÉn ƒë·ªïi In/T·∫£i
    document.querySelectorAll('.export-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // C·∫≠p nh·∫≠t tab active
            document.querySelectorAll('.export-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Hi·ªÉn th·ªã content t∆∞∆°ng ·ª©ng
            document.querySelectorAll('.export-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // C·∫≠p nh·∫≠t text th√¥ng tin
            const infoText = tabName === 'print' ? 'Ch·ªçn lo·∫°i in ·∫•n' : 'Ch·ªçn ƒë·ªãnh d·∫°ng t·∫£i xu·ªëng';
            document.getElementById('selectedOptionText').textContent = infoText;
        });
    });
    
    
    // Hi·ªáu ·ª©ng hover cho export option
   document.querySelectorAll('.export-option').forEach(option => {
    option.addEventListener('mouseenter', function() {
        const type = this.dataset.type;
        const isPrint = this.classList.contains('print-option');
        let text = '';
        
        if (isPrint) {
            const printTexts = {
                'full': 'In to√†n b·ªô b·ªánh √°n v·ªõi t·∫•t c·∫£ th√¥ng tin',
                'medicine': 'In ƒë∆°n thu·ªëc cho b·ªánh nh√¢n',
                'procedure': 'In danh s√°ch th·ªß thu·∫≠t ƒë√£ th·ª±c hi·ªán',
                'progress': 'In l·ªãch s·ª≠ di·ªÖn bi·∫øn b·ªánh'
            };
            text = printTexts[type] || '';
        } else {
            // CH·ªà C√íN DOCX
            const downloadTexts = {
                'full': 'T·∫£i to√†n b·ªô b·ªánh √°n (DOCX)',
                'medicine': 'T·∫£i ƒë∆°n thu·ªëc (DOCX)',
                'procedure': 'T·∫£i th·ªß thu·∫≠t (DOCX)',
                'progress': 'T·∫£i di·ªÖn bi·∫øn (DOCX)'
            };
            text = downloadTexts[type] || '';
        }
        
        if (text) {
            document.getElementById('selectedOptionText').textContent = text;
        }
    });
    
    option.addEventListener('mouseleave', function() {
        const isPrintTab = document.querySelector('.export-tab[data-tab="print"]').classList.contains('active');
        const text = isPrintTab ? 'Ch·ªçn lo·∫°i in ·∫•n' : 'Ch·ªçn t√πy ch·ªçn t·∫£i xu·ªëng';
        document.getElementById('selectedOptionText').textContent = text;
    });
});
    
    // S·ª± ki·ªán cho c√°c t√πy ch·ªçn in
    document.querySelectorAll('.print-option').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.getAttribute('data-type');
            handlePrint(type);
            printOptionsModal.style.display = 'none';
        });
    });
    
    // S·ª± ki·ªán cho c√°c t√πy ch·ªçn t·∫£i xu·ªëng
document.querySelectorAll('.download-option').forEach(btn => {
    btn.addEventListener('click', function() {
        const type = this.getAttribute('data-type');
        handleDownload(type); // Ch·ªâ g·ªçi h√†m DOCX
        printOptionsModal.style.display = 'none';
    });
});
   
	
          // S·ª± ki·ªán cho n√∫t m·ªü r·ªông n·ªôi dung b·ªánh √°n
document.getElementById('expandDiagnosisBtn').addEventListener('click', function() {
    document.getElementById('diagnosisDetail').value = document.getElementById('diagnosis').value;
    diagnosisModal.style.display = 'block';
});

// S·ª± ki·ªán click cho th·ªß thu·∫≠t v√† thu·ªëc (v·∫´n gi·ªØ click)
document.querySelectorAll('.textarea-double-click').forEach(element => {
    element.addEventListener('click', function() {
        const targetModal = this.getAttribute('data-target');
        
        if (targetModal === 'procedureModal') {
            // M·ªü modal nh·∫≠p th·ªß thu·∫≠t
            procedureModal.style.display = 'block';
            initializeProcedureTable();
        } else if (targetModal === 'medicineModal') {
            // M·ªü modal nh·∫≠p thu·ªëc
            medicineModal.style.display = 'block';
            initializeMedicineTable();
        }
    });
});
            
			
            // S·ª± ki·ªán ƒë√≥ng modal n·ªôi dung b·ªánh √°n
            document.querySelectorAll('.close-diagnosis-modal').forEach(btn => {
                btn.addEventListener('click', () => diagnosisModal.style.display = 'none');
            });
            
            document.getElementById('saveDiagnosisBtn').addEventListener('click', function() {
    const diagnosisDetail = document.getElementById('diagnosisDetail').value;
    document.getElementById('diagnosis').value = diagnosisDetail;
    diagnosisModal.style.display = 'none';
    showToast('ƒê√£ c·∫≠p nh·∫≠t n·ªôi dung b·ªánh √°n!', 'success');
});
            
            // S·ª± ki·ªán ƒë√≥ng modal th·ªß thu·∫≠t
            document.querySelectorAll('.close-procedure-modal').forEach(btn => {
                btn.addEventListener('click', () => procedureModal.style.display = 'none');
            });
            
            // S·ª± ki·ªán ƒë√≥ng modal thu·ªëc
            document.querySelectorAll('.close-medicine-modal').forEach(btn => {
                btn.addEventListener('click', () => medicineModal.style.display = 'none');
            });
            
            // ƒê√≥ng modal khi click b√™n ngo√†i
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        });
        
        // Kh·ªüi t·∫°o b·∫£ng th·ªß thu·∫≠t
        function initializeProcedureTable() {
    const procedureTableBody = document.getElementById('procedureTableBody');
    procedureTableBody.innerHTML = '';
    
    // L·∫•y d·ªØ li·ªáu th·ªß thu·∫≠t t·ª´ b·ªánh √°n ƒëang ch·ªânh s·ª≠a ho·∫∑c t·ª´ localStorage t·∫°m th·ªùi
    let procedures = [];
    
    if (currentEditingRecordId) {
        // L·∫•y t·ª´ b·ªánh √°n ƒëang ch·ªânh s·ª≠a
        const record = medicalRecords.find(r => r.id === currentEditingRecordId);
        if (record && record.procedures) {
            procedures = record.procedures;
        }
    } else {
        // L·∫•y t·ª´ localStorage t·∫°m th·ªùi (cho th√™m m·ªõi)
        procedures = JSON.parse(localStorage.getItem('tempProcedures')) || [];
    }
    
    if (procedures.length > 0) {
        procedures.forEach((proc, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" class="procedure-name" value="${proc.name || ''}"></td>
                <td><input type="text" class="procedure-note" value="${proc.note || ''}" placeholder="Ghi ch√∫"></td>
                <td><input type="number" class="procedure-quantity" value="${proc.quantity || 1}" min="1"></td>
                <td class="price-column"><input type="number" class="procedure-price" value="${proc.price || 0}" min="0"></td>
                <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
            `;
            procedureTableBody.appendChild(row);
        });
    } else {
        // Th√™m h√†ng m·∫∑c ƒë·ªãnh
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>1</td>
            <td><input type="text" class="procedure-name" placeholder="Nh·∫≠p t√™n th·ªß thu·∫≠t"></td>
            <td><input type="text" class="procedure-note" placeholder="Ghi ch√∫"></td>
            <td><input type="number" class="procedure-quantity" placeholder="S·ªë l·∫ßn" min="1" value="1"></td>
            <td class="price-column"><input type="number" class="procedure-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
            <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
        `;
        procedureTableBody.appendChild(row);
    }
    
    // C·∫≠p nh·∫≠t t·ªïng
    updateProcedureTotals();
            
            // S·ª± ki·ªán cho n√∫t th√™m h√†ng
            document.getElementById('addProcedureRow').onclick = function() {
                const rowCount = procedureTableBody.children.length + 1;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="text" class="procedure-name" placeholder="Nh·∫≠p t√™n th·ªß thu·∫≠t"></td>
					<td><input type="text" class="procedure-note" placeholder="Ghi ch√∫"></td>
                    <td><input type="number" class="procedure-quantity" placeholder="S·ªë l·∫ßn" min="1" value="1"></td>
                    <td class="price-column"><input type="number" class="procedure-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
                    <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
                `;
                procedureTableBody.appendChild(newRow);
            };
            
            // S·ª± ki·ªán cho toggle hi·ªÉn th·ªã gi√°
            document.getElementById('toggleProcedurePrice').addEventListener('change', function() {
                const showPrice = this.checked;
                const priceColumns = document.querySelectorAll('#procedureTable .price-column');
                const totalRow = document.getElementById('procedureTotalRow');
                
                priceColumns.forEach(col => {
                    col.style.display = showPrice ? 'table-cell' : 'none';
                });
                
                totalRow.style.display = showPrice ? 'none' : 'table-row';
                
                if (!showPrice) {
                    document.getElementById('procedureTotalAmount').value = '';
                }
                
                updateProcedureTotals();
            });
            
            // S·ª± ki·ªán c·∫≠p nh·∫≠t t·ªïng khi nh·∫≠p li·ªáu
            procedureTableBody.addEventListener('input', updateProcedureTotals);
            
            // S·ª± ki·ªán l∆∞u th·ªß thu·∫≠t
           document.getElementById('saveProcedureBtn').addEventListener('click', function() {
    const procedures = [];
    const rows = document.querySelectorAll('#procedureTableBody tr');
    
    rows.forEach(row => {
        const name = row.querySelector('.procedure-name').value.trim();
        const note = row.querySelector('.procedure-note').value.trim();
        const quantity = parseInt(row.querySelector('.procedure-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.procedure-price').value) || 0;
        
        if (name) {
            procedures.push({ name, note, quantity, price });
        }
    });
    
    if (currentEditingRecordId) {
        // C·∫≠p nh·∫≠t v√†o b·ªánh √°n ƒëang ch·ªânh s·ª≠a
        const recordIndex = medicalRecords.findIndex(r => r.id === currentEditingRecordId);
        if (recordIndex !== -1) {
            medicalRecords[recordIndex].procedures = procedures;
        }
    } else {
        // L∆∞u v√†o localStorage t·∫°m th·ªùi
        localStorage.setItem('tempProcedures', JSON.stringify(procedures));
    }
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t√≥m t·∫Øt
    let procedureHTML = '<ul>';
    procedures.forEach(proc => {
        procedureHTML += `<li>${proc.name} - S·ªë l·∫ßn: ${proc.quantity}${proc.price ? ` - Gi√°: ${formatCurrency(proc.price)}` : ''}</li>`;
    });
    procedureHTML += '</ul>';
    document.getElementById('procedureSummary').innerHTML = procedureHTML;
    document.getElementById('procedureText').innerHTML = '<i class="fas fa-expand-alt"></i> Nh·∫•n ƒë·ªÉ ch·ªânh s·ª≠a th·ªß thu·∫≠t';
    
    procedureModal.style.display = 'none';
    showToast('ƒê√£ l∆∞u th·ªß thu·∫≠t!', 'success');
});
          
        }
        
		
        // C·∫≠p nh·∫≠t t·ªïng th·ªß thu·∫≠t
        function updateProcedureTotals() {
            const showPrice = document.getElementById('toggleProcedurePrice').checked;
            const rows = document.querySelectorAll('#procedureTableBody tr');
            
            let totalQuantity = 0;
            let totalPrice = 0;
            
            rows.forEach(row => {
                const quantity = parseInt(row.querySelector('.procedure-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.procedure-price').value) || 0;
                
                totalQuantity += quantity;
                totalPrice += price * quantity;
            });
            
            document.getElementById('procedureTotalQuantity').textContent = totalQuantity;
            document.getElementById('procedureTotalPrice').textContent = formatCurrency(totalPrice);
            
            // N·∫øu kh√¥ng hi·ªÉn th·ªã gi√°, c·∫≠p nh·∫≠t t·ªïng gi√° ti·ªÅn t·ª´ input
            if (!showPrice) {
                const totalAmount = parseFloat(document.getElementById('procedureTotalAmount').value) || 0;
                document.getElementById('procedureTotalPrice').textContent = formatCurrency(totalAmount);
            }
        }
        
        // Kh·ªüi t·∫°o b·∫£ng thu·ªëc
      function initializeMedicineTable() {
    const medicineTableBody = document.getElementById('medicineTableBody');
    medicineTableBody.innerHTML = '';
    
    // L·∫•y d·ªØ li·ªáu thu·ªëc t·ª´ b·ªánh √°n ƒëang ch·ªânh s·ª≠a ho·∫∑c t·ª´ localStorage t·∫°m th·ªùi
    let medicines = [];
    
    if (currentEditingRecordId) {
        // L·∫•y t·ª´ b·ªánh √°n ƒëang ch·ªânh s·ª≠a
        const record = medicalRecords.find(r => r.id === currentEditingRecordId);
        if (record && record.medicines) {
            medicines = record.medicines;
        }
    } else {
        // L·∫•y t·ª´ localStorage t·∫°m th·ªùi (cho th√™m m·ªõi)
        medicines = JSON.parse(localStorage.getItem('tempMedicines')) || [];
    }
    
    if (medicines.length > 0) {
        medicines.forEach((med, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" class="medicine-name" value="${med.name || ''}"></td>
                <td><input type="number" class="medicine-quantity" value="${med.quantity || 1}" min="1"></td>
                <td class="price-column"><input type="number" class="medicine-price" value="${med.price || 0}" min="0"></td>
                <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
            `;
            medicineTableBody.appendChild(row);
        });
    } else {
        // Th√™m h√†ng m·∫∑c ƒë·ªãnh
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>1</td>
            <td><input type="text" class="medicine-name" placeholder="Nh·∫≠p t√™n thu·ªëc"></td>
            <td><input type="number" class="medicine-quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1"></td>
            <td class="price-column"><input type="number" class="medicine-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
            <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
        `;
        medicineTableBody.appendChild(row);
    }
    
    // C·∫≠p nh·∫≠t t·ªïng
    updateMedicineTotals();
            
            // S·ª± ki·ªán cho n√∫t th√™m h√†ng
            document.getElementById('addMedicineRow').onclick = function() {
                const rowCount = medicineTableBody.children.length + 1;
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${rowCount}</td>
                    <td><input type="text" class="medicine-name" placeholder="Nh·∫≠p t√™n thu·ªëc"></td>
                    <td><input type="number" class="medicine-quantity" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1"></td>
                    <td class="price-column"><input type="number" class="medicine-price" placeholder="Gi√° ti·ªÅn" min="0"></td>
                    <td><button class="btn btn-danger btn-sm remove-row"><i class="fas fa-trash"></i></button></td>
                `;
                medicineTableBody.appendChild(newRow);
            };
            
            // S·ª± ki·ªán cho toggle hi·ªÉn th·ªã gi√°
            document.getElementById('toggleMedicinePrice').addEventListener('change', function() {
                const showPrice = this.checked;
                const priceColumns = document.querySelectorAll('#medicineTable .price-column');
                const totalRow = document.getElementById('medicineTotalRow');
                
                priceColumns.forEach(col => {
                    col.style.display = showPrice ? 'table-cell' : 'none';
                });
                
                totalRow.style.display = showPrice ? 'none' : 'table-row';
                
                if (!showPrice) {
                    document.getElementById('medicineTotalAmount').value = '';
                }
                
                updateMedicineTotals();
            });
            
            // S·ª± ki·ªán c·∫≠p nh·∫≠t t·ªïng khi nh·∫≠p li·ªáu
            medicineTableBody.addEventListener('input', updateMedicineTotals);
            
            // S·ª± ki·ªán l∆∞u thu·ªëc
            document.getElementById('saveMedicineBtn').addEventListener('click', function() {
                const medicines = [];
                const rows = medicineTableBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const name = row.querySelector('.medicine-name').value.trim();
                    const quantity = parseInt(row.querySelector('.medicine-quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.medicine-price').value) || 0;
                    
                    if (name) {
                        medicines.push({ name, quantity, price });
                    }
                });
                
                // L∆∞u v√†o localStorage t·∫°m th·ªùi
                localStorage.setItem('tempMedicines', JSON.stringify(medicines));
                
                // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t√≥m t·∫Øt
                let medicineHTML = '<ul>';
                medicines.forEach(med => {
                    medicineHTML += `<li>${med.name} - S·ªë l∆∞·ª£ng: ${med.quantity}${med.price ? ` - Gi√°: ${formatCurrency(med.price)}` : ''}</li>`;
                });
                medicineHTML += '</ul>';
                document.getElementById('medicineSummary').innerHTML = medicineHTML;
                document.getElementById('medicineText').textContent = 'Nh·∫•n ƒë√∫p ƒë·ªÉ ch·ªânh s·ª≠a thu·ªëc...';
                
                medicineModal.style.display = 'none';
                showToast('ƒê√£ l∆∞u thu·ªëc!', 'success');
            });
        }
        
        // C·∫≠p nh·∫≠t t·ªïng thu·ªëc
        function updateMedicineTotals() {
            const showPrice = document.getElementById('toggleMedicinePrice').checked;
            const rows = document.querySelectorAll('#medicineTableBody tr');
            
            let totalQuantity = 0;
            let totalPrice = 0;
            
            rows.forEach(row => {
                const quantity = parseInt(row.querySelector('.medicine-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.medicine-price').value) || 0;
                
                totalQuantity += quantity;
                totalPrice += price * quantity;
            });
            
            document.getElementById('medicineTotalQuantity').textContent = totalQuantity;
            document.getElementById('medicineTotalPrice').textContent = formatCurrency(totalPrice);
            
            // N·∫øu kh√¥ng hi·ªÉn th·ªã gi√°, c·∫≠p nh·∫≠t t·ªïng gi√° ti·ªÅn t·ª´ input
            if (!showPrice) {
                const totalAmount = parseFloat(document.getElementById('medicineTotalAmount').value) || 0;
                document.getElementById('medicineTotalPrice').textContent = formatCurrency(totalAmount);
            }
        }
        
        // X·ª≠ l√Ω x√≥a h√†ng trong b·∫£ng th·ªß thu·∫≠t v√† thu·ªëc
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-row')) {
                const row = e.target.closest('tr');
                const tableBody = row.parentNode;
                row.remove();
                
                // C·∫≠p nh·∫≠t STT
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.cells[0].textContent = index + 1;
                });
                
                // C·∫≠p nh·∫≠t t·ªïng
                if (tableBody.id === 'procedureTableBody') {
                    updateProcedureTotals();
                } else if (tableBody.id === 'medicineTableBody') {
                    updateMedicineTotals();
                }
            }
        });
		const themeDots = document.querySelectorAll('.theme-dot');
const darkToggle = document.getElementById('darkModeToggle');

// Load theme ƒë√£ l∆∞u
const savedColor = localStorage.getItem('themeColor');
const savedDark = localStorage.getItem('darkMode');

if (savedColor) applyThemeColor(savedColor);
if (savedDark === 'true') enableDarkMode();

// Click ch·ªçn m√†u
themeDots.forEach(dot => {
    dot.addEventListener('click', () => {
        const color = dot.dataset.color;
        applyThemeColor(color);
        localStorage.setItem('themeColor', color);
    });
});

// Dark mode toggle
darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    const isDark = document.body.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    darkToggle.textContent = isDark ? '‚òÄÔ∏è S√°ng' : 'üåô T·ªëi';
});

function enableDarkMode() {
    document.body.classList.add('dark');
    darkToggle.textContent = '‚òÄÔ∏è S√°ng';
}

// √Åp m√†u ch·ªß ƒë·ªÅ
function applyThemeColor(color) {
    document.documentElement.style.setProperty('--primary', color);
    document.documentElement.style.setProperty('--primary-dark', shadeColor(color, -15));
    document.documentElement.style.setProperty('--primary-light', shadeColor(color, 20));
}

// X·ª≠ l√Ω s√°ng/t·ªëi m√†u
function shadeColor(hex, percent) {
    let num = parseInt(hex.replace("#",""),16),
        amt = Math.round(2.55 * percent),
        R = (num >> 16) + amt,
        G = (num >> 8 & 0x00FF) + amt,
        B = (num & 0x0000FF) + amt;

    return "#" + (
        0x1000000 +
        (R<255?R<1?0:R:255)*0x10000 +
        (G<255?G<1?0:G:255)*0x100 +
        (B<255?B<1?0:B:255)
    ).toString(16).slice(1);
}



function printByIframe(htmlContent) {
    const iframe = document.getElementById("printFrame");
    const doc = iframe.contentWindow.document;

    doc.open();
    doc.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>In b·ªánh √°n</title>
            <style>
                body {
                    font-family: "Times New Roman", serif;
                    font-size: 14px;
                    padding: 20px;
                }
                h2 {
                    text-align: center;
                    margin-bottom: 20px;
                }
                p {
                    margin: 6px 0;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                }
                th, td {
                    border: 1px solid #000;
                    padding: 6px;
                }
            </style>
        </head>
        <body>
            ${htmlContent}
        </body>
        </html>
    `);
    doc.close();

    // ‚ö†Ô∏è B·∫ÆT BU·ªòC PH·∫¢I DELAY
    setTimeout(() => {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
    }, 500);
}

function showPreview(recordId) {
    const record = medicalRecords.find(r => r.id === recordId);
    if (!record) return;

    const html = generateFullPrintContent(record);

    document.getElementById("previewContainer").innerHTML = `
        <div class="pdf-page">
            ${html}
        </div>
    `;

    document.getElementById("previewModal").style.display = "block";
}

function closePreview() {
    document.getElementById("previewModal").style.display = "none";
}

    </script>
	
<footer class="app-footer">
    ¬© 2025 DrC
</footer>
	<!-- IFRAME D√ôNG CHO IN (KH√îNG ƒê∆Ø·ª¢C X√ìA) -->
<iframe id="printFrame" style="display:none;"></iframe>
<div id="previewModal" class="modal">
  <div class="modal-content" style="max-width:1200px">
    <div class="modal-header">
      <h3>üëÅ Xem b·ªánh √°n</h3>
      <button class="close-btn" onclick="closePreview()">&times;</button>
    </div>

    <div class="modal-body">
   

      <div class="pdf-preview-wrapper" id="previewContainer"></div>
    </div>
  </div>
</div>

</body>
</html>
